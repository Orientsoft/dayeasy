!function(t,e){function s(t){this._ele=t,this._canvas=null,this._sceneImage=null,this._customImage=null,this._customImageData=null,this._user=null,this._scene=null,this._width=350,this._height=525,this._customX=0,this._customY=0,this._dragX=0,this._dragY=0,this._dragListen=!1,this._customZoom=1,this._customAngle=0,this._canvasZoom=1,this._init(),this._drawWord=function(t){var s=this,i=function(e){if(t.save(),t.font=e.font,t.fillStyle=e.color,t.globalCompositeOperation="source-over",e.point.max)for(var i=Math.ceil(e.point.max*s._canvasZoom),n=0;n<Math.ceil(e.text.length/i);n++){var a=e.text.substring(n*i,(n+1)*i);t.fillText(a,e.point.x*s._canvasZoom,e.point.y*s._canvasZoom+n*(e.lineHeight||25))}else t.fillText(e.text,e.point.x*s._canvasZoom,e.point.y*s._canvasZoom);t.restore()};i(this._scene.word),this._scene.teacher.text=e.format(this._scene.teacher.text,this._user),i(this._scene.teacher),this._scene.from.text=e.format(this._scene.from.text,this._user),i(this._scene.from)},this._drawScene=function(t,e){var s=function(s){t.drawImage(s._sceneImage,0,0,s._width,s._height),e&&e.call()};if(this._sceneImage)return s(this),!0;if(this._scene){this._sceneImage=new Image,this._sceneImage.src=this._scene.image;var i=this;this._sceneImage.onload=function(){return s(i),!0}}},this._drawCustom=function(t,e){var s=function(s){t.save();var i=s._width/s._customImage.width*s._customImage.height,n=s._customX+(s._dragX||0),a=s._customY+(s._dragY||0);if(s._customAngle>0){var o=s._width/2,h=s._height/2;t.translate(o,h),t.rotate(s._customAngle*Math.PI/180),t.translate(-o,-h)}t.drawImage(s._customImage,n,a,s._width*s._customZoom,i*s._customZoom),t.restore(),e&&e.call()};if(this._customImage)return void s(this);if(this._customImageData){this._customImage=new Image,this._customImage.src=this._customImageData;var i=this;return this._customImage.onload=function(){s(i)},void(this._dragListen||(this.dragEvent(),this._dragListen=!0))}e&&e.call()}}s.prototype._init=function(){var e=document.createElement("canvas");if(!e||!e.getContext)return!1;var s=Math.min(t(window).width()-50,this._width);this._canvasZoom=s/this._width,this._width=s,this._height=this._height*this._canvasZoom,e.width=this._width,e.height=this._height,t(this._ele).append(e),this._canvas=e},s.prototype.dragEvent=function(){var t,e,s=this,i=function(s){if(s.preventDefault(),s.touches.length){var i=s.touches[0];t=i.pageX,e=i.pageY}},n=function(i){if(i.preventDefault(),i.touches.length){var n=i.touches[0],a=n.pageX-t,o=n.pageY-e;s.dragCustom(a,o)}},a=function(i){if(i.preventDefault(),i.changedTouches.length){var n=i.changedTouches[0];s._customX+=n.pageX-t,s._customY+=n.pageY-e}};this._canvas.addEventListener("touchstart",i,!1),this._canvas.addEventListener("touchmove",n,!1),this._canvas.addEventListener("touchend",a,!1)},s.prototype.draw=function(){var t=this._canvas.getContext("2d"),e=this;t.clearRect(0,0,this._canvas.width,this._canvas.height),e._drawCustom(t,function(){e._drawScene(t,function(){e._drawWord(t)})})},s.prototype.editWord=function(t){return this._scene&&this._scene.word?(this._scene.word.text=t,void this.draw()):!1},s.prototype.setUser=function(t){this._user=t},s.prototype.setScene=function(t){return t?(this._scene=t,this._sceneImage=null,this._customX=t.position.x*this._canvasZoom,this._customY=t.position.y*this._canvasZoom,void this.draw()):!1},s.prototype.setCustom=function(t){this._customImageData=t,this._customImage=null,this.draw()},s.prototype.dragCustom=function(t,e){this._dragX=t,this._dragY=e,this.draw()},s.prototype.zoomCustom=function(t){this._customZoom+=t,this.draw()},s.prototype.rotate=function(t){this._customAngle+=t,this.draw()},s.prototype.getImage=function(){return this._canvas.toDataURL("image/png")},t.fn.extend({poster:function(){return new s(this)},fileSelector:function(e){var s=t('<input type="file" id="takePicture" accept="image/*" />');s.css("display","none"),t("body").append(s),t(this).bind("click",function(){s.click()}),s.bind("change",function(t){var s,i=t.target.files;if(i&&i.length>0){s=i[0];try{var n=new FileReader;n.onload=function(t){var s=t.target.result;e&&e.call(this,s)},n.readAsDataURL(s)}catch(a){}}})}})}(jQuery,SINGER);