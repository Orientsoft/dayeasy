!function(t,e){function i(t){this._ele=t,this._canvas=null,this._context=null,this._sceneImage=null,this._customImage=null,this._customImageData=null,this._user=null,this._scene=null,this._width=350,this._height=525,this._customX=0,this._customY=0,this._dragX=0,this._dragY=0,this._dragListen=!1,this._customZoom=1,this._customAngle=0,this._init(),this._drawWord=function(t,i){var s=function(e){if(t.save(),t.font=e.font,t.fillStyle=e.color,t.globalCompositeOperation="source-over",e.point.max)for(var i=Math.ceil(e.point.max),s=0;s<Math.ceil(e.text.length/i);s++){var o=e.text.substring(s*i,(s+1)*i);t.fillText(o,e.point.x,e.point.y+s*(e.lineHeight||25))}else t.fillText(e.text,e.point.x,e.point.y);t.restore()};s(this._scene.word),this._scene.teacher.text=e.format(this._scene.teacher.text,this._user),s(this._scene.teacher),this._scene.from.text=e.format(this._scene.from.text,this._user),s(this._scene.from),i&&i.call(this)},this._drawScene=function(t,e){var i=function(i){t.drawImage(i._sceneImage,0,0,i._canvas.width,i._canvas.height),e&&e.call()};if(this._sceneImage)return i(this),!0;if(this._scene){this._sceneImage=new Image,this._sceneImage.src=this._scene.image;var s=this;this._sceneImage.onload=function(){return i(s),!0}}},this._drawCustom=function(t,e){var i=function(i){t.save();var s=i._canvas.width/2,o=s/i._customImage.width*i._customImage.height,a=i._customX+(i._dragX||0),n=i._customY+(i._dragY||0);if(i._customAngle>0){var c=i._width/2,h=i._height/2;t.translate(c,h),t.rotate(i._customAngle*Math.PI/180),t.translate(-c,-h)}s*=i._customZoom,o*=i._customZoom,t.drawImage(i._customImage,0,0,i._customImage.width,i._customImage.height,a,n,s,o),t.restore(),i._dragX=0,i._dragY=0,e&&e.call(i)};if(this._customImage)return void i(this);if(this._customImageData){this._customImage=new Image,this._customImage.src=this._customImageData;var s=this;return this._customImage.onload=function(){i(s)},void(this._dragListen||(this.dragEvent(),this._dragListen=!0))}e&&e.call()}}var s=function(t){var e=t.backingStorePixelRatio||t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1;return(window.devicePixelRatio||1)/e},o=function(t,e,i){if(!e)return i&&i.call(this,t),!1;var s=new Image;s.onload=function(){var t,s,o,a,n=0;t=this.naturalWidth,s=this.naturalHeight;var c=Math.max(t,s);if(c>1024){var h=Math.min(t,s);h=h/c*1024,c=1024,t>s?(t=c,s=h):(t=h,s=c)}var r=document.createElement("canvas");r.width=o=t,r.height=a=s;var u=r.getContext("2d");switch(e){case 3:n=180,t=-o,s=-a;break;case 6:r.width=a,r.height=o,n=90,t=o,s=-a;break;case 8:r.width=a,r.height=o,n=270,t=-o,s=a}u.rotate(n*Math.PI/180),u.drawImage(this,0,0,t,s),i&&i.call(this,r.toDataURL("image/png"))},s.src=t};i.prototype._init=function(){var e=document.createElement("canvas");return e&&e.getContext?(e.width=this._width,e.height=this._height,t(this._ele).append(e),this._canvas=e,void(this._context=this._canvas.getContext("2d"))):!1},i.prototype.dragEvent=function(){var t,e,i=this,o=function(i){if(i.preventDefault(),i.touches.length){var s=i.touches[0];t=s.pageX,e=s.pageY}},a=function(s){if(s.preventDefault(),s.touches.length){var o=s.touches[0],a=o.pageX-t,n=o.pageY-e;i.dragCustom(a,n)}},n=function(o){if(o.preventDefault(),o.changedTouches.length){var a=o.changedTouches[0],n=s(i._context);i._customX+=(a.pageX-t)*n,i._customY+=(a.pageY-e)*n}};this._canvas.addEventListener("touchstart",o,!1),this._canvas.addEventListener("touchmove",a,!1),this._canvas.addEventListener("touchend",n,!1)},i.prototype.draw=function(t){var e=this._context,i=this;e.clearRect(0,0,this._canvas.width,this._canvas.height),i._drawCustom(e,function(){i._drawScene(e,function(){i._drawWord(e,function(){t&&t.call(i)})})})},i.prototype.editWord=function(t){return this._scene&&this._scene.word?(this._scene.word.text=t,void this.draw()):!1},i.prototype.setUser=function(t){this._user=t},i.prototype.setScene=function(t){if(!t)return!1;var e=s(this._context);this._customX=t.position.x*e,this._customY=t.position.y*e,this._scene=t,this._sceneImage=null,this.draw()},i.prototype.setCustom=function(t,e){this._customImageData=t,this._customImage=null;var i=s(this._context);this._customX=this._scene.position.x*i,this._customY=this._scene.position.y*i,this.draw(e)},i.prototype.dragCustom=function(t,e){var i=s(this._context);this._dragX=t*i,this._dragY=e*i,this.draw()},i.prototype.zoomCustom=function(t){if(!this._customImage)return!1;var e=0;if(e=t?this._customZoom>=1?.2:.05:this._customZoom>1?-.2:-.05,this._customZoom+e<.5||this._customZoom+e>3)return!1;var i=this._width/(2*this._customImage.width),s=i*this._customZoom,o=i*this._customImage.height*this._customZoom;return this._customX-=s*e/2,this._customY-=o*e/2,this._customZoom=parseFloat((this._customZoom+e).toFixed(2)),this.draw(),this._customZoom},i.prototype.rotate=function(t){this._customAngle+=t,this.draw()},i.prototype.getImage=function(){return this._canvas.toDataURL("image/jpeg",.88)},t.fn.extend({poster:function(){return new i(this)},fileSelector:function(e){e=t.extend({},{start:void 0,finished:void 0},e||{});var i=t('<input type="file" id="takePicture" accept="image/*" />');i.css("display","none"),t("body").append(i),t(this).bind("click",function(){i.click()}),i.bind("change",function(t){var i,s=t.target.files;if(s&&s.length>0){i=s[0];try{e.start&&e.start.call(this);var a;EXIF.getData(i,function(){a=EXIF.getTag(this,"Orientation"),console.log("orientation:"+a)});var n=new FileReader;n.onload=function(t){var i=t.target.result;o(i,a,e.finished)},n.readAsDataURL(i)}catch(c){}}})}})}(jQuery,SINGER);