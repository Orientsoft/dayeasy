var editController=["$scope","$http",function(e,s){e.info={index:1,share:0,key:"",isnull:!1,err_msg:""},e.pages={index:1,max:0,page:5,size:10,key:""},e.data={id:"",name:"",desc:"",tags:"",face:"",grade:1},e.sendC={c_class:[],expire:"",startTime:"",all_class:[]},e.v_groups=[],e.c_groups=[],e.checks={data:[],tmp:[]},e.contents=[],e.makeThumb=singer.makeThumb,e.grades=[{id:-1,name:"请选择年级"}];var n=singer.tags({canEdit:!0}),a=function(e,s,n){if(!singer.isArray(e))return!1;var a,t=0,i=e.concat();for(a=0;a<e.length;a++)if(i[a].id==s&&i[a].type==n){t=i[a].sort,e.splice(a,1);break}if(0==e.length)return!1;for(a=0;a<e.length;a++)e[a].sort>t&&(e[a].sort-=1);e.sort(function(e,s){return e.sort>s.sort})};$(function(a){singer.isUndefined(singer.uri().crid)||s.get("/Home/Item?crid="+singer.uri().crid).success(function(s){if(singer.isUndefined(s.status)){e.data.id=s.id,e.data.name=s.name,e.data.desc=s.desc,e.data.tags=s.tags,e.data.face=s.face,singer.isArray(singer.json(s.tags))&&(n=singer.tags({canEdit:!0,data:singer.json(s.tags)})),e.checks.tmp=s.videos;for(var t=0;t<s.papers.length;t++)e.checks.tmp.push(s.papers[t]);e.checks.data=a.extend(!0,[],e.checks.tmp),e.checks.data.sort(function(e,s){return e.sort>s.sort})}}),s.get("/Home/Grade").success(function(s){s.status&&(e.grades=e.grades.concat(s.data),e.data.grade=-1)})}),e.videos=function(n){e.v_groups=[],n>-1&&3>n&&e.info.share!=n&&(e.info.share=n,e.pages.index=1,e.pages.max=0,e.pages.key=""),e.info.isnull=!1,s.get("/Home/Videos?share="+e.info.share+"&index="+e.pages.index+"&size="+e.pages.size+"&key="+e.pages.key).success(function(s){if(e.info.isnull=!s.status||!s.data.groups.length||0==s.data.groups.length,s.status){e.v_groups=s.data.groups;for(var n=0;n<e.v_groups.length;n++)for(var a=0;a<e.v_groups[n].videos.length;a++){var t=e.v_groups[n].videos[a];t.points=t.points&&t.points.length?singer.json(t.points):[];for(var i=0;i<e.checks.tmp.length;i++)t.id==e.checks.tmp[i].id&&(t.checked=!0)}var r=Math.ceil(s.data.total/e.pages.size);e.pages.max!=r&&(e.pages.max=r,PageHtml(e))}else e.pages.max=0}).error(function(){e.pages.max=0})},e.papers=function(n){e.c_groups=[],n>-1&&3>n&&e.info.share!=n&&(e.info.share=n,e.pages.index=1,e.pages.max=0,e.pages.key=""),e.info.isnull=!1,s.get("/Home/Papers/?index="+e.pages.index+"&size="+e.pages.size+"&share="+e.info.share+"&key="+e.pages.key).success(function(s){if(e.info.isnull=!s.status||!s.data.length||0==s.data.length,s.status){for(var n=0;n<s.data.length;n++)for(var a=0;a<e.checks.tmp.length;a++)s.data[n].id==e.checks.tmp[a].id&&(s.data[n].checked=!0);e.c_groups=s.data}else e.pages.max=0}).error(function(){e.pages.max=0})},e.check=function(s){if(s.checked=singer.isUndefined(s.checked)?!0:!s.checked,s.checked){var n={id:s.id,type:e.info.index,points:s.points,share:s.share,sort:e.checks.tmp.length+1};2==e.info.index?(n.name=s.name,n.duration=s.duration,n.speaker=s.speaker,n.face=s.face):(n.title=s.title,n.s_time=s.s_time,n.grade_name=s.grade_name),e.checks.tmp.push(n)}else a(e.checks.tmp,s.id,e.info.index)};var t=function(s,n){a(e.checks.data,s,n),e.checks.tmp=e.checks.data.concat()};e.cpage=function(s,n){1>s||s>e.pages.max||s==e.pages.index||(e.pages.index=s,(n||s<e.pages_html.l||s>e.pages_html.r)&&PageHtml(e),2==e.info.index?e.videos():e.papers())},e.search=function(){e.pages.key=e.info.key,2==e.info.index?e.videos():e.papers()},e.searchPress=function(s){s&&13==s.keyCode&&e.search()},e.copyChk=function(){e.checks.data=e.checks.tmp.concat();for(var s=0;s<e.checks.data.length;s++)e.checks.data[s].sort=s+1;e.barChg(1)},e.cansolChk=function(){e.checks.tmp=$.extend(!0,[],e.checks.data),e.barChg(1)},e.barChg=function(s){1>s||s>3||e.info.index==s||(e.info.share=0,e.info.key="",e.info.isnull=!1,e.info.index=s,e.pages.index=1,e.pages.key="",2==s?e.videos():3==s&&e.papers())},e.isLock=!1;var i=function(s){e.isLock=!0},r=function(s){e.isLock=!1};e.verification=function(){if(""==e.data.name)return"请填写课堂标题";if(e.data.grade<1)return"请选择适用年级";var s=$("#imgValues").find("input").val();if("undefined"!=typeof s&&(e.data.face=s),""==e.data.face)return"请上传课堂封面";if(0==e.checks.data.length)return"请添加视频或微检测";e.data.tags=singer.json(n.get()),e.contents=[];for(var a=0;a<e.checks.data.length;a++){var t=e.checks.data[a],i=a+1;!singer.isUndefined(t.sort)&&t.sort>0&&(i=t.sort),e.contents.push({id:t.id,type:2==t.type?0:1,sort:i})}return""},e.save=function(){i();var n=e.verification();return""!=n?(singer.msg(n),void r()):void s.post("/Home/AddVideoClass",{v:e.data,d:e.contents}).success(function(e){e.status?singer.confirm("保存成功，是否继续出课？",function(){window.location.href=window.location.href},function(){window.location.href="/"}):singer.msg(e.message),r(!0)}).error(function(){r(!0)})},e.sendOpen=function(){i();var n=e.verification();return""!=n?(singer.msg(n),void r()):(e.info.err_msg="",ddShow(),r(),void(e.sendC.all_class.length||s.get("/Home/Classes").success(function(s){s.status?e.sendC.all_class=s.data:e.info.err_msg="未查询到任课班级"}).error(function(){})))},e.addClass=function(s){if(!singer.isUndefined(s)){for(var n=0;n<e.sendC.c_class.length;n++)if(e.sendC.c_class[n]==s)return void e.sendC.c_class.splice(n,1);e.sendC.c_class.push(s)}},e.send=function(){if(i(),e.sendC.expire=$("#txtExpire").val(),e.sendC.startTime=$("#txtStartTime").val(),""==e.sendC.id)return e.info.err_msg="系统参数错误，请刷新重试！",void r();if(0==e.sendC.c_class.length)return e.info.err_msg="请选择发布班级",void r();if(""==e.sendC.startTime)return e.info.err_msg="请填写开始时间",void r();if(""==e.sendC.expire)return e.info.err_msg="请填写截止时间",void r();var n=$("#usedToWeb:checked").val();s.post("/Home/SendVideoClass",{v:e.data,d:e.contents,classes:e.sendC.c_class.join(","),expire:e.sendC.expire,startTime:e.sendC.startTime,used2Web:n}).success(function(s){s.status?(ddClose(),singer.confirm("发布成功，是否继续出课？",function(){window.location.href=window.location.href},function(){window.location.href="/"})):e.info.err_msg=josn.message,r()}).error(function(){r()})},$(".groups").dragsort({dragSelectorExclude:"div.remove",dragEnd:function(){$(".groups").find("li").each(function(s,n){var a,t=$(n).data("id"),i=$(n).data("type");for(a=0;s<e.checks.data.length;a++){var r=e.checks.data[a];if(r.id==t&&r.type==i){r.sort=s+1;break}}}),e.checks.data.sort(function(e,s){return e.sort>s.sort}),e.$digest()}}),$(".groups").delegate(".j-remove","click",function(){var s=$(this),n=s.parents("li"),a=n.data("id"),i=n.data("type");t(a,i),e.$digest()})}];