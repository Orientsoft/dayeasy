var classroomController=["$scope","$http",function(e,s){e.info={index:1,type:0,share:0,key:"",keyword:"",page:1,size:10,grade:-1,isnull:!1,err_msg:""},e.pages={},e.sendC={id:"",name:"",c_class:[],expire:"",start_time:"",all_class:[]},e.stages=[],e.grades=[],e.c_groups=[],e.v_groups=[],e.makeThumb=singer.makeThumb,e.load=function(n){e.pages={},e.c_groups=[],n>-1&&3>n&&e.info.type!=n&&(e.info.type=n,e.info.page=1,e.info.keywork="",e.pages={}),s.post("/Home/VideoClass",{type:e.info.type,index:e.info.page,size:e.info.size,key:e.info.keyword,grade:e.info.grade}).success(function(s){s.status?(e.info.isnull=!1,e.c_groups=s.data.groups,e.pages=singer.page({current:e.info.page-1,size:e.info.size,total:s.data.total})):e.info.isnull=!0}).error(function(){})},e.videos=function(n){e.v_groups=[],n>-1&&2>n&&e.info.share!=n&&(e.info.share=n,e.info.page=1,e.info.keywork=""),e.pages={},s.post("/Home/Videos",{share:e.info.share,index:e.info.page,size:e.info.size,key:e.info.keyword,grade:e.info.grade}).success(function(s){if(s.status){e.info.isnull=!1,e.v_groups=s.data.groups;for(var n=0;n<e.v_groups.length;n++)for(var i=0;i<e.v_groups[n].videos.length;i++){var t=e.v_groups[n].videos[i];singer.isUndefined(t.tags)&&(t.tags=t.tagids?singer.json(t.tagids):[]),t.points=t.points&&t.points.length?singer.json(t.points):[],t.e_data=$.extend(!0,{},t),t.e_data.add_status=!1}s.data.total>e.info.size&&(e.pages=singer.page({current:e.info.page-1,size:e.info.size,total:s.data.total}))}else e.info.isnull=!0,e.pages={}}).error(function(){e.pages={}})},$(function(n){singer.isUndefined(singer.uri().video)||(e.info.index=2),singer.isUndefined(singer.uri().done)||(e.info.type=2),s.get("/Home/Stage").success(function(s){s.status&&(e.stages=s.data)}),s.get("/Home/Grade").success(function(s){if(s.status){e.grades=[];for(var n=0;n<s.data.length;n++){var i=s.data[n].name,t={id:s.data[n].id,name:i,stage:0==i.indexOf("小学")?"小学":0==i.indexOf("初中")?"初中":0==i.indexOf("高中")?"高中":""};e.grades.push(t)}}}),1==e.info.index?e.load():e.videos(),n(document).delegate(".q-share","mouseenter",function(){n(this).addClass("share-hover")}).delegate(".q-share","mouseleave",function(){n(this).removeClass("share-hover")})}),e.gradeName=function(e){switch(singer.isString(e)&&(e=parseInt(e)),e){case 0:return"全部";case 1:return"小学一年级";case 2:return"小学二年级";case 3:return"小学三年级";case 4:return"小学四年级";case 5:return"小学五年级";case 6:return"小学六年级";case 7:return"初中一年级";case 8:return"初中二年级";case 9:return"初中三年级";case 10:return"高中一年级";case 11:return"高中二年级";case 12:return"高中三年级";default:return""}},e.showTime=function(e){var s=/Date\((\d+)\+/i;if(s.test(e)){var n=new Date(parseInt(RegExp.$1));return singer.formatDate(n,"yyyy-MM-dd hh:mm")}return e},e.detail=function(n){for(var i=n.batch,t=n.id,a=0;a<e.c_groups.length;a++)for(var r=0;r<e.c_groups[a].v_classes.length;r++)if(i.length>0&&e.c_groups[a].v_classes[r].batch==i||i.length<1&&e.c_groups[a].v_classes[r].id==t){var o=e.c_groups[a].v_classes[r];return o.tags||(o.tags=[]),singer.isString(o.tags)&&(o.tags=singer.json(o.tags)),singer.isUndefined(o.ss_time)&&(o.ss_time=DateFormat(o.star_time)),singer.isUndefined(o.se_time)&&(o.se_time=DateFormat(o.expire)),singer.isUndefined(o.s_time)&&(o.s_time=DateFormat(o.time)),singer.isUndefined(o.is_edit_expire)&&(o.is_edit_expire=!1),o.s_detail=n.state=singer.isUndefined(o.s_detail)?!0:!o.s_detail,singer.isUndefined(o.isnull_detail)&&(o.isnull_detail=!1),void(singer.isUndefined(o.detail)&&(o.detail=[],s.post("/Home/VideoDetail",{crid:t,batch:i}).success(function(e){e.status?o.detail=e.data:o.isnull_detail=!0}).error(function(){})))}},e.editV=function(s){if(!e.stages.length||!e.grades.length)return void singer.msg("学段年级未能加载，请刷新重试");if(s.edit=!s.edit,s.edit){var n=$('.edit[data-id="'+s.id+'"]'),i=n.find(".d-tags"),t=n.find(".d-points");singer.tags({container:i,data:s.e_data.tags,canEdit:!0,change:function(e){s.e_data.tags=e}}),singer.points({container:t,treeId:s.id,url:"/kpoints",data:s.e_data.points,init:function(){var n=e.stages[0].id;if(e.stages.length>1){var i=s.e_data.grade;7>i?n=1:10>i?n=2:13>i&&(n=3)}return{subject_id:5,stage:n}},change:function(e){s.e_data.points=e}})}},e.deleteV=function(e){singer.confirm("确认删除视频："+e.name,function(){s.post("/Home/DeleteV",{id:e.id}).success(function(e){e.status?singer.alert("删除成功!",function(){var e=window.location.href;-1==e.indexOf("video=")&&(e+=e.indexOf("?")>-1?"&video=1":"?video=1"),window.location.href=e}):singer.msg(e.message)})},function(){})},e.save=function(n){1!=e.info.share&&(n.e_data.tagids=singer.json(n.e_data.tags.concat()),n.e_data.points=singer.json(n.e_data.points),s.post("/Home/Update",n.e_data).success(function(s){n.e_data.points=singer.json(n.e_data.points),s.status?(n.edit=!1,n.name=n.e_data.name,n.speaker=n.e_data.speaker,n.share=n.e_data.share,n.points=n.e_data.points,n.tags=n.e_data.tags.concat(),n.grade=n.e_data.grade,n.grade_name=e.gradeName(n.grade),n.edit=!1):singer.msg("修改失败")}).error(function(){}))},e.open=function(e){0==e.type?singer.play({url:e.url,height:450}):1==e.type&&singer.open(singer.sites.main+"/paper/detail/"+e.source_id+"?app=classroom")},e.videoPlay=function(e){singer.play({url:e,height:450})},e.undo=function(s,n){var i="/Home/Undo?batch="+s+"&content="+n.id;0!=n.type&&(i=2==e.info.type?singer.format("{0}/work/teacher/statistics-question?batch={1}&paper_id={2}&app=classroom",singer.sites.main,s,n.source_id):singer.sites.main+"/Paper/Detail/"+n.source_id+"?app=classroom"),singer.open(i)},e.deleteC=function(e){confirm("确定删除课堂："+e.name)&&s.post("Home/Delete?vcId="+e.id).success(function(e){e.status?(singer.msg("删除成功"),window.location.reload(!0)):singer.msg(e.message)}).error(function(){})},e.editC=function(e){return window.location.href="/Home/Create?crid="+e,!1},e.page=function(s){1>s||s==e.info.page||(e.info.page=s,1==e.info.index?e.load():e.videos())},e.tab_c=function(s){1>s||s>2||e.info.index==s||(e.pages={},e.info.index=s,e.info.page=1,e.info.grade=-1,$("#grade").val("-1"),1==s?e.load(0):e.videos(0))},e.search=function(){e.pages={},e.info.keyword=e.info.key,e.info.page=1,e.info.grade=$("#grade").children("option:selected").val(),1==e.info.index?e.load():e.videos()},e.searchPress=function(s){s&&13==s.keyCode&&e.search()},e.sendOpen=function(n){e.sendC.id=n.id,e.sendC.name=n.name,e.info.err_msg="",ddShow(),e.sendC.all_class.length||s.get("/Home/Classes").success(function(s){s.status?e.sendC.all_class=s.data:e.info.err_msg="未查询到任课班级"}).error(function(){})},e.addClass=function(s){if(!singer.isUndefined(s)){for(var n=0;n<e.sendC.c_class.length;n++)if(e.sendC.c_class[n]==s)return void e.sendC.c_class.splice(n,1);e.sendC.c_class.push(s)}},e.send=function(){if(e.sendC.expire=$("#txtExpire").val(),e.sendC.start_time=$("#txtStartTime").val(),""==e.sendC.id)return void(e.info.err_msg="系统参数错误，请刷新重试！ ");if(0==e.sendC.c_class.length)return void(e.info.err_msg="请选择发布班级");if(""==e.sendC.start_time)return void(e.info.err_msg="请选择开始时间");if(""==e.sendC.expire)return void(e.info.err_msg="请选择截止时间");var n=$("#usedToWeb:checked").val();s.post("/Home/Send",{source:e.sendC.id,classes:e.sendC.c_class.join(","),startTime:e.sendC.start_time,expire:e.sendC.expire,used2Web:n}).success(function(s){s.status?($("#disable-body").remove(),$(".deyi-dialog").fadeOut(),singer.msg("发布成功！老师辛苦了，<span class='tip-color'>进行中</span>可查看哦~")):e.info.err_msg=s.message}).error(function(){})},e.editExpire=function(s,n){n?singer.confirm("确定关闭当前课堂？",function(){e.saveExpire(s,!0)},function(){}):s.is_edit_expire=singer.isUndefined(s.is_edit_expire)?!0:!s.is_edit_expire},e.saveExpire=function(e,n){var i="end";n||(i=$("#txtEditExpire").val()),s.post("/Home/UpdateExpire/?batch="+e.batch+"&expire="+i).success(function(s){if(s.status){n&&(i=singer.formatDate(new Date,"yyyy-MM-dd hh:mm")),e.se_time=i,e.is_edit_expire=!1;var t="关闭成功！课堂已移至<span class='tip-color'>已结束</span>咯,请刷新查看！";n||(t="修改成功！课堂已移至<span class='tip-color'>进行中</span>咯,请刷新查看！"),singer.msg(t)}else singer.msg(s.message)}).error(function(){})},e.cancel=function(e){singer.confirm("确定放弃发布当前课堂？",function(){s.post("/Home/CancelPublish",{batch:e.batch}).success(function(e){singer.msg(e.status?"操作成功，请刷新查看！":e.message)})},function(){})},e.shareChg=function(e){var n=0==e.share?1:0;s.post("/Home/UpdShare?id="+e.id+"&share="+n).success(function(s){s.status&&(e.share=n)})}}];