/*! dayeasy.static version:1.1.1 2015-05-13 19:43:46 */
!function(a){a.fn.PaperMaker=function(b){var c=new t(this,b);return c.create(),a(this)};var b,c,d=singer.tags({data:a(".d-tags").data("tags"),canEdit:!0,type:2,change:function(){}}),e=singer.points({container:a("#points").find(".kpPoint"),data:a("#points").data("kps"),max:15,isAppendData:!1,init:function(){var b=2,c=a("#grade").children("option:selected").text();return c.indexOf("小学")>=0?b=1:c.indexOf("初中")>=0?b=2:c.indexOf("高中")>=0&&(b=3),{stage:b,subject_id:a("#subjectId").val()}},change:function(b){if(b){var c=a("#highSet").text();"高级配置"==a.trim(c)?(a("#normalKps").removeClass("hide"),a("#setKps").addClass("hide")):(a("#normalKps").addClass("hide"),a("#setKps").removeClass("hide")),b.length<1?a("#setKps").addClass("hide"):a("#leader").removeClass("hide"),a("#selKps").empty();var d='<li><span class="f-knleg"><em>{kpName}</em><i class="f-close">x</i></span></li>';a.each(b,function(b,c){var e=d.replaceAll("{kpName}",c.name);a("#selKps").append(e)}),a("#f-pips-count").length>0&&A(b)}}}),f=a("#startSelQu"),g=a("#buildPaper"),h=a("#rebuildPaper"),i=a("#paperInfoDiv"),j=a("#chooseQuDiv"),k=a("#paperNav"),l=a("#paperDetailDiv"),m=a(".paper-qSection"),n=a("#questionListDiv"),o=a("#btn_preview"),p=a("#btn_Save"),q=a("#shareRange"),r=a("#questionSort"),s=a("#f-pips-count"),t=function(b,c){this.$element=a(b),this.defaults={},this.options=a.extend({},this.defaults,c)};t.prototype={create:function(){c=this,document.onkeydown=function(b){var c=document.all?window.event:b;13==c.keyCode&&a(".btn_Search").click()},a(window).bind("beforeunload",function(){return"试卷尚未保存，刷新页面数据将会丢失！"}),a("body").append('<div id="ajaxModel" style="z-index: 10000;position: absolute;height: 100%;width: 100%;left: 0;top: 0;" class="hide"><div class="text-center"><span id="dyloading" style="position:fixed; z-index: 1000;top: 50%;"><i class="fa fa-spin fa-spinner fa-3x" ></i><br /><br />正在加载，请稍后...</span></div></div>'),a.ajaxSetup({beforeSend:function(){a("#ajaxModel").removeClass("hide")},complete:function(){a("#ajaxModel").addClass("hide")}}),z(m),a(".q-star").raty({path:singer.sites.static+"/plugs/raty/images/",score:0,hints:["容易","普通","一般","困难","极难"],click:function(b){a("#starValue").val(b),a("#noStar").removeClass("f-fc"),c.questionSearch()}}),b=singer.points({container:a("#searchPoints").find(".d-points"),check:{enable:!0,chkStyle:"radio",radioType:"all"},treeId:"searchTree",init:function(){var b=2,c=a("#grade").children("option:selected").text();return c.indexOf("小学")>=0?b=1:c.indexOf("初中")>=0?b=2:c.indexOf("高中")>=0&&(b=3),{stage:b,subject_id:a("#subjectId").val()}},change:function(b){a("#kp").val(b&&b.length>0?b[0].name:""),a("#searchKps").find("a").eq(0).addClass("z-sel").siblings().removeClass("z-sel")}}),a(document).delegate(".q-perscore,.qScore","keyup",function(){var b=a(this);b.val(/(\d{1,2}((\.\d)|\.)?)/.test(b.val())?RegExp.$1:"")}).delegate(".q-perscore,.qScore","change",function(){var b=a(this);b.val(/(\d{1,2}(\.\d)?)/.test(b.val())?RegExp.$1:"")}),a("#selKps,#f-pips-count").delegate("i.f-close","click",function(){var b=e.get().data,c=a(this).parents("li"),d=c.index();a("#selKps").children("li").eq(d).remove();var f=a("#f-pips-count");f.length>0&&f.children("li").eq(d).remove();var g=[];a.each(b,function(a,b){a!=d&&g.push(b)}),g.length<1&&a("#setKps").addClass("hide"),e.set(g)}),a(".editsave").bind("click",this.paperEditSave),f.bind("click",this.startSelQuClick),g.bind("click",this.buildPaperClick),h.bind("click",this.buildPaperClick),k.find("ul li").bind("click",this.navStepClick),m.dragsort({dragSelectorExclude:"input,textarea,span.plus,i",dragEnd:this.questionSectionDragEnd}),a("#qTypes,#qTypesA,#qTypesB").find("ul li span").bind("click",this.questionTypeChoose),l.delegate("span.plus","click",this.questionSearch),l.delegate("i.s-del","click",this.sectionDel),l.delegate("i.paper-del","click",this.questionDel),l.delegate("input.q-perscore","blur",this.UpdatePerScore),l.delegate("input.qScore","blur",this.UpdateQScoreAndNum),n.delegate(".paper-qlist input[type='checkbox']","click",this.checkboxClick),n.delegate(".btn_Sure","click",this.questionSelectSure),n.delegate(".btn_Cancel","click",this.questionSelectCancel),n.find(".btn_Search").bind("click",this.questionSearch),q.children("a").bind("click",this.shareRangeChange),r.children("a").bind("click",this.searchQuSortClick),o.bind("click",this.paperPreview),p.bind("click",this.paperDataSave),a("#noStar").bind("click",this.noStarClick),a("#searchKps").delegate("a","click",this.kpClick)},startSelQuClick:function(){return v()?(j.removeClass("hide"),i.addClass("hide"),n.addClass("hide"),k.find("ul li:first a").removeClass("crt"),void k.find("ul li:last a").addClass("crt")):!1},prevStepClick:function(){return j.hasClass("hide")?!1:(i.removeClass("hide"),j.addClass("hide"),n.addClass("hide"),k.find("ul li:last a").removeClass("crt"),void k.find("ul li:first a").addClass("crt"))},navStepClick:function(){var b=a(this).index();0==b?c.prevStepClick():c.startSelQuClick()},buildPaperClick:function(){if(!v())return!1;l.empty();var a=c.getAutoPaperData();l.load("/paper/ShowAutoQuestion",{autoData:JSON.stringify(a)},function(){z(l),l.find(".paper-qSection").dragsort({dragSelectorExclude:"input,textarea,span.plus,i",dragEnd:c.questionSectionDragEnd}),j.removeClass("hide"),i.addClass("hide"),n.addClass("hide"),k.find("ul li:first a").removeClass("crt"),k.find("ul li:last a").addClass("crt")})},getAutoPaperData:function(){var b=[],c=s.find("li");a.each(c,function(c,d){var e={};e.Name=a(d).find("span em").text(),e.Count=parseInt(a(d).children("div").attr("data-value")),b.push(e)});var d=[];if(a("#qTypes").length>0){var e=a("#qTypes").find("ul li.sel");a.each(e,function(b,c){var e={};e.Type=a(c).data("value"),e.Name=a(c).children("span").text();var f=parseInt(a(c).children(".qtype-num").val());e.Count=isNaN(f)?0:f,e.PaperSectionType="A",d.push(e)})}else{var f=a("#qTypesA").find("ul li.sel");a.each(f,function(b,c){var e={};e.Type=a(c).data("value"),e.Name=a(c).children("span").text();var f=parseInt(a(c).find(".qtype-num").val());e.Count=isNaN(f)?0:f,e.PaperSectionType="A",d.push(e)});var g=a("#qTypesB").find("ul li.sel");a.each(g,function(b,c){var e={};e.Type=a(c).data("value"),e.Name=a(c).children("span").text();var f=parseInt(a(c).find(".qtype-num").val());e.Count=isNaN(f)?0:f,e.PaperSectionType="B",d.push(e)})}var h=a("#paperLevel").children("li.sel").data("value");return{Kps:b,Qtypes:d,Diffic:h}},questionSectionDragEnd:function(){c.updateSectionNo(a(this).parent("ul")),c.questionContentDragEnd()},questionContentDragEnd:function(){var b=a("ul.paper-qContent").children("li");a.each(b,function(b,c){a(c).find("div.sortNum").text(b+1+".")})},questionTypeChoose:function(){var b=a(this).parent("li");b.toggleClass("sel");var d=b.parents("div").data("pt"),e=l.find("ul.paper-qSection:first");"B"==a.trim(d)&&(e=l.find("ul.paper-qSection:last"));var f=a.trim(b.text()),g=b.data("value"),h="section"+d+"_"+g;if(b.hasClass("sel")){b.find(".qtype-num").focus();var i=a("#qSectionTemp").html(),j=e.children("li").length;i=i.replaceAll("{sectionId}",h).replaceAll("{sectionNo}",y(j+1)).replaceAll("{sectionTitle}",f).replaceAll("{qtype}",g),e.append(i),z(a("#"+h))}else{b.find(".qtype-num").val("");var k=a("#"+h).find("ul.paper-qContent").children("li").length;k>0?a.Dayez.confirm("您确定要删除该题型及其下面的题目？",function(){a("#"+h).remove(),c.updateSectionNo(e)},function(){b.addClass("sel")}):(a("#"+h).remove(),c.updateSectionNo(e))}var m=b.parents("ul"),n=m.find(".qtype-num"),o=0;a.each(n,function(b,c){var d=parseInt(a(c).val());isNaN(d)&&(d=0),o+=d}),m.parent("div").prev("h3").find("em span").text(o)},sectionDel:function(){var b=a(this);a.Dayez.confirm("您确定要删除该题型及其下面的题目？",function(){var d=b.parent("h3").parent("li"),e=d.parent("ul.paper-qSection"),f=d.attr("id"),g=a.trim(f).split("_")[1];f.indexOf("A")>0?a("#qTypesA,#qTypes").find("ul li.sel[data-value='"+g+"']").removeClass("sel"):a("#qTypesB").find("ul li.sel[data-value='"+g+"']").removeClass("sel"),d.remove(),c.updateSectionNo(e),c.questionContentDragEnd()},function(){})},questionDel:function(){var b=a(this),d=a.Dayez.confirm("您确定要删除该题目？",function(){var a=b.parents("li.m-lst-1");a.remove(),c.UpdateQScoreAndNum(),c.questionContentDragEnd(),d[0].close().remove()},function(){d[0].close().remove()})},updateSectionNo:function(b){var d=b.children("li");a.each(d,function(b,c){a(c).find("h3 span:first").text(y(b+1)+".")}),c.UpdateQScoreAndNum()},questionSearch:function(){if(a(this).hasClass("plus")){i.addClass("hide"),j.addClass("hide"),k.addClass("hide"),n.removeClass("hide");var b=a("#searchKps");b.find("a:not(:first)").remove();var c=e.get().data;a.each(c,function(a,c){var d='<a href="javascript:void(0);" data-kp="'+c.name+'">'+c.name+"</a>";b.append(d)}),a("#qtype").val(a(this).data("qtype")),a("#appendId").val(a(this).parents("li").prop("id")),a(".sq-type").text(a(this).prevAll("input.u-ipt-1").val()),a(".sq-num").text(a(this).parents("li").find("ul.paper-qContent li").length)}var d=a("#qtype").val(),f=a(".searchKey").eq(0).val(),g=a("#shareValue").val(),h=a("#sortValue").val(),l=a("#starValue").val(),m=[],o=a("#kp").val();if(a.trim(o))m.push(o);else{var p=a("#searchKps").find("a:not(:first)");a.each(p,function(b,c){m.push(a(c).data("kp"))})}var q=JSON.stringify(m);n.children("div#quList").load("/Paper/ChooseQuestion",{qtype:d,key:f,share:g,sortBy:h,kp:q,star:l},function(){})},checkboxClick:function(b){b.stopPropagation(),a(this).parent("span").toggleClass("bg-glyp");var c=window.selectedData,d=a(this).val(),e=parseInt(a(".sq-num").eq(0).text());if(isNaN(e)&&(e=0),this.checked){a(".sq-num").text(e+1),c||(c={});var f=[],g=a("ul.paper-qContent").children("li");if(a.each(g,function(b,c){f.push(a(c).data("qid"))}),a.inArray(d,f)>-1)return a.Dayez.msg("已经添加到试卷了！"),!1;c[d]=a(this).parent("span").siblings("div.paper-qContent").children("div").first().html(),window.selectedData=c}else{var h=e-1;if(0>h&&(h=0),a(".sq-num").text(h),c){var i={};a.each(c,function(b,c){a.trim(b)!=a.trim(d)&&(i[b]=c)}),window.selectedData=i}}},UpdatePerScore:function(){var b=parseFloat(a(this).val());isNaN(b)&&(b=""),a(this).parents("li").find("input.qScore").val(b),c.UpdateQScoreAndNum()},UpdateQScoreAndNum:function(){var b=l.find("ul.paper-qSection"),c=0,d=a("#tScoreA"),e=a("#tScoreB"),f=a("#tScore");a.each(b,function(f,g){var h=a(g).children("li"),i=0;a.each(h,function(b,c){var d=a(c).find("ul.paper-qContent li");a(c).find("span.qCNum").text(d.length);var e=0,f=a(c).find("input.qScore");a.each(f,function(b,c){var d=parseFloat(a(c).val());isNaN(d)||(e=a.Operation.Add(e,d))}),a(c).find("span.qCScore").text(e),i=a.Operation.Add(i,e)}),b.length>1&&0==f?d.text(i):b.length>1&&1==f&&e.text(i),c=a.Operation.Add(c,i)}),f.text(c)},questionSelectSure:function(){var b=a("#appendId").val(),d=parseFloat(a("#"+b).find("input.q-perscore").val());isNaN(d)&&(d="");var e=a("#qContentTemp").html(),f=a("#qScoreElementTemp").html(),g=window.selectedData;a.each(g,function(c,g){var h=g,i=c,j="";j=f.replaceAll("{qNo}","").replaceAll("{qScore}",d);var k=e.replaceAll("{qId}",i).replaceAll("{qNo}","1.").replaceAll("{qContent}",h).replaceAll("{qScoreElement}",j);a("#"+b).children("ul.paper-qContent").append(k)}),n.addClass("hide"),k.removeClass("hide"),j.removeClass("hide"),c.UpdateQScoreAndNum(),c.questionContentDragEnd(),window.selectedData={},u()},questionSelectCancel:function(){n.addClass("hide"),k.removeClass("hide"),j.removeClass("hide"),window.selectedData={},u()},getPaperData:function(){var b={};b.PaperTitle=a("#paperTitle").val(),b.Kps=e.get().data,b.Tags=d.get(),b.PaperType="A",b.PScores={},b.PScores.TScore=parseFloat(a("#tScore").text()),b.PScores.TScoreA=0,b.PScores.TScoreB=0,a("#tScoreA").length>0&&(b.PaperType="AB",b.PScores.TScoreA=parseFloat(a("#tScoreA").text()),b.PScores.TScoreB=parseFloat(a("#tScoreB").text())),b.PSection=[];var c=l.children("ul.paper-qSection");return a.each(c,function(c,d){var e="A";c>0&&(e="B");var f=a(d).children("li");a.each(f,function(c,d){var f={};f.Sort=c+1,f.Description=a(d).find("h3 input.u-ipt-1").val(),f.PaperSectionType=e,f.SectionQuType=parseInt(a(d).find("h3 span.plus").data("qtype")),f.SectionScore=0,f.Questions=[];var g=a(d).find("ul.paper-qContent").children("li");a.each(g,function(b,c){var d={};d.Sort=b+1,d.QuestionID=a(c).data("qid"),d.Score=0,d.SmallQuestionScore=[];var e=a(c).find("input.qScore"),g=a(c).find("div.smallquestion").children("div.q-detail");if(1==e.length||g.length<1){var h=parseFloat(a(e).val());isNaN(h)&&(h=0),d.Score=h}else a.each(e,function(b,c){var e={};e.QuestionID=a(c).parent("span").data("qid");var f=parseFloat(a(c).val());isNaN(f)&&(f=0),e.Score=f,d.SmallQuestionScore.push(e),d.Score=a.Operation.Add(d.Score,f)});f.Questions.push(d)}),a.each(f.Questions,function(b,c){f.SectionScore=a.Operation.Add(f.SectionScore,c.Score)}),b.PSection.push(f)})}),b},paperPreview:function(){var b=c.getPaperData();a("#paperData").val(JSON.stringify(b)),a("#showPreview").submit()},paperDataSave:function(){if(!v()||!w())return!1;var b=c.getPaperData(),d=a("#savePaper").html().replaceAll("{name}",b.PaperTitle);return a.Dayez.dialog("保存试卷",d,function(){var c=a("#paperName").val();if(!c)return a("#paperName").focus(),!1;b.PaperTitle=c;var d=a("#grade").children("option:selected").val();if(parseInt(d)<0)return a("#grade").focus(),!1;b.Grade=d;var e=JSON.stringify(b);a.post("/Paper/SavePaperData",{paperData:e},function(b){b.Status?(a(window).unbind("beforeunload"),window.location="/Paper/Index"):x(b.Message)})},function(){}),!1},paperEditSave:function(){if(!v()||!w())return!1;var b=c.getPaperData(),d=a("#paperId").val(),e="/Paper/EditSaveOther",f=a(this).data("type");"save"==a.trim(f)&&(e="/Paper/EditSave");var g=a("#savePaper").html().replaceAll("{name}",b.PaperTitle);return a.Dayez.dialog("保存试卷",g,function(){var c=a("#paperName").val();if(!c)return a("#paperName").focus(),!1;b.PaperTitle=c;var f=a("#grade").children("option:selected").val();if(parseInt(f)<0)return a("#grade").focus(),!1;b.Grade=f;var g=JSON.stringify(b);a.post(e,{paperId:d,paperData:g},function(b){b.Status?(a(window).unbind("beforeunload"),window.location="/Paper/Index"):x(b.Message)})},function(){}),!1},shareRangeChange:function(){a(this).addClass("z-sel").siblings().removeClass("z-sel");var b=a(this).data("value");return a("#shareValue").val(b),c.questionSearch(),!1},searchQuSortClick:function(){a(this).addClass("z-sel").siblings().removeClass("z-sel");var b=a(this).data("sort");return a("#sortValue").val(b),c.questionSearch(),!1},noStarClick:function(){return a(this).hasClass("f-fc")||a(this).addClass("f-fc"),a("#starValue").val(0),a(".q-star").raty("setScore",a("#starValue").val()),c.questionSearch(),!1},kpClick:function(){return a(this).addClass("z-sel").siblings().removeClass("z-sel"),a("#kp").val(a(this).data("kp")),b.get().data.length>0&&b.set([]),c.questionSearch(),!1}};var u=function(){a("#shareValue").val(2),a("#sortValue").val(2),a("#starValue").val(0),a(".searchKey").val(""),a("#kp").val(""),a("#qtype").val(""),a("#appendId").val(""),r.children("a").eq(2).addClass("z-sel").siblings().removeClass("z-sel"),q.children("a").eq(2).addClass("z-sel").siblings().removeClass("z-sel"),a(".q-star").raty("setScore",a("#starValue").val()),b.set([])},v=function(){var b=e.get().data;if(!b||b.length<1)return x("请选择知识点！"),!1;if(a("#qTypes").length>0){var c=a("#qTypes").find("ul li.sel");if(c.length<1)return x("请选择所含题型！"),!1}else{var d=a("#qTypesA").find("ul li.sel"),f=a("#qTypesB").find("ul li.sel");if(d.length<1)return x("请选择 A卷 所含题型！"),!1;if(f.length<1)return x("请选择 B卷 所含题型！"),!1}return!0},w=function(){for(var b=a("ul.paper-qContent"),c=0;c<b.length;c++){var d=a(b[c]).children("li");if(d.length<1)return x("请确保所有的题型都有题目！"),!1}return!0},x=function(b){return a.Dayez.msg(b),!1},y=function(a){var b=["〇","一","二","三","四","五","六","七","八","九","十","十一","十二","十三","十四","十五","十六","十七","十八","十九","二十"],c=parseInt(a);return(isNaN(c)||c>20)&&(c=1),b[c]},z=function(a){a.find("ul.paper-qContent").dragsort({dragSelectorExclude:"input,textarea,div.f-posa,img.qImg,.s-del,.paper-del",dragEnd:c.questionContentDragEnd})},A=function(b){a("#f-pips-count").empty(),b&&a.each(b,function(a,b){B(b.name)})},B=function(b){var c=25,d='<li><span class="f-knleg"><em>{kpName}</em><i class="f-close">x</i></span><div class="f-fr pips-coun" data-value="'+c+'"></div></li>';d=d.replaceAll("{kpName}",b);var e=a(d);e.find(".pips-coun").noUiSlider({range:{min:1,max:50},start:c,step:1}),e.find(".pips-coun").on({slide:function(){a(this).attr("data-value",a(this).val())}}),a("#f-pips-count").append(e)}}(jQuery);