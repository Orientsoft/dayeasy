!function(e){e.fn.AutoPaperMaker=function(a){var t=new r(this,a);return t.create(),e(this)};var a,t=singer.points({container:e("#points").find(".kpPoint"),data:"",max:15,isAppendData:!1,init:function(){return{stage:e("#stage").val(),subject_id:e("#subjectId").val()}},change:function(a){if(a){var t=e("#highSet").text();"高级配置"==e.trim(t)?(e("#normalKps").removeClass("hide"),e("#setKps").addClass("hide")):(e("#normalKps").addClass("hide"),e("#setKps").removeClass("hide")),a.length<1?e("#setKps").addClass("hide"):e("#leader").removeClass("hide"),e("#selKps").empty();var n='<li data-value="{kpValue}"><span class="f-knleg"><em>{kpName}</em><i class="f-close">x</i></span></li>';e.each(a,function(a,t){var i=n.replaceAll("{kpName}",t.name).replaceAll("{kpValue}",t.id);e("#selKps").append(i)}),e("#f-pips-count").length>0&&d(a)}}}),n=e("#buildPaper"),i=e("#rebuildPaper"),s=e("#paperNav"),l=e("#paperDetailDiv"),p=e("#f-pips-count"),r=function(a,t){this.$element=e(a),this.defaults={autoGetQuestionUrl:""},this.options=e.extend({},this.defaults,t)};r.prototype={create:function(){a=this,e("#selKps,#f-pips-count").delegate("i.f-close","click",function(){var a=t.get().data,n=e(this).parents("li"),i=n.index();e("#selKps").children("li").eq(i).remove();var s=e("#f-pips-count");s.length>0&&s.children("li").eq(i).remove();var l=[];e.each(a,function(e,a){e!=i&&l.push(a)}),l.length<1&&e("#setKps").addClass("hide"),t.set(l)}),n.bind("click",this.buildPaperClick),i.bind("click",this.buildPaperClick),s.find("ul li").bind("click",this.navStepClick),e("#qTypes,#qTypesA,#qTypesB").find("ul li span").bind("click",this.questionTypeChoose)},navStepClick:function(){var a=e(this).index();return 0!=a?!1:(e(this).children("a").hasClass("crt")||e.Dayez.confirm("您确定要重置出卷条件吗？重置后当前数据将丢失。",function(){window.location=window.location.href},function(){}),!1)},buildPaperClick:function(){var t=e("#autoData").val();if(!t&&!u())return!1;l.empty(),t||(t=JSON.stringify(a.getAutoPaperData()));var n=e("<form></form>");n.attr("action",a.options.autoGetQuestionUrl),n.attr("method","post"),n.attr("target","_self");var i=e('<input type="hidden" name="autoData" />');return i.attr("value",t),n.append(i),n.appendTo("body"),n.submit(),!1},getAutoPaperData:function(){var a=[],t=p.find("li");e.each(t,function(t,n){var i={};i.Name=e(n).data("value"),i.Count=parseInt(e(n).children("div").attr("data-value")),a.push(i)});var n=[];if(e("#qTypes").length>0){var i=e("#qTypes").find("ul li.sel");e.each(i,function(a,t){var i={};i.Type=e(t).data("value"),i.Name=e(t).children("span").text();var s=parseInt(e(t).children(".qtype-num").val());i.Count=isNaN(s)?0:s,i.PaperSectionType="A",n.push(i)})}else{var s=e("#qTypesA").find("ul li.sel");e.each(s,function(a,t){var i={};i.Type=e(t).data("value"),i.Name=e(t).children("span").text();var s=parseInt(e(t).find(".qtype-num").val());i.Count=isNaN(s)?0:s,i.PaperSectionType="A",n.push(i)});var l=e("#qTypesB").find("ul li.sel");e.each(l,function(a,t){var i={};i.Type=e(t).data("value"),i.Name=e(t).children("span").text();var s=parseInt(e(t).find(".qtype-num").val());i.Count=isNaN(s)?0:s,i.PaperSectionType="B",n.push(i)})}var r=e("#paperLevel").children("li.sel").data("value");return{Kps:a,Qtypes:n,Diffic:r}},questionTypeChoose:function(){var a=e(this).parent("li");a.toggleClass("sel"),a.hasClass("sel")?a.find(".qtype-num").focus():a.find(".qtype-num").val("");var t=a.parents("ul"),n=t.find(".qtype-num"),i=0;e.each(n,function(a,t){var n=parseInt(e(t).val());isNaN(n)&&(n=0),i+=n}),t.parent("div").prev("h3").find("em span").text(i)}};var u=function(){var a=t.get().data;if(!a||a.length<1)return e.Dayez.msg("请选择知识点！"),!1;if(e("#qTypes").length>0){var n=e("#qTypes").find("ul li.sel");if(n.length<1)return e.Dayez.msg("请选择所含题型！"),!1}else{var i=e("#qTypesA").find("ul li.sel"),s=e("#qTypesB").find("ul li.sel");if(i.length<1)return e.Dayez.msg("请选择 A卷 所含题型！"),!1;if(s.length<1)return e.Dayez.msg("请选择 B卷 所含题型！"),!1}var l=0,p=e("#paperInfoDiv").find("span.q-totalnum");return e.each(p,function(a,t){var n=parseInt(e(t).text());isNaN(n)&&(n=0),l+=n}),l>100||1>l?(e.Dayez.msg("试卷题目总数介于1到100之间！"),!1):!0},d=function(a){e("#f-pips-count").empty(),a&&e.each(a,function(e,a){o(a.name,a.id)})},o=function(a,t){var n=25,i='<li data-value="{kpValue}"><span class="f-knleg"><em>{kpName}</em><i class="f-close">x</i></span><div class="f-fr pips-coun" data-value="'+n+'"></div></li>';i=i.replaceAll("{kpName}",a).replaceAll("{kpValue}",t);var s=e(i);s.find(".pips-coun").noUiSlider({range:{min:1,max:50},start:n,step:1}),s.find(".pips-coun").on({slide:function(){e(this).attr("data-value",e(this).val())}}),e("#f-pips-count").append(s)}}(jQuery),$(function(){var e=function(e){a(e);var t=0,n=$("#paperInfoDiv").find("span.q-totalnum");$.each(n,function(e,a){var n=parseInt($(a).text());isNaN(n)&&(n=0),t+=n}),(t>100||0>t)&&($.Dayez.msg("试卷题目总数介于1到100之间！"),$(e).val("").focus(),a(e))},a=function(e){var a=$(e).parents("ul"),t=a.find(".qtype-num"),n=0;$.each(t,function(e,a){var t=parseInt($(a).val());isNaN(t)&&(t=0),n+=t}),a.parent("div").prev("h3").find("em span").text(n)};$("#highSet").click(function(){var e=$(this).text();"高级配置"==$.trim(e)?(e="收起配置",$("#normalKps").addClass("hide"),$("#setKps").removeClass("hide")):(e="高级配置",$("#normalKps").removeClass("hide"),$("#setKps").addClass("hide")),$(this).text(e),$("#f-pips-count").children("li").length<1?($("#setKps").addClass("hide"),$("#leader").addClass("hide")):$("#leader").removeClass("hide")}),$("#paperLevel li").click(function(){$(this).addClass("sel").siblings().removeClass("sel")}),$(document).delegate(".qtype-num","keyup",function(){var a=$(this);a.val(/(\d{1,2})/.test(a.val())?RegExp.$1:""),e(this)}).delegate(".qtype-num","change",function(){var a=$(this);a.val(/(\d{1,2})/.test(a.val())?RegExp.$1:""),e(this)})});