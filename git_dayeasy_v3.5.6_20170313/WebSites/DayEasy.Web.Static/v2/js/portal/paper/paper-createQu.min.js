$(function(){var e=$("#kPoints").tokenInput($("#getKpUrl").val(),{method:"POST",queryParam:"kp",hintText:"",noResultsText:"没有找到相关知识点",searchingText:"Searching...",placeholder:"输入知识点关键字",tokenLimit:5,excludeCurrent:!1,preventDuplicates:!0}),t=UE.getEditor("qContent",{toolbars:[["source","|","Undo","Redo","|","bold","italic","underline","|","insertimage","inserttable","deletetable","superscript","subscript","|","kityformula","spechars"]],serverUrl:$("#fileSite").val()+"/uploader",initialContent:"",autoClearinitialContent:!0,wordCount:!1,elementPathEnabled:!1,enableAutoSave:!1,enableContextMenu:!0,saveInterval:5e6,retainOnlyLabelPasted:!0,pasteplain:!1,initialFrameHeight:200});$(".f-success").click(function(){var a=$("#selectedQtype").val(),i=e.tokenInput("get"),n=$("<div/>").text(t.getContent()).html(),r=$("#optionNum").children("option:selected").val(),s=parseInt($("#smallQuNum").val());if(!a)return $.Dayez.msg("请先选择题型！"),!1;if(!t.hasContents())return $.Dayez.msg("请输入题目内容！"),!1;var l=["4","18"];if(isNaN(s)&&(s=0),$.inArray(a,l)>-1&&1>s)return $.Dayez.msg("请输入小问数！"),!1;if(!i||i.length<1)return $.Dayez.msg("请输入知识点！"),!1;var o=$(this).data("atype");$.post($("#saveQuUrl").val(),{qtype:a,kps:JSON.stringify(i),qContent:n,optionNum:r,smallQuNum:s},function(e){if(e.Status){var t=GetPaperInfo();if(t){var i={};i.QId=e.Data,i.Type=a,i.Score=0,i.Sort=0,i.PaperType=o;var n=[],r=[];if(t.ChooseQus){r=t.ChooseQus;var s=r[a];s&&(i.Sort=s.length+1,n=s)}n.push(i),r[a]=n,t.ChooseQus=r}var l=$("<form></form>");l.attr("action",window.location.href+"#actionDiv_"+o),l.attr("method","post"),l.attr("target","_self");var d=$('<input type="hidden" name="paperBase" />');d.attr("value",JSON.stringify(t)),l.append(d),l.appendTo("body"),l.submit()}else $.Dayez.msg(e.Message)})}),$(".f-qtype").click(function(){var e=$(this).data("qtype");$(this).addClass("z-sel").siblings().removeClass("z-sel"),$("#f-getmore").removeClass("z-sel").attr("data-qtype","").children("span").text("更多"),$("#f-getmore").parents("div.col-sm-12").css("z-index","100"),showOptionAndSmallQu(e)}),$("#f-getmore").click(function(){return $(this).next("div.f-more-p").hasClass("hide")?($(this).parents("div.col-sm-12").css("z-index","2001"),$(this).next("div.f-more-p").removeClass("hide")):($(this).parents("div.col-sm-12").css("z-index","100"),$(this).next("div.f-more-p").addClass("hide")),!1}),$("div.f-more-p ul li").click(function(){var e=$(this).children("a").text(),t=$(this).children("a").data("qtype");$(".f-qtype").removeClass("z-sel"),$("#f-getmore").addClass("z-sel").attr("data-qtype",t).children("span").text(e),showOptionAndSmallQu(t)}),$(document).bind("click",function(){$("#f-getmore").parents("div.col-sm-12").css("z-index","100"),$("#f-getmore").next("div.f-more-p").addClass("hide")})});var GetPaperInfo=function(){for(var e=[],t=$("ul.paper-qContent"),a=0;a<t.length;a++){var i=$(t[a]).data("qtype"),n=$(t[a]).data("section"),r=[];e[i]&&(r=e[i]);var s=$(t[a]).children("li");$.each(s,function(e,t){var a={};a.QId=$(t).data("qid"),a.Type=i;var s=parseFloat($(t).find("input.qScore").val());isNaN(s)&&(s=0),a.Score=s,a.Sort=e,a.PaperType=n,r.push(a)}),e[i]=r}var l=[],o=$(".paper-qSection").children("li");o&&$.each(o,function(e,t){var a=$(t).children("ul.paper-qContent");if(a){var i=$(t).find(".q-perscore").val();(!i||isNaN(i))&&(i=0);var n={};n.QSectionType=$(a).data("qtype"),n.PaperType=$(a).data("section"),n.PerScore=i,l.push(n)}});var d={};return d.Type=$("#type").val(),d.AddType=$(this).data("atype"),d.Title=$("#paperTitle").val(),d.ChooseQus="",d.PerScores="",d.AutoData=$("#autoData").val(),e.length>0&&(d.ChooseQus=e),l.length>0&&(d.PerScores=JSON.stringify(l)),d},showOptionAndSmallQu=function(e){var t=[1,2,3,4,18,24],a=[4,18];$("#optionDiv").addClass("hide").find("select").val(4),$("#smallQuDiv").addClass("hide").find("input").val(""),$.inArray(e,t)>-1&&($("#optionDiv").removeClass("hide"),$.inArray(e,a)>-1&&$("#smallQuDiv").removeClass("hide")),$("#selectedQtype").val(e)},checkNum=function(e){e.value=e.value.replace(/\D/g,""),e.value.length>2&&(e.value=e.value.substring(0,2))};