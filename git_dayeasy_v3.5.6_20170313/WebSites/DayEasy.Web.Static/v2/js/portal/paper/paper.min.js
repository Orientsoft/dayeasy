!function(e){e.fn.PaperMaker=function(t){var a=new s(this,t);return a.create(),e("body").append('<div id="ajaxModel" style="z-index: 10000;position: absolute;height: 100%;width: 100%;left: 0;top: 0;" class="hide"><div class="text-center"><span id="dyloading" style="position:fixed; z-index: 1000;top: 50%;left:50%;"><i class="fa fa-spin fa-spinner fa-3x" ></i><br /><br />正在加载，请稍后...</span></div></div>'),e.ajaxSetup({beforeSend:function(t){e("#ajaxModel").removeClass("hide")},complete:function(t,a){e("#ajaxModel").addClass("hide")}}),e(this)};var t,a=e("#paperDetailDiv"),n=e(".paper-qSection"),i=e("#btn_SaveTemp"),r=e("#btn_Save"),o=e(".f-addQuestion"),s=function(t,a){this.$element=e(t),this.defaults={addQuestionUrl:"",chooseQuestionUrl:"",chooseQuCompleteUrl:"",inputAnswerUrl:""},this.options=e.extend({},this.defaults,a)};s.prototype={create:function(){t=this,this.UpdateQScoreAndNum(),u(n),e(document).delegate(".q-perscore,.qScore","keyup",function(){var t=e(this);t.val(/(\d{1,2}((\.\d)|\.)?)/.test(t.val())?RegExp.$1:"")}).delegate(".q-perscore,.qScore","change",function(){var t=e(this);t.val(/(\d{1,2}(\.\d)?)/.test(t.val())?RegExp.$1:"")}),e("#paperTitle").on("keyup",function(){var t=e(this).val().length;e(this).attr("size",t)}),n.dragsort({dragSelectorExclude:"input,textarea,i",dragEnd:this.questionSectionDragEnd}),a.delegate("i.s-del","click",this.sectionDel),a.delegate("i.paper-del","click",this.questionDel),a.delegate("input.q-perscore","blur",this.UpdatePerScore),a.delegate("input.qScore","blur",this.UpdateQScoreAndNum),i.bind("click",this.paperSaveTemp),r.bind("click",this.makePaper),o.bind("click",this.addQuestion),e("#inputAnswerDiv").delegate("#btnSureAnswer","click",this.paperSave),e(".f-createQu").bind("click",this.showAddQuestion)},questionSectionDragEnd:function(){t.updateSectionNo(e(this).parent("ul")),t.questionContentDragEnd()},questionContentDragEnd:function(){var t=e("ul.paper-qContent").children("li");e.each(t,function(t,a){e(a).find("div.sortNum").text(t+1+".")})},sectionDel:function(){var a=e(this);e.Dayez.confirm("您确定要删除该题型及其下面的题目？",function(){var n=a.parent("h3").parent("li"),i=n.parent("ul.paper-qSection"),r=n.attr("id"),o=e.trim(r).split("_")[1];r.indexOf("A")>0?e("#qTypesA,#qTypes").find("ul li.sel[data-value='"+o+"']").removeClass("sel"):e("#qTypesB").find("ul li.sel[data-value='"+o+"']").removeClass("sel"),n.remove(),t.updateSectionNo(i),t.questionContentDragEnd()},function(){})},questionDel:function(){var a=e(this),n=e.Dayez.confirm("您确定要删除该题目？",function(){var e=a.parents("li.m-lst-1"),i=e.parent("ul");if(1==i.children("li").length){var r=i.parent("li").parent("ul.paper-qSection");i.parent("li").remove(),t.updateSectionNo(r)}else e.remove();t.UpdateQScoreAndNum(),t.questionContentDragEnd(),n[0].close().remove()},function(){n[0].close().remove()})},updateSectionNo:function(a){var n=a.children("li");e.each(n,function(t,a){e(a).find("h3 span:first").text(p(t+1)+".")}),t.UpdateQScoreAndNum()},UpdatePerScore:function(){var a=parseFloat(e(this).val());return isNaN(a)?!1:(e(this).parents("li").find("input.qScore").val(a),void t.UpdateQScoreAndNum())},UpdateQScoreAndNum:function(){var t=a.find("ul.paper-qSection"),n=0,i=e("#tScoreA"),r=e("#tScoreB"),o=e("#tScore");e.each(t,function(a,o){var s=e(o).children("li"),d=0;e.each(s,function(t,a){var n=e(a).find("ul.paper-qContent li");e(a).find("span.qCNum").text(n.length);var i=0,r=e(a).find("input.qScore");e.each(r,function(t,a){var n=parseFloat(e(a).val());isNaN(n)||(i=e.Operation.Add(i,n))}),e(a).find("span.qCScore").text(i),d=e.Operation.Add(d,i)}),t.length>1&&0==a?i.text(d):t.length>1&&1==a&&r.text(d),n=e.Operation.Add(n,d)}),o.text(n)},getPaperData:function(t){var n={};n.PaperTitle=e("#paperTitle").val(),n.PaperType="A",n.PScores={},n.PScores.TScore=parseFloat(e("#tScore").text()),n.PScores.TScoreA=0,n.PScores.TScoreB=0,e("#tScoreA").length>0&&(n.PaperType="AB",n.PScores.TScoreA=parseFloat(e("#tScoreA").text()),n.PScores.TScoreB=parseFloat(e("#tScoreB").text()));var i=[1,2,3,4,18,24];n.PSection=[];var r=a.children("ul.paper-qSection");return e.each(r,function(a,r){var o="A";a>0&&(o="B");var s=e(r).children("li");e.each(s,function(a,r){var s=parseInt(e(r).children("ul.paper-qContent").data("qtype"));if(t&&e.inArray(s,i)<0)return!0;var d={};d.Sort=a+1,d.Description=e(r).find("h3 input.u-ipt-1").val(),d.PaperSectionType=o,d.SectionQuType=s,d.SectionScore=0,d.Questions=[];var c=e(r).find("ul.paper-qContent").children("li");e.each(c,function(t,a){var n={};n.Sort=t+1,n.QuestionID=e(a).data("qid"),n.Score=0,n.SmallQuestionScore=[];var i=e(a).find("input.qScore"),r=e(a).find("div.smallquestion").children("div.q-detail");if(1==i.length||r.length<1){var o=parseFloat(e(i).val());isNaN(o)&&(o=0),n.Score=o}else e.each(i,function(t,a){var i={};i.QuestionID=e(a).parent("span").data("qid");var r=parseFloat(e(a).val());isNaN(r)&&(r=0),i.Score=r,n.SmallQuestionScore.push(i),n.Score=e.Operation.Add(n.Score,r)});d.Questions.push(n)}),e.each(d.Questions,function(t,a){d.SectionScore=e.Operation.Add(d.SectionScore,a.Score)}),n.PSection.push(d)})}),n},paperSaveTemp:function(){return d()?(t.showSaveDiv(!0),!1):!1},makePaper:function(){return d()?(l()?t.inputAnswer():e.Dayez.confirm("还有题目没有录入分数 , 您确定要生成试卷吗？",function(){t.inputAnswer()},function(){}),!1):!1},paperSave:function(){return c()?(t.showSaveDiv(!1),!1):!1},showSaveDiv:function(a){var n="/Paper/SavePaperData",i=t.getPaperData(),r=e("#savePaper").html().replaceAll("{name}",i.PaperTitle),o=a?"保存草稿":"生成试卷";if(a){var s=e(r).find("#saveTip").html();r=r.replace(s,"")}var d,c=dialog({title:o,content:e(r),onshow:function(){d=singer.tags({container:e(".d-tags"),data:e(".d-tags").data("tags"),canEdit:!0,type:2,max:5,change:function(e){}})},okValue:"确定",ok:function(){i.Tags=d.get();var r=e("#paperName").val();if(!r)return e("#paperName").focus(),!1;i.PaperTitle=r;var o=e("#grade").children("option:selected").val();if(parseInt(o)<0)return e("#grade").focus(),!1;i.Grade=o;var s=JSON.stringify(i),l=e("#paperId").val(),p=e("#shareSchool").is(":checked"),u="";return a||(u=JSON.stringify(t.getPaperAnswer())),e(".ui-dialog-button").children("button").attr("disabled","disabled"),e.post(n,{isTemp:a,paperId:l,paperData:s,shareSchool:p,answers:u},function(t){t.Status?(c.close().remove(),window.location="/Paper/Index"):(e(".ui-dialog-button").children("button").removeAttr("disabled"),e.Dayez.msg(t.Message))}),!1},cancelValue:"取消",cancel:function(){},backdropBackground:"#000",backdropOpacity:.3}).showModal()},showAddQuestion:function(){var a=e(this).parent("div").next("div.fa-createQuDiv");e(this).children("i").hasClass("fa-plus")?(e("div.fa-createQuDiv").hide(),e("div.fa-createQuDiv").children("div").empty(),e("div.fa-createQuDiv").children("span").removeClass("hide"),e(".f-createQu").children("i").addClass("fa-plus").removeClass("fa-times"),e(this).children("i").addClass("fa-times").removeClass("fa-plus"),e.ajax({url:t.options.addQuestionUrl,data:{},type:"POST",beforeSend:function(){},success:function(e){a.show().children("div").empty().append(e),a.children("span").addClass("hide")}})):(e(this).children("i").removeClass("fa-times").addClass("fa-plus"),e("div.fa-createQuDiv").children("div").empty(),a.hide())},addQuestion:function(){for(var a=[],n=e("ul.paper-qContent"),i=0;i<n.length;i++){var r=e(n[i]).data("qtype"),o=e(n[i]).data("section"),s=[];a[r]&&(s=a[r]);var d=e(n[i]).children("li");e.each(d,function(t,a){var n={};n.QId=e(a).data("qid"),n.Type=r;var i=parseFloat(e(a).find("input.qScore").val());isNaN(i)&&(i=0),n.Score=i,n.Sort=t,n.PaperType=o,s.push(n)}),a[r]=s}var c=[],l=e(".paper-qSection").children("li");l&&e.each(l,function(t,a){var n=e(a).children("ul.paper-qContent");if(n){var i=e(a).find(".q-perscore").val();(!i||isNaN(i))&&(i=0);var r={};r.QSectionType=e(n).data("qtype"),r.PaperType=e(n).data("section"),r.PerScore=i,r.Sort=t,c.push(r)}});var p={};p.Type=e("#type").val(),p.AddType=e(this).data("atype"),p.Title=e("#paperTitle").val(),p.ChooseQus="",p.PerScores="",p.CompleteUrl=t.options.chooseQuCompleteUrl,p.AutoData=e("#autoData").val(),a.length>0&&(p.ChooseQus=a),c.length>0&&(p.PerScores=JSON.stringify(c));var u=e("<form></form>");u.attr("action",t.options.chooseQuestionUrl),u.attr("method","post"),u.attr("target","_self");var v=e('<input type="hidden" name="paperBase" />');v.attr("value",JSON.stringify(p)),u.append(v),u.appendTo("body"),u.submit()},inputAnswer:function(){e(".f-createQu").children("i").removeClass("fa-times").addClass("fa-plus"),e("div.fa-createQuDiv").children("div").empty(),e("div.fa-createQuDiv").hide(),e("#chooseQuDiv").addClass("hide"),e("#paperNav").addClass("hide");var a=t.getPaperData();e("#inputAnswerDiv").empty().load(t.options.inputAnswerUrl,{paperData:JSON.stringify(a)})},getPaperAnswer:function(){var t=[],a=e(".g-wrap input[type=text]:visible:not(:disabled)");a&&a.length>0&&e.each(a,function(a,n){var i={};i.DetailId=e(n).data("detailid"),i.QId=e(n).data("qid"),i.Answer=e(n).val(),t.push(i)});var n=e(".g-wrap .answerEditDiv");return n&&n.length>0&&e.each(n,function(a,n){var i={};i.QId=e(n).data("qid"),i.Answer=e("<div/>").text(e("#content_"+i.QId).html()).html(),t.push(i)}),t}};var d=function(){var t=e("ul.paper-qContent");if(t.length<1)return e.Dayez.msg("请先添加题目！"),!1;for(var a=0;a<t.length;a++){var n=e(t[a]).children("li");if(n.length<1)return e.Dayez.msg("请确保所有的题型都有题目！"),!1}return!0},c=function(){var t=!0,a=e(".g-wrap input[type=text]:visible:not(:disabled)");return a&&a.length>0&&e.each(a,function(a,n){var i=e(n).val();return e.trim(i)?void 0:(t=!1,!1)}),t?!0:(e.Dayez.msg("请先录入所有客观题的答案！"),!1)},l=function(){var t=!0,a=e(document).find(".qScore");return a&&e.each(a,function(a,n){var i=parseFloat(e(n).val());return isNaN(i)||1>i?(t=!1,!1):void 0}),t},p=function(e){var t=["〇","一","二","三","四","五","六","七","八","九","十","十一","十二","十三","十四","十五","十六","十七","十八","十九","二十"],a=parseInt(e);return(isNaN(a)||a>20)&&(a=1),t[a]},u=function(e){e.find("ul.paper-qContent").dragsort({dragSelectorExclude:"input,textarea,div.f-posa,img.qImg,.s-del,.paper-del",dragEnd:t.questionContentDragEnd})}}(jQuery);