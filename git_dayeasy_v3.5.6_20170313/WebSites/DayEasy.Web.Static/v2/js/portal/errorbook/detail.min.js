var ebDetail=function(){var a={};return a}();$(function(a){function t(e,i,n,s){for(var d=0;d<n.length;d++){var r=n[d],o=r.head;!singer.isUndefined(o)&&o&&o.length||(o=deyi.sites["static"]+"/image/default/user_s50x50.jpg");var l=r.id;s&&s.length&&(l=s);var c="";if(r.details&&r.details.length){var p=a('<div class="comments-detail" data-id="1" data-pid="'+l+'">');t(p,i,r.details,r.id),r.details.length<r.detail_count&&p.append('<div class="d-more">更多 &raquo;</div>'),c=p.prop("outerHTML")}e.append(i.replace("{head_pic}",o).replace("{content}",r.content).replace("{time}",r.time).replace("{details}",c).replace("last-child",d!=n.length-1?"":"last-child").replace("{user_name}",r.parent_name&&r.parent_name.length?r.user_name+" <span style='color:#999999;'>回复</span> "+r.parent_name:r.user_name).replace("{call}",r.user_id!=ebDetail.user_id?'<a class="a-call" data-id="'+l+'" data-uid="'+r.user_id+'" data-uname="'+r.user_name+'" href="#" title="回复TA"><i class="fa fa-pencil-square-o"></i></a>':""))}}function e(e,i){var n=e.find(".txt-comment-id").val().trim(),s=1;i||(s=parseInt(e.data("idx")||1)),a.post("/reason/comments",{id:n,index:s},function(a){e.find(".f-more").html("更多 &raquo;");var n=e.find(".other-comments");a.status?a.data&&a.data.length?(i&&n.html(""),e.data("idx",s+1),t(n,d,a.data),e.parent().find(".a-comment-power").text("评论("+a.count+")"),a.count<10*s?e.find(".f-more").hide():e.find(".f-more").show()):i&&n.html("暂无评论"):i&&n.html(a.message)})}function i(t){var i=t.find(".txt-comment-id").val().trim(),n=t.find(".txt-comment-content"),s=n.val().trim(),d=n.data("uid"),r=n.data("uname");return""==i?void singer.msg("参数错误，请刷新重试"):""==s?void singer.msg("请填写评论内容"):void a.post("/reason/AddComment",{id:i,content:s,pid:"",uid:d,uname:r},function(i){i.status?(t.find(".txt-comment-content").val(""),a(".f-subs").text("140"),e(t,!0)):singer.msg(i.message)})}function n(t){a.post("/reason/Shares",{questionId:ebDetail.question_id,classId:ebDetail.class_id,all:t},function(t){var e=a(".tab-con-2").find(".students-answer");if(t.status)if(t.data&&t.data.length){var i=a('<dl class="answer-dl after">');i.append("<dt>同学答案：</dt>");for(var n=0;n<t.data.length;n++)i.append('<dd data-val="'+t.data[n].id+'">'+t.data[n].name+"</dd>");t.count>t.data.length&&i.append('<dd class="f-fr" data-val="more">更多…</dd>'),e.html("").append(i)}else e.html("暂无同学分享答案");else e.html("同学答案加载失败")})}function s(t,e,i,n){a("#container-survey-class").highcharts(Highcharts.merge(r,{yAxis:{min:0,max:100,labels:{enabled:!1},title:{text:'<span style="color:#fc9797;font-size:16px">班级 错</span><span style="color:#65cafc;font-size:16px">'+e+'</span><span style="color:#fc9797;font-size:16px">人</span>'}},credits:{enabled:!1},series:[{name:"班级错误率",data:[t],innerRadius:"80%",dataLabels:{format:'<div style="text-align:center;font-size:20px;color:#fc9797">{y}%</div>',y:-20}}]})),a("#container-survey-year").highcharts(Highcharts.merge(r,{yAxis:{min:0,max:100,labels:{enabled:!1},title:{text:'<span style="color:#fc9797;font-size:16px">年级 错</span><span style="color:#65cafc;font-size:16px">'+n+'</span><span style="color:#fc9797;font-size:16px">人</span>'}},credits:{enabled:!1},series:[{name:"年级错误率",data:[i],innerRadius:"80%",dataLabels:{format:'<div style="text-align:center;font-size:20px;color:#fc9797">{y}%</div>',y:-20}}]}))}ebDetail.error_id=a("#txtErrorId").val(),ebDetail.batch=a("#txtBatch").val(),ebDetail.paper_id=a("#txtPaperId").val(),ebDetail.question_id=a("#txtQuestionId").val(),ebDetail.class_id=a("#txtClassId").val(),ebDetail.user_id=a("#txtUserId").val(),ebDetail.is_objective="1"==a("#txtObjectiveQuestion").val(),ebDetail.is_ebook="1"==a("#txtIsEBook").val(),ebDetail.is_teacher="1"==a("#txtIsTeacher").val(),setTimeout(singer.loadFormula,120),ebDetail.is_teacher||reason.load(ebDetail.error_id,a(".my-reason"),!1,!1,{show_count:!1});var d=a("#commentTemplate").html();a(".comment-bottom").delegate(".d-more","click",function(){var t=a(this).parents(".comments-detail"),e=a(this).parents(".comment-bottom").find(".txt-comment-id").val().trim(),i=t.data("pid"),n=(t.data("idx")||1)+1;return""==e||""==i||2>n?void singer.msg("参数错误，请刷新重试"):(a(this).html('<i class="fa fa-spin fa-spinner fa-1x"></i>&nbsp;&nbsp;正在加载，请稍后...'),void a.post("/reason/commentDetails",{id:e,pid:i,index:n},function(a){if(t.find(".d-more").remove(),a.status){for(var e=0;e<a.data.length;e++){var s=a.data[e],r=s.head;!singer.isUndefined(r)&&r&&r.length||(r=deyi.sites["static"]+"/image/default/user_s50x50.jpg"),t.append(d.replace("{head_pic}",r).replace("{content}",s.content).replace("{time}",s.time).replace("{details}","").replace("last-child",e!=a.data.length-1?"":"last-child").replace("{user_name}",s.user_name+" <span style='color:#999999;'>回复</span> "+s.parent_name).replace("{call}",s.user_id!=ebDetail.user_id?'<a class="a-call" data-id="'+i+'" data-uid="'+s.user_id+'" data-uname="'+s.user_name+'" href="#" title="回复TA"><i class="fa fa-pencil-square-o"></i></a>':""))}10*n<a.count&&(t.data("idx",n),t.append('<div class="d-more">更多 &raquo;</div>'))}else singer.msg(a.message)}))}),a(".a-comment-power").bind("click",function(){var t=a(this).parents(".ed-comment-list").find(".comment-bottom");t.toggleClass("hide"),"0"==a(this).data("load")&&(a(this).data("load",1),e(t,!0))}),a(".f-more").bind("click",function(){a(this).html('<i class="fa fa-spin fa-spinner fa-1x"></i>&nbsp;&nbsp;正在加载，请稍后...'),e(a(this).parents(".comment-bottom"),!1)}),a(".btn-addcomment").bind("click",function(){i(a(this).parents(".comment-bottom"))}),a(".ed-comment").delegate(".a-call","click",function(){if("1"==a(this).data("open"))return a(this).data("open","0"),a(this).parent().find(".comment-cc").remove(),!1;a(this).data("open","1");var t=a('<div class="comment-cc text-right">'),i=a('<textarea class="txt-cc-content" cols="30" rows="2" maxlength="140" placeholder="回复 '+a(this).data("uname")+'"></textarea>');i.data("id",a(this).data("id")),i.data("uname",a(this).data("uname")),i.data("uid",a(this).data("uid")),t.append(i);var n=a('<button type="button" style="width: 60px; height: 22px; padding: 0;" class="btn btn-primary btn-addcomment">回复</button>');return n.bind("click",function(){var n=a(this).parents(".comment-bottom"),s=n.find(".txt-comment-id").val().trim(),d=i.val().trim(),r=i.data("id"),o=i.data("uid"),l=i.data("uname");return""==s||""==r||""==l?(singer.msg("参数错误，请刷新重试"),!1):""==d?(singer.msg("请输入回复内容"),!1):void a.post("/reason/AddComment",{id:s,content:d,pid:r,uid:o,uname:l},function(a){a.status?(t.remove(),t.parents(".list-time").data("open","0"),e(n,!0)):singer.msg(a.message)})}),t.append(n),a(this).parent().append(t),!1}),a(".txt-comment-content").bind("keyup",function(){var t=140-a(this).val().length;0>t&&(t=0),a(this).parent().find(".f-subs").text(t)}),a(".a-comment-delete").bind("click",function(){var t=a(this).data("id");singer.confirm("确定删除分析及评论吗？",function(){a.post("/reason/delete",{id:t},function(a){a.status?singer.msg("删除成功",2e3,function(){window.location.reload()}):singer.msg(a.message)})})}),a(".tab-menu li").bind("click",function(){a(this).addClass("z-crt").siblings().removeClass("z-crt"),a(".tab-contenr").find(".tab-con").eq(a(this).index()).addClass("show").siblings().removeClass("show"),1==a(this).index()&&(singer.isUndefined(a(".tab-con-2").data("load"))||"1"!=a(".tab-con-2").data("load"))&&(a(".tab-con-2").data("load","1"),ebDetail.is_teacher||a.post("/errorBook/answer",{batch:ebDetail.batch,paperId:ebDetail.paper_id,questionId:ebDetail.question_id,source_type:ebDetail.is_ebook?1:0},function(t){var e=a(".eb-my-answer");if(t.status&&t.is_print){var i=a('<div class="q-item">');i.attr("style","margin-bottom:10px;"),t.body&&t.body.length&&i.append('<div style="margin:5px 0;">'+t.body+"</div>"),t.img&&josn.img.length&&i.append('<div class="q-image"><img alt="我的答案" src="'+t.img+'" style="border:5px solid #f0f0f0;" /></div>');var n=a('<div style="margin:5px 0;">'),s="/work/marking-detail?batch="+ebDetail.batch+"&paperId="+ebDetail.paper_id+"&studentId="+ebDetail.user_id+(t.isb?"&type=b":"");n.append('<a target="_blank" href="'+s+'" style="color:#65cafc;">查看我的答卷</a>'),i.append(n),e.append(i)}else if(t.status&&t.data&&t.data.length)for(var d=0;d<t.data.length;d++){var r=t.data[d],n=a('<div class="q-item">');if(n.attr("style","margin-bottom:10px;"),r.body&&r.body.length&&n.append("<div>"+r.body+"</div>"),r.images&&r.images.length){var o=a("<div>");o.attr("style","margin:5px 0").addClass("q-image");for(var l=0;l<r.images.length;l++)o.append('<div title="查看大图"><img src="'+r.images[l]+'" /></div>');n.append(o)}r.body||r.images&&r.images.length||n.append('<div class="q-not-answer"><strong>未作答</strong></div>'),e.append(n)}else{var s="/work/marking-detail?batch="+ebDetail.batch+"&paperId="+ebDetail.paper_id+"&studentId="+ebDetail.user_id+(t.isb?"&type=b":"");e.append('<a target="_blank" href="'+s+'" style="color:#65cafc;">点击答卷详细</a>')}}),ebDetail.is_objective||ebDetail.is_ebook||(a(".students-answer").show(),n(!1)))}),a(".students-answer").delegate("dd","click",function(){var t=a(this).data("val");"more"==t?n(!0):a.post("/reason/Detail",{id:t},function(e){if(e.status){var i=a('<img class="answer-img" src="'+e.data.img+'" alt="同学答案"/>'),n=a('<div class="answer-thumb mt5"><i class="fa fa-thumbs-o-up"></i>膜拜(<span>'+e.data.count+"</span>)</div>");e.data.hadworship?n.attr("style","cursor:default;color:#ffa64c;"):(n.data("id",t),n.bind("click",function(){var t=a(this).data("id");a.post("/reason/Worship",{id:t},function(t){if(t.status){a(".answer-thumb").unbind("click");var e=parseInt(a(".answer-thumb").find("span").text())+1;a(".answer-thumb").find("span").text(e),a(".answer-thumb").attr("style","cursor:default;color:#ffa64c;"),e>1&&a(".answer-bottom").find("span").text("我,"+a(".answer-bottom").find("span").text())}else singer.msg(t.message)})}));var s=a('<div class="answer-share-box">');s.append(i).append(n),e.data.count>0&&s.append('<div class="answer-bottom mt5"><span>'+e.data.name+"</span> "+(e.data.count>5?" 等"+e.data.count+"人":"")+"进行了膜拜</div>");var d=e.data.studentname+" 的答案分享",r=singer.dialog({title:d,content:s,fixed:!0,backdropOpacity:.7});i.bind("load",function(){r.showModal()})}else singer.msg(e.message)})}),a(".span-variant-answer-p").bind("click",function(){a(".variant-answer").toggleClass("hide")});var r={chart:{type:"solidgauge"},title:null,pane:{background:{backgroundColor:Highcharts.theme&&Highcharts.theme.background2||"#ccc",innerRadius:"80%",outerRadius:"100%",shape:"arc"}},tooltip:{enabled:!1},yAxis:{stops:[[1,"#fc9797"]],lineWidth:0,minorTickInterval:null,tickPixelInterval:400,tickWidth:0,title:{y:110},labels:{y:0}},plotOptions:{solidgauge:{dataLabels:{y:5,borderWidth:0,useHTML:!0}}}};ebDetail.is_ebook?a.post("/reason/eBookRates",{chapterId:ebDetail.paper_id,classId:ebDetail.class_id,questionId:ebDetail.question_id},function(a){s(parseFloat(a.rate_c),a.count_c,parseFloat(a.rate_y),a.count_y)}):a.post("/reason/rates",{batch:ebDetail.batch,paperId:ebDetail.paper_id,questionId:ebDetail.question_id},function(a){s(parseFloat(a.rate_c),a.count_c,parseFloat(a.rate_y),a.count_y)})});