var errorBook=function(){var e={total:0,list:[],params:{index:1,size:10,subject:-1,type:-1,start:"",expire:"",key:"",source_type:0,has_reason:-1},load:function(){e.list=[],$(".loading").show(),$(".q-list").hide(),$(".v-empty").hide(),$.post("/errorBook/questions",e.params).success(function(a){$(".loading").hide(),a.status&&(e.total=a.count,e.pager(singer.page({current:e.params.index-1,size:e.params.size,total:a.count})),a.data&&a.data.length?(e.list=a.data,e.bind()):$(".v-empty").show())}).error(function(){})},bind:function(){$(".e-total").text(e.total);var a=$(".q-list");a.html("").show();for(var t=$("#ebookItem").html(),r=0;r<e.list.length;r++){var s=e.list[r],i="";i=0==e.params.source_type?'<a href="/work/student/pub-paper/'+s.batch+'" target="_blank">'+s.paper_title+"</a>":'<span class="text-muted">'+s.paper_title+"</span>";var n=t.replace("{paper_title}",i).replace("{subject_name}",s.subject_name).replace("{subject_name}",s.subject_name).replace("{time}",s.time).replace("{errorId}",s.id).replace("{errorId}",s.id).replace("{questionId}",s.question.question_id);if(s.reason&&s.reason.tags&&s.reason.tags.length){for(var o="",d=0;d<s.reason.tags.length;d++)o+='<div class="d-tag">'+s.reason.tags[d].name+"</div>";n=n.replace("{reasons}",o)}else n=n.replace("{reasons}","");var l=$(n),c=singer.render("q-template",s.question);l.find(".q-main").html("").append(c),r==e.list.length-1&&l.addClass("q-item-last"),0!=e.params.source_type?l.find(".span-dw").remove():e.dw.check(s.id)&&l.find(".span-dw").addClass("dw-active").html('<i class="fa fa-times"></i> 移除下载</span>'),a.append(l)}setTimeout(singer.loadFormula,120)},pager:function(e){if(e.data&&e.data.length){$(".d-pager").show();var a=$(".pagination");a.html(""),e.prev&&a.append('<li><a href="javascript:void(0);" data-num="'+(e.current-1)+'">上一页</a></li>');for(var t=0;t<e.data.length;t++){var r=e.data[t],s="<li"+(r.isActive?' class="active"':"")+'><a href="javascript:void(0);" data-num="'+(r.isActive?"0":r.page)+'">'+(r.page>0?r.page:"...")+"</a></li>";a.append(s)}e.next&&a.append('<li><a href="javascript:void(0);" data-num="'+(e.current+1)+'">下一页</a></li>')}else $(".d-pager").hide()},dw:{show:!1,data:{subjects:[],list:[]},refreshHtml:function(){if($(".dc-items").html(""),e.dw.data.list.length){var a=e.dw.data.list.length;$(".dw-icon").text(a),$(".dc-num").text(a);for(var t=0;t<e.dw.data.subjects.length;t++){var r=e.dw.data.subjects[t];$(".dc-items").append('<div class="dc-item"><span>'+r.name+"</span><span>"+r.count+"</span></div>")}$(".d-dowload").show()}else $(".d-dowload").hide()},refresh:function(a,t){for(var r=0;r<e.dw.data.list.length;r++)if(e.dw.data.list[r]==a){e.dw.data.list.splice(r,1);for(var s=0;s<e.dw.data.subjects.length;s++)e.dw.data.subjects[s].name==t&&(e.dw.data.subjects[s].count-=1,e.dw.data.subjects[s].count<1&&e.dw.data.subjects.splice(s,1));return!0}if(e.dw.data.list.length>49)return singer.msg("已经选择了很多错题啦，先下载一份吧~~"),!1;e.dw.data.list.push(a);for(var i=0;i<e.dw.data.subjects.length;i++)if(e.dw.data.subjects[i].name==t)return e.dw.data.subjects[i].count+=1,!0;return e.dw.data.subjects.push({name:t,count:1}),!0},reset:function(){e.dw.data={subjects:[],list:[]},$(".span-dw").removeClass("dw-active").html('<i class="fa fa-plus"></i> 加入下载</span>'),e.dw.refreshHtml()},download:function(){return e.dw.data.list.length<1?void singer.msg("请选择错题"):($("#txtDwData").val(encodeURIComponent(singer.json(e.dw.data.list))),$("#dwForm").submit(),void singer.dialog({title:"下载提示",content:"请问您下载成功了吗？<br/>确定下载成功将<span style='color:#ffab00'>清空</span>错题下载列表",fixed:!0,backdropOpacity:.7,okValue:"是的",cancelValue:"还没有",ok:function(){$("#txtDwData").val(""),e.dw.reset()},cancel:function(){}}).showModal())},check:function(a){if(!e.dw.data.list.length)return!1;for(var t=0;t<e.dw.data.list.length;t++)if(a==e.dw.data.list[t])return!0;return!1}}};return e}();$(function(e){function a(){var a=e("#txtSearchKey").val().trim();a!=errorBook.params.key&&(errorBook.params.key=a,errorBook.params.index=1,errorBook.load())}function t(){e("#txtSearchKey").removeAttr("style"),e(".search-keys").html("").hide()}function r(a){var r=e(".search-keys");if(a&&a.length){r.html("");for(var s=0;s<a.length;s++)r.append('<div class="item">'+a[s]+"</div>");e("#txtSearchKey").attr("style","border-bottom-left-radius: 0;"),r.show()}else t();i=!1}function s(){var a=e("#txtSearchKey").val().trim();if(!i)return""==a?(n="",o=1,void t()):void(a.indexOf(n)>-1&&0==o||(i=!0,e.post("/errorBook/searchKeys",{key:a,subjectId:errorBook.params.subject},function(e){e.status?(n=a,o=e.data.length,r(e.data)):t()})))}singer.loadTemplate("question-item",function(){errorBook.load()}),e.get("/errorBook/subjects").success(function(a){var t=e(".sn-subjects");if(t.html(""),a&&a.length){t.append('<div class="item" data-val="-1">不限</div>');for(var r=0;r<a.length;r++)t.append('<div class="item" data-val="'+a[r].id+'">'+a[r].name+"</div>")}}),e(".sn-source").delegate(".item","click",function(a){a.stopPropagation();var t=e(this),r=parseInt(t.data("val"));if(!singer.isUndefined(r)){if(r==errorBook.params.type)return t.parents(".sing").data("open",0).removeClass("active"),void t.parent().hide();t.parents(".sing").data("open",0).removeClass("active").find("span").text(t.text()),t.parent().hide(),"0"!=r?t.data("val","0").text("试卷错题"):t.data("val","1").text("课本错题"),errorBook.params.source_type=r,errorBook.params.index=1,errorBook.load()}}),e(".sn-subjects").delegate(".item","click",function(a){a.stopPropagation();var t=e(this),r=parseInt(t.data("val"));if(!singer.isUndefined(r)){if(r==errorBook.params.subject)return t.parents(".sing").data("open",0).removeClass("active"),void t.parent().hide();var s=t.text();"-1"==r&&(s="学科"),t.parents(".sing").data("open",0).removeClass("active").find("span").text(s),t.parent().hide(),errorBook.params.subject=r,errorBook.params.type=-1,errorBook.params.index=1,errorBook.load();var i=e(".sn-types");i.parents(".sing").find("span").text("题型"),i.html(""),r>-1?e.get("/errorBook/questionType?subjectId="+r).success(function(e){if(e&&e.length){i.append('<div class="item" data-val="-1">不限</div>');for(var a=0;a<e.length;a++)i.append('<div class="item" data-val="'+e[a].id+'">'+e[a].name+"</div>")}}):i.append('<div class="item" data-val="-1">请选择学科</div>')}}),e(".sn-types").delegate(".item","click",function(a){a.stopPropagation();var t=e(this),r=parseInt(t.data("val"));if(!singer.isUndefined(r)){if(r==errorBook.params.type)return t.parents(".sing").data("open",0).removeClass("active"),void t.parent().hide();var s=t.text();"-1"==r&&(s="题型"),t.parents(".sing").data("open",0).removeClass("active").find("span").text(s),t.parent().hide(),errorBook.params.type=r,errorBook.params.index=1,errorBook.load()}}),e(".sn-times").bind("click",function(e){e.stopPropagation()}),e(".st-cancel").bind("click",function(){e(this).parents(".sing").data("open",0).removeClass("active"),e(".sn-times").hide()}),e(".st-ok").bind("click",function(){e(this).parents(".sing").data("open",0).removeClass("active").find("span").text("时间范围"),e(".sn-times").hide();var a=e("#txtStarDate").val(),t=e("#txtEndDate").val();""!=a&&""!=t?e(this).parents(".sing").find("span").text(a+" - "+t):""!=a?e(this).parents(".sing").find("span").text(a+" 开始"):""!=t&&e(this).parents(".sing").find("span").text(t+" 截止"),(a!=errorBook.params.start||t!=errorBook.params.expire)&&(errorBook.params.start=a,errorBook.params.expire=t,errorBook.params.index=1,errorBook.load())}),e(".sn-time-reset").bind("click",function(){e(this).parents(".sing").data("open",0).removeClass("active").find("span").text("时间范围"),e(".sn-times").hide(),e("#txtStarDate").val(""),e("#txtEndDate").val(""),(""!=errorBook.params.start||""!=errorBook.params.expire)&&(errorBook.params.start="",errorBook.params.expire="",errorBook.params.index=1,errorBook.load())}),e(".sn-reason").delegate(".item","click",function(a){a.stopPropagation();var t=e(this),r=parseInt(t.data("val"));if(!singer.isUndefined(r)){if(r==errorBook.params.has_reason)return t.parents(".sing").data("open",0).removeClass("active"),void t.parent().hide();var s=t.text();"-1"==r&&(s="错因分析"),t.parents(".sing").data("open",0).removeClass("active").find("span").text(s),t.parent().hide(),errorBook.params.has_reason=r,errorBook.params.index=1,errorBook.load()}}),e("#btnSearch").bind("click",function(){a()}),e("#txtSearchKey").bind("keyup",function(t){var r=t||window.event||arguments.callee.caller.arguments[0];if(r&&13==r.keyCode)e(this).data("idx","-99"),a(),e(this).blur();else if(!r||38!=r.keyCode&&40!=r.keyCode)e(this).data("idx","-99"),s();else{var i=e(".search-keys").find(".item");if(i.length<1)return;var n=0;if(n=singer.isUndefined(e(this).data("idx"))?-1:parseInt(e(this).data("idx")),-99==n){var o='<div class="item hide">'+e(this).val()+"</div>"+e(".search-keys").html();e(".search-keys").html(o),i=e(".search-keys").find(".item"),n=0}i.removeClass("active"),n+=38==r.keyCode?-1:1,n>=i.length&&(n=0),0>n&&(n=i.length-1),e(this).data("idx",n);var d=e(i[n]);d.addClass("active"),e(this).val(d.text())}});var i=!1,n="",o=1;e(".search-keys").delegate(".item","click",function(){e("#txtSearchKey").val(e(this).text()),a()}),e("#txtSearchKey").bind("blur",function(){setTimeout(t,200)}),e(".q-list").delegate(".span-dw","click",function(){var a=e(this).parents(".q-item").data("id"),t=e(this).parents(".q-item").data("subject");errorBook.dw.refresh(a,t)&&(errorBook.dw.refreshHtml(),e(this).hasClass("dw-active")?e(this).removeClass("dw-active").html('<i class="fa fa-plus"></i> 加入下载</span>'):e(this).addClass("dw-active").html('<i class="fa fa-times"></i> 移除下载</span>'))}),e(".dw-power-p").bind("click",function(){e(this).hide(),e(".dw-body").show()}),e(".dw-power-c").bind("click",function(){e(".dw-body").hide(),e(".dw-power-p").show()}),e(".dw-dowload").bind("click",function(){errorBook.dw.download()}),e(".dw-reset").bind("click",function(){errorBook.dw.reset()}),e(".pagination").delegate("a","click",function(){var a=parseInt(e(this).data("num"));singer.isUndefined(a)||1>a||a==errorBook.params.index||(errorBook.params.index=a,errorBook.load())}),e(".sing").bind("click",function(){var a=e(this).data("open");e(".screen").find(".sing").data("open",0).removeClass("active"),e(".screen").find(".list").hide(),a||e(this).data("open",1).addClass("active").find(".list").show()})});