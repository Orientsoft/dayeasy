var logger=singer.getLogger("addCtrl"),addCtrl=["$scope","$http","$sce",function(t,e,i){t.qt={stage:"",type:"",range:0,subject_id:"",points:[],tags:[],difficulty:3},t.qType=-1,t.qTypes=[{id:-1,name:"请选择题型"}],t.editorText="",t.step=1,t.tagState=!1,t.typeTags=[],t.points=[],t.saving=!1,t.ranges=[];for(var n=0;n<singer.ranges.length;n++)t.ranges.push({id:n,name:singer.ranges[n]});{var s,o,r=(singer.sites.main||"")+"/sys";!function(){e.post(r+"/question_init").success(function(e){t.qt.subject_id=e.subject_id,t.stages=e.stages,t.qTypes=t.qTypes.concat(e.types),t.qType=-1,1==t.stages.length&&(t.qt.stage=t.stages[0].id)}),singer.tags({canEdit:!0,max:5,change:function(e){t.qt.tags=e,t.$digest()}})}()}$(".b-tag").keypress(function(e){13==e.keyCode&&t.addTag()}),t.clearEditor=function(){t.editorText=""};var a=singer.sites["static"]+"/plugs/raty/images/";$(".q-star").raty({path:a,score:t.qt.difficulty,hints:["容易","普通","一般","困难","极难"],click:function(e,i){t.qt.difficulty=e}}),$(window).bind("beforeunload.question",function(){return"离开当前页面，数据将不会被保存，是否继续？"}),t.setStep=function(e){var i=function(){if(2==e){if(t.questionForm.stage.$invalid||t.questionForm.qType.$invalid||t.qType<0||!t.qt.points||t.qt.points.length<1)return!1;t.qt.type=t.qType,logger.info(t.qt);for(var i=0;i<t.qTypes.length;i++)if(t.qTypes[i].id==t.qType){o=t.qTypes[i],t.typeTags=singer.getTags(o.style||0);break}}if(3==e){if(!t.editorText)return!1;t.question=singer.recognition($("#q-editor").val(),t.typeTags),logger.info(t.question),setTimeout(function(){$("body,html").animate({scrollTop:$(".step-03").offset().top},"fast");var t=$(".qth-content").find("textarea");t.each(function(t,e){var i=e.scrollHeight+12;i=i>220?220:i,$(e).css("height",i)})},200)}t.step=e};t.step>=e?2==e?singer.confirm("你刚才切换了题型，是否初始化出题界面？<br/>如果不初始化出题界面可能导致界面不符合你出题型的要求...",function(){t.editorText="",t.question={},i(),t.$digest()},function(){i(),t.$digest()}):3==e&&singer.confirm("你刚才重新点击了快速出题，是否确认重置题目详情界面？",function(){i(),t.$digest()},function(){return!1}):i()},t.showSection=function(e){return singer.inArray(singer.getTag(e)||"",t.typeTags)},t.optionWords=singer.optionWords;var g=$("#kPoints").tokenInput($("#getKpUrl").val(),{method:"POST",queryParam:"kp",hintText:"",noResultsText:"没有找到相关知识点",searchingText:"Searching...",placeholder:"输入知识点关键字",tokenLimit:5,excludeCurrent:!1,preventDuplicates:!0,onAdd:function(){t.qt.points=g.tokenInput("get"),t.$digest()},onDelete:function(){t.qt.points=g.tokenInput("get"),t.$digest()}});t.add=function(t){t=t||[],t.push({body:"",images:[],sort:t.length})},t.del=function(t,e){if(!singer.isArray(e))return!1;e.splice(t,1);for(var i=0;i<e.length;i++)e[i].sort=i},t.setCorrect=function(t,e){if(!o.multi&&!t.is_correct)for(var i=0;i<e.length;i++)e[i].is_correct=!1;t.is_correct=!t.is_correct},t.uploadImg=function(t){t=t||{},t.images=t.images||[],s=t,$(".webuploader-element-invisible").click()},t.getImageUrl=function(t,e,i){return singer.makeThumb(t,e,i)},t.editText=function(e){singer.textEditor(e,function(){t.$digest(),setTimeout(singer.loadFormula,120)})},t.trustHtml=function(t){return t?(t=singer.formatText(t),i.trustAsHtml(t)):""},t.save=function(){if(t.saving)return!1;var i=$.extend({},t.question,t.qt);return logger.info(i),singer.checkQuestion(i,o)?(t.saving=!0,void e.post("save",i).success(function(e){e.status?($(window).unbind("beforeunload.question"),singer.confirm("老师辛苦了，题已加入<span class='tip-color'>题库</span>啦！",function(){location.href="/question"},function(){t.step=1,t.saving=!1,t.editorText="",t.$digest()},["回到题库","继续添加"])):(singer.msg(e.message),t.saving=!1)}).error(function(e){singer.msg("网络请求异常，请稍后重试！"),t.saving=!1,console.log(e)})):!1},singer.uploader.on("uploadSuccess",function(e,i){i.state&&(s.images=i.urls,t.$digest()),singer.uploader.reset()}),singer.uploader.on("uploadError",function(t){})}];!function(t,e){t(document).delegate(".q-tags li","click",function(){var i="【"+t(this).html()+"】",n=t("#q-editor").get(0);e.insertText(n,i)}).delegate(".q-tag","click",function(){return!1}).delegate(".step-text","click",function(){var e=t(this).parents(".q-step");return e.hasClass("step-active")?void t("body,html").animate({scrollTop:e.offset().top},"fast"):!1}).delegate(".qth-editor","mouseenter",function(){t(this).addClass("qth-editor-hover")}).delegate(".qth-editor","mouseleave",function(){t(this).removeClass("qth-editor-hover")}).delegate(".image-view","mouseenter",function(){t(this).addClass("image-hover")}).delegate(".image-view","mouseleave",function(){t(this).removeClass("image-hover")}).delegate(".btn-return","click",function(){location.href="/question"}).delegate(".q-help li","click",function(){t.get(singer.sites["static"]+"/data/question-helper.html",{t:Math.random()},function(t){singer.dialog({title:"快速出题 - 帮助文档",content:t,height:420}).showModal()})});var i=t(".step-text"),n=function(t){var e=function(t){var e=i.eq(t);e.data("opt",{top:e.offset().top,left:e.offset().left,h:e.height()})};if(singer.isNumber(t))e(t);else for(var n=0;n<i.length;n++)e(n)};t(function(){n()});var s=5;t(window).bind("scroll.step",function(){for(var e,o,r=t(this).scrollTop(),a=0;a<i.length;a++)e=i.eq(a),o=e.data("opt"),r>=o.top-a*(o.h+s)?e.data("fixed")||(e.css({position:"fixed",top:(o.h+s)*a,left:o.left}),e.data("fixed",!0)):e.data("fixed")?(e.css({position:"relative",top:0,left:0}),e.data("fixed",!1)):n(a)})}(jQuery,singer);