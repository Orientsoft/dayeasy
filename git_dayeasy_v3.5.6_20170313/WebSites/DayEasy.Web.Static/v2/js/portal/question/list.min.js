var url=(singer.sites.main||"")+"/sys",logger=singer.getLogger("listCtrl"),$window=$(window),lazyLoadCount=3,listCtrl=["$scope","$http","$sce",function(e,t,s){e.sd={range:0,type:-1,keyword:"",subject_id:0,page:0,size:10,stage:-1},e.pages={},e.qtype=-1,e.page=0,e.list=[],e.totalCount=0,e.showEmpty=!1,e.showError=!1,e.loading=!1,t.post(url+"/question_init").success(function(t){e.sd.subject_id=t.subject_id,e.qTypes=t.types});var n=function(){t.post("/question/search",e.sd).success(function(t){return e.pages=[],e.showError=!1,e.loading=!1,t.status&&t.data&&t.data.length?(e.showEmpty=!1,e.list=e.list.concat(t.data),e.totalCount=t.count,t.data.length==e.sd.size&&(e.sd.page+1)%lazyLoadCount>0&&$window.bind("scroll.lazyLoad",o),t.data.length<e.sd.size&&$window.unbind("scroll.lazyLoad"),(e.sd.page>=lazyLoadCount-1||t.data.length<e.sd.size)&&(e.pages=singer.page({current:Math.floor(e.sd.page/lazyLoadCount),size:e.sd.size*lazyLoadCount,total:t.count})),setTimeout(singer.loadFormula,120),void 0):(e.list.length||(e.showEmpty=!0),$window.unbind("scroll.lazyLoad"),!1)}).error(function(t){e.loading=!1,e.list.length||(e.showError=!0),$window.unbind("scroll.lazyLoad")})},o=function(){var t=$(window).height(),s=$(document.body).height(),o=$(window).scrollTop(),r=(s-t-o)/t;if(.15>r&&!e.loading){if((e.sd.page+1)%lazyLoadCount==0)return $window.unbind("scroll.lazyLoad"),!1;e.loading=!0,e.$digest(),e.sd.page=e.sd.page+1,n()}};e.formatNum=function(e){return singer.formatNum(e)},e.page=function(t){var s=(t-1)*lazyLoadCount;return 0>t||e.sd.page==s?!1:(e.sd.page=s,e.list=[],e.pages=[],e.showEmpty=!1,e.loading=!0,n(),!1)},e.optionWords=singer.optionWords,e.ranges=singer.ranges,e.otherRanges=function(e){var t=[0,1,2];return t.splice(e,1),t},e.updateRange=function(e,s){return t.post("/question/range",{question_id:e.question_id,range:s}).success(function(t){t.status&&(singer.msg(singer.msgArray.updateSuccess),e.range=s)}),!1},e.keyPress=function(t){13==t.keyCode&&e.search()},$(".d-range-item").bind("click",function(){var t=$(this);return t.hasClass("active")?!1:(t.addClass("active").siblings("li").removeClass("active"),e.sd.range=$(".d-range-item").index(t),e.pages={},void e.search())}),e.makeThumb=function(e,t,s){return singer.makeThumb(e,t,s)},e.remove=function(s,n){singer.confirm("删除之后将不能找回，确认删除当前题目？",function(){t.post("/question/remove",{question_id:n.question_id}).success(function(t){t.status?(e.list.splice(s,1),e.$digest()):singer.msg(t.message)}).error(function(){})},function(){})},e.showAnswer=function(e,t){return t.stopPropagation(),e.showAnswer=e.showMore=!e.showAnswer,e.showAnswer&&setTimeout(singer.loadFormula,120),!1},e.showImage=function(e,t){return t.stopPropagation(),singer.showImage(e),!1},e.trustHtml=function(e){return e=singer.formatText(e),s.trustAsHtml(e)},e.bindQuestionBody=function(t,s){var n=singer.questionTypes[t];return n&&(s='<b class="q-type" title="'+n.name+'">'+n.title+"</b>"+s),e.trustHtml(s)},e.optionModel=function(e){return singer.optionModel(e)},e.errorRate=function(e,t){if(0>=e)return"0.0%";var s=t/e;return s>1&&(s=1),Math.round(100*s).toFixed(1)+"%"},e.getAnswer=function(t){return e.trustHtml(singer.getCorrectAnswers(t))},e.showMore=function(e){e.showMore=!e.showMore},e.search=function(){return e.loading?!1:(e.sd.page=0,e.list=[],e.showEmpty=!1,e.showError=!1,e.loading=!0,e.pages=[],n(),!1)},e.search()}];!function(e){e(document).delegate(".q-item","mouseenter",function(){e(this).addClass("q-hover")}).delegate(".q-item","mouseleave",function(){e(this).removeClass("q-hover")}).delegate(".q-share","mouseenter",function(){e(this).addClass("share-hover")}).delegate(".q-share","mouseleave",function(){e(this).removeClass("share-hover")}).delegate(".d-pager li a","click",function(){return!1})}(jQuery);