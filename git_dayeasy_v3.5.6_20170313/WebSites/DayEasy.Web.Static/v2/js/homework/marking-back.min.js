var marking=function(){var t={data:{},item:{},url:DEYI.sites["static"]+"/v1/image/icon/marking/",lock:!1,charCode:function(t){t=t||[];for(var e="",i=0;i<t.length;i++)t[i]>-1&&t[i]<26&&(e+=String.fromCharCode(65+t[i]));return e},equals:function(t,e){if(t=t||[],e=e||[],t.length!=e.length)return!1;for(var i=0;i<t.length;i++)if(!singer.inArray(t[i],e))return!1;return!0},_mix:function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])}};return t}();!function(t){t._mix(t,{dw:{doc:$(document),icons:[],images:["full.png","semi.png","error.png"],main:$("#dt_pic"),x:0,y:0,init:function(e,i){if(t.dw.x=e||t.dw.x,t.dw.y=i||t.dw.y,t.dw.icons.length)for(var a=0;a<t.dw.icons.length;a++){var s=t.dw.icons[a],n=t.url+(s.t>2?s.w:t.dw.images[s.t]),d="<div class='icon' style='position: absolute;left: "+s.x+"px;top: "+s.y+"px;'><img src='"+n+"'>";t.dw.main.append($(d).data("x",s.x).data("y",s.y))}},print:function(e){var i=parseInt(t.dw.main.data("t")||"0");if(10!=i){(0>i||i>3)&&(i=0);var a=i>2?t.dw.main.data("w")||"":t.dw.images[i];if(a){var e=e||window.event,s=e.clientX+t.dw.doc.scrollLeft()-t.dw.x,n=e.clientY+t.dw.doc.scrollTop()-t.dw.y;if(0==i||1==i?(s-=2,n-=10):2==i&&(s-=3,n-=2),t.dw.icons.length>0)for(var d=t.dw.icons.length;d>0;d--){var r=t.dw.icons[d-1];if(r.x==s&&r.y==n)return}var o="<div class='icon' style='position: absolute;left: "+s+"px;top: "+n+"px;'><img src='"+t.url+a+"'>";t.dw.main.append($(o).data("x",s).data("y",n)),t.dw.icons.push({x:s,y:n,t:i,w:i>2?a:""})}}},load:function(){var e=$("#divIcons"),i=t.dw.main.width()/2-e.width()/2+t.dw.main.offset().left-16;e.attr("style","position: fixed;left:"+i+"px;");var a=$(window).height();if(!(100>a)){a=a-20-($(".hidden-print").height()||82);var s=$("#divScore");i=t.dw.main.width()+t.dw.main.offset().left+1;var n="height:"+a+"px;",d="position: fixed;left:"+i+"px;top:10px;height:"+a+"px;";s.attr("style",n),a=a-25-$("#divScoreTop").height(),$("#divScoreContent").attr("style","max-height:"+a+"px;min-height:"+a+"px;");var r=s.offset().top;t.dw.doc.scroll(function(){t.dw.doc.scrollTop()>r-10?s.attr("style",d):s.attr("style",n)})}}},qt:{bind:function(){var e=$("#objectQuDiv"),i=$("#unObjectQuDiv"),a=!1,s=!1;e.html(""),i.html("");var n=t.item.i-1,d=0,r=t.data.pictures[n],o=r.student_id>0?r.details:[],c=!o.length;t.item.total=0,t.item.details=[],t.item.first_mk=c,t.item.obj_count=0;for(var l=0;l<t.data.questions.length;l++){var m=t.data.questions[l],u=t.mt.detail(m.id,o);if(c&&(u.id=m.id,u.score=m.score,u.correct=!0),singer.isUndefined(u.id))return $("#totalScore").text("0"),void singer.alert("啊，出现重要错误啦，请联系我们！");if(u.total=m.score,m.objective){u.stu_answer=[],u.stu_content=[],u.sys_answer=[],u.sys_content=[],t.item.answers.length>l+d&&(u.stu_content=t.item.answers[l+d]);for(var f=0;f<m.answer.length;f++){var p=m.answer[f];singer.inArray(p.sort,u.stu_content)&&u.stu_answer.push(p.id),p.correct&&(u.sys_answer.push(p.id),u.sys_content.push(p.sort))}singer.isUndefined(t.item.err_question)&&(t.item.err_question=[]),t.item.obj_count++,(!u.correct||t.item.first_mk&&!t.equals(u.stu_content,u.sys_content))&&(u.score=0,u.correct=!1,u.tmp_content=u.stu_content,u.tmp_answer=u.stu_answer,t.item.err_question.push({i:m.id,s:m.sort,o:!1}))}else d++;t.item.total+=u.score,c&&o.push(u)}c&&(t.item.details=$.extend(!0,[],o)),t.item.student_id<1&&(r.details=o),$("#totalScore").text(t.item.total);for(var h=0;h<t.data.questions.length;h++){var v=t.data.questions[h],g=t.mt.detail(v.id,o);if(v.objective)g.correct||(a=!0,e.append('<li title="点击纠正" class="z-sel-f" data-full="0" data-id="'+g.id+'"><span>'+v.sort+"、</span><em>×</em></li>"));else{var w;if(v.score<=0)s=!0,w=$("#chooseTempUnScore").html(),i.append(w.replace("{Id}",g.id).replace("{qNo}",v.sort).replace("{fullActive}",g.correct?"active":"").replace("{errorActive}",g.correct?"":"active"));else{w=$("#chooseTempScore").html();for(var _="",k=0;k<=v.score;k++)_+="<li>"+k+"</li>";i.append(w.replace("{Id}",g.id).replace("{qNo}",v.sort).replace("{cScore}",g.score).replace("{scores}",_))}}}a||e.append('<li style="cursor:default;">(全对)</li>'),s&&$("#unObjectQuTitle").html('主观题<span style="font-size:12px;color:#fcb66f;">（部分题目未设置分数）</span>'),t.item.student_id<1?($("#divQuestions").hide(),$("#divNeedBind").show()):($("#divQuestions").show(),$("#divNeedBind").hide())},init:function(){$("#objectQuDiv").delegate("li","click",function(){var e=$(this).data("id")||0;if(e){var i=$(this).data("full")||0;i?$(this).addClass("z-sel-f").removeClass("z-sel-t").find("em").text("×"):$(this).removeClass("z-sel-f").addClass("z-sel-t").find("em").text("√"),$(this).data("full",!i);for(var a=t.data.pictures[t.item.i-1].details,s=0;s<a.length;s++){var n=$.extend(!0,{},a[s]),d=!1;if(n.id==e){if(t.item.details.length){var r=t.mt.detail(e,t.item.details);(r.id||"")==e&&(n=r,d=!0)}return n.correct=!n.correct,n.score=n.correct?n.total:0,t.item.total+=n.correct?n.total:0-n.total,$("#totalScore").text(t.item.total),t.item.o=8|t.item.o,i?t.item.first_mk&&(n.stu_content=n.tmp_content,n.stu_answer=n.tmp_answer,t.qt.setErrQuestion(n.id,!1)):(n.stu_content=n.sys_content,n.stu_answer=n.sys_answer,t.qt.setErrQuestion(n.id,!0)),void(d?t.item.first_mk||t.mt.remove(n.id,t.item.details):t.item.details.push(n))}}}}),$("#unObjectQuDiv").delegate("dt","click",function(){$("#unObjectQuDiv dt").removeClass("z-sel");var t=$(this).siblings("dd");t.hasClass("hide")&&($(this).addClass("z-sel"),$(".q-scores dd").not(t).addClass("hide")),t.toggleClass("hide")}).delegate("li","click",function(){var e=$(this).text(),i=$(this).parent().parent(),a=i.siblings("dt"),s=a.data("id");a.find("em").text(e),i.addClass("hide");for(var n=t.data.pictures[t.item.i-1].details,d=0;d<n.length;d++){var r=$.extend(!0,{},n[d]),o=!1;if(r.id==s){if(t.item.details.length){var c=t.mt.detail(s,t.item.details);(c.id||"")==s&&(r=c,o=!0)}return r.correct=e==r.total,t.item.total+=e-r.score,r.score=e,$("#totalScore").text(t.item.total),t.item.o=8|t.item.o,void(o?t.item.first_mk||n[d].correct!=r.correct||n[d].score!=r.score||t.mt.remove(r.id,t.item.details):t.item.details.push(r))}}}).delegate("span","click",function(){var e=$(this).data("t");if("full"==e||"error"==e){$(this).parent().find("span").removeClass("active"),$(this).addClass("active");for(var i=$(this).parent().data("id"),a=t.data.pictures[t.item.i-1].details,s=0;s<a.length;s++){var n=$.extend(!0,{},a[s]),d=!1;if(n.id==i){if(t.item.details.length){var r=t.mt.detail(i,t.item.details);(r.id||"")==i&&(n=r,d=!0)}return n.correct="full"==e,t.item.o=8|t.item.o,void(d?t.item.first_mk||a[s].correct!=n.correct||t.mt.remove(n.id,t.item.details):t.item.details.push(n))}}}})},setErrQuestion:function(e,i){if(t.item.err_question&&t.item.err_question.length)for(var a=0;a<t.item.err_question.length;a++){var s=t.item.err_question[a];s.i==e&&(s.o=i)}}},mk:{init:function(){$("#span_paper_title").text(t.data.paper_name),$("#span_class_name").text(t.data.class_name),$("#span_total").text("/"+t.data.pictures.length),$("#power_students").click(function(){$(this).toggleClass("z-sel"),$("#divStudents").slideToggle(500)}),"1"==singer.cookie.get("MARKINGALT")?$(".u-prompt").remove():($(".u-prompt").show(),$(".u-prompt em").click(function(){$(".u-prompt").remove(),singer.cookie.set("MARKINGALT","1",525600)}));for(var e="",i=0;i<t.data.pictures.length;i++){t.data.pictures[i].i=i+1;var a="",s=t.data.pictures[i];0==i&&(a=' class="z-sel"'),s.student_id<1&&(a=' class="s-fc"',s.student_name="未识别"),e+="<li"+a+" data-idx='"+(i+1)+"' data-id='"+s.id+"'>"+s.student_name+"</li>"}$("#dt_students").html(e).delegate("li","click",function(){if(t.lock&&$(this).data("id")!=t.item.id)for(var e=0;e<t.data.pictures.length;e++)if(t.data.pictures[e].id==$(this).data("id")){t.lock=!1,t.mt.submit(e),$("#power_students").toggleClass("z-sel"),$("#divStudents").slideToggle(500);break}}),$(".pic-chg").click(function(){if(!(t.data.pictures.length<2)&&t.lock){t.lock=!1;var e=$(this).data("power")+t.item.i;1>e&&(e=t.data.pictures.length),e>t.data.pictures.length&&(e=1),t.mt.submit(e-1)}}),$(document).keydown(function(e){var i=e.which;if(t.lock&&(37==i||39==i)){if(t.data.pictures.length<2)return;t.lock=!1;var a=t.item.i+(37==i?-1:1);1>a&&(a=t.data.pictures.length),a>t.data.pictures.length&&(a=1),t.mt.submit(a-1)}}),$(".icons").click(function(){$(".icons").removeClass("z-crt"),$(this).addClass("z-crt");var e=parseInt($(this).data("t")||"0");return 3==e?void $("#dt_marks").show():($("#dt_marks").hide(),void(t.dw.main.data("t")!=e&&(t.dw.main.data("o",2),t.mk.setBox(e))))}),t.dw.main.bind("contextmenu",function(){return!1}).mousedown(function(e){if(3==e.which){$(".icons").removeClass("z-crt");var i=parseInt(t.dw.main.data("t")||"0");0==i?(i=1,$("#divIconSemi").addClass("z-crt")):1==i?(i=2,$("#divIconError").addClass("z-crt")):(i=0,$("#divIconFull").addClass("z-crt")),t.dw.main.data("o",2),t.mk.setBox(i)}}),$("#dt_marks li").click(function(){var e=$(this).data("w");$("#dt_marks").hide(),e!=t.dw.main.data("w")&&(t.dw.main.data("o",4),t.mk.setBox(3,e))}),t.dw.main.click(function(e){t.dw.print(e),t.item.o=t.item.o|(t.dw.main.data("o")||2)}),t.dw.main.delegate(".icon","click",function(){var e=parseInt(t.dw.main.data("t")||"0");if(10==e){var i=$(this).data("x"),a=$(this).data("y");$(this).remove();for(var s=0;s<t.dw.icons.length;s++){var n=t.dw.icons[s];if(n.x==i&&n.y==a)return void t.dw.icons.splice(s,1)}t.item.o=6|t.item.o}}),$("#dt_img").load(function(){t.dw.init($(this).offset().left,$(this).offset().top)}),$("#btnSave").click(function(){t.item.o|=16,t.mt.submit()}),$("#btnFinish").click(function(){return t.item.o>0||t.item.first_mk&&t.item.student_id>0?void singer.msg("请先保存当前批阅进度"):void singer.dialog({title:"完成批阅",content:'完成<span style="color:#fa9632;font-size:16px;">所有</span>批阅后，将生成统计报表，<span style="color:#fa9632;font-size:16px;">不可</span>再更改。<br/>确认完成吗？',fixed:!0,backdropOpacity:.7,okValue:"确定",cancelValue:"取消",ok:function(){$.post("finished",{batch:t.data.batch,paperId:t.data.paper_id,type:t.data.paper_type},function(t){t.Status?singer.msg("操作成功",0,function(){window.location.href="/work"}):singer.msg(t.Message)})},cancel:function(){}}).showModal()}),$("#btnOpenBind").click(function(){t.item.student_id<1&&$.post("unbind",{id:t.item.id,batch:t.data.batch,classId:t.data.class_id},function(e){if(!e.status)return void singer.msg("加载未绑定学生资料失败");for(var i=$('<div style="min-width: 300px;min-height: 80px;max-width: 600px;max-height: 250px;"></div>'),a=$('<ul class="ul-bind-students after"></ul>'),s=0;s<e.data.length;s++){var n=e.data[s],d=$('<li data-id="'+n.id+'" data-name="'+n.name+'">'+n.name+"</li>");d.bind("click",function(e){return e.stopPropagation(),t.item.student_id=$(this).data("id"),t.item.student_name=$(this).data("name"),$(".ul-bind-students li").removeClass("z-sel"),$(this).addClass("z-sel"),!1}),a.append(d)}i.append(a),singer.dialog({title:"绑定学生",content:i,fixed:!0,backdropOpacity:.7,okValue:"确定",cancelValue:"取消",ok:function(){return t.item.student_id<1?(singer.msg("请选择学生"),!1):void $.post("bind",{id:t.item.id,studentId:t.item.student_id,studentName:t.item.student_name,batch:t.data.batch},function(e){if(e.status){singer.msg("绑定成功");var i=t.item.i-1,a=t.data.pictures[i];a.student_id=t.item.student_id,a.student_name=t.item.student_name,$("#student_name").text(t.item.student_name),$("#dt_students li").each(function(e,i){$(i).data("id")==t.item.id&&($(i).removeClass("s-fc"),$(i).text(t.item.student_name))}),$("#divQuestions").show(),$("#divNeedBind").hide()}else singer.msg(e.message)})},cancel:function(){t.item.student_id=0,t.item.student_name="未绑定"}}).showModal()})})},bind:function(){$("#span_idx").text(t.item.i),$("#student_name").text(t.item.student_id>0?t.item.student_name:"未识别"),$("#dt_students li").removeClass("z-sel").each(function(e,i){return $(i).data("id")==t.item.id?void $(i).addClass("z-sel"):void 0})},setBox:function(e,i){switch(t.dw.main.data("w",0),e){case 2:return void t.dw.main.data("t",e).removeClass("mk-1 mk-2 mk-c remark").addClass("mk-0");case 1:return void t.dw.main.data("t",e).removeClass("mk-0 mk-2 mk-c remark").addClass("mk-1");case 0:return void t.dw.main.data("t",e).removeClass("mk-0 mk-1 mk-c remark").addClass("mk-2");case 10:return void t.dw.main.data("t",e).removeClass("mk-0 mk-1 mk-2 remark").addClass("mk-c");case 3:return void t.dw.main.data("t",e).data("w",i).removeClass("mk-0 mk-1 mk-2 mk-c").addClass("remark")}}},mt:{list:function(e,i){$.post("pictures",{batch:e,type:i},function(e){if(!e.status)return void $("#divLoad").text(e.message);$("#divLoad").text("").hide(),$("#divData").show(),t.data=e.data;var i=0,a=t.data.last_student_id;if(a>1)for(var s=0;s<t.data.pictures.length;s++)if(t.data.pictures[s].student_id==a){i=s;break}t.mt.item(t.data.pictures[i],i+1),t.mk.init(),t.qt.init(),t.dw.load()})},item:function(e,i){e.load=e.load||!1,e.load?t.mt.item_set(e,i):$.post("picture",{id:e.id,type:t.data.paper_type},function(a){if(!a.status)return void singer.msg(a.message);if(e.answers=singer.json(a.data.answers)||[],e.icons=singer.json(a.data.icons)||[],e.marks=singer.json(a.data.marks)||[],e.details=a.data.details||[],e.marks&&e.marks.length)for(var s=0;s<e.marks.length;s++)e.icons.push({x:e.marks[s].x,y:e.marks[s].y,t:e.marks[s].t,w:e.marks[s].w});e.load=!0,t.mt.item_set(e,i)})},item_set:function(e,i){t.dw.icons=[],$(".icon").remove();var a=singer.isUndefined(t.item)?"":t.item.id;t.item=$.extend(!0,{},e),t.item.o=0,i&&(t.item.i=i),t.item.icons&&t.item.icons.length&&(t.dw.icons=t.item.icons),a==e.id?t.dw.init():$("#dt_img").attr("src",t.item.pic),t.mk.bind(),t.qt.bind(),t.lock=!0},detail:function(t,e){if(e.length)for(var i=0;i<e.length;i++)if(e[i].id==t)return e[i];return{}},remove:function(t,e){for(var i=0;i<e.length;i++)if(e[i].id==t)return void e.splice(i,1)},submit:function(e){if(singer.isUndefined(e)&&(e=-1),t.item.student_id<1)return 0>e?singer.msg("请先绑定学生"):0!=t.item.o?singer.dialog({title:"请绑定试卷",content:'当前试卷未绑定学生，切换后批阅资料将<span style="color:#fa9632;font-size:16px;">丢失</span>。<br/>是否继续?',fixed:!0,backdropOpacity:.7,okValue:"确定",cancelValue:"取消",ok:function(){t.mt.item(t.data.pictures[e])},cancel:function(){}}).showModal():t.mt.item(t.data.pictures[e]),void(t.lock=!0);if(t.item.first_mk||0!=t.item.o){var i=[],a=[],s=[],n="not";if(t.dw.icons&&t.dw.icons.length&&((4&t.item.o)>0||(2&t.item.o)>0)){for(var d=0;d<t.dw.icons.length;d++){var r={x:t.dw.icons[d].x,y:t.dw.icons[d].y,t:t.dw.icons[d].t};3!=t.dw.icons[d].t?i.push(r):(r.w=t.dw.icons[d].w,a.push(r))}0==(2&t.item.o)&&(i=[]),0==(4&t.item.o)&&(a=[])}if(t.item.first_mk||(8&t.item.o)>0)for(var o=0;o<t.item.details.length;o++){var c=t.item.details[o],l=c.stu_answer||[],m="";singer.isArray(c.stu_content)&&c.stu_content.length&&(m=t.charCode(c.stu_content)),s.push({question_id:c.id,score:c.total||0,current_score:c.score,correct:c.correct,answer_ids:singer.json(l).replace(/'/gi,'\\"'),answers:m})}if(t.item.obj_count){var u=[];$(t.item.err_question).each(function(t,e){e.o||u.push(e.s)}),n=u.length?u.length==t.item.obj_count?"全错":u.join(","):"全对"}$.post("submit",{id:t.item.id,o:t.item.o,type:t.data.paper_type,eq:n,icons:singer.json(i).replace(/\'/gi,'"'),marks:singer.json(a).replace(/\'/gi,'"'),details:singer.json(s).replace(/\'/gi,'"')},function(i){if(t.lock=!0,i.status){var a=t.item.i-1;t.data.pictures[a].icons=$.extend([],t.dw.icons),t.data.pictures[a].details=[],t.data.pictures[a].load=!1,t.item.first_mk&&0==t.item.o||singer.msg("已保存",1e3),t.item.o=0,t.item.first_mk=!1,t.mt.item(t.data.pictures[e>-1?e:a])}else singer.msg(i.message)})}else t.lock=!0,e>-1&&t.mt.item(t.data.pictures[e])}}})}(marking),$(function(t){var e=singer.uri().batch,i=singer.uri().type;return singer.isUndefined(e)||""==e?void t("#divLoad").text("参数错误"):(singer.isUndefined(i)&&(i=""),void marking.mt.list(e,i))});