!function(e,t){var a,i=e(".image-map"),n=e(".index-map"),d=i.find("img"),s={x:0,y:0,width:120,height:26},c=[],l=10,r=15,o=15,h=230,u=780,v='<div class="index-item"><div class="index-num">{0}</div></div>',f=0,g=t.uri(),b=t.getLogger("marking-area"),m={},p=0,y=function(){e(".m-back").bind("click",function(){window.location.href="/work"});var t=e("#paperId").val(),a=g.type||0;e.ajax({url:"/work/marking-area-questions",data:{paperId:t,type:a},type:"GET",success:function(t){return t.status?void 0:0==t.length?(e(".index-loading").html("没有主观题！"),void n.append('<div class="index-action"><button class="deyi-btn j-finish no-question">开始批阅</button>')):void x(t)}})};y();var x=function(i){var d;e(".index-loading").remove(),e(".js-change").bind("click",function(){var t=g.batch,a=g.type||0;e.post("/work/picture-change",{batch:t,type:a},function(t){t&&t.status&&e(".image-map img").attr("src",t.message).bind("load",function(){var t=e(this);t.siblings("canvas").height(t.height())})})});for(var s=0;s<i.length;s++)d=e(t.format(v,i[s].index)).data("id",i[s]),n.append(d);n.append('<div class="index-action"><button class="deyi-btn j-finish disabled" disabled>完成标记</button><button class="deyi-btn j-reset">重新标记</button></div>'),a=n.find(".index-item")},k=setInterval(function(){return d.width()<780?!1:(d.areaSelect({initAreas:[],deleteMethod:"",padding:3,area:{strokeStyle:"#d9534f",lineWidth:2},point:{size:4,fillStyle:"#d9534f",type:"rect"},create:!1,drag:!0}),void clearInterval(k))},200);e(document).delegate("canvas","click",function(n){if(b.info("canvas click!"),!(c.length>=a.length)){if("create"!=d.data("AreaSelect").status)return void b.info("鼠标移动："+p);var v,g=e(this),m=e.extend({},s),y=g.offset(),x=a.eq(f);if(f>0&&(v=c[f-1]),m.x=n.clientX-y.left-l,m.y=n.clientY-y.top-r+e(window).scrollTop(),m.width=u-m.x-o,v&&m.y<v.y-s.height)return void t.msg("坐标点不能高于上一个点！");var k=x.data("id");if(k.t?m.width=h:f>0&&!v.t&&(v.height=m.y-v.y-10),f==a.length-1&&(m.height=g.height()-m.y-20),e.inArea(m,c))return void t.msg("标记区域发生重叠，请调整！");m.num=x.text(),d.areaSelect("add",m),m.id=k.id,m.index=k.index,m.t=k.t,c.push(m),a.eq(f).addClass("active"),f++,f>=a.length&&(g.unbind("click.areaSelect"),e(".j-finish").removeClass("disabled").removeAttr("disabled"),i.find("canvas").css("cursor","default"))}}).delegate("canvas","mousedown.areaSelect",function(e){m={x:e.clientX,y:e.clientY},p=0}).delegate("canvas","mousemove.areaSelect",function(e){p=Math.max(Math.abs(e.clientX-m.x),Math.abs(e.clientY-m.y))}),n.delegate(".j-reset","click.areaSelect",function(){location.reload(!0)}).delegate(".j-finish","click.areaSelect",function(){e(this).hasClass("disabled")||e(this).attr("disabled")||(e(this).addClass("disabled").attr("disabled","disabled").html("正在提交.."),e.ajax({url:"/work/marking-area-save",data:{batch:g.batch,type:g.type,areas:t.json(c)},type:"POST",success:function(a){if(a.status){var i="/work/marking-online?batch="+g.batch;return 2==g.type&&(i+="&type=b"),location.href=i,!1}t.alert(a.msg),e(this).removeClass("disabled").removeAttr("disabled").html("完成标记")}}))})}(jQuery,SINGER);