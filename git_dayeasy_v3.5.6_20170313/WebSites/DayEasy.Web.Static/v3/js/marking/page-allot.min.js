!function(e,i){var d,t,s,n,a,l,o,r,c;o=e(".d-box").data("joint"),r=i.getLogger("marking-allot"),d=function(){var i,d=e(".d-choose-questions"),s=e(".d-task-section"),n=!0;d.empty();for(var a=0;a<s.length;a++){var l=s.eq(a),o=l.find("h4");if(i=l.find("li.checked"),i.length>0){d.append(o.clone());var r=e('<ul class="d-questions">');r.append(i.clone()),d.append(r),n=!1}}n&&d.html('<div class="dy-nothing">暂无选中的题目</div>'),t()},t=function(){var i=e(".d-choose-questions li.checked"),d=e(".d-teachers-area li.checked"),t=e("#addMission");i.length>0&&d.length>0?t.removeClass("disabled").removeAttr("disabled"):t.addClass("disabled").attr("disabled","disabled")},s=function(){var d,t,s=e(".d-task-list"),n=e(".d-task-item"),a=e(".d-task-choose .d-questions"),l=e(".d-teachers-area"),o=l.find("li.checked");for(d=0;d<a.length;d++){var r=a.eq(d);t=r.prev();var c={title:"任务"+i.padLeft(n.length+d+1,2,"0"),section:t.length>0?t.html():""},h=template("missionTemplate",c),f=e(h);f.find(".d-questions").html(r.find("li").clone().removeClass("checked"));var u=o.clone().removeClass("checked");u.find("i").remove(),f.find(".d-teachers").html(u),s.append(f)}e(".d-choose-questions").html('<div class="dy-nothing">暂无选中的题目</div>'),o.removeClass("checked"),e(".d-task-left .checked").removeClass("checked").addClass("hide");var m=e(".d-task-section");for(d=0;d<m.length;d++)t=m.eq(d),t.find("li").length==t.find("li.hide").length&&t.addClass("hide");e(".d-task-left li").length==e(".d-task-left li.hide").length&&(e(".d-task-area").addClass("hide"),e("#submitBtn").removeClass("disabled").removeAttr("disabled")),e("#addMission").addClass("disabled").attr("disabled","disabled"),i.msg("添加成功！")},n=function(d){var t,s=d.find(".d-questions li"),n=e(".d-task-area");for(t=0;t<s.length;t++){var a=s.eq(t),l=a.data("qid"),o=n.find('li[data-qid="'+l+'"]');o.parents(".d-task-questions").prev().removeClass("hide"),o.parents(".d-task-section").removeClass("hide"),o.removeClass("hide")}n.hasClass("hide")&&n.removeClass("hide"),e("#submitBtn").addClass("disabled").attr("disabled","disabled"),d.remove();var r=e(".d-task-item");for(t=0;t<r.length;t++){var c="任务"+i.padLeft(t+1,2,"0");r.eq(t).find(".d-task-header").html(c)}},a=function(){var d,t,s,n,a=e(".d-task-item"),l=[];for(s=0;s<a.length;s++){d=a.eq(s),t={sectionType:1,questions:[],teacherIds:[]};var c=d.find(".d-section");c.length&&"B卷"==c.html()&&(t.sectionType=2);var h=d.find(".d-questions li");for(n=0;n<h.length;n++)t.questions.push(h.eq(n).data("qid"));var f=d.find(".d-teachers li");for(n=0;n<f.length;n++)t.teacherIds.push(f.eq(n).data("uid"));l.push(t)}r.info(l),e.post("/marking/allot-submit",{jointBatch:o,missions:encodeURIComponent(i.json(l))},function(d){d.status?i.msg("分配成功！",2e3,function(){e(window).unbind("beforeunload.allot"),location.href="/marking/mission_v2/"+o}):(i.alert(d.message),e("#submitBtn").undisableFieldset())})},l=function(d,t,s){e.post("/marking/allot-add",{id:d,teachers:t.join(",")},function(e){if(e.status){c.close().remove();for(var d=s.prev().find(".d-add-box"),n=0;n<t.length;n++){var a=s.find('li[data-uid="'+t[n]+'"]');a.find("i").remove(),d.before(a)}0==s.find("li").length&&(d.remove(),s.remove()),i.msg("添加成功！")}else i.alert(e.message)})},e(".d-task-type").bind("click",function(){var i=e(this),t=i.next().find("li:visible"),s=i.hasClass("checked");i.add(t).toggleClass("checked",!s),d()}),e(".d-task-questions").find("li").bind("click",function(){var i=e(this),t=i.hasClass("checked"),s=i.parents(".d-task-questions").prev();if(t)s.removeClass("checked");else{var n=i.siblings(":visible"),a=i.siblings(".checked");n.length==a.length&&s.addClass("checked")}i.toggleClass("checked"),d()}),e(".d-teachers-area").find("li").bind("click",function(){e(this).toggleClass("checked"),t()}),e("#addMission").bind("click",function(){var i=e(this);return i.hasClass("disabled")?!1:(s(),!1)}),e("#submitBtn").bind("click",function(){var i=e(this);return i.hasClass("disabled")?!1:(i.disableField("分配中..."),void a())}),e("#cancelBtn").bind("click",function(){i.confirm("确认取消分配任务?",function(){e(window).unbind("beforeunload.allot"),location.reload(!0)})}),e("#completeBtn").bind("click",function(){i.confirm("确认完成协同任务分配?",function(){e(window).unbind("beforeunload.allot"),document.referrer&&-1==document.referrer.indexOf("marking/mission_v2")?location.href=document.referrer:window.close()})}),e(".d-add-box").bind("click",function(){var d=e(this),t=d.parents(".d-teachers-wrap").find(".d-add-teachers"),s=d.data("gid"),n=t.clone();c=i.dialog({title:"添加教师",content:n.html(),okValue:"确认添加",align:"bottom left",quickClose:!0,backdropOpacity:.5,width:400,ok:function(){var d=e(this.node).find("li.checked"),n=[];if(0==d.length)return i.msg("请选择要添加的教师！"),!1;for(var a=0;a<d.length;a++)n.push(d.eq(a).data("uid"));return l(s,n,t),!1},onshow:function(){e(this.node).find("li").bind("click",function(){e(this).toggleClass("checked")})}}),c.showModal(d.get(0))}),e(window).bind("beforeunload.allot",function(){return"离开当前页面，数据将不会被保存，是否继续？"}),e(".d-task-list").delegate(".d-task-remove","click",function(){var d=e(this).parents(".d-task-item");i.confirm("确认要删除该任务？",function(){n(d)})})}(jQuery,SINGER);