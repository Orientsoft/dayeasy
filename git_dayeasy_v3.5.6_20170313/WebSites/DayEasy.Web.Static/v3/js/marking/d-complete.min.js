!function(e,i){var t,n,a,s,c,o,l,d=i.uri(),r=!1,u=d.batch,f=!1;i.getLogger("marking-complete");u||(u=e(".dm-header").data("joint"),r=!0),a=function(t,n,a){var s={batch:u,isJoint:r,setIcon:t,setMarks:n};e.post("/marking/complete",s,function(e){if(l&&l.close().remove(),e.status){o&&o.close().remove();var t=i.sites.apps||"";i.dialog({title:"提示",content:"<p>已成功结束阅卷</p><p>您可以在【报表中心】查看本次批阅的统计报告</p>",okValue:"立即查看",ok:function(){window.location.href=t+"/report"},cancelValue:"稍后查看",cancel:function(){window.location.href=t+"/work/teacher"}}).showModal()}else a&&a.call(this),i.msg(e.message);f=!1})},n=function(t,n){var a={batch:u,status:t};e.post("/marking/update-status",a,function(e){l&&l.close().remove(),e.status?i.msg("已完成阅卷",2e3,function(){window.location.href=i.sites.apps+"/work/teacher"}):(n&&n.call(this),i.msg(e.message)),f=!1})},c=function(t,n,a){var s=function(){var s,c=0,l=!0;if(r){var d,u=e(".d-rank");for(d=0;d<u.length;d++)if(u.eq(d).data("rank")<100){l=!1;break}}s=template("finished-template",{finished:l,isJoint:r});var p=function(){var s=e("#cbxFinishedAgree"),l=e("#btnFinishedOk"),d=e(".finished-step2");t||l.html("结束阅卷"),e("#btnFinishedCancel").bind("click",function(){a&&a.call(this),o.close().remove()}),s.bind("click",function(){s[0].checked?l.removeAttr("disabled"):l.attr("disabled","disabled")}),l.bind("click",function(){if(f)return!1;if(f=!0,l.disableField("稍后.."),t){if(0==c)return e(".finished-step1").remove(),d.removeClass("hide"),c=1,f=!1,void i.later(function(){l.undisableFieldset(),l.html("确认结束")},500);var a=e("#cbxFinishedAutoSetIcon")[0].checked,s=e("#cbxFinishedAutoSetScore")[0].checked;n&&i.isFunction(n)&&n.call(this,l,a,s)}else n&&n.call(this,l)})};o=i.dialog({title:"结束阅卷",content:s,fixed:!0,backdropOpacity:.7,cancelValue:"取消",cancelDisplay:!1,cancel:function(){a&&a.call(this),o.close().remove()},onshow:function(){p()}}),o.showModal()};"undefined"==typeof template?i.loadScript(i.sites["static"]+"/js/artTemplate.min.js",{success:function(){s()}}):s()};var p;s=function(t){t=t||10,p&&p.cancel();var n=e('<div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="min-width:2em;width: 0%">0%</div>'),a=e('<div class="progress"></div>');a.append(n);var s=e('<div style="width:500px;">正在结束阅卷...<br/><br/></div>');s.append(a),l=i.dialog({content:s,fixed:!0,backdropOpacity:.7}),l.showModal(),p=i.later(function(){99>t?t+=1:p.cancel(),n.css({width:t+"%"}).html(t+"%")},100,!0)},e(document).delegate(".b-complete","click",function(){var n=e(this);return n.blur(),u&&u.length?(n.disableField('<i class="fa fa-spin fa-spinner fa-1x"></i>&nbsp;&nbsp;请稍候...'),void c(!0,function(e,c,o){s(),r?(t=n.data("paper"),a(c,o,function(){e.undisableFieldset()})):(t=i.config("paperId"),a(c,o,function(){e.undisableFieldset()}))},function(){n.undisableFieldset()})):void i.msg("没有检测到批次号，请重试")}).delegate(".b-update-status","click",function(){var i=e(this),t=i.data("status");i.disableField("稍后.."),c(!1,function(e){s(),n(t,function(){i.undisableFieldset(),e.undisableFieldset()})},function(){i.undisableFieldset()})})}(jQuery,SINGER);