var errorBook=function(){var a={total:0,list:[],params:{index:1,size:10,subject:-1,type:-1,start:"",expire:"",key:"",source_type:0,pass:-1,has_reason:-1},load:function(){a.list=[],$(".loading").show(),$(".q-list").hide(),$(".v-empty").hide(),$.post("errorBook/questions",a.params).success(function(e){$(".loading").hide(),e.status&&(a.total=e.count,a.pager(singer.page({current:a.params.index-1,size:a.params.size,total:e.count})),e.data&&e.data.length?(a.list=e.data,a.bind()):$(".v-empty").show())}).error(function(){})},bind:function(){$(".e-total").text(a.total);var e=template("eb-item",{list:a.list,source_type:a.params.source_type});$(".q-list").html(e).show(),setTimeout(singer.loadFormula,120)},pager:function(a){if(a.data&&a.data.length){$(".d-pager").show();var e=$(".pagination");e.html(""),a.prev&&e.append('<li><a href="javascript:void(0);" data-num="'+(a.current-1)+'">上一页</a></li>');for(var t=0;t<a.data.length;t++){var s=a.data[t],r="<li"+(s.isActive?' class="active"':"")+'><a href="javascript:void(0);" data-num="'+(s.isActive?"0":s.page)+'">'+(s.page>0?s.page:"...")+"</a></li>";e.append(r)}a.next&&e.append('<li><a href="javascript:void(0);" data-num="'+(a.current+1)+'">下一页</a></li>')}else $(".d-pager").hide()},dw:{show:!1,data:{subjects:[],list:[]},refreshHtml:function(){if($(".dc-items").html(""),a.dw.data.list.length){var e=a.dw.data.list.length;$(".dw-icon").text(e),$(".dc-num").text(e);for(var t=0;t<a.dw.data.subjects.length;t++){var s=a.dw.data.subjects[t];$(".dc-items").append('<div class="dc-item"><span>'+s.name+"</span><span>"+s.count+"</span></div>")}$(".d-dowload").show()}else $(".d-dowload").hide()},refresh:function(e,t){for(var s=0;s<a.dw.data.list.length;s++)if(a.dw.data.list[s]==e){a.dw.data.list.splice(s,1);for(var r=0;r<a.dw.data.subjects.length;r++)a.dw.data.subjects[r].name==t&&(a.dw.data.subjects[r].count-=1,a.dw.data.subjects[r].count<1&&a.dw.data.subjects.splice(r,1));return!0}if(a.dw.data.list.length>49)return singer.msg("已经选择了很多错题啦，先下载一份吧~~"),!1;a.dw.data.list.push(e);for(var i=0;i<a.dw.data.subjects.length;i++)if(a.dw.data.subjects[i].name==t)return a.dw.data.subjects[i].count+=1,!0;return a.dw.data.subjects.push({name:t,count:1}),!0},reset:function(){a.dw.data={subjects:[],list:[]},$(".span-dw").removeClass("dw-active").html('<i class="fa fa-plus"></i> 加入下载</span>'),a.dw.refreshHtml()},download:function(){return a.dw.data.list.length<1?void singer.msg("请选择错题"):($("#txtDwData").val(encodeURIComponent(singer.json(a.dw.data.list))),$("#dwForm").submit(),void singer.dialog({title:"下载提示",content:"请问您下载成功了吗？<br/>确定下载成功将<span style='color:#ffab00'>清空</span>错题下载列表",fixed:!0,backdropOpacity:.7,okValue:"是的",cancelValue:"还没有",ok:function(){$("#txtDwData").val(""),a.dw.reset()},cancel:function(){}}).showModal())},check:function(e){if(!a.dw.data.list.length)return!1;for(var t=0;t<a.dw.data.list.length;t++)if(e==a.dw.data.list[t])return!0;return!1}}};return a}();$(function(a){function e(){var e=a("#txtSearchKey").val().trim();e!=errorBook.params.key&&(errorBook.params.key=e,errorBook.params.index=1,errorBook.load())}function t(){a("#txtSearchKey").removeAttr("style"),a(".search-keys").html("").hide()}function s(e){var s=a(".search-keys");if(e&&e.length){s.html("");for(var r=0;r<e.length;r++)s.append('<div class="item">'+e[r]+"</div>");a("#txtSearchKey").attr("style","border-bottom-left-radius: 0;"),s.show()}else t();o=!1}function r(){var e=a("#txtSearchKey").val().trim();if(!o)return""==e?(n="",d=1,void t()):void(e.indexOf(n)>-1&&0==d||(o=!0,a.post("errorBook/search-keys",{key:e,subjectId:errorBook.params.subject},function(a){a.status?(n=e,d=a.data.length,s(a.data)):t()})))}errorBook.load(),a.get("errorBook/subjects").success(function(e){var t=a(".sn-subjects");if(t.html(""),e&&e.length){t.append('<div class="item" data-val="-1">不限</div>');for(var s=0;s<e.length;s++)t.append('<div class="item" data-val="'+e[s].key+'">'+e[s].value+"</div>")}});var i={"-1":"全部错题",1:"已过关",0:"未过关"};a(".sn-collect").delegate(".item","click",function(e){e.stopPropagation();var t=a(this),s=t.data("val");return errorBook.params.pass==s?(t.parents(".sing").data("open",0).removeClass("active"),void t.parent().hide()):(t.parents(".sing").data("open",0).removeClass("active").find("span").text(t.text()),t.parent().hide(),t.data("val",errorBook.params.pass).text(i[errorBook.params.pass]),errorBook.params.pass=s,errorBook.params.index=1,void errorBook.load())}),a(".sn-source").delegate(".item","click",function(e){e.stopPropagation();var t=a(this),s=parseInt(t.data("val"));if(!singer.isUndefined(s)){if(s==errorBook.params.source_type)return t.parents(".sing").data("open",0).removeClass("active"),void t.parent().hide();t.parents(".sing").data("open",0).removeClass("active").find("span").text(t.text()),t.parent().hide(),"0"!=s?t.data("val","0").text("试卷错题"):t.data("val","1").text("课本错题"),errorBook.params.source_type=s,errorBook.params.index=1,errorBook.load()}}),a(".sn-subjects").delegate(".item","click",function(e){e.stopPropagation();var t=a(this),s=parseInt(t.data("val"));if(!singer.isUndefined(s)){if(s==errorBook.params.subject)return t.parents(".sing").data("open",0).removeClass("active"),void t.parent().hide();var r=t.text();"-1"==s&&(r="学科"),t.parents(".sing").data("open",0).removeClass("active").find("span").text(r),t.parent().hide(),errorBook.params.subject=s,errorBook.params.type=-1,errorBook.params.index=1,errorBook.load();var i=a(".sn-types");i.parents(".sing").find("span").text("题型"),i.html(""),s>-1?a.get("errorBook/question-type?subjectId="+s).success(function(a){if(a.status&&a.data&&a.data.length){i.append('<div class="item" data-val="-1">不限</div>');for(var e=0;e<a.data.length;e++)i.append('<div class="item" data-val="'+a.data[e].id+'">'+a.data[e].name+"</div>")}}):i.append('<div class="item" data-val="-1">请选择学科</div>')}}),a(".sn-types").delegate(".item","click",function(e){e.stopPropagation();var t=a(this),s=parseInt(t.data("val"));if(!singer.isUndefined(s)){if(s==errorBook.params.type)return t.parents(".sing").data("open",0).removeClass("active"),void t.parent().hide();var r=t.text();"-1"==s&&(r="题型"),t.parents(".sing").data("open",0).removeClass("active").find("span").text(r),t.parent().hide(),errorBook.params.type=s,errorBook.params.index=1,errorBook.load()}}),a(".sn-times").bind("click",function(a){a.stopPropagation()}),a(".st-cancel").bind("click",function(){a(this).parents(".sing").data("open",0).removeClass("active"),a(".sn-times").hide()}),a(".st-ok").bind("click",function(){a(this).parents(".sing").data("open",0).removeClass("active").find("span").text("时间范围"),a(".sn-times").hide();var e=a("#txtStarDate").val(),t=a("#txtEndDate").val();""!=e&&""!=t?a(this).parents(".sing").find("span").text(e+" - "+t):""!=e?a(this).parents(".sing").find("span").text(e+" 开始"):""!=t&&a(this).parents(".sing").find("span").text(t+" 截止"),(e!=errorBook.params.start||t!=errorBook.params.expire)&&(errorBook.params.start=e,errorBook.params.expire=t,errorBook.params.index=1,errorBook.load())}),a(".sn-time-reset").bind("click",function(){a(this).parents(".sing").data("open",0).removeClass("active").find("span").text("时间范围"),a(".sn-times").hide(),a("#txtStarDate").val(""),a("#txtEndDate").val(""),(""!=errorBook.params.start||""!=errorBook.params.expire)&&(errorBook.params.start="",errorBook.params.expire="",errorBook.params.index=1,errorBook.load())}),a(".sn-reason").delegate(".item","click",function(e){e.stopPropagation();var t=a(this),s=parseInt(t.data("val"));if(!singer.isUndefined(s)){if(s==errorBook.params.has_reason)return t.parents(".sing").data("open",0).removeClass("active"),void t.parent().hide();var r=t.text();"-1"==s&&(r="错因分析"),t.parents(".sing").data("open",0).removeClass("active").find("span").text(r),t.parent().hide(),errorBook.params.has_reason=s,errorBook.params.index=1,errorBook.load()}}),a("#btnSearch").bind("click",function(){e()}),a("#txtSearchKey").bind("keyup",function(t){var s=t||window.event||arguments.callee.caller.arguments[0];if(s&&13==s.keyCode)a(this).data("idx","-99"),e(),a(this).blur();else if(!s||38!=s.keyCode&&40!=s.keyCode)a(this).data("idx","-99"),r();else{var i=a(".search-keys").find(".item");if(i.length<1)return;var o=0;if(o=singer.isUndefined(a(this).data("idx"))?-1:parseInt(a(this).data("idx")),-99==o){var n='<div class="item hide">'+a(this).val()+"</div>"+a(".search-keys").html();a(".search-keys").html(n),i=a(".search-keys").find(".item"),o=0}i.removeClass("active"),o+=38==s.keyCode?-1:1,o>=i.length&&(o=0),0>o&&(o=i.length-1),a(this).data("idx",o);var d=a(i[o]);d.addClass("active"),a(this).val(d.text())}});var o=!1,n="",d=1;a(".search-keys").delegate(".item","click",function(){a("#txtSearchKey").val(a(this).text()),e()}),a("#txtSearchKey").bind("blur",function(){setTimeout(t,200)}),a(".q-list").delegate(".span-pass","click",function(){var e=a(this),t=e.parents(".q-item").data("id"),s=!(1==e.data("pass"));a.post("errorBook/pass",{id:t,isPass:s},function(t){if(t.status){if(s?e.data("pass",1).html('<i class="iconfont dy-icon-48"></i> 已过关'):e.data("pass",0).html('<i class="iconfont dy-icon-five-star"></i> 过关'),errorBook.params.is_collect){var r=a(".e-total"),i=parseInt(r.text()||"0");i+=s?1:-1,0>i&&(i=0),r.text(i)}}else singer.msg(t.message)})}).delegate(".span-dw","click",function(){var e=a(this).parents(".q-item").data("id"),t=a(this).parents(".q-item").data("subject");errorBook.dw.refresh(e,t)&&(errorBook.dw.refreshHtml(),a(this).hasClass("dw-active")?a(this).removeClass("dw-active").html('<i class="fa fa-plus"></i> 加入下载</span>'):a(this).addClass("dw-active").html('<i class="fa fa-times"></i> 移除下载</span>'))}),a(".dw-power-p").bind("click",function(){a(this).hide(),a(".dw-body").show()}),a(".dw-power-c").bind("click",function(){a(".dw-body").hide(),a(".dw-power-p").show()}),a(".dw-dowload").bind("click",function(){errorBook.dw.download()}),a(".dw-reset").bind("click",function(){errorBook.dw.reset()}),a(".pagination").delegate("a","click",function(){var e=parseInt(a(this).data("num"));singer.isUndefined(e)||1>e||e==errorBook.params.index||(errorBook.params.index=e,errorBook.load())}),a(".sing").bind("click",function(){var e=a(this).data("open");a(".screen").find(".sing").data("open",0).removeClass("active"),a(".screen").find(".list").hide(),e||a(this).data("open",1).addClass("active").find(".list").show()})}),template.helper("showDowloadHtml",function(a){return errorBook.dw.check(a)?'<span class="oi collection-icon span-dw dw-active"><i class="fa fa-times"></i> 移除下载</span>&nbsp;&nbsp;':'<span class="oi collection-icon span-dw"><i class="fa fa-plus"></i> 加入下载</span>&nbsp;&nbsp;'});