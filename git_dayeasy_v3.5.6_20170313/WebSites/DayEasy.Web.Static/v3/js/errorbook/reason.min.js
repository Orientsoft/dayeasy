var reason=function(){var n={data:{eid:"",qid:"",batch:""},box:$(".reason-box"),templateLoaded:!1,load:function(t,e,i,a,s){n.data=t,n.box=e||n.box,n.templateLoaded?n.getData(i,a,s):singer.loadTemplate("reason-edit-v3",function(){n.templateLoaded=!0,n.getData(i,a,s)})},getData:function(t,e,i){$.post("/reason/load",{id:n.data.eid,question_id:n.data.qid,batch:n.data.batch},function(a){if(a.status){var s=a.data;n.box.html(singer.render("reason-item",s)),i&&(i.show_count||n.box.find(".s-count").remove()),s.tags&&s.tags.length&&s.content?e&&singer.isFunction(e)&&e.call(this):n.init(t)}})},init:function(t){var e=n.box,i=singer.tags({canEdit:!0,max:5,container:e.find(".d-tags"),change:function(n){e.find(".txt-reason-tag").val(n.join(" "));for(var t=e.find(".sys-tags span.selected"),i=0;i<t.length;i++){var a=t.eq(i),s=a.html();singer.inArray(s,n)||a.removeClass("selected")}}});e.find(".sys-tags span").bind("click",function(){var n=$(this);return n.hasClass("selected")?!1:void(i.set(n.text())&&n.addClass("selected"))}),e.find(".txt-reason-content").bind("keyup",function(){var n=140-$(this).val().length;0>n&&(n=0),e.find(".hight-num").text(n)}),e.find(".btn-reason-submit").bind("click",function(){var n="",i=[],a=e.find(".txt-reason-id").val().trim(),s=e.find(".txt-reason-content").val().trim(),o=e.find(".txt-reason-tag");if(!singer.isUndefined(o)&&"1"==o.data("untag")){if(n=o.val().trim(),""==n)return void singer.msg("请添加错因标签");var r=n.split(" ");if(!r||!r.length)return void singer.msg("请添加错因标签");for(var d=0;d<r.length;d++)if(""!=r[d].trim()){if(r[d].length>10)return void singer.msg("单个错因标签最多10个字符");for(var g=!1,l=0;l<i.length;l++)if(r[d]==i[l]){g=!0;break}g||i.push(r[d].replace(/'/g,""))}if(!i.length)return void singer.msg("请添加错因标签");if(i.length>5)return void singer.msg("最多添加5个错因标签");n=singer.json(i)}return""==n&&""==s?void singer.msg("请填写简短分析"):s.length>140?void singer.msg("简短分析最多140个字符"):void $.post("/reason/add",{id:a,content:encodeURIComponent(s),tag:encodeURIComponent(n),isOpen:!0},function(n){n.status?singer.msg("保存成功",2e3,function(){t&&singer.isFunction(t)?t.call(this,i,s):window.location.reload()}):singer.msg(n.message)})})}};return n}();