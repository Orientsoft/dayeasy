var dialogObj,voteData={};$(function(){var t=UE.getEditor("qContent",{toolbars:[["source","|","Undo","Redo","|","bold","italic","underline","|","forecolor","backcolor","insertorderedlist","insertunorderedlist","selectall","cleardoc","|","fontfamily","fontsize","|","justifyleft","justifycenter","justifyright","justifyjustify","|","imagenone","imageleft","imageright","imagecenter","|","link","unlink","anchor","|","emotion","insertimage","inserttable","deletetable","superscript","subscript","|","kityformula","spechars","fullscreen"]],serverUrl:$("#fileSite").val()+"/uploader",initialContent:"",autoClearinitialContent:!1,wordCount:!1,elementPathEnabled:!1,enableAutoSave:!1,enableContextMenu:!0,saveInterval:5e6,retainOnlyLabelPasted:!0,pasteplain:!1,initialFrameHeight:200}),e=singer.tags({container:$(".d-tags"),data:$(".d-tags").data("tags"),canEdit:!0,type:2,max:3,change:function(t){}});$("#btn_addVote").click(function(){var t=getVoteHtml();dialogObj=dialog({title:"添加投票",content:t,backdropBackground:"#000",backdropOpacity:.3}).showModal()}),$("#btn_pub").click(function(){var i=$("#topicTitle").val();if(!$.trim(i))return singer.msg("请输入帖子标题！"),$("#topicTitle").focus(),!1;if(i.length>250)return singer.msg("帖子标题最多250个字！"),$("#topicTitle").focus(),!1;var n=$("<div/>").text(t.getContent()).html();if(!t.hasContents())return singer.msg("请输入帖子内容！"),!1;var o=$("#groupId").val(),a=e.get(),l={};return l.Title=i,l.Content=n,l.Tags=a,l.GroupId=o,l.PubVote=voteData,$.post($("#saveUrl").val(),{topic:JSON.stringify(l)},function(t){t.Status?window.location=$("#redirectUrl").val():singer.msg(t.Message)}),!1})});var getVoteHtml=function(){var t=$($("#addVoteTemp").html());return t.find("#addOption").bind("click",function(){var t=$("#optionLis").children("li").length+1;$("#optionLis").append('<li><input type="text" placeholder="选项'+t+'" /><i class="iconfont dy-icon-close f-remove"></i></li>')}),t.delegate(".f-remove","click",function(){var t=$(this);singer.confirm("您确定要移除该选项？",function(){t.parent("li").remove(),$.each($("#optionLis").children("li"),function(t,e){$(e).find("input").prop("placeholder","选项"+(t+1))})},function(){})}),t.find("#btn_cancel").bind("click",function(){dialogObj.close().remove()}),t.find("#btn_sure").bind("click",function(){var t=$("#voteTitle").val();if(!$.trim(t))return singer.msg("请输入标题！"),$("#voteTitle").focus(),!1;var e=$("#optionLis").children("li");if(e.length<1)return singer.msg("请先添加选项！"),!1;var i=[];if($.each(e,function(t,e){var n=$(e).find("input").val();if(!$.trim(n))return singer.msg("选项内容不能为空！"),$(e).find("input").focus(),i=[],!1;var o={};o.Sort=t,o.OpContent=n,i.push(o)}),i.length<1)return!1;var n=$("input[name='chooseType']:checked").val(),o=$("#finishTime").val(),a=$("input[name='secret']:checked").val();return voteData={},voteData.Title=t,voteData.IsSingle=n,voteData.IsPublic=a,voteData.FinishedAt=o,voteData.VoteOptions=i,addVoteSuccess(),dialogObj.close().remove(),!1}),t},addVoteSuccess=function(){$("#btn_addVote").addClass("hide");var t=$($("#voteDetailTemp").html());t.find("#deleteVote").bind("click",function(){singer.confirm("您确定要删除该投票吗？",function(){$("#voteDetail").empty(),$("#btn_addVote").removeClass("hide"),voteData={}},function(){})}),t.find("#editVote").bind("click",editVote),t.find("#title").text("【投票】"+voteData.Title);var e=t.find("#voteOptions");$.each(voteData.VoteOptions,function(t,i){var n=0==t?"#fc6e51":1==t?"#ffce54":"#ccd1d9";e.append("<li><label>"+i.OpContent+'</label><em style="background: '+n+';"></em> 0</li>')}),$("#voteDetail").html(t)},editVote=function(){var t=getVoteHtml();t.find("#voteTitle").val(voteData.Title),t.find("#finishTime").val(voteData.FinishedAt),t.find("#optionLis").empty(),$.each(voteData.VoteOptions,function(e,i){t.find("#optionLis").append('<li><input type="text" value="'+i.OpContent+'" /><i class="iconfont dy-icon-close f-remove"></i></li>')}),dialogObj=dialog({title:"编辑投票",content:t,backdropBackground:"#000",backdropOpacity:.3,onshow:function(){"false"==voteData.IsSingle&&t.find("input[name='chooseType']:eq(1)").click(),"false"==voteData.IsPublic&&t.find("input[name='secret']:eq(1)").click()}}).showModal()};