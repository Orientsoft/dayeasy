!function(t,e){var a,n,i,r,s,o,d,l,c,v,u,h,p=t(".dw-variant-list"),f=t(".send-variant"),m="True"==p.data("variant"),g="True"==p.data("isab"),w=e.getLogger("page-variants"),b=[],k={},y=0;n=p.data("batch"),i=p.data("paper"),Array.prototype.remove=function(t){var e=this.indexOf(t);e>-1&&this.splice(e,1)},template.helper("optionModel",function(t){return e.optionModel(t)?"q-options-horizontal":""}),template.helper("correctAnswer",function(t){return e.getCorrectAnswers(t)}),m?(t.get("/work/teacher/variant-list",{batch:n,paper_id:i},function(n){if(n.status){var i=n.data.questions,r=n.data.variants;for(a=0;a<r.length;a++){var s=r[a];s.model=i[s.id],s.title=g?(1==s.sectionType?"A":"B")+"卷 - 第"+s.sort:"第"+s.sort,s.variants=[];for(var o=0;o<s.variantIds.length;o++)s.variants.push(i[s.variantIds[o]]),b.push(s.variantIds[o])}var d=template("variantQuestion",r);p.html(d),t(".download-variant").undisableFieldset(),e.loadFormula()}}),u=function(){e.open(e.format("/work/dowload_variant?data={0}&title={1}",encodeURIComponent(e.json(b)),"变式训练题"))},t(".download-variant").bind("click",function(){u()})):(r=function(t,a){var n=!1;for(var i in k)if(k.hasOwnProperty(i)&&i==t){k[i].push(a),n=!0;break}n||(k[t]=[a]),y++,f.html(e.format("推送变式<small>(共{0}题)</small>",y)).undisableFieldset()},s=function(t,a){for(var n in k)if(k.hasOwnProperty(n)&&n==t){k[n].remove(a),0==k[n].length&&delete k[n],y--,y>0?f.html(e.format("推送变式<small>(共{0}题)</small>",y)):f.html("推送变式").disableField();break}},l=function(a,n,i,o,d){if(!a.length)return!1;var c,v=a.data("qid"),u=a.find(".dwv-list");n&&n.length&&(c=n.data("qid")),t.post("/work/teacher/variant",{qid:v,isdata:d,count:1,excepts:b.join(",")},function(t){u.find(".dy-loading,.dy-nothing").remove();var h=a.find(".add-variant");if(t.count>0){var p=t.data[0],f=template("variantItem",p);c?(n.replaceWith(f),s(v,c),!i&&e.msg("更换成功！")):(u.append(f),!i&&e.msg("添加成功！")),b.push(p.id),r(v,p.id),u.find(".dwv-item").length>=3?h.disableField():h.undisableFieldset(),!i&&e.loadFormula()}else 0==u.find(".dwv-item").length?(u.html('<div class="dy-nothing">没有相关变式题！</div>'),d&&l(a,n,i,o,0)):(!i&&e.msg("已没有更多的变式题！"),c&&n.find(".change-variant").remove()),h.disableField();e.later(function(){o&&e.isFunction(o)&&o.call(this)},300)})},d=function(){var a=t(".dw-variant-item");if(0==a.length)return!1;var n=-1,i=function(){return n>=a.length-1?(e.loadFormula(),!1):(n++,void l(a.eq(n),!1,!0,i,1))};i()},o=function(){t.get("/work/teacher/variant-paper",{batch:n,paper_id:i},function(t){if(!t.status)return!1;var e=t.data.questions,n=t.data.variants;if(0==n.length||0==e.length)return p.html('<div class="dy-nothing">同学们没有错题信息！</div>'),!1;for(a=0;a<n.length;a++){var i=n[a];i.model=e[i.id],i.title=g?(1==i.sectionType?"A":"B")+"卷 - 第"+i.sort:"第"+i.sort,b.push(i.id)}var r=template("variantQuestion",n);p.html(r),d()})},o(),c=function(t,e){if(!t.length||!e.length)return!1;var a=t.data("qid"),n=e.data("qid");s(a,n),b.remove(n);var i=e.parents(".dwv-list");return e.remove(),w.info(k),0==i.find(".dwv-item").length?i.append('<div class="dy-othing">请添加变式题！</div>').data("isnodiv","false"):i.data("isnodiv","true"),t.find(".add-variant").removeClass("disabled").removeAttr("disabled"),!0},v=function(){var n,r=[],s=function(){t.post("/work/teacher/send-variant",{paper_id:i,class_ids:r.join(","),variants:e.json(k)},function(t){t.status?e.alert("推送成功！",function(){location.reload(!0)}):e.alert(t.message)})};n=t('<div class="dwv-classes">');for(var o in h)h.hasOwnProperty(o)&&n.append('<label class="checkbox-group group-checkbox"><input type="checkbox" checked="checked" class="groupItem" value="'+o+'" name="options"><span>'+h[o]+'</span><i class="iconfont dy-icon-checkbox dy-icon-checkboxhv"></i></label>');e.dialog({title:"推送变式题",content:n,okValue:"确认推送",ok:function(){var n=t(this.node).find('input[type="checkbox"]:checked');if(0==n.length)return e.msg("请选择要推送变式的班级！"),!1;for(w.info(n.length),a=0;a<n.length;a++)r.push(n.eq(a).val());s()}}).showModal()},f.bind("click",function(){h?v():t.get("/work/teacher/usage-list",{paper_id:i},function(t){t.status?(h=t.data,v()):(e.alert(t.message),f.disableField())})})),p.delegate(".dwv-source span i","mouseenter",function(){t(this).parents(".dwv-source").siblings(".dwv-source-box").addClass("hover")}).delegate(".dwv-source span i","mouseleave",function(){t(this).parents(".dwv-source").siblings(".dwv-source-box").removeClass("hover")}).delegate(".variant-answer","click",function(){t(this).toggleClass("dy-btn-info"),t(this).parents(".dwv-item").find(".dwv-answer").toggleClass("hide"),t(this).blur()}).delegate(".dwv-item","mouseenter",function(){t(this).addClass("hover")}).delegate(".dwv-item","mouseleave",function(){t(this).removeClass("hover")}).delegate(".add-variant","click",function(){t(this).disableField();var e=t(this).parents(".dw-variant-item");l(e)}).delegate(".change-variant","click",function(){var e=t(this).parents(".dw-variant-item"),a=t(this).parents(".dwv-item");l(e,a)}).delegate(".delete-variant","click",function(){var a=t(this).parents(".dw-variant-item"),n=t(this).parents(".dwv-item");c(a,n)&&e.msg("删除成功！")})}(jQuery,SINGER);