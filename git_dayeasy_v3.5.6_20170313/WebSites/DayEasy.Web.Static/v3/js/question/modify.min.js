var logger=singer.getLogger("modifyCtrl"),modifyCtrl=["$scope","$http","$sce",function(e,t,n){var s=!1;e.qType="",e.tagState=!1,e.typeTags=[],e.points=[],e.saving=!1;var i,o,r=singer.sites["static"]+"/plugs/raty/images/";e.optionWords=singer.optionWords;var a=function(){var e=new RegExp("/modify/([0-9a-z]{32})","gi");return location.href.match(e),RegExp.$1};t.get("/question/load/"+a()).success(function(t){t.status?(e.question=t.data,e.question.tags=e.question.tags||[],e.question.knowledges=e.question.knowledges||[],e.question.details=e.question.details||[],u()):logger.warn(t)}).error(function(e){logger.info(e)});var u=function(){$(".q-star").raty({path:r,score:e.question.difficulty,hints:["容易","普通","一般","困难","极难"],click:function(t,n){e.question.difficulty=t}}),e.stages=singer.stages.concat().splice(e.question.stage-1,1),e.question.stage=e.stages[0].id,t.post("/sys/qtype/"+e.question.type).success(function(t){e.qTypes=t,o=t[0],e.typeTags=singer.getTags(o.style||0)}),e.QTypeChg=function(){for(var t=0;t<e.qTypes.length;t++)e.qTypes[t].id==e.question.type&&(o=e.qTypes[t])},singer.tags({canEdit:!0,max:5,data:e.question.tags,change:function(t){e.question.tags=t,e.$digest()}});var n=$("#kPoints").tokenInput("/sys/knowledges?stage="+e.question.stage,{method:"POST",queryParam:"keyword",hintText:"请输入知识点关键字",noResultsText:"没有找到相关知识点",searchingText:"查询中，请稍候...",placeholder:"输入知识点关键字",tokenLimit:5,propertyToSearch:"path",excludeCurrent:!1,prePopulate:e.question.knowledges,tokenFormatter:function(e){var t=e.name;return"<li><p>"+t+"</p></li>"},onAdd:function(){e.question.knowledges=n.tokenInput("get"),e.$digest()},onDelete:function(){e.question.knowledges=n.tokenInput("get"),e.$digest()}});setTimeout(function(){var e=$(".qth-content").find("textarea");e.each(function(e,t){var n=t.scrollHeight+12;n=n>220?220:n,$(t).css("height",n)}),singer.loadFormula()},200)};e.showSection=function(t){return singer.inArray(singer.getTag(t)||"",e.typeTags)},e.add=function(e){e=e||[],e.push({body:"",images:[],sort:e.length})},e.del=function(e,t){if(!singer.isArray(t))return!1;t.splice(e,1);for(var n=0;n<t.length;n++)t[n].sort=n},e.setCorrect=function(e,t){if(!o.multi&&!e.isCorrect)for(var n=0;n<t.length;n++)t[n].isCorrect=!1;e.isCorrect=!e.isCorrect,s=!0},e.uploadImg=function(e){e=e||{},e.images=e.images||[],i=e,$(".webuploader-element-invisible").click()},e.getImageUrl=function(e,t,n){return singer.makeThumb(e,t,n)},e.editText=function(t){singer.textEditor(t,function(){e.$digest(),setTimeout(singer.loadFormula,120)})},e.trustHtml=function(e){return e?(e=singer.formatText(e),n.trustAsHtml(e)):""},e.save=function(n){if(e.saving)return!1;var s=e.question;if(!singer.checkQuestion(s,o))return!1;e.saving=!0;var i=function(){e.saveAs="copy"===n;var i=e.saveAs?"save-as":"save";t.post("/question/"+i,s).success(function(t){t.status?($(window).unbind("beforeunload.question"),singer.confirm("保存成功，是否返回列表？",function(){location.href="/question"},function(){e.step=1,e.saving=!1,e.editorText="",e.$digest()},["返回列表","继续编辑"])):(singer.msg(t.message),e.saving=!1)}).error(function(t){singer.msg("网络请求异常，请稍后重试！"),e.saving=!1})},r=function(){t.post("/question/save-knowledge",{id:s.id,knowledges:encodeURIComponent(singer.json(s.knowledges))}).success(function(t){t.status?singer.alert("保存成功！"):singer.msg(t.message),e.saving=!1}).error(function(t){singer.msg("网络请求异常，请稍后重试！"),e.saving=!1})};"knowledge"===n?r():i()},singer.uploader.on("uploadSuccess",function(t,n){n.state&&(i.images=n.urls,e.$digest()),singer.uploader.reset()}),singer.uploader.on("uploadError",function(e){})}];!function(e,t){e(document).delegate(".q-tag","click",function(){return!1}).delegate(".qth-editor","mouseenter",function(){e(this).addClass("qth-editor-hover")}).delegate(".qth-editor","mouseleave",function(){e(this).removeClass("qth-editor-hover")}).delegate(".image-view","mouseenter",function(){e(this).addClass("image-hover")}).delegate(".image-view","mouseleave",function(){e(this).removeClass("image-hover")}).delegate(".btn-return","click",function(){return location.href="/question",!1})}(jQuery,SINGER);