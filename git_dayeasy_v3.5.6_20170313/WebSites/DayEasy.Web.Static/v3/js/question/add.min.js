var logger=singer.getLogger("addCtrl"),addCtrl=["$scope","$http","$sce",function(e,t,n){e.qt={stage:"",type:"",range:0,subject_id:"",points:[],tags:[],difficulty:3},e.qType=-1,e.qTypes=[{id:-1,name:"请选择题型"}],e.editorText="",e.step=1,e.tagState=!1,e.typeTags=[],e.points=[],e.saving=!1,e.ranges=singer.ranges.concat();var i,s;(function(){t.post("/question/init").success(function(t){e.qt.subjectId=t.subjectId,e.stages=t.stages,e.qTypes=e.qTypes.concat(t.types),e.qType=-1,1==e.stages.length&&(e.qt.stage=e.stages[0].id)}),singer.tags({canEdit:!0,max:5,change:function(t){e.qt.tags=t,e.$digest()}})})();$(".b-tag").keypress(function(t){13==t.keyCode&&e.addTag()}),e.clearEditor=function(){e.editorText=""};var o=singer.sites["static"]+"/plugs/raty/images/";$(".q-star").raty({path:o,score:e.qt.difficulty,hints:["容易","普通","一般","困难","极难"],click:function(t,n){e.qt.difficulty=t}}),$(window).bind("beforeunload.question",function(){return"离开当前页面，数据将不会被保存，是否继续？"}),e.setStep=function(t){var n=function(){if(2==t){if(e.questionForm.stage.$invalid||e.questionForm.qType.$invalid||e.qType<0||!e.qt.knowledges||e.qt.knowledges.length<1)return!1;e.qt.type=e.qType,logger.info(e.qt);for(var n=0;n<e.qTypes.length;n++)if(e.qTypes[n].id==e.qType){s=e.qTypes[n],e.typeTags=singer.getTags(s.style||0);break}}if(3==t){if(!e.editorText)return!1;e.question=singer.recognition($("#q-editor").val(),e.typeTags),logger.info(e.question),setTimeout(function(){$("body,html").animate({scrollTop:$(".step-03").offset().top},"fast");var e=$(".qth-content").find("textarea");e.each(function(e,t){var n=t.scrollHeight+12;n=n>220?220:n,$(t).css("height",n)})},200)}e.step=t};e.step>=t?2==t?singer.confirm("你刚才切换了题型，是否初始化出题界面？<br/>如果不初始化出题界面可能导致界面不符合你出题型的要求...",function(){e.editorText="",e.question={},n(),e.$digest()},function(){n(),e.$digest()}):3==t&&singer.confirm("你刚才重新点击了快速出题，是否确认重置题目详情界面？",function(){n(),e.$digest()},function(){return!1}):n()},e.showSection=function(t){return singer.inArray(singer.getTag(t)||"",e.typeTags)},e.optionWords=singer.optionWords;var r=$("#kPoints").tokenInput("/sys/knowledges?stage=",{method:"POST",queryParam:"keyword",hintText:"",noResultsText:"没有找到相关知识点",searchingText:"Searching...",placeholder:"输入知识点关键字",tokenLimit:10,propertyToSearch:"path",tokenFormatter:function(e){var t=e.name;return"<li><p>"+t+"</p></li>"},excludeCurrent:!1,preventDuplicates:!0,onAdd:function(){e.qt.knowledges=r.tokenInput("get"),e.$digest()},onDelete:function(){e.qt.knowledges=r.tokenInput("get"),e.$digest()}});e.add=function(e){e=e||[],e.push({body:"",images:[],sort:e.length})},e.del=function(e,t){if(!singer.isArray(t))return!1;t.splice(e,1);for(var n=0;n<t.length;n++)t[n].sort=n},e.setCorrect=function(e,t){if(!s.multi&&!e.isCorrect)for(var n=0;n<t.length;n++)t[n].isCorrect=!1;e.isCorrect=!e.isCorrect},e.uploadImg=function(e){e=e||{},e.images=e.images||[],i=e,$(".webuploader-element-invisible").click()},e.getImageUrl=function(e,t,n){return singer.makeThumb(e,t,n)},e.editText=function(t){singer.textEditor(t,function(){e.$digest(),setTimeout(singer.loadFormula,120)})},e.trustHtml=function(e){return e?(e=singer.formatText(e),n.trustAsHtml(e)):""},e.save=function(){if(e.saving)return!1;var n=$.extend({},e.question,e.qt);return logger.info(n),singer.checkQuestion(n,s)?(e.saving=!0,void t.post("/question/save",n).success(function(t){t.status?($(window).unbind("beforeunload.question"),singer.confirm("老师辛苦了，题已加入<span class='tip-color'>题库</span>啦！",function(){location.href="/question"},function(){e.step=1,e.saving=!1,e.editorText="",e.$digest()},["回到题库","继续添加"])):(singer.msg(t.message),e.saving=!1)}).error(function(t){singer.msg("网络请求异常，请稍后重试！"),e.saving=!1,console.log(t)})):!1},$('select[name="stage"]').bind("change",function(){var t=$(this).find("option:selected").val();$("#kPoints").data("settings").url="/sys/knowledges?stage="+t,e.qt.knowledges=[],r.tokenInput("clear")}),singer.uploader.on("uploadSuccess",function(t,n){n.state&&(i.images=n.urls,e.$digest()),singer.uploader.reset()}),singer.uploader.on("uploadError",function(e){})}];!function(e,t){e(document).delegate(".q-tags li","click",function(){var n="【"+e(this).html()+"】",i=e("#q-editor").get(0);t.insertText(i,n)}).delegate(".q-tag","click",function(){return!1}).delegate(".step-text","click",function(){var t=e(this).parents(".q-step");return t.hasClass("step-active")?void e("body,html").animate({scrollTop:t.offset().top},"fast"):!1}).delegate(".qth-editor","mouseenter",function(){e(this).addClass("qth-editor-hover")}).delegate(".qth-editor","mouseleave",function(){e(this).removeClass("qth-editor-hover")}).delegate(".image-view","mouseenter",function(){e(this).addClass("image-hover")}).delegate(".image-view","mouseleave",function(){e(this).removeClass("image-hover")}).delegate(".btn-return","click",function(){location.href="/question"}).delegate(".q-help li","click",function(){e.get(singer.sites["static"]+"/data/question-helper.html",{t:Math.random()},function(e){singer.dialog({title:"快速出题 - 帮助文档",content:e,height:420}).showModal()})});var n=e(".step-text"),i=function(e){var t=function(e){var t=n.eq(e);t.data("opt",{top:t.offset().top,left:t.offset().left,h:t.height()})};if(singer.isNumber(e))t(e);else for(var i=0;i<n.length;i++)t(i)};e(function(){i()});var s=5;e(window).bind("scroll.step",function(){for(var t,o,r=e(this).scrollTop(),a=0;a<n.length;a++)t=n.eq(a),o=t.data("opt"),r>=o.top-a*(o.h+s)?t.data("fixed")||(t.css({position:"fixed",top:(o.h+s)*a,left:o.left}),t.data("fixed",!0)):t.data("fixed")?(t.css({position:"relative",top:0,left:0}),t.data("fixed",!1)):i(a)})}(jQuery,singer);