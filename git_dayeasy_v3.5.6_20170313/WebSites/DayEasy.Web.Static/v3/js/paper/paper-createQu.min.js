$(function(){var e=$("#stage").val(),t=$("#kPoints").tokenInput("/sys/knowledges?stage="+e,{method:"POST",queryParam:"keyword",hintText:"",noResultsText:"没有找到相关知识点",searchingText:"Searching...",placeholder:"输入知识点关键字",tokenLimit:5,propertyToSearch:"path",tokenFormatter:function(e){var t=e.name;return"<li><p>"+t+"</p></li>"},excludeCurrent:!1,preventDuplicates:!0}),a=UE.getEditor("qContent",{toolbars:[["source","|","Undo","Redo","|","bold","italic","underline","|","insertimage","inserttable","deletetable","superscript","subscript","|","kityformula","spechars"]],serverUrl:$("#fileSite").val()+"/uploader",initialContent:"",autoClearinitialContent:!0,wordCount:!1,elementPathEnabled:!1,enableAutoSave:!1,enableContextMenu:!0,saveInterval:5e6,retainOnlyLabelPasted:!0,pasteplain:!1,initialFrameHeight:200});$(".f-success").click(function(){var n=parseInt($("#selectedQtype").val()),i=t.tokenInput("get"),s=$("<div/>").text(a.getContent()).html(),r=$("#optionNum").children("option:selected").val(),o=parseInt($("#smallQuNum").val());if(!n||isNaN(n))return singer.msg("请先选择题型！"),!1;if(!a.hasContents())return singer.msg("请输入题目内容！"),!1;var l=window.getSmallQtype();if(isNaN(o)&&(o=0),$.inArray(n,l)>-1&&r>0&&1>o)return singer.msg("请输入小问数！"),!1;if(!i||i.length<1)return singer.msg("请输入知识点！"),!1;var p=$(this).data("atype");$.post($("#saveQuUrl").val(),{qtype:n,kps:JSON.stringify(i),qContent:s,optionNum:r,smallQuNum:o,stage:e},function(e){if(e.Status){var t=window.GetPaperInfo();if(t){var a={};a.QId=e.Data,a.Type=n,a.Score=0,a.Sort=0,a.PaperType=p;var i=[],s=[];if(t.ChooseQus){s=t.ChooseQus;var r=s[n];r&&(a.Sort=r.length+1,i=r)}i.push(a),s[n]=i,t.ChooseQus=s}var o=$("<form></form>");window.location.hash="actionDiv_"+p,o.attr("action",window.location.href),o.attr("method","post"),o.attr("target","_self");var l=$('<input type="hidden" name="paperBase" />');l.attr("value",JSON.stringify(t)),o.append(l),o.appendTo("body"),o.submit()}else singer.msg(e.Message)})}),$(".f-qtype").click(function(){var e=$(this).data("qtype");$(this).addClass("z-sel").siblings().removeClass("z-sel"),$("#f-getmore").removeClass("z-sel").attr("data-qtype","").children("span").text("更多"),$("#f-getmore").parents("div.col-sm-12").css("z-index","100"),window.showOptionAndSmallQu(e)}),$("#f-getmore").click(function(){return $(this).next("div.f-more-p").hasClass("hide")?($(this).parents("div.col-sm-12").css("z-index","2001"),$(this).next("div.f-more-p").removeClass("hide")):($(this).parents("div.col-sm-12").css("z-index","100"),$(this).next("div.f-more-p").addClass("hide")),!1}),$("div.f-more-p ul li").click(function(){var e=$(this).children("a").text(),t=$(this).children("a").data("qtype");$(".f-qtype").removeClass("z-sel"),$("#f-getmore").addClass("z-sel").attr("data-qtype",t).children("span").text(e),window.showOptionAndSmallQu(t)}),$(document).bind("click",function(){$("#f-getmore").parents("div.col-sm-12").css("z-index","100"),$("#f-getmore").next("div.f-more-p").addClass("hide")})});var GetPaperInfo=function(){for(var e=[],t=$("ul.paper-qContent"),a=0;a<t.length;a++){var n=$(t[a]).data("qtype"),i=$(t[a]).data("section"),s=[];e[n]&&(s=e[n]);var r=$(t[a]).children("li");$.each(r,function(e,t){var a={};a.QId=$(t).data("qid"),a.Type=n;var r=parseFloat($(t).find("input.qScore").val());isNaN(r)&&(r=0),a.Score=r,a.Sort=e,a.PaperType=i,s.push(a)}),e[n]=s}var o=[],l=$(".paper-qSection").children("li");l&&$.each(l,function(e,t){var a=$(t).children("ul.paper-qContent");if(a){var n=$(t).find(".q-perscore").val();(!n||isNaN(n))&&(n=0);var i={};i.QSectionType=$(a).data("qtype"),i.PaperType=$(a).data("section"),i.PerScore=n,o.push(i)}});var p={};return p.Type=$("#type").val(),p.Stage=$("#stage").val(),p.AddType=$(this).data("atype"),p.Title=$("#paperTitle").val(),p.ChooseQus="",p.PerScores="",p.AutoData=$("#autoData").val(),e.length>0&&(p.ChooseQus=e),o.length>0&&(p.PerScores=JSON.stringify(o)),p},showOptionAndSmallQu=function(e){var t=window.getOptionQtype(),a=window.getSmallQtype();$("#optionDiv").addClass("hide").find("select").val(0),$("#smallQuDiv").addClass("hide").find("input").val(""),$.inArray(e,t)>-1&&$("#optionDiv").removeClass("hide"),$.inArray(e,a)>-1&&$("#smallQuDiv").removeClass("hide"),$("#selectedQtype").val(e),1==e?$("#optionDiv").find("select").val(4):$("#optionDiv").find("select").val(0)},checkNum=function(e){e.value=e.value.replace(/\D/g,""),e.value.length>2&&(e.value=e.value.substring(0,2))},getOptionQtype=function(){var optionStr=$("#hasOptionQType").val(),options=eval("("+optionStr+")");return options},getSmallQtype=function(){var smallStr=$("#hasSmallQType").val(),smalls=eval("("+smallStr+")");return smalls};