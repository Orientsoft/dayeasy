!function($){$.fn.PaperMaker=function(e){var a=new paperMaker(this,e);return a.create(),$("body").append('<div id="ajaxModel" style="z-index: 10000;position: absolute;height: 100%;width: 100%;left: 0;top: 0;" class="hide"><div class="text-center"><span id="dyloading" style="position:fixed; z-index: 1000;top: 50%;left:50%;"><i class="fa fa-spin fa-spinner fa-3x" ></i><br /><br />正在加载，请稍后...</span></div></div>'),$.ajaxSetup({beforeSend:function(e){$("#ajaxModel").removeClass("hide")},complete:function(e,a){$("#ajaxModel").addClass("hide")}}),$(this)};var $paperDetailDiv=$("#paperDetailDiv"),$paperQSection=$(".paper-qSection"),$btnSaveTemp=$("#btn_SaveTemp"),$btnSave=$("#btn_Save"),$addQuestion=$(".f-addQuestion"),$paperMaker,paperMaker=function(e,a){this.$element=$(e),this.defaults={addQuestionUrl:"",chooseQuestionUrl:"",chooseQuCompleteUrl:"",inputAnswerUrl:""},this.options=$.extend({},this.defaults,a)};paperMaker.prototype={create:function(){$paperMaker=this,this.UpdateQScoreAndNum(),this.questionContentDragEnd(),questionContentDrag($paperQSection),$(document).delegate(".q-perscore,.qScore","keyup",function(){var e=$(this);/(\d{1,2}((\.\d)|\.)?)/.test(e.val())?e.val(RegExp.$1):e.val("")}).delegate(".q-perscore,.qScore","change",function(){var e=$(this);/(\d{1,2}(\.\d)?)/.test(e.val())?e.val(RegExp.$1):e.val("")}),$("#paperTitle").on("keyup",function(){var e=$(this).val().length;$(this).attr("size",e)}),$paperQSection.dragsort({dragSelectorExclude:"input,textarea,i",dragEnd:this.questionSectionDragEnd}),$paperDetailDiv.delegate("i.s-del","click",this.sectionDel),$paperDetailDiv.delegate("i.paper-del","click",this.questionDel),$paperDetailDiv.delegate("input.q-perscore","blur",this.UpdatePerScore),$paperDetailDiv.delegate("input.qScore","blur",this.UpdateQScoreAndNum),$btnSaveTemp.bind("click",this.paperSaveTemp),$btnSave.bind("click",this.makePaper),$addQuestion.bind("click",this.addQuestion),$("#inputAnswerDiv").delegate("#btnSureAnswer","click",this.paperSave),$(".f-createQu").bind("click",this.showAddQuestion)},questionSectionDragEnd:function(){$paperMaker.updateSectionNo($(this).parent("ul")),$paperMaker.questionContentDragEnd()},questionContentDragEnd:function(){var e=$("ul.paper-qContent").children("li");$.each(e,function(e,a){$(a).find("div.sortNum").text(e+1+".")})},sectionDel:function(){var e=$(this);$.Dayez.confirm("您确定要删除该题型及其下面的题目？",function(){var a=e.parent("h3").parent("li"),t=a.parent("ul.paper-qSection"),r=a.attr("id"),n=$.trim(r).split("_")[1];r.indexOf("A")>0?$("#qTypesA,#qTypes").find("ul li.sel[data-value='"+n+"']").removeClass("sel"):$("#qTypesB").find("ul li.sel[data-value='"+n+"']").removeClass("sel"),a.remove(),$paperMaker.updateSectionNo(t),$paperMaker.questionContentDragEnd()},function(){})},questionDel:function(){var e=$(this),a=$.Dayez.confirm("您确定要删除该题目？",function(){var t=e.parents("li.m-lst-1"),r=t.parent("ul");if(1==r.children("li").length){var n=r.parent("li").parent("ul.paper-qSection");r.parent("li").remove(),$paperMaker.updateSectionNo(n)}else t.remove();$paperMaker.UpdateQScoreAndNum(),$paperMaker.questionContentDragEnd(),a[0].close().remove()},function(){a[0].close().remove()})},updateSectionNo:function(e){var a=e.children("li");$.each(a,function(e,a){$(a).find("h3 span:first").text(convertToChinese(e+1)+".")}),$paperMaker.UpdateQScoreAndNum()},UpdatePerScore:function(){var e=parseFloat($(this).val());return isNaN(e)?!1:($(this).parents("li").find("input.qScore").val(e),void $paperMaker.UpdateQScoreAndNum())},UpdateQScoreAndNum:function(){var e=$paperDetailDiv.find("ul.paper-qSection"),a=0,t=$("#tScoreA"),r=$("#tScoreB"),n=$("#tScore");$.each(e,function(n,i){var o=$(i).children("li"),p=0;$.each(o,function(e,a){var t=$(a).find("ul.paper-qContent li");$(a).find("span.qCNum").text(t.length);var r=0,n=$(a).find("input.qScore");$.each(n,function(e,a){var t=parseFloat($(a).val());isNaN(t)||(r=$.Operation.Add(r,t))}),$(a).find("span.qCScore").text(r),p=$.Operation.Add(p,r)}),e.length>1&&0==n?t.text(p):e.length>1&&1==n&&r.text(p),a=$.Operation.Add(a,p)}),n.text(a)},getPaperData:function(e){var a={};a.PaperTitle=$("#paperTitle").val(),a.PaperType="A",a.PScores={},a.PScores.TScore=parseFloat($("#tScore").text()),a.PScores.TScoreA=0,a.PScores.TScoreB=0,$("#tScoreA").length>0&&(a.PaperType="AB",a.PScores.TScoreA=parseFloat($("#tScoreA").text()),a.PScores.TScoreB=parseFloat($("#tScoreB").text()));var t=[1,2,3,4,18,24];a.PSection=[];var r=$paperDetailDiv.children("ul.paper-qSection");return $.each(r,function(r,n){var i="A";r>0&&(i="B");var o=$(n).children("li");$.each(o,function(r,n){var o=parseInt($(n).children("ul.paper-qContent").data("qtype"));if(e&&$.inArray(o,t)<0)return!0;var p={};p.Sort=r+1,p.Description=$(n).find("h3 input.u-ipt-1").val(),p.PaperSectionType=i,p.SectionQuType=o,p.SectionScore=0,p.Questions=[];var s=$(n).find("ul.paper-qContent").children("li");$.each(s,function(e,a){var t={};t.Sort=e+1,t.QuestionID=$(a).data("qid"),t.Score=0,t.SmallQuestionScore=[];var r=$(a).find("input.qScore"),n=$(a).find("div.smallquestion").children("div.q-detail");if(1==r.length||n.length<1){var i=parseFloat($(r).val());isNaN(i)&&(i=0),t.Score=i}else $.each(r,function(e,a){var r={};r.QuestionID=$(a).parent("span").data("qid");var n=parseFloat($(a).val());isNaN(n)&&(n=0),r.Score=n,t.SmallQuestionScore.push(r),t.Score=$.Operation.Add(t.Score,n)});p.Questions.push(t)}),$.each(p.Questions,function(e,a){p.SectionScore=$.Operation.Add(p.SectionScore,a.Score)}),a.PSection.push(p)})}),a},paperSaveTemp:function(){if(!validateChooseQu())return!1;var e=$(".fa-createQuDiv:visible");return e.length>0?$.Dayez.confirm("还有题目没有保存 , 您确定要放弃该题目吗？",function(){$paperMaker.showSaveDiv(!0)},function(){}):$paperMaker.showSaveDiv(!0),!1},makePaper:function(){if(!validateChooseQu())return!1;var e=$(".fa-createQuDiv:visible");return e.length>0?$.Dayez.confirm("还有题目没有保存 , 您确定要放弃该题目吗？",function(){validateScore()?$paperMaker.inputAnswer():$.Dayez.confirm("还有题目没有录入分数 , 您确定要生成试卷吗？",function(){$paperMaker.inputAnswer()},function(){})},function(){}):validateScore()?$paperMaker.inputAnswer():$.Dayez.confirm("还有题目没有录入分数 , 您确定要生成试卷吗？",function(){$paperMaker.inputAnswer()},function(){}),!1},paperSave:function(){return validateAnswer()?($paperMaker.showSaveDiv(!1),!1):!1},showSaveDiv:function(isTemp){var saveUrl="/Paper/SavePaperData",paperData=$paperMaker.getPaperData(),savePaperStr=$("#savePaper").html().replaceAll("{name}",paperData.PaperTitle),title=isTemp?"保存草稿":"生成试卷";if(isTemp){var tipStr=$(savePaperStr).find("#saveTip").html();savePaperStr=savePaperStr.replace(tipStr,"")}var tags,$tags,d=singer.dialog({title:title,content:$(savePaperStr),onshow:function(){$tags=$(".d-tags");var data=$tags.data("tags")||[];singer.isString(data)&&(data=eval("("+data+")")),tags=singer.tags({container:$tags,data:data,canEdit:!0,type:2,max:5,change:function(e){}})},okValue:"确定",ok:function(){paperData.Tags=tags.get();var e=$("#paperName").val();if(!e)return $("#paperName").focus(),!1;paperData.PaperTitle=e;var a=$("#grade").children("option:selected").val();if(parseInt(a)<0)return $("#grade").focus(),!1;paperData.Grade=a;var t=JSON.stringify(paperData),r=$("#paperId").val(),n=$("#shareSchool").is(":checked"),i="";return isTemp||(i=JSON.stringify($paperMaker.getPaperAnswer())),$(".ui-dialog-button").children("button").attr("disabled","disabled"),$.post(saveUrl,{isTemp:isTemp,paperId:r,paperData:t,shareSchool:n,answers:i},function(e){e.Status?(d.close().remove(),window.location="/Paper/Index"):($(".ui-dialog-button").children("button").removeAttr("disabled"),singer.msg(e.Message))}),!1},cancelValue:"取消",cancel:function(){},backdropBackground:"#000",backdropOpacity:.3}).showModal()},showAddQuestion:function(){var e=$(this),a=$(".fa-createQuDiv"),t=e.parent().next();return t.length&&a.length?void(e.data("show")?(t.hide(),e.data("show",!1).removeClass("btn-danger").addClass("btn-warning").html('<i class="fa fa-plus"></i> 录入新题')):(a.not(t).data("loaded",!1).hide().children("div").empty(),$(".f-createQu").not(e).data("show",!1).removeClass("btn-danger").addClass("btn-warning").html('<i class="fa fa-plus"></i> 录入新题'),t.data("loaded")?(t.show(),e.data("show",!0).removeClass("btn-warning").addClass("btn-danger").html('<i class="fa fa-times"></i> 取消录入')):(e.attr("disabled","disabled").addClass("disabled"),t.show(),$.ajax({url:$paperMaker.options.addQuestionUrl,data:{},type:"POST",beforeSend:function(){},success:function(a){t.children("div").html(a),t.children("span").addClass("hide"),e.removeAttr("disabled").removeClass("disabled"),t.data("loaded",!0),e.data("show",!0).removeClass("btn-warning").addClass("btn-danger").html('<i class="fa fa-times"></i> 取消录入')}})))):!1},addQuestion:function(){for(var e=[],a=$("ul.paper-qContent"),t=0;t<a.length;t++){var r=$(a[t]).data("qtype"),n=$(a[t]).data("section"),i=[];e[r]&&(i=e[r]);var o=$(a[t]).children("li");$.each(o,function(e,a){var t={};t.QId=$(a).data("qid"),t.Type=r;var o=parseFloat($(a).find("input.qScore").val());isNaN(o)&&(o=0),t.Score=o,t.Sort=e,t.PaperType=n,i.push(t)}),e[r]=i}var p=[],s=$(".paper-qSection").children("li");s&&$.each(s,function(e,a){var t=$(a).children("ul.paper-qContent");if(t){var r=$(a).find(".q-perscore").val();(!r||isNaN(r))&&(r=0);var n={};n.QSectionType=$(t).data("qtype"),n.PaperType=$(t).data("section"),n.PerScore=r,n.Sort=e,p.push(n)}});var d={};d.Type=$("#type").val(),d.AddType=$(this).data("atype"),d.Title=$("#paperTitle").val(),d.Stage=$("#stage").val(),d.ChooseQus="",d.PerScores="",d.CompleteUrl=$paperMaker.options.chooseQuCompleteUrl,d.AutoData=$("#autoData").val(),e.length>0&&(d.ChooseQus=e),p.length>0&&(d.PerScores=JSON.stringify(p));var l=$("<form></form>");l.attr("action",$paperMaker.options.chooseQuestionUrl),l.attr("method","post"),l.attr("target","_self");var c=$('<input type="hidden" name="paperBase" />');c.attr("value",JSON.stringify(d)),l.append(c),l.appendTo("body"),l.submit()},inputAnswer:function(){$(".f-createQu").children("i").removeClass("fa-times").addClass("fa-plus"),$("div.fa-createQuDiv").children("div").empty(),$("div.fa-createQuDiv").hide(),$("#chooseQuDiv").addClass("hide"),$("#paperNav").addClass("hide");var e=$paperMaker.getPaperData();$("#inputAnswerDiv").empty().load($paperMaker.options.inputAnswerUrl,{paperData:JSON.stringify(e)})},getPaperAnswer:function(){var e=[],a=$(".g-wrap input[type=text]:visible:not(:disabled)");a&&a.length>0&&$.each(a,function(a,t){var r={};r.DetailId=$(t).data("detailid"),r.QId=$(t).data("qid"),r.Answer=$(t).val(),e.push(r)});var t=$(".g-wrap .answerEditDiv");return t&&t.length>0&&$.each(t,function(a,t){var r={};r.QId=$(t).data("qid"),r.Answer=$("<div/>").text($("#content_"+r.QId).html()).html(),e.push(r)}),e}};var validateChooseQu=function(){var e=$("ul.paper-qContent");if(e.length<1)return singer.msg("请先添加题目！"),!1;for(var a=0;a<e.length;a++){var t=$(e[a]).children("li");if(t.length<1)return singer.msg("请确保所有的题型都有题目！"),!1}return!0},validateAnswer=function(){var e=!0,a=$(".g-wrap input[type=text]:visible:not(:disabled)");return a&&a.length>0&&$.each(a,function(a,t){var r=$(t).val();return $.trim(r)?void 0:(e=!1,!1)}),e?!0:(singer.msg("请先录入所有客观题的答案！"),!1)},validateScore=function(){var e=!0,a=$(document).find(".qScore");return a&&$.each(a,function(a,t){var r=parseFloat($(t).val());return isNaN(r)||1>r?(e=!1,!1):void 0}),e},convertToChinese=function(e){var a=["〇","一","二","三","四","五","六","七","八","九","十","十一","十二","十三","十四","十五","十六","十七","十八","十九","二十"],t=parseInt(e);return(isNaN(t)||t>20)&&(t=1),a[t]},questionContentDrag=function(e){e.find("ul.paper-qContent").dragsort({dragSelectorExclude:"input,textarea,div.f-posa,img.qImg,.s-del,.paper-del",dragEnd:$paperMaker.questionContentDragEnd})}}(jQuery);