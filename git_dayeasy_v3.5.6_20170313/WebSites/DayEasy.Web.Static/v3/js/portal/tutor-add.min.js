var tags,selector,solveContent,stage=1;$(function(){$("#description").keyup(function(){var t=$(this).val();t.length>80&&$(this).val(t.substr(0,80));var e=$(this).val().length;$(this).next("p.f-tar").text("还可输入"+(80-e)+"个字")}),$("#uploadImg").click(function(){$(".webuploader-element-invisible").click()}),singer.uploader.on("uploadSuccess",function(t,e){e.state&&($("#tutorPhotoUrl").val(e.urls[0]),$("#tutorPhoto").attr("src",singer.makeThumb(e.urls[0],300,300))),singer.uploader.reset()}),tags=singer.tags({container:$(".d-tags"),data:$(".d-tags").data("tags"),canEdit:!0,max:5,change:function(t){}}),selector=$("#kPoints").tokenInput("/sys/knowledges?stage="+stage,{method:"POST",queryParam:"keyword",hintText:"",noResultsText:"没有找到相关知识点",searchingText:"Searching...",placeholder:"输入知识点关键字",tokenLimit:5,excludeCurrent:!1,preventDuplicates:!0,prePopulate:$("#kPoints").data("kps")}),$("#grade").bind("change",function(){var t=$(this).val(),e=7>t?1:t>9?3:2;e!=stage&&(stage=e,$("#kPoints").data("settings").url="/sys/knowledges?stage="+stage,selector.tokenInput("clear"))}),solveContent=UE.getEditor("solveContent",editorOptions),$("#tutorContentDiv").delegate(".f-close","click",function(){var t=this;$.Dayez.confirm("您确定要删除该项吗？",function(){$(t).parent("div").parent("div").fadeOut(500,function(){this.remove(),updateSortNo()})},function(){})});var t=$("#tutorContentDiv").find("textarea");$.each(t,function(t,e){var n=$(this).attr("id");UE.getEditor(n,editorOptions)}),$("#addText").click(function(){var t=$("#contentTemp").html(),e=contentCount()+1;t=t.replace("{{contentType}}",contentType.Text).replace("{{sortNo}}",e);var n=(new Date).getTime(),a=$("#addTextTemp").html().replace("{{No}}",n);t=t.replace("{{contentDetail}}",a),$("#tutorContentDiv").append(t),UE.getEditor("text_"+n,editorOptions)}),$("#chooseQuestion,#addNewQuestion,#uploadVideo").click(function(){var t=$(this).data("url"),e={};e.CompleteUrl=$("#chooseQuCompleteUrl").val(),e.AutoData=JSON.stringify(getCurrentData());var n=$("<form></form>");n.attr("action",t),n.attr("method","post"),n.attr("target","_self");var a=$('<input type="hidden" name="paperBase" />');a.attr("value",JSON.stringify(e)),n.append(a),n.appendTo("body"),n.submit()}),$("#btnSaveDraft,#btnSave").click(function(){var t=getCurrentData();if(!$.trim(t.Title))return $.Dayez.msg("请输入标题！"),!1;if(!$.trim(t.Author))return $.Dayez.msg("请输入作者！"),!1;if(!$.trim(t.Kps))return $.Dayez.msg("请选择知识点！"),!1;if(!$.trim(t.SolveContent))return $.Dayez.msg("请输入知识点特征与常见解法！"),!1;if(t.Contents.length<1)return $.Dayez.msg("请添加辅导内容！"),!1;var e=$(this).attr("id"),n=$(this).data("draft"),a="btnSave"==e?"您确定要保存该辅导吗？":"您确定要保存草稿吗？";$.Dayez.confirm(a,function(){$.post($("#saveTutor").val(),{tutorData:JSON.stringify(t),draft:n},function(t){t.Status?window.location=$("#tutorListUrl").val():$.Dayez.msg(t.Message)})},function(){})})});var getCurrentData=function(){var t={};t.EditId=$("#editId").val(),t.Profile=$("#tutorPhotoUrl").val(),t.Title=$("#tutorTitle").val(),t.Diff=$("#diffLevel").children("option:selected").val(),t.Author=$("#author").val(),t.Grade=$("#grade").children("option:selected").val(),t.Kps=selector.tokenInput("get"),t.Tags=tags.get(),t.Subject=$("#subject").children("option:selected").val(),t.Description=$("#description").val(),t.SolveContent=$("<div/>").text(solveContent.getContent()).html(),t.Contents=[];var e=$("#tutorContentDiv").children("div");return e&&$.each(e,function(e,n){var a={};if(a.Sort=e,a.Type=$(n).data("type"),a.Remarks=$(n).find("input.add-notes").val(),a.Type==contentType.Text){var i=$(n).find("textarea").prev("div").attr("id");a.Detail=$("<div/>").text(UE.getEditor(i).getContent()).html()}else a.Detail=$(n).data("sourceid");t.Contents.push(a)}),t},contentType={Text:0,Video:1,Question:2},editorOptions={toolbars:[["source","|","Undo","Redo","|","bold","italic","underline","|","insertimage","inserttable","deletetable","superscript","subscript","|","kityformula","spechars","link"]],serverUrl:$("#fileSite").val()+"/uploader",initialContent:"",autoClearinitialContent:!1,wordCount:!1,elementPathEnabled:!1,enableAutoSave:!1,enableContextMenu:!0,saveInterval:5e6,retainOnlyLabelPasted:!0,pasteplain:!1,initialFrameHeight:100},contentCount=function(){return $("#tutorContentDiv").children("div").length},updateSortNo=function(){var t=$("#tutorContentDiv").children("div");t&&$.each(t,function(t,e){$(e).find("span.titile-list").text(t+1)})};