var marking=function(){var t={data:{batch:"",type:0,paperId:"",isRefresh:!1,isJoint:!0,allObjective:!1,loaded:!1,lock:!1,keydown:!0,operation:0,url:DEYI.sites["static"]+"/v1/image/icon/marking/",deyiGroupId:"",questionGroupId:"",groupId:"",groupName:"",minScore:1,semiAuto:!1,semiScore:"50%",errorAuto:!1,errorScore:"100%"},shares:[],questions:[],pictures:[],picture:{},details:[],_mix:function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])}};return t}();!function(t){t._mix(t,{dw:{doc:$(document),box:$("#mkBox"),n_icons:[],r_icons:[],images:["full.png","semi.png","error.png"],x:0,y:0,w:780,h:0,init:function(){$(".icon").remove();var e=singer.json(t.picture.icons)||[],i=singer.json(t.picture.marks)||[];if(i&&i.length)for(var a=0;a<i.length;a++)e.push({x:i[a].x,y:i[a].y,t:i[a].t,w:i[a].w});if(e&&e.length)for(var s=t.questions&&t.questions.length,a=0;a<e.length;a++){var o,n=e[a];if(n.id&&n.id.length&&s){for(var d=!1,r=0;r<t.questions.length;r++)if(t.questions[r].id==n.id){d=!0;break}if(!d)continue}if(4==n.t)o=$("<div class='icon icon-lg' style='font-size:24px;line-height:1em;font-family: 宋体;font-weight:bold;color:#fa8989;left: "+n.x+"px;top: "+n.y+"px;'>"+n.w+"</div>");else{var c="";if(n.t<3?c=t.data.url+t.dw.images[n.t]:5==n.t?c=t.data.url+"brow/"+n.w:3==n.t&&(c=t.data.url+n.w),o=$('<div class="icon '+(3==n.t?"icon-lg":"icon-sm")+'" style="left:'+n.x+"px;top:"+n.y+'px;">'),o.html('<img src="'+c+'"/>'),(1==n.t||2==n.t)&&n.id&&n.id.length){o.append('<div class="score">-'+(n.w||0)+"</div>");var l="T"+n.t+"_"+(n.x+"_"+n.y).replace(/\./gi,"D");o.attr("id",l).data("qId",n.id).data("t",n.t).data("score",n.w)}}t.dw.box.append(o.data("x",n.x).data("y",n.y))}},print:function(e,i,a,s){t.qt.semiBox.hide();var o=t.dw.box.data("t");if("clear"!=o){(0>o||o>5)&&(o=0);var n=3>o?t.dw.images[o]:t.dw.box.data("v")||"";if(n){e=e||window.event;var d=parseInt(e.clientX+t.dw.doc.scrollLeft()-t.dw.x),r=parseInt(e.clientY+t.dw.doc.scrollTop()-t.dw.y);if(0==o||1==o)r-=23;else if(2==o)d-=3,r-=18;else if(5==o)switch(n){case"praise.png":d+=2;break;case"line.png":r+=4;break;case"wavy.png":r+=6;break;case"oval.png":d-=75,r-=6}if(t.dw.n_icons.length)for(var c=t.dw.n_icons.length;c>0;c--){var l=t.dw.n_icons[c-1];if(l.x==d&&l.y==r)return}var u,p,m={x:d,y:r,t:o,w:o>2?n:0};4==o?u=$("<div class='icon icon-lg' style='font-size:24px;line-height:1em;font-family: 宋体;font-weight:bold;color:#fa8989;left: "+d+"px;top: "+r+"px;'>").text(n):(u=$('<div class="icon '+(3==o?"icon-lg":"icon-sm")+'" style="left:'+d+"px;top:"+r+'px;">').html('<img src="'+t.data.url+(5==o?"brow/"+n:n)+'"/>'),3>o&&(m.id=i),(1==o||2==o)&&(u.append('<div class="score">-0</div>'),singer.isUndefined(i)||(p="T"+o+"_"+(d+"_"+r).replace(/\./gi,"D"),u.attr("id",p).data("qId",i).data("t",o).data("score",0)))),t.dw.box.append(u.data("x",d).data("y",r)),t.dw.n_icons.push(m),singer.isUndefined(i)||(singer.isUndefined(s)||($("#questionList .item").removeClass("active"),$(".num-"+s).addClass("active"),$(".scroll-items").mCustomScrollbar("scrollTo",".num-"+s)),1==o&&t.dw.openScoreBox(i,o,{x:d,y:r},p),2==o&&t.dw.openScoreBox(i,o,{x:d,y:r},p))}}},clear:function(e){var i=parseFloat(e.data("score")||0);i>0&&t.qt.setScore(e.data("qId"),i,!1,0);var a=e.data("x"),s=e.data("y");e.remove();for(var o=!1,n=0;n<t.dw.n_icons.length;n++){var d=t.dw.n_icons[n];if(d.x==a&&d.y==s){o=!0,t.dw.n_icons.splice(n,1);break}}o||t.dw.r_icons.push({x:a,y:s})},openScoreBox:function(e,i,a,s){for(var o=0,n=0;n<t.questions.length;n++)if(t.questions[n].id==e){o=t.questions[n].score;break}if(0==o)return void t.qt.setScore(e,0,!0,0);if(1==i&&t.data.semiAuto||2==i&&t.data.errorAuto){var d=1==i?t.data.semiScore:t.data.errorScore,r=0;return r="50%"==d?0-o/2:"100%"==d?0-o:parseFloat(d),void t.qt.setScore(e,r,!1,s)}t.qt.semiBox.show(e,i,o,a,s)}},qt:{init:function(){$("#questionList").delegate(".qc-num","click",function(){if($("#questionList .item").removeClass("active"),$("#questionList .qc-scores").hide(),$(this).data("open"))$(this).data("open",0);else{var t=$(this).parents(".item");t.addClass("active"),$(this).data("open",1).siblings(".qc-scores").slideDown(200,function(){t.hasClass("last")&&$(".scroll-items").mCustomScrollbar("scrollTo","bottom")})}$("#questionList .qc-num").not($(this)).data("open",0)}).delegate(".qc-scores li","click",function(){var e=$(this).parents(".item"),i=$(this).text(),a=e.data("id");e.find(".num").text(i),t.qt.setScore(a,i,!0,0)})},setScore:function(e,i,a,s){a=a||!1,i=parseFloat(i);var o=0,n=0;if(!t.questions||!t.questions.length)return void singer.msg("没有批阅任务");for(;o<t.questions.length;o++)if(t.questions[o].id==e){n=t.questions[o];break}if(!n)return void singer.msg("没有检测到题目分数，请刷新重试");var d=!1,r=0;if(t.details&&t.details.length)for(o=0;o<t.details.length;o++)if(t.details[o].question_id==e){d=!0,r=t.details[o];break}var c=0;if(r)c=r.score;else for(r={question_id:e},o=0;o<t.picture.details.length;o++)if(t.picture.details[o].questionId==e){c=t.picture.details[o].score;break}if(!singer.isUndefined(s)&&0!=s){var l=0-i;a&&(l=c+i),0>c+i&&(l=c);var u=$("#"+s);u.data("score",l),u.find("div").text("-"+l);var p=u.data("t"),m=u.data("x"),h=u.data("y");for(o=t.dw.n_icons.length-1;o>=0;o--){var v=t.dw.n_icons[o];if(v.t==p&&v.x==m&&v.y==h){v.w=l;break}}}var f=c;c=a?i:c+i,0>c&&(c=0),c>n.score&&(c=n.score),r.score=c,r.is_correct=c==n.score,d||t.details.push(r),$("#questionList").find(".item").each(function(t,i){$(i).data("id")==e&&$(i).find(".num").text(c)}),t.data.isJoint||(t.picture.totalScore+=c-f,$(".stu-score").html(t.picture.totalScore))},semiBox:{timerId:0,iconId:0,show:function(e,i,a,s,o){(0!=t.qt.semiBox.timerId||0!=t.qt.semiBox.iconId)&&t.qt.semiBox.hide(),a=parseFloat(a||0);var n=$("#semiBox");n.html("");var d=122,r=$("<ul>");if(r.data("id",e).data("iconId",o),e&&a>0){var c=a>20?20:a;if(c>9&&(d=30*Math.ceil(c/3)+32),a>4){var l=0-(1==i?a/2:a);r.append('<li class="one" data-v="'+l+'">'+(1==i?"扣一半":"全扣")+"</li>")}for(var u=1;c>=u;)1!=t.data.minScore&&r.append('<li class="li-float-score" style="display: none;" data-v="'+(0-u+.5)+'">'+(0-u+.5)+"</li>"),r.append('<li class="li-int-score" data-v="'+(0-u)+'">'+(0-u)+"</li>"),++u>c&&u!=c+1&&r.append('<li class="li-int-score" data-v="'+(0-c)+'">'+(0-c)+"</li>");r.append('<li data-v="cancel" title="取消"><i class="fa fa-reply"></i></li>'),r.find("li").bind("click",function(){var e=$(this).data("v"),i=$(this).parent().data("id"),a=$(this).parent().data("iconId");return"cancel"==e?void t.qt.semiBox.hide():(t.qt.semiBox.iconId=0,t.qt.semiBox.hide(),void t.qt.setScore(i,parseFloat(e),!1,a))})}if(1!=t.data.minScore){d+=30;var p=$('<div class="box semi-box-tab"></div>');p.append('<div class="box-lg-6 active" data-v="1">整分</div>'),p.append('<div class="box-lg-6" data-v="0">小数</div>'),p.find("div").bind("mouseover",function(){var t=$(this);if(!t.hasClass("active")){p.find("div").removeClass("active"),t.addClass("active");var e=$("#semiBox");"1"==t.data("v")?(e.find(".li-int-score").show(),e.find(".li-float-score").hide()):(e.find(".li-int-score").hide(),e.find(".li-float-score").show())}}),n.append(p)}n.append(r),singer.isUndefined(s)||(t.dw.w-s.x<180&&(s.x-=172),t.dw.h-s.y<d&&(s.y-=d-50),n.data("xy",s.x+"-"+s.y+"-"+d).attr("style","top:"+s.y+"px;left:"+(s.x+50)+"px;")),t.qt.semiBox.iconId=o,t.qt.semiBox.timerId=window.setTimeout(function(){t.qt.semiBox.hide(200)},5e3),n.show()},hide:function(e){0!=t.qt.semiBox.timerId&&window.clearTimeout(t.qt.semiBox.timerId),0!=t.qt.semiBox.iconId&&t.dw.clear($("#"+t.qt.semiBox.iconId)),t.qt.semiBox.timerId=0,t.qt.semiBox.iconId=0,$("#semiBox").html("").fadeOut(e||0)}}},mk:{init:function(){t.data.allObjective?($(".tool-full").addClass("tool-full-disabled").removeClass("active"),$(".tool-semi").addClass("tool-semi-disabled"),$(".tool-error").addClass("tool-error-disabled"),$(".tool-setting").addClass("tool-setting-disabled"),$("#mkBox").removeClass("cur-0"),$(".power").data("show","0").addClass("power-disabled"),$(".power").find("i").attr("class","fa fa-chevron-right"),$(".power").find(".qc-line").hide()):$(".power").bind("click",function(){var t=$(this),e="1"==t.data("show");e?(t.data("show","0").attr("title","点击展开"),t.find("i").attr("class","fa fa-chevron-right")):(t.data("show","1").attr("title","点击收起"),t.find("i").attr("class","fa fa-chevron-down"),t.find(".qc-line").show()),$(".items").slideToggle(800,function(){e&&t.find(".qc-line").hide()})}),$(".m-back").bind("click",function(){return t.data.isJoint?void window.history.back():void(window.location.href="/work/teacher")}),t.data.isJoint&&$(".a-exception").bind("click",function(){var e=$(this),i=$(".ms-submits li").eq(t.picture.index-1);if(0==e.data("type")){for(var a=[],s=0;s<t.questions.length;s++)a.push(t.questions[s].sort);var o="学生"+t.picture.index+" 题号："+a.join("、");t.data.isAb&&(o=(1==t.data.sectionType?"[A卷] ":"[B卷] ")+o),$.post("/marking/add-exception",{id:t.picture.jointPictureId,desc:o},function(t){if(!t.status)return void singer.msg(t.message);e.data("type",1).html("取消异常申报");var a=i.find("i");a&&a.length?a.attr("class","fa fa-exclamation i-declare"):i.append('<i class="fa fa-exclamation i-declare"></i>')})}else $.post("/marking/cancel-exception",{id:t.picture.jointPictureId},function(a){if(!a.status)return void singer.msg(a.message);e.data("type",0).html("异常申报");var s=i.find("i");t.picture.isMarking?s.remove():s.attr("class","i-undo")})}),$(".m-students-scroll").mCustomScrollbar({axis:"y",theme:"minimal-dark"}),$(".btn-schedule").bind("click",function(){marking.mt.schedule()}),$(".btn-mk-save").bind("mouseover",function(){$(".mk-save-tip").stop().fadeIn()}).bind("mouseout",function(){$(".mk-save-tip").stop().hide()}).bind("click",function(){t.mt.submit(t.picture.pictureId,function(){var e=t.data.isJoint&&!t.data.allObjective?t.picture.jointPictureId:t.picture.pictureId;t.mt.loadPicture(e),singer.msg("批阅进度已保存")})}),$(".btn-mk-finished").bind("click",function(){var e=template("finished-template"),i=singer.dialog({title:"完成批阅",content:e,fixed:!0,backdropOpacity:.7});i.showModal();var a=$("#cbxFinishedAgree"),s=$("#btnFinishedOk"),o=$(".finished-step2");$("#btnFinishedCancel").bind("click",function(){i.close().remove()}),a.bind("click",function(){a[0].checked?s.removeAttr("disabled"):s.attr("disabled","disabled")}),s.bind("click",function(){return o.hasClass("hide")?($(".finished-step1").remove(),o.removeClass("hide"),void $(this).html("结束")):void t.mt.submit(t.picture.pictureId,function(){t.mt.finished($("#cbxFinishedAutoSetIcon")[0].checked,$("#cbxFinishedAutoSetScore")[0].checked)})})}),$(".btn-students").bind("click",function(){var t=$(".m-students");t.data("open")?t.data("open",0).hide():t.data("open",1).fadeIn(500)}),$(".ms-submits").delegate("li","click",function(){var e=$(this),i=e.data("id");i!=t.picture.pictureId&&($(".m-students").data("open",0).hide(),$(".ms-submits li").removeClass("active"),$(this).addClass("active"),$(".em-schedule-currect").html(e.data("idx")),t.data.isJoint&&!t.data.allObjective&&(i=e.data("jointid")),t.mt.submit(i))}),$("#semiBox").mouseover(function(){window.clearTimeout(t.qt.semiBox.timerId)}).mouseout(function(){t.qt.semiBox.timerId=window.setTimeout(function(){t.qt.semiBox.hide(200)},5e3)});var e=function(e){if(t.data.stopping)return!1;if(t.data.lock)return t.data.stopping=!0,singer.msg("老师别急，正在努力加载中...",1e3,function(){t.data.stopping=!1}),!1;t.data.lock=!0;var i=t.data.isJoint&&!t.data.allObjective?parseInt($(".em-schedule-currect").text()||"1"):t.picture.index;i+=e;var a=t.pictures&&t.pictures.length?t.pictures.length:0;1>i&&(i=1),i>a&&!t.data.isJoint&&(i=a);var s=a>=i?t.data.isJoint&&!t.data.allObjective?t.pictures[i-1].jointPictureId:t.pictures[i-1].pictureId:"";t.mk.studentActive(i),t.mt.submit(s)};$(".m-change").click(function(){var t=parseInt($(this).data("v")||"1");e(t)}),t.data.keydown&&$(document).keydown(function(t){var i=t.which;(37==i||39==i)&&e(37==i?-1:1)}),$(".m-tools").find(".tool").bind("click",function(){t.qt.semiBox.hide();var e=$(this).data("t");if(!t.data.allObjective||"0"!=e&&"1"!=e&&"2"!=e&&"setting"!=e){if($(".m-tools").find(".tool").removeClass("active"),$(this).addClass("active"),"remark"==e)return $(".m-setting").data("open",0).hide(),void($(".remarks").data("open")?($(".remarks").data("open",0).hide(),t.data.keydown=!0):($(".remarks").data("open",1).fadeIn(500),t.data.keydown=!1));if($(".remarks").data("open",0).hide(),"setting"==e)return void($(".m-setting").data("open")?$(".m-setting").data("open",0).hide():$(".m-setting").data("open",1).fadeIn(500));$(".m-setting").data("open",0).hide(),t.data.keydown=!0,t.dw.box.data("t")!=e&&(t.dw.box.data("o",2),t.mk.setBox(e))}}),t.dw.box.bind("contextmenu",function(){return t.data.allObjective}).mousedown(function(e){if(!t.data.allObjective&&3==e.which){$(".m-tools").find(".tool").removeClass("active");var i=t.dw.box.data("t");0==i?(i=1,$(".tool-semi").addClass("active")):1==i?(i=2,$(".tool-error").addClass("active")):(i=0,$(".tool-full").addClass("active")),t.data.keydown=!0,$(".remarks").data("open",0).hide(),t.qt.semiBox.hide(),t.dw.box.data("o",2),t.mk.setBox(i)}}),$(".remarks li").bind("click",function(){var e=$(this).parent().data("t"),i=$(this).data("v");$(".remarks").data("open",0).hide(),t.data.keydown=!0,i!=t.dw.box.data("v")&&(t.dw.box.data("o",4),t.mk.setBox(e,i))}),$("#txtCustom").bind("change",function(){var t=$("#txtCustom").val();t&&t.length&&$("#txtCustom").val(t.replace(/['"<>]/gi,"").replace("_","").replace(/(\r)|(\n)/g," "))}),$("#btnUsageCustom").bind("click",function(){var e=$("#txtCustom").val().replace(/['"<>]/gi,"").replace("_","").replace(/(\r)|(\n)/g," ");if(!e||!e.length)return $(".custom-history").removeClass("hide"),void $(".custom-edit").addClass("hide");if($(".remarks").data("open",0).hide(),t.data.keydown=!0,$(".custom-history").removeClass("hide"),$(".custom-edit").addClass("hide"),e!=t.dw.box.data("v")){t.dw.box.data("o",4),t.mk.setBox(4,e);var i=$(".custom-history .list"),a=i.find(".item");i.html('<div class="ht item" title="点击使用">'+e+"</div>"),a&&a.length&&$(a).each(function(t,e){4>t&&i.append($(e))})}}),$(".custom-history").delegate(".item","click",function(){var e=$(this).text();return e&&e.length?($(".remarks").data("open",0).hide(),t.data.keydown=!0,void(e!=t.dw.box.data("v")&&(t.dw.box.data("o",4),t.mk.setBox(4,e)))):void singer.msg("说点什么吧...")}),$("#ddlMinScore").bind("change",function(){var t=parseFloat($(this).val()),e=$("#ddlSemiScore"),i=$("#ddlErrorScore");e.html('<option value="50%">扣一半</option>'),i.html('<option value="100%">全扣</option>');for(var a=1;5>=a;a++)1!=t&&(e.append('<option value="-'+(a-.5)+'">-'+(a-.5)+"分</option>"),i.append('<option value="-'+(a-.5)+'">-'+(a-.5)+"分</option>")),e.append('<option value="-'+a+'">-'+a+"分</option>"),i.append('<option value="-'+a+'">-'+a+"分</option>");e.append('<option value="100%">全扣</option>'),i.append('<option value="500%">扣一半</option>')}),$(".m-setting").find("input[name='rdoSemi']").bind("click",function(){var t=$(this).val();"1"==t?$("#ddlSemiScore").removeAttr("disabled"):$("#ddlSemiScore").attr("disabled","disabled")}),$(".m-setting").find("input[name='rdoError']").bind("click",function(){var t=$(this).val();"1"==t?$("#ddlErrorScore").removeAttr("disabled"):$("#ddlErrorScore").attr("disabled","disabled")}),$("#btnUpdateMkArea").bind("click",function(){t.mt.submit(t.picture.pictureId,function(){window.location.href="/marking/marking-area?batch="+t.data.batch+"&type="+t.data.type+"&isJoint="+t.data.isJoint})}),$("#btnCancelSetting").bind("click",function(){$(".m-setting").data("open",0).hide()}),$("#btnSaveSetting").bind("click",function(){var e=$(".m-setting");t.data.minScore=parseFloat($("#ddlMinScore").val()),t.data.semiAuto="1"==e.find("input[name='rdoSemi']:checked").val(),t.data.errorAuto="1"==e.find("input[name='rdoError']:checked").val(),t.data.semiAuto&&(t.data.semiScore=$("#ddlSemiScore").val()),t.data.errorAuto&&(t.data.errorScore=$("#ddlErrorScore").val()),1!=t.data.minScore?$("#questionList").find(".li-float-score").show():$("#questionList").find(".li-float-score").hide(),$(".m-setting").data("open",0).hide()}),t.dw.box.click(function(e){var i=t.dw.box.data("t");(3==i||4==i||5==i)&&(t.dw.print(e),t.data.operation=t.data.operation|(t.dw.box.data("o")||2))}),t.dw.box.delegate(".q-area","click",function(e){t.dw.print(e,$(this).data("id"),$(this).data("t"),$(this).data("sort")),t.data.operation=t.data.operation|(t.dw.box.data("o")||2)}),t.dw.box.delegate(".icon","click",function(){var e=t.dw.box.data("t");"clear"==e&&(t.dw.clear($(this)),t.data.operation=6|t.data.operation)}),t.dw.box.delegate(".qa-sort","click",function(t){t.stopPropagation()}),t.dw.box.delegate(".qa-share-active","click",function(t){t.stopPropagation()}),t.dw.box.delegate(".qa-share","click",function(e){e.stopPropagation();var i=$(this),a=i.parent().data("id");if(t.shares&&t.shares.length)for(var s=0;s<t.shares.length;s++){var o=t.shares[s];if(o.questionId==a&&o.studentId==t.picture.studentId)return}singer.confirm("请确认您分享的是本题的正确答案",function(){$.post("marking/add-share",{batch:t.data.batch,paper_id:t.data.paperId,group_id:t.data.groupId,question_id:a,student_id:t.picture.studentId,student_name:t.picture.studentName},function(e){e.status?(t.shares.push({id:e.data,questionId:a,studentId:t.picture.studentId}),i.removeClass("qa-share").addClass("qa-share-active").html('<i class="fa fa-star"></i><span>已晒</span>'),singer.msg("分享成功")):singer.msg(e.message)})})}),t.dw.box.delegate(".q-area","mouseover",function(){$(this).addClass("q-area-active")}),t.dw.box.delegate(".q-area","mouseout",function(){$(this).removeClass("q-area-active")})},setBox:function(e,i){switch(t.dw.box.data("v",0),e){case 0:return void t.dw.box.data("t",e).attr("class","cur-0");case 1:return void t.dw.box.data("t",e).attr("class","cur-1");case 2:return void t.dw.box.data("t",e).attr("class","cur-2");case"clear":return void t.dw.box.data("t",e).attr("class","cur-clear");case 3:case 4:return void t.dw.box.data("t",e).data("v",i).attr("class","cur-remark");case 5:switch(t.dw.box.data("t",e).data("v",i),i){case"smile.png":return void t.dw.box.attr("class","cur-bw-smile");case"cry.png":return void t.dw.box.attr("class","cur-bw-cry");case"praise.png":return void t.dw.box.attr("class","cur-bw-praise");case"doubt.png":return void t.dw.box.attr("class","cur-bw-doubt");case"line.png":return void t.dw.box.attr("class","cur-bw-line");case"wavy.png":return void t.dw.box.attr("class","cur-bw-wavy");case"oval.png":return void t.dw.box.attr("class","cur-bw-oval")}return}},studentActive:function(t){var e=$(".ms-submits li"),i=e.length;t-=1,0>t&&(t=0),i>t&&(e.removeClass("active"),e.eq(t).addClass("active"))}},mt:{initDialog:0,loadData:function(){var e=$('<div class="m-init-box f-tac">');e.append('<div><i class="fa fa-spin fa-spinner fa-4x"></i></div>'),e.append('<div class="m-init-message">正在准备阅卷数据，请稍候...</div>'),t.mt.initDialog=singer.dialog({content:e}),t.mt.initDialog.showModal(),$.post("/marking/load",{joint:t.data.isJoint,batch:t.data.batch,type:t.data.type},function(e){e.status?t.mt.bindData(e.data):($(".dy-container").css("padding","0"),$(".m-message").text(e.message).removeClass("hide"),t.mt.initDialog.close().remove(),t.mt.initDialog=0)})},bindData:function(e){t.pictures=e.pictures,t.questions=e.questions,t.data.paperId=e.paperId,singer.config({paperId:e.paperId}),t.data.allObjective=e.allObjective;var i={isJoint:t.data.isJoint,paperTitle:e.paperTitle,pictures:t.pictures,unSubmits:e.unSubmits||[]},a=template("m-header-box",i);$(".m-header-box").html(a).removeClass("hide");var s=template("question-template",{questions:t.questions});$("#questionList").append(s),$("#questionList").find(".item").last().addClass("last").find(".qc-line").remove();for(var o=singer.json(e.areas)||[],n=$("#mkBox"),d=0;d<o.length;d++){var r=!t.data.isJoint,c=o[d];if(t.data.isJoint)for(var l=0;l<t.questions.length;l++)if(t.questions[l].id==c.id){r=!0;break}if(r){var u=$("<div class='q-area' style='position: absolute;width:"+c.width+"px;height:"+c.height+"px;left: "+c.x+"px;top: "+c.y+"px;' data-id='"+c.id+"' data-t='"+c.t+"' data-sort='"+c.index+"'>");u.append('<div class="qa-sort">'+c.index+"</div>"),t.data.isJoint||u.append('<div class="qa-share"><i class="fa fa-star"></i><span class="qa-share-text">晒答案</span></div>'),n.append(u)}}if(t.data.isJoint){if(t.data.deyiGroupId=e.deyiGroupId,t.data.questionGroupId=e.questionGroupId,(!t.pictures||!t.pictures.length)&&t.questions&&t.questions.length){var p="";for(d=0;d<t.questions.length;d++)p+=(0==d?"":",")+t.questions[d].sort;singer.alert("你需要批阅的题目【"+p+"】")}}else t.data.groupId=e.groupId,t.data.groupName=e.groupName,t.shares=e.shares;var m="";if(t.pictures&&t.pictures.length){var h=t.pictures[t.pictures.length-1];m=t.data.isJoint&&!t.data.allObjective?h.jointPictureId:h.pictureId,t.mk.studentActive(t.pictures.length)}$(".m-body").removeClass("hide"),$(".m-prompt-box").removeClass("hide"),0!=t.mt.initDialog&&(t.mt.initDialog.close().remove(),t.mt.initDialog=0),t.mt.loadPicture(m),t.qt.init(),t.mk.init()},loadPicture:function(e){if(!(t.data.allObjective||t.questions&&t.questions.length))return $(".m-body").addClass("hide"),$(".m-prompt-box").addClass("hide"),$(".em-schedule-currect").text("0"),$(".dy-container").css("padding","0"),$(".m-message").text("没有批阅任务").removeClass("hide"),$(".j-autoHeight").attr("style","height:"+$(window).height()+"px;"),void(t.data.lock=!1);if(e&&e.length){var i="";if(t.picture&&(i=t.data.isJoint&&!t.data.allObjective?t.picture.jointPictureId:t.picture.pictureId),!t.data.isRefresh&&e==i)return 1==t.picture.index&&singer.msg("已批阅到第一份试卷啦~"),t.picture.index==t.pictures.length&&singer.msg("没有待批阅的试卷啦~"),void(t.data.lock=!1)}else{if(!t.data.isJoint)return singer.msg("参数错误，请刷新重试"),void(t.data.lock=!1);if(t.data.loaded&&0==parseInt($(".em-schedule-surplus").text()||"0"))return singer.msg("没有待批阅的试卷啦~"),void(t.data.lock=!1)}t.data.isRefresh=!1,t.data.isJoint?$.post("/marking/joint-picture",{all_objective:t.data.allObjective,group_id:t.data.questionGroupId,picture_id:e},function(i){t.mt.jsonPicture(i,e)}):$.post("/marking/picture",{picture_id:e,type:t.data.type},function(i){t.mt.jsonPicture(i,e)}),t.data.loaded||(t.data.loaded=!0)},jsonPicture:function(e,i){if(!e.status||!e.data){if(!t.pictures||!t.pictures.length)return $(".m-body").addClass("hide"),$(".m-prompt-box").addClass("hide"),$(".dy-container").css("padding","0"),$(".m-message").text("没有待批阅的答卷").removeClass("hide"),void $(".j-autoHeight").attr("style","height:"+$(window).height()+"px;");var a=e.message||"答卷加载失败";return void singer.msg(a)}if(t.picture=e.data,t.data.isJoint&&(!i||!i.length)){t.pictures.push({jointPictureId:t.picture.jointPictureId,pictureId:t.picture.pictureId});var s=$('<li class="active" data-id="'+t.picture.pictureId+'">');s.data("jointid",t.picture.jointPictureId).data("idx",t.pictures.length).html("<span>学生"+t.pictures.length+'</span><i class="i-undo"></i>');var o=$(".ms-submits");o.find("li").removeClass("active"),o.append(s)}t.mt.bindPicture()},bindPicture:function(){for(var e=0;e<t.pictures.length;e++)if(t.pictures[e].pictureId==t.picture.pictureId){var i=t.pictures[e];t.picture.index=e+1,t.data.isJoint||(t.picture.studentId=i.studentId,t.picture.studentName=i.studentName);break}if($("#markingImage").unbind("load.marking").bind("load.marking",function(){t.data.lock=!1}).attr("src",t.picture.pictureUrl),t.picture.details&&t.picture.details.length){var a=$("#questionList").find(".item");for(e=0;e<t.picture.details.length;e++){var s=t.picture.details[e];a.each(function(t,e){$(e).data("id")==s.questionId&&$(e).find(".num").text(s.score)})}}$(".em-schedule-currect").html(t.picture.index),t.data.isJoint?$(".em-schedule-readed").text(t.pictures.length):($(".stu-name").html(t.picture.studentName),$(".stu-score").html(t.picture.totalScore),$(".ms-submits li").removeClass("active").each(function(e,i){var a=$(i);a.data("id")==t.picture.pictureId&&a.addClass("active")}),t.shares&&t.shares.length&&($(".qa-share-active").removeClass("qa-share-active").addClass("qa-share").find("span").html("晒答案"),$(".q-area").each(function(e,i){for(var a=$(i),s=a.data("id"),o=0;o<t.shares.length;o++){var n=t.shares[o];if(n.questionId==s&&n.studentId==t.picture.studentId){a.find(".qa-share").removeClass("qa-share").addClass("qa-share-active").find("span").html("已晒");break}}}))),t.data.isJoint&&(null==t.picture.exceptionType?$(".a-exception").data("type",0).html("异常申报"):$(".a-exception").data("type",1).html("取消异常申报")),t.dw.init(),t.data.isJoint&&!t.data.allObjective&&t.mt.groupSchedule()},schedule:function(){if(t.picture&&t.picture.pictureId&&t.picture.pictureId.length){var e=t.data.isJoint&&!t.data.allObjective?t.picture.jointPictureId:t.picture.pictureId;t.mt.submit(e)}var i=singer.dialog({content:'<i class="fa fa-spin fa-spinner fa-2x"></i>&nbsp;&nbsp;请稍后，正在查询进度...'});i.showModal(),$.get("/marking/schedule",{batch:t.data.batch,t:Math.random()},function(t){singer.dialog({title:"批阅进度",content:t}).showModal(),i.close().remove()})},groupSchedule:function(){"0"!=$(".em-schedule-surplus").data("count")&&$.post("/marking/question-group-surplus",{group_id:t.data.questionGroupId},function(t){t.status&&$(".em-schedule-surplus").data("count",t.data).text(t.data)})},submit:function(e,i){if(t.qt.semiBox.hide(),0!=t.data.operation||t.details&&t.details.length){t.data.lock=!0;var a=[],s=[];if(t.dw.n_icons&&t.dw.n_icons.length&&((4&t.data.operation)>0||(2&t.data.operation)>0)){for(var o=0;o<t.dw.n_icons.length;o++){var n={x:t.dw.n_icons[o].x,y:t.dw.n_icons[o].y,t:t.dw.n_icons[o].t,w:t.dw.n_icons[o].w};0==t.dw.n_icons[o].t||1==t.dw.n_icons[o].t||2==t.dw.n_icons[o].t?(n.id=t.dw.n_icons[o].id,a.push(n)):s.push(n)}0==(2&t.data.operation)&&(a=[]),0==(4&t.data.operation)&&(s=[])}$.post("/marking/submit",{pictureId:t.picture.pictureId,operation:t.data.operation,paperType:t.data.type,icons:singer.json(a).replace(/\'/gi,'"'),marks:singer.json(s).replace(/\'/gi,'"'),removeIcons:singer.json(t.dw.r_icons).replace(/\'/gi,'"'),detailData:singer.json(t.details).replace(/\'/gi,'"')},function(a){if(a.status){if(t.details=[],t.data.operation=0,t.dw.n_icons=[],t.dw.r_icons=[],t.data.isRefresh=!0,$('.ms-submits li[data-id="'+t.picture.pictureId+'"]').find("i").remove(),i&&singer.isFunction(i))return void i.call(this);t.mt.loadPicture(e)}else t.data.lock=!1,singer.msg(a.message)})}else{if(i&&singer.isFunction(i))return void i.call(this);t.mt.loadPicture(e)}},finished:function(e,i){t.data.isJoint||$.post("/marking/finished",{batch:t.data.batch,paper_id:t.data.paperId,type:t.data.type,auto_set_icon:e,auto_set_score:i},function(t){t.status?singer.msg("已结束阅卷",2e3,function(){window.location.href="/work/teacher"}):singer.msg(t.message)})}}})}(marking),$(function(t){if(t("#txtFail").val())return void t(".dy-container").css("padding","0");var e=singer.uri().batch,i=singer.uri().type;if(singer.isUndefined(e)||""==e)return t(".dy-container").css("padding","0"),void t(".m-message").text("参数错误").removeClass("hide");var a=t(window).width(),s=t(window).height();(!a||1280>a)&&(a=1280);var o=(a-1e3)/2+175-9,n=100;"1"==singer.cookie.get("MARKINGALT")?(t(".m-prompt-box").remove(),n=60,marking.dw.y=60):(marking.dw.y=100,t(".m-prompt .p-close").bind("click",function(){singer.cookie.set("MARKINGALT","1",525600),t(".m-prompt-box").remove(),t(".m-goal").css("top","60px"),t(".m-tools").css("top","60px"),marking.dw.y=60}),t(".m-prompt-box").show()),marking.dw.x=o,t(".m-body").attr("style","min-height:"+(s-50)+"px;margin-left:"+o+"px;"),t(".m-tools").attr("style","top:"+n+"px;left:"+(o+781)+"px;"),t(".m-goal").attr("style","left:"+(o-175)+"px;top:"+n+"px;"),t(".scroll-items").attr("style","max-height:"+(s-n-100)+"px;"),t(".m-change-left").attr("style","top:"+(s/2-37)+"px;left:"+(o-175-74-50)+"px;"),t(".m-change-right").attr("style","top:"+(s/2-37)+"px;left:"+(o+780+45+50)+"px;"),t(".remarks").find(".title").bind("click",function(){switch(t(".remarks").find(".title").removeClass("active"),t(".remarks").find(".content").addClass("hide"),t(this).addClass("active"),t(this).data("t")){case 3:t(".remarks").find(".c-text").removeClass("hide");break;case 5:t(".remarks").find(".c-brow").removeClass("hide");break;default:t(".remarks").find(".c-custom").removeClass("hide")}}),t(".custom-history").find(".edit").bind("click",function(){t(".custom-history").addClass("hide"),t(".custom-edit").removeClass("hide"),t(".txt-custom").focus()}),t(".scroll-items").mCustomScrollbar({axis:"y",theme:"minimal-dark"}),singer.isUndefined(i)&&(i=""),marking.data.batch=e,marking.data.type=i,marking.data.isJoint="1"==t("#txtIsJoint").val(),marking.mt.loadData()}),template.helper("questionScores",function(t){if(1>t)return"<li>0</li>";for(var e="",i=0;t>=i;)e+="<li>"+i+"</li>",t>i+.5&&(e+='<li class="li-float-score" style="display: none;">'+(i+.5)+"</li>"),++i>t&&i!=t+1&&(e+="<li>"+t+"</li>");return e});