!function(e,i){var t,n,a,s,o,c=i.uri(),r=!1,d=c.batch,l=!1;i.getLogger("marking-complete");d||(d=c.joint,r=!0),n=function(n,a){if(r)return l=!1,!1;var s={batch:d,paper_id:t,type:c.type,auto_set_icon:n,auto_set_score:a};e.post("/marking/finished",s,function(e){e.status?i.msg("已结束阅卷",2e3,function(){window.location.href=i.sites.apps+"/work/teacher"}):i.msg(e.message),l=!1})},a=function(t,n,a){var o=e('<div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="min-width:2em;width: 0%">0%</div>'),c=e('<div class="progress"></div>');c.append(o);var r=e('<div style="width:500px;">正在结束阅卷...<br/><br/></div>');r.append(c);var u=i.dialog({content:r,fixed:!0,backdropOpacity:.7});u.showModal(),s(0,t,n,a,o,function(){e.post("/marking/joint-finished",{batch:d},function(e){i.msg("已结束阅卷",2e3,function(){u.close(),window.location.href="/"}),l=!1})},function(){u.close(),i.alert("操作失败，请刷新重试！"),l=!1})},s=function(n,a,o,c,r,d,l){if(n>=a.length)return d&&i.isFunction(d)&&d(),!1;var u={batch:a[n],paper_id:t,type:3,auto_set_icon:o,auto_set_score:c};e.post("/marking/finished",u,function(e){if(e.status){var t=Math.round((n+1)/a.length*100);r.attr("style","min-width:2em;width:"+t+"%;").text(t+"%"),setTimeout(function(){s(++n,a,o,c,r,d,l)},1e3)}else l&&i.isFunction(l)&&l()})},o=function(t,n){t.disableField('<i class="fa fa-spin fa-spinner fa-1x"></i>&nbsp;&nbsp;正在提交...');var a=function(){var a=template("finished-template"),s=i.dialog({content:a,fixed:!0,backdropOpacity:.7}),o=0;s.showModal();var c=e("#cbxFinishedAgree"),r=e("#btnFinishedOk"),d=e(".finished-step2");e("#btnFinishedCancel").bind("click",function(){t.undisableFieldset(),s.close().remove()}),c.bind("click",function(){c[0].checked?r.removeAttr("disabled"):r.attr("disabled","disabled")}),r.bind("click",function(){if(l)return!1;if(l=!0,r.disableField(),0==o)return e(".finished-step1").remove(),d.removeClass("hide"),e(this).html("确认结束"),o=1,l=!1,void i.later(function(){r.undisableFieldset()},500);var t=e("#cbxFinishedAutoSetIcon")[0].checked,a=e("#cbxFinishedAutoSetScore")[0].checked;n&&i.isFunction(n)&&n.call(this,t,a)})};"undefined"==typeof template?i.loadScript(i.sites["static"]+"/js/artTemplate.min.js",{success:function(){a()}}):a()},e(document).delegate(".b-complete","click",function(){var s=e(this);return d&&d.length?void o(s,function(o,c){r?e.post("/marking/joint-finished-check",{batch:d},function(e){if(s.removeAttr("disabled").html("结束批阅"),!e.status)return i.msg(e.message),void(l=!1);var n=e.data.batchs;t=s.data("paper"),a(n,o,c)}):(t=i.config("paperId"),n(o,c))}):void i.msg("没有检测到批次号，请重试")})}(jQuery,SINGER);