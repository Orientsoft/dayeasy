var marking=function(){var t={data:{batch:"",type:0,paperId:"",isAb:!1,sectionType:1,bagId:"",isRefresh:!1,isJoint:!0,allObjective:!1,loaded:!1,lock:!1,keydown:!0,editScore:!1,operation:0,url:DEYI.sites["static"]+"/v1/image/icon/marking/",deyiGroupId:"",questionGroupId:"",groupId:"",groupName:"",minScore:1,semiAuto:!1,semiScore:"50%",errorAuto:!1,errorScore:"100%"},questions:[],pictures:[],picture:{},details:[],region:{},_mix:function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])}};return t}();!function(t){t._mix(t,{dw:{doc:$(document),box:$("#mkBox"),n_icons:[],r_icons:[],images:["full.png","semi.png","error.png"],x:0,y:0,w:780,h:0,init:function(){$(".icon").remove();var e=singer.json(t.picture.icons)||[],i=singer.json(t.picture.marks)||[],a=0;if(i&&i.length)for(;a<i.length;a++)e.push({x:i[a].x,y:i[a].y,t:i[a].t,w:i[a].w});if(e&&e.length){var n=t.questions&&t.questions.length;for(a=0;a<e.length;a++){var o,d=e[a];if(d.id&&d.id.length&&n){for(var s=!1,r=0;r<t.questions.length;r++)if(t.questions[r].id==d.id){s=!0;break}if(!s)continue}if(d.x-=t.region.x,d.y-=t.region.y,4==d.t)o=$("<div class='icon icon-lg' style='font-size:24px;line-height:1em;font-family: 宋体;font-weight:bold;color:#fa8989;left: "+d.x+"px;top: "+d.y+"px;'>"+d.w+"</div>");else{var c="";if(d.t<3?c=t.data.url+t.dw.images[d.t]:5==d.t?c=t.data.url+"brow/"+d.w:3==d.t&&(c=t.data.url+d.w),o=$('<div class="icon '+(3==d.t?"icon-lg":"icon-sm")+'" style="left:'+d.x+"px;top:"+d.y+'px;">'),o.html('<img src="'+c+'"/>'),(1==d.t||2==d.t)&&d.id&&d.id.length){o.append('<div class="score">-'+(d.w||0)+"</div>");var l="T"+d.t+"_"+(d.x+"_"+d.y).replace(/\./gi,"D");o.attr("id",l).data("qId",d.id).data("t",d.t).data("score",d.w)}}t.dw.box.append(o.data("x",d.x).data("y",d.y))}}},print:function(e,i){t.qt.semiBox.hide();var a=t.dw.box.data("t");if("clear"!=a){(0>a||a>5)&&(a=0);var n=3>a?t.dw.images[a]:t.dw.box.data("v")||"";if(n){e=e||window.event;var o=parseInt(e.clientX+t.dw.doc.scrollLeft()-t.dw.x),d=parseInt(e.clientY+t.dw.doc.scrollTop()-t.dw.y);if(0==a||1==a)d-=23;else if(2==a)o-=3,d-=18;else if(5==a)switch(n){case"praise.png":o+=2;break;case"line.png":d+=4;break;case"wavy.png":d+=6;break;case"oval.png":o-=75,d-=6}if(t.dw.n_icons.length)for(var s=t.dw.n_icons.length;s>0;s--){var r=t.dw.n_icons[s-1];if(r.x==o&&r.y==d)return}var c,l,u={x:o,y:d,t:a,w:a>2?n:0};4==a?c=$("<div class='icon icon-lg' style='font-size:24px;line-height:1em;font-family: 宋体;font-weight:bold;color:#fa8989;left: "+o+"px;top: "+d+"px;'>").text(n):(c=$('<div class="icon '+(3==a?"icon-lg":"icon-sm")+'" style="left:'+o+"px;top:"+d+'px;">').html('<img src="'+t.data.url+(5==a?"brow/"+n:n)+'"/>'),3>a&&(u.id=i),(1==a||2==a)&&(c.append('<div class="score">-0</div>'),singer.isUndefined(i)||(l="T"+a+"_"+(o+"_"+d).replace(/\./gi,"D"),c.attr("id",l).data("qId",i).data("t",a).data("score",0)))),t.dw.box.append(c.data("x",o).data("y",d)),t.dw.n_icons.push(u),singer.isUndefined(i)||(1==a||2==a)&&t.dw.openScoreBox(i,a,{x:o,y:d},l)}}},clear:function(e){var i=parseFloat(e.data("score")||0);i>0&&t.qt.setScore(e.data("qId"),i,!1,0);var a=e.data("x"),n=e.data("y");e.remove();for(var o=!1,d=0;d<t.dw.n_icons.length;d++){var s=t.dw.n_icons[d];if(s.x==a&&s.y==n){o=!0,t.dw.n_icons.splice(d,1);break}}o||t.dw.r_icons.push({x:a+t.region.x,y:n+t.region.y})},openScoreBox:function(e,i,a,n){for(var o=0,d=0;d<t.questions.length;d++)if(t.questions[d].id==e){o=t.questions[d].score;break}if(0==o)return void t.qt.setScore(e,0,!0,0);if(1==i&&t.data.semiAuto||2==i&&t.data.errorAuto){var s=1==i?t.data.semiScore:t.data.errorScore,r=0;return r="50%"==s?0-o/2:"100%"==s?0-o:parseFloat(s),void t.qt.setScore(e,r,!1,n)}t.qt.semiBox.show(e,i,o,a,n)}},qt:{init:function(){var e=$("#questionList input");e.focus(function(){t.data.editScore=!0,$(this).data("blurCk",1)}).change(function(){t.data.editScore=!1,0!=$(this).data("blurCk")&&t.qt.ckScore($(this))}).bind("keydown",function(i){if(13==i.which){var a=$(this);if(!t.qt.ckScore(a))return;var n=a.data("index");if(n!=e.length)return void e.each(function(t,e){$(e).data("index")==n+1&&$(e).focus()});a.data("blurCk",0).blur(),t.mk.changePicture(1)}}).eq(0).focus(),$("#btnScoreToZero").bind("click",function(){e.val(0).each(function(e,i){t.qt.ckScore($(i))})})},ckScore:function(e){var i=e.parent().data("id"),a=e.val(),n=parseFloat(parseFloat(e.data("total")).toFixed(2)),o=parseFloat(parseFloat(e.data("score")).toFixed(2));return a&&a.length?/^[0-9]{0,3}\.??[0-9]{1,2}$/.test(a)?(a=parseFloat(parseFloat(a).toFixed(2)),a>n&&(a=n,e.val(n)),t.qt.setScore(i,a,!0,0),!0):(e.val(o),t.qt.setScore(i,o,!0,0),!1):!0},setScore:function(e,i,a,n){a=a||!1,i=parseFloat(i);var o=0,d=0;if(!t.questions||!t.questions.length)return void singer.msg("没有批阅任务");for(;o<t.questions.length;o++)if(t.questions[o].id==e){d=t.questions[o];break}if(!d)return void singer.msg("没有检测到题目分数，请刷新重试");var s=!1,r=0;if(t.details&&t.details.length)for(o=0;o<t.details.length;o++)if(t.details[o].question_id==e){s=!0,r=t.details[o];break}var c=0;if(r)c=r.score;else for(r={question_id:e},o=0;o<t.picture.details.length;o++)if(t.picture.details[o].questionId==e){c=t.picture.details[o].score;break}if(!singer.isUndefined(n)&&0!=n){var l=0-i;a&&(l=c+i),0>c+i&&(l=c);var u=$("#"+n);u.data("score",l),u.find("div").text("-"+l);var p=u.data("t"),m=u.data("x"),v=u.data("y");for(o=t.dw.n_icons.length-1;o>=0;o--){var f=t.dw.n_icons[o];if(f.t==p&&f.x==m&&f.y==v){f.w=l;break}}}var g=c;c=a?i:c+i,0>c&&(c=0),c>d.score&&(c=d.score),r.score=c,r.is_correct=c==d.score,s||t.details.push(r),$("#questionList").find(".item").each(function(t,i){$(i).data("id")==e&&$(i).find("input").val(c)}),t.data.isJoint||(t.picture.totalScore+=c-g,$(".stu-score").html(t.picture.totalScore))},semiBox:{timerId:0,iconId:0,show:function(e,i,a,n,o){(0!=t.qt.semiBox.timerId||0!=t.qt.semiBox.iconId)&&t.qt.semiBox.hide(),a=parseFloat(a||0);var d=$("#semiBox");d.html("");var s=122,r=$("<ul>");if(r.data("id",e).data("iconId",o),e&&a>0){var c=a>20?20:a;if(c>9&&(s=30*Math.ceil(c/3)+32),a>4){var l=0-(1==i?a/2:a);r.append('<li class="one" data-v="'+l+'">'+(1==i?"扣一半":"全扣")+"</li>")}for(var u=1;c>=u;)1!=t.data.minScore&&r.append('<li class="li-float-score" style="display: none;" data-v="'+(0-u+.5)+'">'+(0-u+.5)+"</li>"),r.append('<li class="li-int-score" data-v="'+(0-u)+'">'+(0-u)+"</li>"),++u>c&&u!=c+1&&r.append('<li class="li-int-score" data-v="'+(0-c)+'">'+(0-c)+"</li>");r.append('<li data-v="cancel" title="取消"><i class="fa fa-reply"></i></li>'),r.find("li").bind("click",function(){var e=$(this).data("v"),i=$(this).parent().data("id"),a=$(this).parent().data("iconId");return"cancel"==e?void t.qt.semiBox.hide():(t.qt.semiBox.iconId=0,t.qt.semiBox.hide(),void t.qt.setScore(i,parseFloat(e),!1,a))})}if(1!=t.data.minScore){s+=30;var p=$('<div class="box semi-box-tab"></div>');p.append('<div class="box-lg-6 active" data-v="1">整分</div>'),p.append('<div class="box-lg-6" data-v="0">小数</div>'),p.find("div").bind("mouseover",function(){var t=$(this);if(!t.hasClass("active")){p.find("div").removeClass("active"),t.addClass("active");var e=$("#semiBox");"1"==t.data("v")?(e.find(".li-int-score").show(),e.find(".li-float-score").hide()):(e.find(".li-int-score").hide(),e.find(".li-float-score").show())}}),d.append(p)}d.append(r),singer.isUndefined(n)||(t.dw.w-n.x<180&&(n.x-=172),d.data("xy",n.x+"-"+n.y+"-"+s).attr("style","top:"+n.y+"px;left:"+(n.x+50)+"px;")),t.qt.semiBox.iconId=o,t.qt.semiBox.timerId=window.setTimeout(function(){t.qt.semiBox.hide(200)},5e3),d.show()},hide:function(e){0!=t.qt.semiBox.timerId&&window.clearTimeout(t.qt.semiBox.timerId),0!=t.qt.semiBox.iconId&&t.dw.clear($("#"+t.qt.semiBox.iconId)),t.qt.semiBox.timerId=0,t.qt.semiBox.iconId=0,$("#semiBox").html("").fadeOut(e||0)}}},mk:{init:function(){$(".m-back").bind("click",function(){window.history.back()}),$(".a-exception").bind("click",function(){var e=$(this),i=$(".ms-submits li").eq(t.picture.index-1);if(0==e.data("type")){for(var a=[],n=0;n<t.questions.length;n++)a.push(t.questions[n].sort);var o="学生"+t.picture.index+" 题号："+a.join("、");t.data.isAb&&(o=(1==t.data.sectionType?"[A卷] ":"[B卷] ")+o),$.post("/marking/add-exception",{id:t.picture.jointPictureId,desc:o},function(t){if(!t.status)return void singer.msg(t.message);e.data("type",1).html("取消异常申报");var a=i.find("i");a&&a.length?a.attr("class","fa fa-exclamation i-declare"):i.append('<i class="fa fa-exclamation i-declare"></i>')})}else $.post("/marking/cancel-exception",{id:t.picture.jointPictureId},function(t){return t.status?(e.data("type",0).html("异常申报"),void i.find("i").remove()):void singer.msg(t.message)})}),$(".m-students-scroll").mCustomScrollbar({axis:"y",theme:"minimal-dark"}),$(".btn-mk-save").bind("click",function(){t.mt.submit(t.picture.pictureId,function(){t.mt.loadPicture(t.picture.jointPictureId),singer.msg("批阅进度已保存")})}),$(".btn-students").bind("click",function(){var t=$(".m-students");t.data("open")?t.data("open",0).hide():t.data("open",1).fadeIn(500)}),$(".ms-submits").delegate("li","click",function(){var e=$(this),i=e.data("id");i!=t.picture.pictureId&&($(".m-students").data("open",0).hide(),$(".ms-submits li").removeClass("active"),$(this).addClass("active"),$(".em-schedule-currect").html(e.data("idx")),t.data.isJoint&&!t.data.allObjective&&(i=e.data("jointid")),t.mt.submit(i))}),$("#semiBox").mouseover(function(){window.clearTimeout(t.qt.semiBox.timerId)}).mouseout(function(){t.qt.semiBox.timerId=window.setTimeout(function(){t.qt.semiBox.hide(200)},5e3)}),$(".m-change").click(function(){var e=parseInt($(this).data("v")||"1");t.mk.changePicture(e)}),t.data.keydown&&$(document).keydown(function(e){if(!t.data.editScore){var i=e.which;(37==i||39==i)&&t.mk.changePicture(37==i?-1:1)}}),$(".m-tools").find(".tool").bind("click",function(){t.qt.semiBox.hide();var e=$(this).data("t");if(!t.data.allObjective||"0"!=e&&"1"!=e&&"2"!=e&&"setting"!=e){if($(".m-tools").find(".tool").removeClass("active"),$(this).addClass("active"),"remark"==e)return $(".m-setting").data("open",0).hide(),void($(".remarks").data("open")?($(".remarks").data("open",0).hide(),t.data.keydown=!0):($(".remarks").data("open",1).fadeIn(500),t.data.keydown=!1));if($(".remarks").data("open",0).hide(),"setting"==e)return void($(".m-setting").data("open")?$(".m-setting").data("open",0).hide():$(".m-setting").data("open",1).fadeIn(500));if($(".m-setting").data("open",0).hide(),"zoom"==e){var i=$('<div class="img-enlarge-box">');i.html('<img style="width:'+1.3*t.region.width+'px;" src="'+t.picture.pictureUrl+'" />');var a=singer.dialog({title:"试卷大图",content:i,fixed:!1,quickClose:!0,backdropOpacity:.7});return a.showModal(),void $(a.node).find(".ui-dialog-body").css("padding","5")}t.data.keydown=!0,t.dw.box.data("t")!=e&&(t.dw.box.data("o",2),t.mk.setBox(e))}}),t.dw.box.bind("contextmenu",function(){return t.data.allObjective}).mousedown(function(e){if(!t.data.allObjective&&3==e.which){$(".m-tools").find(".tool").removeClass("active");var i=t.dw.box.data("t");0==i?(i=1,$(".tool-semi").addClass("active")):1==i?(i=2,$(".tool-error").addClass("active")):(i=0,$(".tool-full").addClass("active")),t.data.keydown=!0,$(".remarks").data("open",0).hide(),t.qt.semiBox.hide(),t.dw.box.data("o",2),t.mk.setBox(i)}}),$(".remarks li").bind("click",function(){var e=$(this).parent().data("t"),i=$(this).data("v");$(".remarks").data("open",0).hide(),t.data.keydown=!0,i!=t.dw.box.data("v")&&(t.dw.box.data("o",4),t.mk.setBox(e,i))}),$("#txtCustom").bind("change",function(){var t=$("#txtCustom").val();t&&t.length&&$("#txtCustom").val(t.replace(/['"<>]/gi,"").replace("_","").replace(/(\r)|(\n)/g," "))}),$("#btnUsageCustom").bind("click",function(){var e=$("#txtCustom").val().replace(/['"<>]/gi,"").replace("_","").replace(/(\r)|(\n)/g," ");if(!e||!e.length)return $(".custom-history").removeClass("hide"),void $(".custom-edit").addClass("hide");if($(".remarks").data("open",0).hide(),t.data.keydown=!0,$(".custom-history").removeClass("hide"),$(".custom-edit").addClass("hide"),e!=t.dw.box.data("v")){t.dw.box.data("o",4),t.mk.setBox(4,e);var i=$(".custom-history .list"),a=i.find(".item");i.html('<div class="ht item" title="点击使用">'+e+"</div>"),a&&a.length&&$(a).each(function(t,e){4>t&&i.append($(e))})}}),$(".custom-history").delegate(".item","click",function(){var e=$(this).text();return e&&e.length?($(".remarks").data("open",0).hide(),t.data.keydown=!0,void(e!=t.dw.box.data("v")&&(t.dw.box.data("o",4),t.mk.setBox(4,e)))):void singer.msg("说点什么吧...")}),$("#ddlMinScore").bind("change",function(){var t=parseFloat($(this).val()),e=$("#ddlSemiScore"),i=$("#ddlErrorScore");e.html('<option value="50%">扣一半</option>'),i.html('<option value="100%">全扣</option>');for(var a=1;5>=a;a++)1!=t&&(e.append('<option value="-'+(a-.5)+'">-'+(a-.5)+"分</option>"),i.append('<option value="-'+(a-.5)+'">-'+(a-.5)+"分</option>")),e.append('<option value="-'+a+'">-'+a+"分</option>"),i.append('<option value="-'+a+'">-'+a+"分</option>");e.append('<option value="100%">全扣</option>'),i.append('<option value="500%">扣一半</option>')}),$(".m-setting").find("input[name='rdoSemi']").bind("click",function(){var t=$(this).val();"1"==t?$("#ddlSemiScore").removeAttr("disabled"):$("#ddlSemiScore").attr("disabled","disabled")}),$(".m-setting").find("input[name='rdoError']").bind("click",function(){var t=$(this).val();"1"==t?$("#ddlErrorScore").removeAttr("disabled"):$("#ddlErrorScore").attr("disabled","disabled")}),$("#btnUpdateMkArea").bind("click",function(){t.mt.submit(t.picture.pictureId,function(){window.location.href="/marking/marking-area?batch="+t.data.batch+"&type="+t.data.type+"&isJoint="+t.data.isJoint})}),$("#btnCancelSetting").bind("click",function(){$(".m-setting").data("open",0).hide()}),$("#btnSaveSetting").bind("click",function(){var e=$(".m-setting");t.data.minScore=parseFloat($("#ddlMinScore").val()),t.data.semiAuto="1"==e.find("input[name='rdoSemi']:checked").val(),t.data.errorAuto="1"==e.find("input[name='rdoError']:checked").val(),t.data.semiAuto&&(t.data.semiScore=$("#ddlSemiScore").val()),t.data.errorAuto&&(t.data.errorScore=$("#ddlErrorScore").val()),1!=t.data.minScore?$("#questionList").find(".li-float-score").show():$("#questionList").find(".li-float-score").hide(),$(".m-setting").data("open",0).hide()}),t.dw.box.click(function(e){var i=t.dw.box.data("t");(3==i||4==i||5==i)&&(t.dw.print(e),t.data.operation=t.data.operation|(t.dw.box.data("o")||2))}),t.dw.box.delegate(".q-area","click",function(e){t.dw.print(e,$(this).data("id")),t.data.operation=t.data.operation|(t.dw.box.data("o")||2)}),t.dw.box.delegate(".icon","click",function(){var e=t.dw.box.data("t");"clear"==e&&(t.dw.clear($(this)),t.data.operation=6|t.data.operation)}),t.dw.box.delegate(".qa-sort","click",function(t){t.stopPropagation()}),t.dw.box.delegate(".q-area","mouseover",function(){$(this).addClass("q-area-active")}),t.dw.box.delegate(".q-area","mouseout",function(){$(this).removeClass("q-area-active")})},changePicture:function(e){if(t.data.stopping)return!1;if(t.data.lock)return t.data.stopping=!0,singer.msg("老师别急，正在努力加载中...",1e3,function(){t.data.stopping=!1}),!1;t.data.lock=!0;var i=parseInt($(".em-schedule-currect").text()||"1")+e,a=t.pictures&&t.pictures.length?t.pictures.length:0;1>i&&(i=1),i>a&&!t.data.isJoint&&(i=a);var n=a>=i?t.data.isJoint&&!t.data.allObjective?t.pictures[i-1].jointPictureId:t.pictures[i-1].pictureId:"";t.mk.studentActive(i),t.mt.submit(n)},setBox:function(e,i){switch(t.dw.box.data("v",0),e){case 0:return void t.dw.box.data("t",e).attr("class","cur-0");case 1:return void t.dw.box.data("t",e).attr("class","cur-1");case 2:return void t.dw.box.data("t",e).attr("class","cur-2");case"clear":return void t.dw.box.data("t",e).attr("class","cur-clear");case 3:case 4:return void t.dw.box.data("t",e).data("v",i).attr("class","cur-remark");case 5:switch(t.dw.box.data("t",e).data("v",i),i){case"smile.png":return void t.dw.box.attr("class","cur-bw-smile");case"cry.png":return void t.dw.box.attr("class","cur-bw-cry");case"praise.png":return void t.dw.box.attr("class","cur-bw-praise");case"doubt.png":return void t.dw.box.attr("class","cur-bw-doubt");case"line.png":return void t.dw.box.attr("class","cur-bw-line");case"wavy.png":return void t.dw.box.attr("class","cur-bw-wavy");case"oval.png":return void t.dw.box.attr("class","cur-bw-oval")}return}},studentActive:function(t){var e=$(".ms-submits li"),i=e.length;t-=1,0>t&&(t=0),i>t&&(e.removeClass("active"),e.eq(t).addClass("active"))}},mt:{initDialog:0,loadData:function(){var e=$('<div class="m-init-box f-tac">');e.append('<div><i class="fa fa-spin fa-spinner fa-4x"></i></div>'),e.append('<div class="m-init-message">正在准备阅卷数据，请稍候...</div>'),t.mt.initDialog=singer.dialog({content:e}),t.mt.initDialog.showModal(),$.post("/marking/load-bag",{id:t.data.bagId},function(e){e.status?t.mt.bindData(e.data):($(".dy-container").css("padding","0"),$(".m-message").text(e.message).removeClass("hide"),t.mt.initDialog.close().remove(),t.mt.initDialog=0)})},bindData:function(e){t.region=e.region,t.pictures=e.pictures,t.questions=e.questions,t.data.paperId=e.paperId,t.data.allObjective=e.allObjective||!1,t.data.isAb=e.isAb,t.data.batch=e.batch,t.data.sectionType=e.sectionType,t.data.type=e.isAb?e.sectionType:0;var i={isJoint:t.data.isJoint,paperTitle:e.paperTitle,pictures:t.pictures,unSubmits:e.unSubmits||[],unMarkingCount:e.unMarkingCount},a=template("m-header-box",i);$(".m-header-box").html(a).removeClass("hide");var n=template("question-template",{questions:t.questions});$("#questionList").append(n);for(var o=singer.json(e.areas)||[],d=$("#mkBox"),s=0;s<o.length;s++){var r=!t.data.isJoint,c=o[s];if(t.data.isJoint)for(var l=0;l<t.questions.length;l++)if(t.questions[l].id==c.id){r=!0;break}if(r){var u=c.x-t.region.x,p=c.y-t.region.y,m=$("<div class='q-area' style='position: absolute;width:"+c.width+"px;height:"+c.height+"px;left: "+u+"px;top: "+p+"px;' data-id='"+c.id+"' data-t='"+c.t+"' data-sort='"+c.index+"'>");m.append('<div class="qa-sort">'+c.index+"</div>"),t.data.isJoint||m.append('<div class="qa-share"><i class="fa fa-star"></i><span class="qa-share-text">晒答案</span></div>'),d.append(m)}}var v="";if(t.pictures&&t.pictures.length){var f=t.pictures[t.pictures.length-1];v=t.data.isJoint&&!t.data.allObjective?f.jointPictureId:f.pictureId,t.mk.studentActive(t.pictures.length)}$(".m-body").removeClass("hide"),$(".m-prompt-box").removeClass("hide"),0!=t.mt.initDialog&&(t.mt.initDialog.close().remove(),t.mt.initDialog=0),t.mt.loadPicture(v),t.qt.init(),t.mk.init()},loadPicture:function(e){if(!(t.data.allObjective||t.questions&&t.questions.length))return $(".m-body").addClass("hide"),$(".m-prompt-box").addClass("hide"),$(".em-schedule-currect").text("0"),$(".dy-container").css("padding","0"),$(".m-message").text("没有批阅任务").removeClass("hide"),$(".j-autoHeight").attr("style","height:"+$(window).height()+"px;"),void(t.data.lock=!1);if(e&&e.length){var i="";if(t.picture&&(i=t.data.isJoint&&!t.data.allObjective?t.picture.jointPictureId:t.picture.pictureId),!t.data.isRefresh&&e==i)return 1==t.picture.index&&singer.msg("已批阅到第一份试卷啦~"),t.picture.index==t.pictures.length&&singer.msg("没有待批阅的试卷啦~"),void(t.data.lock=!1)}else if(t.data.loaded&&0==parseInt($(".em-schedule-surplus").text()||"0"))return singer.msg("没有待批阅的试卷啦~"),void(t.data.lock=!1);t.data.isRefresh=!1,$.post("/marking/joint-bag-picture",{bag_id:t.data.bagId,picture_id:e},function(i){t.mt.jsonPicture(i,e)}),t.data.loaded||(t.data.loaded=!0)},jsonPicture:function(e,i){if(!e.status||!e.data)return t.pictures&&t.pictures.length?void singer.msg(e.message||"答卷加载失败"):($(".m-body").addClass("hide"),$(".m-prompt-box").addClass("hide"),$(".dy-container").css("padding","0"),$(".m-message").text("没有待批阅的答卷").removeClass("hide"),void $(".j-autoHeight").attr("style","height:"+$(window).height()+"px;"));if(t.picture=e.data,t.data.isJoint&&(!i||!i.length)){t.pictures.push({jointPictureId:t.picture.jointPictureId,pictureId:t.picture.pictureId});var a=$('<li class="active">');a.data("id",t.picture.pictureId).data("jointid",t.picture.jointPictureId).data("idx",t.pictures.length).html("<span>学生"+t.pictures.length+"</span>");var n=$(".ms-submits");n.find("li").removeClass("active"),n.append(a)}t.mt.bindPicture()},bindPicture:function(){for(var e=0;e<t.pictures.length;e++)if(t.pictures[e].pictureId==t.picture.pictureId){var i=t.pictures[e];t.picture.index=e+1,t.data.isJoint||(t.picture.studentId=i.studentId,t.picture.studentName=i.studentName);break}if($("#markingImage").unbind("load.marking").bind("load.marking",function(){t.data.lock=!1}).attr("src",t.picture.pictureUrl),t.picture.details&&t.picture.details.length){var a=$("#questionList").find(".item");for(e=0;e<t.picture.details.length;e++){var n=t.picture.details[e];a.each(function(t,e){$(e).data("id")==n.questionId&&$(e).find("input").data("score",n.score).attr("placeholder",n.score).val("")})}}$("#questionList input").eq(0).focus(),$(".em-schedule-currect").html(t.picture.index),$(".em-schedule-readed").text(t.pictures.length),t.picture.unMarkingCount>-1&&$(".em-schedule-surplus").data("count",t.picture.unMarkingCount).text(t.picture.unMarkingCount),null==t.picture.exceptionType?$(".a-exception").data("type",0).html("异常申报"):$(".a-exception").data("type",1).html("取消异常申报"),t.dw.init()},schedule:function(){if(t.picture&&t.picture.pictureId&&t.picture.pictureId.length){var e=t.data.isJoint&&!t.data.allObjective?t.picture.jointPictureId:t.picture.pictureId;t.mt.submit(e)}var i=singer.dialog({content:'<i class="fa fa-spin fa-spinner fa-2x"></i>&nbsp;&nbsp;请稍后，正在查询进度...'});i.showModal(),$.get("/marking/schedule",{batch:t.data.batch,t:Math.random()},function(t){singer.dialog({title:"批阅进度",content:t}).showModal(),i.close().remove()})},submit:function(e,i){if(t.qt.semiBox.hide(),0!=t.data.operation||t.details&&t.details.length){t.data.lock=!0;var a=[],n=[];if(t.dw.n_icons&&t.dw.n_icons.length&&((4&t.data.operation)>0||(2&t.data.operation)>0)){for(var o=0;o<t.dw.n_icons.length;o++){var d={x:t.dw.n_icons[o].x+t.region.x,y:t.dw.n_icons[o].y+t.region.y,t:t.dw.n_icons[o].t,w:t.dw.n_icons[o].w};0==t.dw.n_icons[o].t||1==t.dw.n_icons[o].t||2==t.dw.n_icons[o].t?(d.id=t.dw.n_icons[o].id,a.push(d)):n.push(d)}0==(2&t.data.operation)&&(a=[]),0==(4&t.data.operation)&&(n=[])}$.post("/marking/submit",{pictureId:t.picture.pictureId,operation:t.data.operation,paperType:0,icons:singer.json(a).replace(/\'/gi,'"'),marks:singer.json(n).replace(/\'/gi,'"'),removeIcons:singer.json(t.dw.r_icons).replace(/\'/gi,'"'),detailData:singer.json(t.details).replace(/\'/gi,'"')},function(a){if(a.status){if(t.details=[],t.data.operation=0,t.dw.n_icons=[],t.dw.r_icons=[],t.data.isRefresh=!0,$('.ms-submits li[data-id="'+t.picture.pictureId+'"]').find("i").remove(),i&&singer.isFunction(i))return void i.call(this);t.mt.loadPicture(e)}else t.data.lock=!1,singer.msg(a.message)})}else{if(i&&singer.isFunction(i))return void i.call(this);t.mt.loadPicture(e)}},finished:function(e,i){t.data.isJoint||$.post("/marking/finished",{batch:t.data.batch,paper_id:t.data.paperId,type:t.data.type,auto_set_icon:e,auto_set_score:i},function(t){t.status?singer.msg("已结束阅卷",2e3,function(){window.location.href="/work/teacher"}):singer.msg(t.message)})}}})}(marking),$(function(t){if(t("#txtFail").val())return void t(".dy-container").css("padding","0");var e=singer.uri().id;if(singer.isUndefined(e)||""==e)return t(".dy-container").css("padding","0"),void t(".m-message").text("参数错误").removeClass("hide");var i=t(window).width(),a=t(window).height();(!i||1280>i)&&(i=1280);var n=(i-1e3)/2+175-9,o=80;marking.dw.y=o,marking.dw.x=n,t(".m-body").attr("style","min-height:"+(a-130)+"px;margin-left:"+n+"px;"),t(".m-tools").attr("style","top:"+o+"px;left:"+(n+781)+"px;"),t(".m-goal").attr("style","left:"+(n-175)+"px;top:"+o+"px;"),t(".m-change-left").attr("style","top:"+(a/2-37)+"px;left:"+(n-175-74-50)+"px;"),t(".m-change-right").attr("style","top:"+(a/2-37)+"px;left:"+(n+780+45+50)+"px;"),t(".remarks").find(".title").bind("click",function(){switch(t(".remarks").find(".title").removeClass("active"),t(".remarks").find(".content").addClass("hide"),t(this).addClass("active"),t(this).data("t")){case 3:t(".remarks").find(".c-text").removeClass("hide");break;case 5:t(".remarks").find(".c-brow").removeClass("hide");break;default:t(".remarks").find(".c-custom").removeClass("hide")}}),t(".custom-history").find(".edit").bind("click",function(){t(".custom-history").addClass("hide"),t(".custom-edit").removeClass("hide"),t(".txt-custom").focus()}),marking.data.bagId=e,marking.data.isJoint=!0,marking.mt.loadData()});