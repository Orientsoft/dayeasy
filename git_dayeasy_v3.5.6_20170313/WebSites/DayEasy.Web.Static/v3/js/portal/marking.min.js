var marking=function(){var t={set_def:!0,data:{},item:{},url:DEYI.sites["static"]+"/v1/image/icon/marking/",isLoadArea:!1,firstBindShare:!1,lock:!1,keydown:!0,charCode:function(t){t=t||[];for(var e="",i=0;i<t.length;i++)t[i]>-1&&t[i]<26&&(e+=String.fromCharCode(65+t[i]));return e},equals:function(t,e){if(t=t||[],e=e||[],t.length!=e.length)return!1;for(var i=0;i<t.length;i++)if(!singer.inArray(t[i],e))return!1;return!0},_mix:function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])}};return t}();!function(t){t._mix(t,{dw:{doc:$(document),icons:[],n_icons:[],r_icons:[],images:["full.png","semi.png","error.png"],curs:["cur-0","cur-1","cur-2","cur-clear","cur-remark","cur-bw-smile","cur-bw-cry","cur-bw-praise","cur-bw-doubt"],main:$(".m-box"),x:0,y:0,w:780,h:0,bindShares:function(){t.isLoadArea&&(t.firstBindShare||(t.firstBindShare=!0),$(".q-area").each(function(e,i){var a=$(i).data("id"),s=!1;if(t.item.student_id>10)for(var n=0;n<t.data.shares.length;n++){var d=t.data.shares[n];if(d.question_id==a&&d.student_id==t.item.student_id){s=!0;break}}var r=$("<div>");s?r.attr("class","share-active").html('<i class="fa fa-star"></i><span>已晒</span>'):r.attr("class","item share").html('<i class="fa fa-star"></i><span>晒答案</span>'),$(i).append(r)}))},init:function(e,i,a,s){if(t.dw.x=e||t.dw.x,t.dw.y=i||t.dw.y,t.dw.w=a||t.dw.c,t.dw.h=s||t.dw.h,t.dw.icons.length)for(var n=0;n<t.dw.icons.length;n++){var d,r=t.dw.icons[n];if(4==r.t)d=$("<div class='icon icon-lg' style='font-size:24px;line-height:1em;font-family: 宋体;font-weight:bold;color:#fa8989;left: "+r.x+"px;top: "+r.y+"px;'>"+r.w+"</div>");else{var o=t.url+r.w;if(5==r.t?o=t.url+"brow/"+r.w:r.t<3&&(o=t.url+t.dw.images[r.t]),d=$('<div class="icon '+(3==r.t?"icon-lg":"icon-sm")+'" style="left:'+r.x+"px;top:"+r.y+'px;">').html('<img src="'+o+'"/>'),(1==r.t||2==r.t)&&r.id&&r.id.length){d.append('<div class="score">-'+(r.w||0)+"</div>");var c="T"+r.t+"_"+(r.x+"_"+r.y).replace(/\./gi,"D");d.attr("id",c).data("qId",r.id).data("t",r.t).data("score",r.w)}}t.dw.main.append(d.data("x",r.x).data("y",r.y))}},print:function(e,i,a,s){t.qt.semiBox.hide();var n=t.dw.main.data("t");if("clear"!=n){(0>n||n>5)&&(n=0);var d=n>2?t.dw.main.data("v")||"":t.dw.images[n];if(d){var e=e||window.event,r=parseInt(e.clientX+t.dw.doc.scrollLeft()-t.dw.x),o=parseInt(e.clientY+t.dw.doc.scrollTop()-t.dw.y);if(0==n||1==n?o-=23:2==n&&(r-=3,o-=18),t.dw.icons.length>0)for(var c=t.dw.icons.length;c>0;c--){var l=t.dw.icons[c-1];if(l.x==r&&l.y==o)return}var m,u={x:r,y:o,t:n,w:n>2?d:0};if(4==n)m=$("<div class='icon icon-lg' style='font-size:24px;line-height:1em;font-family: 宋体;font-weight:bold;color:#fa8989;left: "+r+"px;top: "+o+"px;'>").text(d);else if(m=$('<div class="icon '+(3==n?"icon-lg":"icon-sm")+'" style="left:'+r+"px;top:"+o+'px;">').html('<img src="'+t.url+(5==n?"brow/"+d:d)+'"/>'),3>n&&(u.id=i),(1==n||2==n)&&(m.append('<div class="score">-0</div>'),!singer.isUndefined(i))){var f="T"+n+"_"+(r+"_"+o).replace(/\./gi,"D");m.attr("id",f).data("qId",i).data("t",n).data("score",0)}m.data("x",r).data("y",o),t.dw.main.append(m),t.dw.icons.push(u),t.dw.n_icons.push(u),singer.isUndefined(i)||(singer.isUndefined(s)||($("#questionList .item").removeClass("active"),$(".num-"+s).addClass("active"),$(".scroll-items").mCustomScrollbar("scrollTo",".num-"+s)),1==n&&t.dw.openScoreBox(i,n,{x:r,y:o},f),2==n&&(a?t.qt.setScore(i,0,f,!1):t.dw.openScoreBox(i,n,{x:r,y:o},f)))}}},clear:function(e){var i=parseInt(e.data("score")||0);i>0&&t.qt.setScore(e.data("qId"),i,0);var a=e.data("x"),s=e.data("y");e.remove();for(var n=!1,d=0;d<t.dw.n_icons.length;d++){var r=t.dw.n_icons[d];if(r.x==a&&r.y==s){n=!0,t.dw.n_icons.splice(d,1);break}}for(var o=0;o<t.dw.icons.length;o++){var c=t.dw.icons[o];if(c.x==a&&c.y==s){t.dw.icons.splice(o,1),n||t.dw.r_icons.push({x:a,y:s});break}}},openScoreBox:function(e,i,a,s){for(var n=0,d=t.data.pictures[t.item.i-1].details,r=0;r<d.length;r++)if(d[r].id==e){n=d[r].total;break}0==n?t.qt.setScore(e,0,0,!1):t.qt.semiBox.show(e,i,n,a,s)},updateIcon:function(e,i,a,s){for(var n=0;n<t.dw.icons.length;n++){var d=t.dw.icons[n];if(d.t==e&&d.x==i&&d.y==a){d.w=s;break}}},loadQuestionArea:function(){if(!t.isLoadArea){if(t.isLoadArea=!0,t.data.question_area&&t.data.question_area.length){t.data.question_area=singer.json(t.data.question_area);for(var e=0;e<t.data.question_area.length;e++){var i=t.data.question_area[e],a=$("<div class='q-area' style='position: absolute;width:"+i.width+"px;height:"+i.height+"px;left: "+i.x+"px;top: "+i.y+"px;' data-id='"+i.id+"' data-t='"+i.t+"' data-sort='"+i.index+"'>"),s=$('<div class="item sort">');s.text(i.index),a.append(s),t.dw.main.append(a)}}t.firstBindShare||(t.firstBindShare=!0,t.dw.bindShares())}}},qt:{bind:function(){var e=!1,i=!1,a=!1,s=$("#questionList"),n="",d="";s.html("");var r=t.item.i-1,o=0,c=t.data.pictures[r];if(c.student_id<10)return void $("#totalScore").text("0");var l=c.details;t.item.total=0,t.item.details=[];for(var m=$("#objQuestionBox").html(),u=$("#objQuestionItem").html(),f=$("#hasScoreQuestionItem").html(),p=$("#noScoreQuestionItem").html(),h=0;h<t.data.questions.length;h++){var v=t.data.questions[h],g=t.mt.detail(l,v.id);if(singer.isUndefined(g.id))return $("#totalScore").text("0"),void singer.alert("没有找到当前学生的作答信息！");if(g.total=v.score,v.objective)if(e=!0,h==t.data.questions.length-1&&m.replace('<div class="qc-line"></div>',""),v.smalls&&v.smalls.length)for(var w=0;w<v.smalls.length;w++){var x=v.smalls[w],k=t.mt.detail(l,v.id,x.id);if(singer.isUndefined(k.id))return $("#totalScore").text("0"),void singer.alert("没有找到当前学生的作答信息！");k.correct||(i=!0,n+=u.replace("{id}",g.id).replace("{qNo}",v.sort+"."+x.sort).replace("{small_id}",k.small_id)),t.item.total+=k.score}else g.correct||(i=!0,n+=u.replace("{id}",g.id).replace("{qNo}",v.sort).replace("{small_id}","")),t.item.total+=g.score;else{o++;var b="";if(v.score<=0)a=!0,b=p.replace("{id}",g.id).replace("{qNo}",v.sort).replace("{sort}",v.sort).replace("{fullActive}",g.correct?" active":"").replace("{errorActive}",g.correct?"":" active"),h==t.data.questions.length-1&&(b=b.replace('<div class="qc-line"></div>',"")),d+=b;else{for(var _="",y=0;y<=v.score;y++)_+="<li"+(y==v.score?" class='last-num-"+v.sort+"'":"")+">"+y+"</li>";b=f.replace("{id}",g.id).replace("{qNo}",v.sort).replace("{sort}",v.sort).replace("{cScore}",g.score).replace("{liScores}",_),b=h==t.data.questions.length-1?b.replace('<div class="qc-line"></div>',"").replace("{isLast}"," last"):b.replace("{isLast}",""),d+=b}t.item.total+=g.score}}if(t.item.student_id<1&&(c.details=l),$("#totalScore").text(t.item.total),e){var q="";q=i?m.replace("{items}",n).replace("cursor-clear","").replace("{clear}",0):m.replace("{items}","").replace("客观错题","客观题全对").replace("{clear}",1),s.append(q)}s.append(d)},init:function(){$("#questionList").delegate(".obj-item","click",function(){var e=$(this).data("id")||0,i=$(this).data("smid")||0;if(e){var a=$(this).data("full")||0;a?$(this).removeClass("active").find("i").attr("class","fa fa-times"):$(this).addClass("active").find("i").attr("class","fa fa-check"),$("#questionList .item").removeClass("active"),$(".obj-questions").parents(".item").addClass("active"),$(this).data("full",!a);for(var s=t.data.pictures[t.item.i-1].details,n=!1,d=0;d<s.length;d++){var r=$.extend(!0,{},s[d]);if(r.id==e&&(!i||r.small_id==i)){if(t.item.details.length){var o=t.mt.detail(t.item.details,e,i);(o.id||"")!=e||i&&r.small_id!=i||(r=o,n=!0)}return r.correct=!r.correct,r.score=r.correct?r.total:0,t.item.total+=r.correct?r.total:0-r.total,$("#totalScore").text(t.item.total),t.item.o=8|t.item.o,void(n?t.mt.remove(t.item.details,e,i):t.item.details.push(r))}}}}),$("#questionList").delegate(".qc-num","click",function(){if(!$(this).data("clear")){if($("#questionList .item").removeClass("active"),$("#questionList .qc-scores").hide(),$(this).data("open"))$(this).data("open",0);else{var t=$(this).parents(".item");t.addClass("active"),$(this).data("open",1).siblings(".qc-scores").slideDown(200,function(){t.hasClass("last")&&$(".scroll-items").mCustomScrollbar("scrollTo","bottom")})}$("#questionList .qc-num").not($(this)).data("open",0)}}).delegate(".qc-scores li","click",function(){var e=$(this).parents(".item"),i=$(this).text(),a=e.data("id");e.find(".num").text(i),$("#questionList .item").removeClass("active"),$(this).parents(".item").addClass("active"),t.qt.setScore(a,i)}).delegate(".no-score","click",function(){var e=$(this).data("v");if(1==e||0==e){$("#questionList .item").removeClass("active"),$(this).parents(".item").addClass("active");var i=$(this).parents(".item").data("id");t.qt.setScore(i,0,0,e>0)}})},setScore:function(e,i,a,s){i=parseInt(i);for(var n=t.data.pictures[t.item.i-1].details,d=0;d<n.length;d++){var r=$.extend(!0,{},n[d]),o=!1;if(r.id==e){if(t.item.details.length){var c=t.mt.detail(t.item.details,e);(c.id||"")==e&&(r=c,o=!0)}if(t.item.o=8|t.item.o,0==r.total)r.correct=s||!1,o?n[d].correct==r.correct&&t.mt.remove(t.item.details,r.id):t.item.details.push(r),$("#questionList").find(".item").each(function(t,i){if($(i).data("id")==e){var a=$(i).find(".no-score");$(a).removeClass("active"),$(a).each(function(t,e){r.correct&&$(e).data("v")?$(e).addClass("active"):r.correct||$(e).data("v")||$(e).addClass("active")})}});else{if(singer.isUndefined(s)||(i=0-r.total),!singer.isUndefined(a)){if(0!=a){var l=$("#"+a),c=0-i;r.score+i<0&&(c=r.score),l.data("score",c),l.find("div").text("-"+c).show(),t.dw.updateIcon(l.data("t"),l.data("x"),l.data("y"),c)}i+=r.score}0>i&&(i=0),i>r.total&&(i=r.total),r.correct=i==r.total,t.item.total+=i-r.score,r.score=i,$("#totalScore").text(t.item.total),o?n[d].correct==r.correct&&n[d].score==r.score&&t.mt.remove(t.item.details,r.id):t.item.details.push(r),$("#questionList").find(".item").each(function(t,a){$(a).data("id")==e&&$(a).find(".num").text(i)})}break}}},semiBox:{timerId:0,show:function(e,i,a,s,n){var d=$("#semiBox");a=parseInt(a||0);var r=122;if(e&&a>0){d.html("");var o=$("<ul>"),c=1,l=a;if(a>4){c=0;var m=0-Math.ceil(a/2)}for(a>20&&(l=20),l>9&&(r=30*Math.ceil(l/3)+32);l>=c;c++){var u=0-c;0==c&&(1==i?u=m:2==i&&(u=0-a));var f='<li data-v="'+u+'"'+(0==c?'class="one"':"")+">"+(0==c?2==i?"全扣":"扣一半":u)+"</li>",p=$(f).click(function(){t.qt.semiBox.hide(),t.qt.setScore(e,parseInt($(this).data("v")),n)});o.append(p)}var h=$('<li data-v="cancel" title="取消"><i class="fa fa-reply"></i></li>').click(function(){t.qt.semiBox.hide(),t.dw.clear($("#"+n))});o.append(h),d.append(o)}singer.isUndefined(s)||(t.dw.w-s.x<180&&(s.x-=172),t.dw.h-s.y<r&&(s.y-=r-50),d.data("xy",s.x+"-"+s.y+"-"+r).attr("style","top:"+s.y+"px;left:"+(s.x+50)+"px;")),d.show(),t.qt.semiBox.timerId=window.setTimeout(function(){t.qt.semiBox.hide(200)},5e3)},hide:function(e){window.clearTimeout(t.qt.semiBox.timerId),e=e||0,e>0?$("#semiBox").html("").fadeOut(e):$("#semiBox").html("").hide(e)}}},mk:{init:function(){$(".p-no .fs-total").text(t.data.pictures.length),$("#semiBox").mouseover(function(){window.clearTimeout(t.qt.semiBox.timerId)}).mouseout(function(){t.qt.semiBox.timerId=window.setTimeout(function(){t.qt.semiBox.hide(200)},5e3)}),$(".m-back").bind("click",function(){t.item.o>0?t.mt.submit(-1,t.mk.back):window.location.href="/work"});for(var e="",i=0;i<t.data.pictures.length;i++){t.data.pictures[i].i=i+1;var a="",s=t.data.pictures[i];0==i&&(a=' class="active"'),s.student_id<1&&(a=' class="fail"',s.student_name="未识别"),e+="<li"+a+" data-idx='"+(i+1)+"' data-id='"+s.id+"'>"+s.student_name+"</li>"}if($("#studentList").html(e).delegate("li","click",function(){if(t.lock&&$(this).data("id")!=t.item.id)for(var e=0;e<t.data.pictures.length;e++)if(t.data.pictures[e].id==$(this).data("id")){t.lock=!1,t.mt.submit(e),$(".m-progress").find(".students").fadeOut(200);break}}),t.data.un_submits&&t.data.un_submits.length){for(var n=$(".un-submits"),d=0;d<t.data.un_submits.length;d++)n.append("<span>"+t.data.un_submits[d]+"</span>");n.show()}$(".m-change").click(function(){if(!(t.data.pictures.length<2)&&t.lock){t.lock=!1;var e=$(this).data("v")+t.item.i;1>e&&(e=t.data.pictures.length),e>t.data.pictures.length&&(e=1),t.mt.submit(e-1)}}),$(document).keydown(function(e){if(t.keydown&&t.lock){var i=e.which;if(37==i||39==i){if(t.data.pictures.length<2)return;t.lock=!1;var a=t.item.i+(37==i?-1:1);1>a&&(a=t.data.pictures.length),a>t.data.pictures.length&&(a=1),t.mt.submit(a-1)}}}),$(".m-tools").find(".tool").bind("click",function(){$("#dt_marks").hide(),t.qt.semiBox.hide(),$(".m-tools").find(".tool").removeClass("active"),$(this).addClass("active");var e=$(this).data("t");return"remark"==e?void($(".remarks").data("open")?($(".remarks").data("open",0).hide(),t.keydown=!0):($(".remarks").data("open",1).fadeIn(200),t.keydown=!1)):($(".remarks").data("open",0).hide(),t.keydown=!0,void(t.dw.main.data("t")!=e&&(t.dw.main.data("o",2),t.mk.setBox(e))))}),t.dw.main.bind("contextmenu",function(){return!1}).mousedown(function(e){if(3==e.which){$(".m-tools").find(".tool").removeClass("active");var i=t.dw.main.data("t");0==i?(i=1,$(".tool-semi").addClass("active")):1==i?(i=2,$(".tool-error").addClass("active")):(i=0,$(".tool-full").addClass("active")),t.keydown=!0,$(".remarks").data("open",0).hide(),t.qt.semiBox.hide(),t.dw.main.data("o",2),t.mk.setBox(i)}}),$(".remarks li").bind("click",function(){var e=$(this).parent().data("t"),i=$(this).data("v");$(".remarks").data("open",0).hide(),t.keydown=!0,i!=t.dw.main.data("v")&&(t.dw.main.data("o",4),t.mk.setBox(e,i))}),$("#txtCustom").bind("change",function(){var t=$("#txtCustom").val();t&&t.length&&$("#txtCustom").val(t.replace(/['"<>]/gi,"").replace("_","").replace(/(\r)|(\n)/g," "))}),$("#btnUsageCustom").bind("click",function(){var e=$("#txtCustom").val().replace(/['"<>]/gi,"").replace("_","").replace(/(\r)|(\n)/g," ");if(!e||!e.length)return $(".custom-history").removeClass("hide"),void $(".custom-edit").addClass("hide");if($(".remarks").data("open",0).hide(),t.keydown=!0,$(".custom-history").removeClass("hide"),$(".custom-edit").addClass("hide"),e!=t.dw.main.data("v")){t.dw.main.data("o",4),t.mk.setBox(4,e);var i=$(".custom-history .list"),a=i.find(".item");i.html('<div class="ht item" title="点击使用">'+e+"</div>"),a&&a.length&&$(a).each(function(t,e){4>t&&i.append($(e))})}}),$(".custom-history").delegate(".item","click",function(){var e=$(this).text();return e&&e.length?($(".remarks").data("open",0).hide(),t.keydown=!0,void(e!=t.dw.main.data("v")&&(t.dw.main.data("o",4),t.mk.setBox(4,e)))):void singer.msg("说点什么吧...")}),t.dw.main.click(function(e){var i=t.dw.main.data("t");(3==i||4==i||5==i)&&(t.item.student_id<10||(t.dw.print(e),t.item.o=t.item.o|(t.dw.main.data("o")||2)))}),t.dw.main.delegate(".q-area","click",function(e){return t.item.student_id<10?void singer.msg("学生未识别，请先绑定学生后再批阅"):(t.dw.print(e,$(this).data("id"),$(this).data("t"),$(this).data("sort")),void(t.item.o=t.item.o|(t.dw.main.data("o")||2)))}),t.dw.main.delegate(".icon","click",function(){var e=t.dw.main.data("t");if("clear"==e){if(t.item.student_id<10)return void singer.msg("学生未识别，请先绑定学生后再批阅");t.dw.clear($(this)),t.item.o=6|t.item.o}}),t.dw.main.delegate(".sort","click",function(t){t.stopPropagation()}),t.dw.main.delegate(".share-active","click",function(t){t.stopPropagation()}),t.dw.main.delegate(".share","click",function(e){if(e.stopPropagation(),t.item.student_id<10)return void singer.msg("学生未识别，请先绑定学生后再分享");var i=$(this),a=i.parent().data("id");singer.confirm("请确认您分享的是本题的正确答案",function(){$.post("marking/add-share",{batch:t.data.batch,paper_id:t.data.paper_id,group_id:t.data.class_id,question_id:a,student_id:t.item.student_id,student_name:t.item.student_name},function(e){e.status?(t.data.shares||(t.data.shares=[]),t.data.shares.push({id:e.data,question_id:a,student_id:t.item.student_id}),i.removeClass("item").removeClass("share").addClass("share-active").html('<i class="fa fa-star"></i><span>已晒</span>'),singer.msg("分享成功")):singer.msg(e.message)})})}),$("#markingImage").load(function(){t.dw.init($(this).offset().left,$(this).offset().top,$(this).width(),$(this).height()),t.dw.loadQuestionArea()}),$(".finished").click(function(){t.set_def=!0;var e=$('<div style="line-height:2em;">完成<span style="color:#fa9632;font-size:16px;">所有</span>批阅后，将生成统计报表，<span style="color:#fa9632;font-size:16px;">不可</span>再更改。<br/>确认完成吗？<br/></div>'),i=$('<div class="finish-box"><div class="f01"><i class="fa fa-check"></i></div><div> &nbsp;为正确题目自动标记 “ √ ”</div></div>');i.bind("click",function(){$(this).data("ns")?($(this).data("ns",!1),$(this).find(".f01").attr("style",""),t.set_def=!0):($(this).data("ns",!0),$(this).find(".f01").attr("style","color:#fff"),t.set_def=!1)}),e.append(i),singer.dialog({title:"完成批阅",content:e,fixed:!0,backdropOpacity:.7,okValue:"确定",cancelValue:"取消",ok:function(){t.item.o>0?t.mt.submit(-1,t.mt.finished):t.mt.finished()},cancel:function(){}}).showModal()}),$(".btn-bind").click(function(){t.item.student_id<1&&$.post("marking/unbind",{id:t.item.id,batch:t.data.batch,group_id:t.data.class_id},function(e){if(!e.status)return void singer.msg("加载未绑定学生资料失败");var i=$('<div id="unBindParentBox" data-id="'+t.data.class_id+'" style="min-width: 300px;min-height: 80px;max-width: 600px;max-height: 250px;"></div>');i.bind("click",function(t){return t.stopPropagation(),!1}),i.append(t.mk.unBindStudents(e.data));var a="绑定"+t.data.class_name+"的学生";singer.dialog({title:a,content:i,fixed:!0,backdropOpacity:.7,okValue:"确定",cancelValue:"取消",ok:function(){return t.item.student_id<1?(singer.msg("请选择学生"),!1):void $.post("marking/bind",{id:t.item.id,student_id:t.item.student_id,student_name:t.item.student_name,batch:t.data.batch},function(e){return e.status?void singer.msg("绑定成功",500,function(){var e="marking?batch="+t.data.batch;singer.uri().type&&(e+="&type="+singer.uri().type),window.location.href=e}):void singer.msg(e.message)})},cancel:function(){t.item.student_id=0,t.item.student_name="未绑定"}}).showModal()})}),$(".cancel-bind").click(function(){singer.dialog({title:"解除绑定",content:'解除绑定后将<span style="color:#fa9632;font-size:16px;">失去</span>当前答卷的批阅记录。<br/>确认解除吗？',fixed:!0,backdropOpacity:.7,okValue:"确定",cancelValue:"取消",ok:function(){$.post("marking/cancel-bind",{id:t.item.id},function(e){e.status?singer.msg("操作成功",500,function(){var e="marking?batch="+t.data.batch;singer.uri().type&&(e+="&type="+singer.uri().type),window.location.href=e}):singer.msg(e.message)})},cancel:function(){}}).showModal()})},bind:function(){t.item.student_id>0?($(".questions").show(),$(".loco").find(".binded").show(),$(".loco").find(".unbind").hide(),$("#studentName").text(t.item.student_name)):($(".questions").hide(),$(".loco").find(".binded").hide(),$(".loco").find(".unbind").show()),$(".p-no .fs-big").text(t.item.i),$(".m-progress li").removeClass("active").each(function(e,i){return $(i).data("id")==t.item.id?void $(i).addClass("active"):void 0})},setBox:function(e,i){switch(t.dw.main.data("v",0),e){case 0:return void t.dw.main.data("t",e).removeClass(t.dw.curs.join(" ")).addClass("cur-0");case 1:return void t.dw.main.data("t",e).removeClass(t.dw.curs.join(" ")).addClass("cur-1");case 2:return void t.dw.main.data("t",e).removeClass(t.dw.curs.join(" ")).addClass("cur-2");case"clear":return void t.dw.main.data("t",e).removeClass(t.dw.curs.join(" ")).addClass("cur-clear");case 3:case 4:return void t.dw.main.data("t",e).data("v",i).removeClass(t.dw.curs.join(" ")).addClass("cur-remark");case 5:switch(t.dw.main.data("t",e).data("v",i).removeClass(t.dw.curs.join(" ")),i){case"smile.png":return void t.dw.main.addClass("cur-bw-smile");case"cry.png":return void t.dw.main.addClass("cur-bw-cry");case"praise.png":return void t.dw.main.addClass("cur-bw-praise");case"doubt.png":return void t.dw.main.addClass("cur-bw-doubt")}return}},unBindStudents:function(e){for(var i=$('<ul class="ul-bind-students after"></ul>'),a=0;a<e.length;a++){var s=e[a],n=$('<li data-id="'+s.id+'" data-name="'+s.name+'">'+s.name+"</li>");n.bind("click",function(e){return e.stopPropagation(),t.item.student_id=$(this).data("id"),t.item.student_name=$(this).data("name"),$(".ul-bind-students li").removeClass("active"),$(this).addClass("active"),!1}),i.append(n)}return i},back:function(){window.location.href="/work"}},mt:{list:function(e,i){$.post("marking/pictures",{batch:e,type:i},function(e){if(!e.status)return $(".j-autoHeight").attr("style","height:"+$(window).height()+"px;"),$(".m-message").text(e.message).show(),void $(".m-body").hide();t.data=e.data;for(var i=0,a=t.data.last_student_id,s=[],n=0;n<t.data.pictures.length;n++)t.data.pictures[n].i=n,!t.data.pictures[n].is_marking&&t.data.pictures[n].student_id>0&&s.push({id:t.data.pictures[n].id,name:t.data.pictures[n].name}),0==i&&a>1&&t.data.pictures[n].student_id==a&&(i=n);s.length?t.mt.loadingFirst(s,function(){t.mt.item(t.data.pictures[i],i+1),t.mk.init(),t.qt.init()}):(t.mt.item(t.data.pictures[i],i+1),t.mk.init(),t.qt.init())})},item:function(e,i){e.load=e.load||!1,e.load?t.mt.item_set(e,i):$.post("marking/picture",{id:e.id,type:t.data.paper_type},function(a){if(!a.status)return void singer.msg(a.message);if(e.answers=singer.json(a.data.answers)||[],e.icons=singer.json(a.data.icons)||[],e.marks=singer.json(a.data.marks)||[],e.details=a.data.details||[],e.marks&&e.marks.length)for(var s=0;s<e.marks.length;s++)e.icons.push({x:e.marks[s].x,y:e.marks[s].y,t:e.marks[s].t,w:e.marks[s].w});e.load=!0,t.mt.item_set(e,i)})},item_set:function(e,i){t.dw.icons=[],t.dw.n_icons=[],t.dw.r_icons=[],$(".icon").remove(),$(".share").remove(),$(".share-active").remove();var a="";if(singer.isUndefined(t.item.id)||(a=t.item.id),t.item=$.extend(!0,{},e),t.dw.bindShares(),t.item.o=0,i&&(t.item.i=i),t.item.icons&&t.item.icons.length&&(t.dw.icons=t.item.icons),a==e.id?t.dw.init():$("#markingImage").attr("src",t.item.pic),t.data.pictures.length>2){var s=t.item.i-2,n=t.item.i;0>s&&(s=t.data.pictures.length-1),n>=t.data.pictures.length&&(n=0),$("#delayImageL").attr("src",t.data.pictures[s].pic),$("#delayImageR").attr("src",t.data.pictures[n].pic)}t.mk.bind(),t.qt.bind(),t.lock=!0},detail:function(t,e,i){if(t.length)for(var a=0;a<t.length;a++)if(t[a].id==e&&(!i||t[a].small_id==i))return t[a];return{}},remove:function(t,e,i){for(var a=0;a<t.length;a++)if(t[a].id==e&&(!i||t[a].small_id==i))return void t.splice(a,1)},submit:function(e,i){if($("#dt_marks").data("open",0).hide(),t.qt.semiBox.hide(),singer.isUndefined(e)&&(e=-1),t.item.student_id<1)return void(0>e?singer.msg("请先绑定学生"):0!=t.item.o?singer.dialog({title:"请绑定试卷",content:'当前试卷未绑定学生，切换后批阅资料将<span style="color:#fa9632;font-size:16px;">丢失</span>。<br/>是否继续?',fixed:!0,backdropOpacity:.7,okValue:"确定",cancelValue:"取消",ok:function(){t.mt.item(t.data.pictures[e])},cancel:function(){}}).showModal():t.mt.item(t.data.pictures[e]));if(0!=t.item.o){var a=[],s=[],n=[];if(t.dw.n_icons&&t.dw.n_icons.length&&((4&t.item.o)>0||(2&t.item.o)>0)){for(var d=0;d<t.dw.n_icons.length;d++){var r={x:t.dw.n_icons[d].x,y:t.dw.n_icons[d].y,t:t.dw.n_icons[d].t,w:t.dw.n_icons[d].w};0==t.dw.n_icons[d].t||1==t.dw.n_icons[d].t||2==t.dw.n_icons[d].t?(r.id=t.dw.n_icons[d].id,a.push(r)):s.push(r)}0==(2&t.item.o)&&(a=[]),0==(4&t.item.o)&&(s=[])}if((8&t.item.o)>0)for(var o=0;o<t.item.details.length;o++){var c=t.item.details[o];n.push({question_id:c.id,small_question_id:c.small_id,score:c.score,is_correct:c.correct})}$.post("marking/submit",{id:t.item.id,o:t.item.o,type:t.data.paper_type,icons:singer.json(a).replace(/\'/gi,'"'),marks:singer.json(s).replace(/\'/gi,'"'),remove_icons:singer.json(t.dw.r_icons).replace(/\'/gi,'"'),details:singer.json(n).replace(/\'/gi,'"')},function(a){if(a.status){var s=t.item.i-1;t.data.pictures[s].icons=$.extend([],t.dw.icons),t.data.pictures[s].details=[],t.data.pictures[s].load=!1,0!=t.item.o&&singer.msg("已保存",1e3),t.item.o=0,i&&i(),t.mt.item(t.data.pictures[e>-1?e:s])}else singer.msg(a.message)})}else t.lock=!0,e>-1&&t.mt.item(t.data.pictures[e])},finished:function(){$.post("marking/finished",{batch:t.data.batch,paper_id:t.data.paper_id,type:t.data.paper_type,auto_set_icon:t.set_def,auto_set_score:!1},function(t){t.status?singer.msg("操作成功",0,function(){window.location.href="/work"}):singer.msg(t.message)})},loadingFirst:function(e,i){var a=$('<div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="min-width:2em;width: 0%">0%</div>'),s=$('<div class="progress"></div>');s.append(a);var n=$('<div style="width:500px;">正在初始化...<br/><br/></div>');n.append(s);var d=singer.dialog({content:n,fixed:!0,backdropOpacity:.7});d.showModal(),t.mt.setProgressBar(0,e,a,function(){d.close(),i&&i()})},setProgressBar:function(e,i,a,s){return e>=i.length?void(s&&s()):void $.post("marking/commit",{id:i[e].id},function(){var n=Math.round((e+1)/i.length*100);a.attr("style","min-width:2em;width:"+n+"%;").text(n+"%"),++e<i.length?t.mt.setProgressBar(e,i,a,s):setTimeout(function(){t.mt.setProgressBar(e,i,a,s)},2e3)})}}})}(marking),$(function(t){var e=singer.uri().batch,i=singer.uri().type;if(singer.isUndefined(e)||""==e)return t(".m-message").text("参数错误").show(),void t(".m-body").hide();var a=t(window).width(),s=t(window).height();(!a||1280>a)&&(a=1280);var n=(a-1e3)/2+175-10,d=40;"1"==singer.cookie.get("MARKINGALT")?(t(".m-prompt").remove(),d=10):(t(".m-prompt .p-close").bind("click",function(){singer.cookie.set("MARKINGALT","1",525600),t(".m-prompt").remove(),t(".m-goal").attr("style","left:"+t(".m-goal").data("x")+"px;top:10px;"),t(".m-progress").attr("style","left:"+t(".m-progress").data("x")+"px;top:10px;")}),t(".m-prompt").show()),t(".m-body").attr("style","min-height:"+(s-50)+"px;margin-left:"+n+"px;"),t(".m-tools").attr("style","top:"+(s/2-125)+"px;left:"+(n+781)+"px;"),t(".m-goal").data("x",n-175).data("y",d).attr("style","left:"+(n-175)+"px;top:"+d+"px;"),t(".scroll-items").attr("style","max-height:"+(s-206-d)+"px;"),t(".m-progress").data("x",n+790).attr("style","left:"+(n+790)+"px;top:"+d+"px;"),t(".m-change-left").attr("style","top:"+(s/2-37)+"px;left:"+(n-175-74-50)+"px;"),t(".m-change-right").attr("style","top:"+(s/2-37)+"px;left:"+(n+780+45+50)+"px;"),t(".power").bind("click",function(){"1"==t(this).data("show")?(t(this).attr("title","点击展开").data("show","0"),t(this).find("i").attr("class","fa fa-chevron-right")):(t(this).attr("title","点击收起").data("show","1"),t(this).find("i").attr("class","fa fa-chevron-down")),t(".items").slideToggle(500,function(){t(".power").find(".qc-line").toggleClass("hide")})}),t(".m-progress").find(".p-no").bind("click",function(){t(".m-progress").find(".students").fadeToggle(200)}),t(".remarks").find(".title").bind("click",function(){switch(t(".remarks").find(".title").removeClass("active"),t(".remarks").find(".content").addClass("hide"),t(this).addClass("active"),t(this).data("t")){case 3:t(".remarks").find(".c-text").removeClass("hide");break;case 5:t(".remarks").find(".c-brow").removeClass("hide");break;default:t(".remarks").find(".c-custom").removeClass("hide")}}),t(".custom-history").find(".edit").bind("click",function(){t(".custom-history").addClass("hide"),t(".custom-edit").removeClass("hide"),t(".txt-custom").focus()}),t(".scroll-items").mCustomScrollbar({axis:"y",theme:"minimal-dark"}),singer.isUndefined(i)&&(i=""),marking.mt.list(e,i),t(document).delegate(".q-area","mouseenter",function(){t(this).addClass("hover")}).delegate(".q-area","mouseleave",function(){t(this).removeClass("hover")})});