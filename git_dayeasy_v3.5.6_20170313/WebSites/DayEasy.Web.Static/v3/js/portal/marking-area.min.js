!function($,S){var $imgMap=$(".image-map"),$indexMap=$(".index-map"),$indexList,$img=$imgMap.find("img"),point={x:0,y:0,width:120,height:40},points=[],paddingTop=10,paddingLeft=15,bounds=15,tkWidth=230,paperWidth=780,temp='<div class="index-item"><div class="index-num{1}">{0}</div></div>',index=0,uri=S.uri(),logger=S.getLogger("marking-area"),start={},initArea=[],mouseMoved=0,paperType;"true"===uri.isJoint&&$imgMap.append('<div class="image-mask">');var initData=function(){$(".m-back").bind("click",function(){return window.history.length>1?(window.history.back(-1),!1):(location.href=S.sites.apps+"/work",!1)}),$.ajax({url:"/marking/marking-init",data:{batch:uri.batch,type:uri.type,isJoint:uri.isJoint},type:"GET",success:function(json){if(!json.status)return void S.alert(json.message);var markingData=json.data;if(paperType=markingData.type,0==markingData.questions.length)return $(".index-loading").html("没有主观题！"),void $indexMap.append('<div class="index-action"><button class="deyi-btn j-finish no-question">开始批阅</button>');if(initArea=eval("("+markingData.areas+")")||[],initArea&&initArea.length)for(var i=0;i<initArea.length;i++)initArea[i].x=parseFloat(initArea[i].x),initArea[i].y=parseFloat(initArea[i].y),initArea[i].width=parseFloat(initArea[i].width),initArea[i].height=parseFloat(initArea[i].height),initArea[i].index=parseInt(initArea[i].index);points=initArea,setPicture(markingData.imageUrl),bindData(markingData.questions)}})};initData();var setPicture=function(i){return i?void $(".image-map img").attr("src",i).bind("load",function(){$(this).siblings("canvas").css({height:$(this).height(),width:780})}):!1},bindData=function(i){var e;$(".index-loading").remove(),$(".js-change").bind("click",function(){var i=uri.batch,e=S.isUndefined(uri.isJoint)?!1:uri.isJoint;$.post("/marking/picture-change",{batch:i,type:paperType,isJoint:e},function(i){setPicture(i)})});for(var t=0;t<i.length;t++){var a=i[t];e=$(S.format(temp,a.index,a.index.length>3?" num-"+a.index.length:"")).data("id",a),$indexMap.append(e)}$indexMap.append('<div class="index-action"><button class="deyi-btn j-finish disabled" disabled>完成标记</button><button class="deyi-btn j-reset">重新标记</button></div>'),$indexList=$indexMap.find(".index-item"),initArea&&initArea.length&&($indexList.addClass("active"),$(".j-finish").removeClass("disabled").removeAttr("disabled"),$imgMap.find("canvas").css("cursor","default"),index=$indexList.length-1)},timer=setInterval(function(){return $img.width()<780?!1:($img.areaSelect({initAreas:initArea,deleteMethod:"",padding:3,area:{strokeStyle:"#d9534f",lineWidth:2},point:{size:4,fillStyle:"#d9534f",type:"rect"},create:!1,drag:!0}),void clearInterval(timer))},200);$(document).delegate("canvas","click",function(i){if(!(points.length>=$indexList.length)){if("create"!=$img.data("AreaSelect").status)return void logger.info("鼠标移动："+mouseMoved);var e,t=$(this),a=$.extend({},point),n=t.offset(),d=$indexList.eq(index);if(index>0&&(e=points[index-1]),a.x=i.clientX-n.left-paddingTop,a.y=i.clientY-n.top-paddingLeft+$(window).scrollTop(),a.width=paperWidth-a.x-bounds,e&&a.y<e.y-point.height)return void S.msg("坐标点不能高于上一个点！");var s=d.data("id");if(s.t?a.width=tkWidth:index>0&&!e.t&&(e.height=a.y-e.y-10),index==$indexList.length-1&&(a.height=t.height()-a.y-20),$.inArea(a,points))return void S.msg("标记区域发生重叠，请调整！");a.num=d.text(),$img.areaSelect("add",a),a.id=s.id,a.index=s.index,a.t=s.t,points.push(a),$indexList.eq(index).addClass("active"),index++,index>=$indexList.length&&(t.unbind("click.areaSelect"),$(".j-finish").removeClass("disabled").removeAttr("disabled"),$imgMap.find("canvas").css("cursor","default"))}}).delegate("canvas","mousedown.areaSelect",function(i){start={x:i.clientX,y:i.clientY},mouseMoved=0}).delegate("canvas","mousemove.areaSelect",function(i){mouseMoved=Math.max(Math.abs(i.clientX-start.x),Math.abs(i.clientY-start.y))}),$indexMap.delegate(".j-reset","click.areaSelect",function(){$img.areaSelect("clear"),points=[],$indexList.removeClass("active"),$(".j-finish").addClass("disabled").attr("disabled","disabled"),index=0}).delegate(".j-finish","click.areaSelect",function(){$(this).hasClass("disabled")||$(this).attr("disabled")||($(this).addClass("disabled").attr("disabled","disabled").html("正在提交.."),$.ajax({url:"/marking/marking-area-save",data:{batch:uri.batch,type:paperType,areas:S.json(points)},type:"POST",success:function(i){i.status?S.alert("标记完成",function(){return uri.isJoint?(self.location=document.referrer,!1):(location.href="/marking?batch="+uri.batch+"&type="+paperType,!1)}):(S.alert(i.message),$(this).removeClass("disabled").removeAttr("disabled").html("完成标记"))}}))})}(jQuery,SINGER);