var marking=function(){var t={data:{batch:"",paperId:"",paperTitle:"",isAb:!1,allObjective:!1,sectionType:1,isBag:!1,bagId:"",questionGroupId:"",deyiGroupId:"",deyiGroupName:"",unMarkingCount:0,isRefresh:!1,loaded:!1,lock:!1,keydown:!0,editScore:!1,operation:0,url:DEYI.sites["static"]+"/v1/image/icon/marking/",minScore:1,semiAuto:!1,semiScore:"50%",errorAuto:!1,errorScore:"100%"},areas:[],region:{x:0,y:0,width:0,height:0},shares:[],questions:[],pictures:[],picture:{},details:[],_mix:function(t,e){for(var a in e)e.hasOwnProperty(a)&&(t[a]=e[a])}};return t}();!function(t){t._mix(t,{dw:{doc:$(document),box:$("#mkBox"),n_icons:[],r_icons:[],images:["full.png","semi.png","error.png"],x:0,y:60,w:780,winW:0,winH:0,scale:1.2,isZoom:!1,init:function(){$(".icon").remove();var e=0,a=singer.json(t.picture.icons)||[],i=singer.json(t.picture.marks)||[];if(i&&i.length)for(;e<i.length;e++)a.push({x:i[e].x,y:i[e].y,t:i[e].t,w:i[e].w});if(a&&a.length){var s=t.questions&&t.questions.length;for(e=0;e<a.length;e++){var o,d=a[e];if(d.id&&d.id.length&&s){for(var n=!1,r=0;r<t.questions.length;r++)if(t.questions[r].id==d.id){n=!0;break}if(!n)continue}d.x-=t.region.x,d.y-=t.region.y;var c=d.x,l=d.y;if(t.dw.isZoom&&(c*=t.dw.scale,l*=t.dw.scale),4==d.t)o=$("<div class='icon icon-lg' style='font-size:24px;line-height:1em;font-family: 宋体;font-weight:bold;color:#fa8989;left: "+c+"px;top: "+l+"px;'>"+d.w+"</div>");else{var u="";if(d.t<3?u=t.data.url+t.dw.images[d.t]:5==d.t?u=t.data.url+"brow/"+d.w:3==d.t&&(u=t.data.url+d.w),o=$('<div class="icon '+(3==d.t?"icon-lg":"icon-sm")+'" style="left:'+c+"px;top:"+l+'px;" data-x="'+d.x+'" data-y="'+d.y+'">'),o.html('<img src="'+u+'"/>'),(1==d.t||2==d.t)&&d.id&&d.id.length){o.append('<div class="score">-'+(d.w||0)+"</div>");var p="T"+d.t+"_"+(d.x+"_"+d.y).replace(/\./gi,"D");o.attr("id",p).data("qId",d.id).data("t",d.t).data("score",d.w)}}t.dw.box.append(o.data("x",d.x).data("y",d.y))}}},print:function(e,a,i){t.qt.semiBox.hide();var s=t.dw.box.data("t");if("clear"!=s){(0>s||s>5)&&(s=0);var o=3>s?t.dw.images[s]:t.dw.box.data("v")||"";if(o){e=e||window.event;var d=parseInt(e.clientX+t.dw.doc.scrollLeft()-t.dw.x),n=parseInt(e.clientY+t.dw.doc.scrollTop()-t.dw.y);if(0==s||1==s)n-=23;else if(2==s)d-=3,n-=18;else if(5==s)switch(o){case"praise.png":d+=2;break;case"line.png":n+=4;break;case"wavy.png":n+=6;break;case"oval.png":d-=75,n-=6}var r=d,c=n;if(t.dw.isZoom&&(d/=t.dw.scale,n/=t.dw.scale),t.dw.n_icons.length)for(var l=t.dw.n_icons.length;l>0;l--){var u=t.dw.n_icons[l-1];if(u.x==d&&u.y==n)return}var p,m,v={x:d,y:n,t:s,w:s>2?o:0};4==s?p=$("<div class='icon icon-lg' style='font-size:24px;line-height:1em;font-family: 宋体;font-weight:bold;color:#fa8989;left: "+r+"px;top: "+c+"px;'>").text(o):(p=$('<div class="icon '+(3==s?"icon-lg":"icon-sm")+'" style="left:'+r+"px;top:"+c+'px;">').html('<img src="'+t.data.url+(5==s?"brow/"+o:o)+'"/>'),3>s&&(v.id=a),(1==s||2==s)&&(p.append('<div class="score">-0</div>'),singer.isUndefined(a)||(m="T"+s+"_"+(d+"_"+n).replace(/\./gi,"D"),p.attr("id",m).data("qId",a).data("t",s).data("score",0)))),t.dw.box.append(p.data("x",d).data("y",n)),t.dw.n_icons.push(v),singer.isUndefined(a)||(singer.isUndefined(i)||t.mk.scrollToActive(i,2),(1==s||2==s)&&t.dw.openScoreBox(a,s,{x:r,y:c},m))}}},clear:function(e){var a=parseFloat(e.data("score")||0);a>0&&t.qt.setScore(e.data("qId"),a,!1,0);var i=e.data("x"),s=e.data("y");e.remove();for(var o=!1,d=0;d<t.dw.n_icons.length;d++){var n=t.dw.n_icons[d];if(n.x==i&&n.y==s){o=!0,t.dw.n_icons.splice(d,1);break}}o||t.dw.r_icons.push({x:i+t.region.x,y:s+t.region.y})},openScoreBox:function(e,a,i,s){for(var o=0,d=0;d<t.questions.length;d++)if(t.questions[d].id==e){o=t.questions[d].score;break}if(0==o)return void t.qt.setScore(e,0,!0,0);if(1==a&&t.data.semiAuto||2==a&&t.data.errorAuto){var n=1==a?t.data.semiScore:t.data.errorScore,r=0;return r="50%"==n?0-o/2:"100%"==n?0-o:parseFloat(n),void t.qt.setScore(e,r,!1,s)}t.qt.semiBox.show(e,a,o,i,s)},ref:function(){$(".icon").each(function(e,a){var i=$(a),s=parseFloat(i.data("x")),o=parseFloat(i.data("y"));t.dw.isZoom&&(s*=t.dw.scale,o*=t.dw.scale),i.css({left:s,top:o})}),$(".q-area").each(function(e,a){var i=$(a),s=parseFloat(i.data("x")),o=parseFloat(i.data("y")),d=parseFloat(i.data("w")),n=parseFloat(i.data("h"));t.dw.isZoom&&(s*=t.dw.scale,o*=t.dw.scale,d*=t.dw.scale,n*=t.dw.scale),i.attr("style","position: absolute;top:"+o+"px;left:"+s+"px;width:"+d+"px;height:"+n+"px;")})}},qt:{init:function(){$(".m-goal .gi-total").bind("click",function(){var e=$(this),a=$(".mg-score-box"),i=$(".mg-scores"),s=a.find(".arrow"),o=e.parent().data("id");if(o==a.data("id"))return void a.data("id","").hide();s.attr("class","arrow arrow-left"),i.html("");var d=e.offset().top-t.dw.doc.scrollTop()-6-60,n=parseFloat(e.parent().data("total"))||0;if(n>100)return void singer.msg("分数值过大，使用手动录入方式");for(var r=0;n>=r;r++)i.append('<span data-val="'+r+'">'+r+"</span>");i.append('<span data-val="r"><i class="fa fa-reply"></i></span>');var c="";if(n>5){n>50&&(c+="width:432px;");var l=30*Math.ceil((n+2)/(n>50?14:7))+2;console.log(l+"--"+d+"--"+t.dw.winH),l+d+70>t.dw.winH?(d=d-l+32,s.addClass("arrow-left-bottom")):s.addClass("arrow-left-top")}c+="top:"+d+"px;",a.data("id",o).attr("style",c).show()});var e=$(".m-goal input");e.bind("focus",function(){$(this).select()}).bind("change",function(){t.qt.ckScore($(this))}).bind("keydown",function(a){if(13==a.which){var i=$(this);if(t.qt.ckScore(i)){var s=i.data("index");return s!=e.length?void e.each(function(t,e){$(e).data("index")==s+1&&$(e).focus()}):void t.mk.changePicture(1)}}}),$(".mg-score-box").delegate("span","click",function(){var e=$(this),a=$(".mg-score-box"),i=e.data("val");return"r"==i?void a.data("id","").hide():(t.qt.setScore(a.data("id"),i,!0,0),void a.data("id","").hide())}),$(".gt-btn").bind("click",function(){$(".mg-list .mg-item").each(function(e,a){t.qt.setScore($(a).data("id"),0,!0,0)})})},ckScore:function(e){var a=e.parent().data("id"),i=e.val(),s=parseFloat(parseFloat(e.parent().data("total")).toFixed(2)),o=parseFloat(parseFloat(e.data("score")).toFixed(2)),d=(!i||!i.length)&&"0"!=i||!/^[0-9]{0,3}\.??[0-9]{1,2}$/.test(i);return d?(e.val(o),t.qt.setScore(a,o,!0,0),!1):(i=parseFloat(parseFloat(i).toFixed(2)),i>s&&(i=s,e.val(s)),t.qt.setScore(a,i,!0,0),!0)},setScore:function(e,a,i,s){i=i||!1,a=parseFloat(a);var o=0,d=0;if(!t.questions||!t.questions.length)return void singer.msg("没有批阅任务");if(!t.picture.details||!t.picture.details.length)return!1;for(;o<t.questions.length;o++)if(t.questions[o].id==e){d=t.questions[o];break}if(!d)return void singer.msg("没有检测到题目分数，请刷新重试");var n=!1,r=0,c=-1;if(t.details&&t.details.length)for(o=0;o<t.details.length;o++)if(t.details[o].question_id==e){c=o,n=!0,r=t.details[o];break}var l=0;if(r)l=r.score;else for(r={question_id:e},o=0;o<t.picture.details.length;o++)if(t.picture.details[o].questionId==e){l=t.picture.details[o].score;break}if(!singer.isUndefined(s)&&0!=s){var u=0-a;i&&(u=l+a),0>l+a&&(u=l);var p=$("#"+s);p.data("score",u),p.find("div").text("-"+u);var m=p.data("t"),v=p.data("x"),h=p.data("y");for(o=t.dw.n_icons.length-1;o>=0;o--){var f=t.dw.n_icons[o];if(f.t==m&&f.x==v&&f.y==h){f.w=u;break}}}var g=l;l=i?a:l+a,0>l&&(l=0),l>d.score&&(l=d.score),r.score=l,r.is_correct=l==d.score,n||(c=t.details.length,t.details.push(r));var w=!1;for(o=0;o<t.picture.details.length;o++){var x=t.picture.details[o];if(x.questionId==e){w=x.score==l;break}}w&&t.details.splice(c,1),t.picture.totalScore+=l-g,$(".stu-score").html(t.picture.totalScore),$(".mg-list .mg-item").each(function(t,a){var i=$(a);return i.data("id")==e?void i.find("input").val(l):void 0}),t.mk.scrollToActive(d.sort)},semiBox:{timerId:0,iconId:0,show:function(e,a,i,s,o){(0!=t.qt.semiBox.timerId||0!=t.qt.semiBox.iconId)&&t.qt.semiBox.hide(),i=parseFloat(i||0);var d=$("#semiBox");d.html("");var n=122,r=$("<ul>");if(r.data("id",e).data("iconId",o),e&&i>0){var c=i>20?20:i;if(c>9&&(n=30*Math.ceil(c/3)+32),i>4){var l=0-(1==a?i/2:i);r.append('<li class="one" data-v="'+l+'">'+(1==a?"扣一半":"全扣")+"</li>")}for(var u=1;c>=u;)1!=t.data.minScore&&r.append('<li class="li-float-score" style="display: none;" data-v="'+(0-u+.5)+'">'+(0-u+.5)+"</li>"),r.append('<li class="li-int-score" data-v="'+(0-u)+'">'+(0-u)+"</li>"),++u>c&&u!=c+1&&r.append('<li class="li-int-score" data-v="'+(0-c)+'">'+(0-c)+"</li>");r.append('<li data-v="cancel" title="取消"><i class="fa fa-reply"></i></li>'),r.find("li").bind("click",function(){var e=$(this).data("v"),a=$(this).parent().data("id"),i=$(this).parent().data("iconId");return"cancel"==e?void t.qt.semiBox.hide():(t.qt.semiBox.iconId=0,t.qt.semiBox.hide(),void t.qt.setScore(a,parseFloat(e),!1,i))})}if(1!=t.data.minScore){n+=30;var p=$('<div class="box semi-box-tab"></div>');p.append('<div class="box-lg-6 active" data-v="1">整分</div>'),p.append('<div class="box-lg-6" data-v="0">小数</div>'),p.find("div").bind("mouseover",function(){var t=$(this);if(!t.hasClass("active")){p.find("div").removeClass("active"),t.addClass("active");var e=$("#semiBox");"1"==t.data("v")?(e.find(".li-int-score").show(),e.find(".li-float-score").hide()):(e.find(".li-int-score").hide(),e.find(".li-float-score").show())}}),d.append(p)}d.append(r),singer.isUndefined(s)||(t.dw.w-s.x<180&&(s.x-=172),s.y>n&&(s.y-=n-50),d.data("xy",s.x+"-"+s.y+"-"+n).attr("style","top:"+s.y+"px;left:"+(s.x+50)+"px;")),t.qt.semiBox.iconId=o,t.qt.semiBox.timerId=window.setTimeout(function(){t.qt.semiBox.hide(200)},5e3),d.show()},hide:function(e){0!=t.qt.semiBox.timerId&&window.clearTimeout(t.qt.semiBox.timerId),0!=t.qt.semiBox.iconId&&t.dw.clear($("#"+t.qt.semiBox.iconId)),t.qt.semiBox.timerId=0,t.qt.semiBox.iconId=0,$("#semiBox").html("").fadeOut(e||0)}}},mk:{init:function(){if($(".m-back").bind("click",function(){return window.location.href=singer.sites.apps+"/work/teacher",!1}),t.data.allObjective){$(".tool-full").addClass("tool-full-disabled").removeClass("active"),$(".tool-semi").addClass("tool-semi-disabled"),$(".tool-error").addClass("tool-error-disabled"),$(".tool-setting").addClass("tool-setting-disabled"),$("#mkBox").removeClass("cur-0");var e=$(".power");e.data("show","0").addClass("power-disabled"),e.find("i").attr("class","fa fa-chevron-right"),e.find(".qc-line").hide()}$(".m-students-scroll").mCustomScrollbar({axis:"y",theme:"minimal-dark"}),$(".btn-mk-save").bind("mouseover",function(){$(".mk-save-tip").stop().fadeIn()}).bind("mouseout",function(){$(".mk-save-tip").stop().hide()}).bind("click",function(){t.mt.submit(t.picture.pictureId,function(){var e=t.picture.pictureId;t.mt.loadPicture(e),singer.msg("批阅进度已保存")})}),$(".btn-students").bind("click",function(){var t=$(".m-students");t.data("open")?t.data("open",0).hide():t.data("open",1).fadeIn(500)}),$(".ms-submits").delegate("li","click",function(){var e=$(this),a=e.data("id");a!=t.picture.pictureId&&($(".m-students").data("open",0).hide(),$(".ms-submits li").removeClass("active"),$(this).addClass("active"),$(".em-schedule-currect").html(e.data("idx")),t.mt.submit(a))}),$("#semiBox").mouseover(function(){window.clearTimeout(t.qt.semiBox.timerId)}).mouseout(function(){t.qt.semiBox.timerId=window.setTimeout(function(){t.qt.semiBox.hide(200)},5e3)}),$(".m-change").click(function(){var e=parseInt($(this).data("v")||"1");t.mk.changePicture(e)}),$(".m-tools").find(".tool").bind("click",function(){t.qt.semiBox.hide();var e=$(this).data("t");if(!t.data.allObjective||"0"!=e&&"1"!=e&&"2"!=e&&"setting"!=e){var a=$(".remarks"),i=$(".m-setting");if("remark"==e)return $(".m-setting").data("open",0).hide(),void(a.data("open")?(a.data("open",0).hide(),t.data.keydown=!0):(a.data("open",1).fadeIn(500),t.data.keydown=!1));if(a.data("open",0).hide(),"setting"==e)return void(i.data("open")?i.data("open",0).hide():i.data("open",1).fadeIn(500));if(i.data("open",0).hide(),"zoom"==e)return t.dw.isZoom=!t.dw.isZoom,void t.mk.zoom();t.data.keydown=!0,t.dw.box.data("t")!=e&&($(".m-tools").find(".tool").removeClass("active"),$(this).addClass("active"),t.dw.box.data("o",2),t.mk.setBox(e))}}),t.dw.box.bind("contextmenu",function(){if(!t.data.allObjective){$(".m-tools").find(".tool").removeClass("active");var e=t.dw.box.data("t");return 0==e?(e=1,$(".tool-semi").addClass("active")):1==e?(e=2,$(".tool-error").addClass("active")):(e=0,$(".tool-full").addClass("active")),t.data.keydown=!0,$(".remarks").data("open",0).hide(),t.qt.semiBox.hide(),t.dw.box.data("o",2),t.mk.setBox(e),!1}}),$(".remarks li").bind("click",function(){var e=$(this).parent().data("t"),a=$(this).data("v");$(".remarks").data("open",0).hide(),t.data.keydown=!0,a!=t.dw.box.data("v")&&($(".tool").removeClass("active"),$(".tool-remark").addClass("active"),t.dw.box.data("o",4),t.mk.setBox(e,a))}),$("#txtCustom").bind("change",function(){var t=$("#txtCustom").val();t&&t.length&&$("#txtCustom").val(t.replace(/['"<>]/gi,"").replace("_","").replace(/(\r)|(\n)/g," "))}),$("#btnUsageCustom").bind("click",function(){var e=$("#txtCustom").val().replace(/['"<>]/gi,"").replace("_","").replace(/(\r)|(\n)/g," ");if(!e||!e.length)return $(".custom-history").removeClass("hide"),void $(".custom-edit").addClass("hide");if($(".remarks").data("open",0).hide(),t.data.keydown=!0,$(".custom-history").removeClass("hide"),$(".custom-edit").addClass("hide"),e!=t.dw.box.data("v")){$(".tool").removeClass("active"),$(".tool-remark").addClass("active"),t.dw.box.data("o",4),t.mk.setBox(4,e);var a=$(".custom-history .list"),i=a.find(".item");a.html('<div class="ht item" title="点击使用">'+e+"</div>"),i&&i.length&&$(i).each(function(t,e){4>t&&a.append($(e))})}}),$(".custom-history").delegate(".item","click",function(){var e=$(this).text();return e&&e.length?($(".remarks").data("open",0).hide(),t.data.keydown=!0,void(e!=t.dw.box.data("v")&&($(".tool").removeClass("active"),$(".tool-remark").addClass("active"),t.dw.box.data("o",4),t.mk.setBox(4,e)))):void singer.msg("说点什么吧...")}),$("#ddlMinScore").bind("change",function(){var t=parseFloat($(this).val()),e=$("#ddlSemiScore"),a=$("#ddlErrorScore");e.html('<option value="50%">扣一半</option>'),a.html('<option value="100%">全扣</option>');for(var i=1;5>=i;i++)1!=t&&(e.append('<option value="-'+(i-.5)+'">-'+(i-.5)+"分</option>"),a.append('<option value="-'+(i-.5)+'">-'+(i-.5)+"分</option>")),e.append('<option value="-'+i+'">-'+i+"分</option>"),a.append('<option value="-'+i+'">-'+i+"分</option>");e.append('<option value="100%">全扣</option>'),a.append('<option value="500%">扣一半</option>')}),$(".m-setting").find("input[name='rdoSemi']").bind("click",function(){var t=$(this).val();"1"==t?$("#ddlSemiScore").removeAttr("disabled"):$("#ddlSemiScore").attr("disabled","disabled")}),$(".m-setting").find("input[name='rdoError']").bind("click",function(){var t=$(this).val();"1"==t?$("#ddlErrorScore").removeAttr("disabled"):$("#ddlErrorScore").attr("disabled","disabled")}),$("#btnUpdateMkArea").bind("click",function(){t.mt.submit(t.picture.pictureId,function(){window.location.href="/marking/marking-area?batch="+t.data.batch+"&type="+t.data.sectionType})}),$("#btnCancelSetting").bind("click",function(){$(".m-setting").data("open",0).hide()}),$("#btnSaveSetting").bind("click",function(){var e=$(".m-setting");t.data.minScore=parseFloat($("#ddlMinScore").val()),t.data.semiAuto="1"==e.find("input[name='rdoSemi']:checked").val(),t.data.errorAuto="1"==e.find("input[name='rdoError']:checked").val(),t.data.semiAuto&&(t.data.semiScore=$("#ddlSemiScore").val()),t.data.errorAuto&&(t.data.errorScore=$("#ddlErrorScore").val()),1!=t.data.minScore?$("#questionList").find(".li-float-score").show():$("#questionList").find(".li-float-score").hide(),$(".m-setting").data("open",0).hide()}),t.dw.box.click(function(e){var a=t.dw.box.data("t");(3==a||4==a||5==a)&&(t.dw.print(e),t.data.operation=t.data.operation|(t.dw.box.data("o")||2))}),t.dw.box.delegate(".q-area","click",function(e){t.dw.print(e,$(this).data("id"),$(this).data("sort")),t.data.operation=t.data.operation|(t.dw.box.data("o")||2)}),t.dw.box.delegate(".icon","click",function(){var e=t.dw.box.data("t");"clear"==e&&(t.dw.clear($(this)),t.data.operation=6|t.data.operation)}),t.dw.box.delegate(".qa-sort","click",function(t){t.stopPropagation()}),t.dw.box.delegate(".qa-share-active","click",function(t){t.stopPropagation()}),t.dw.box.delegate(".qa-share","click",function(e){e.stopPropagation();var a=$(this),i=a.parent().data("id");if(t.shares&&t.shares.length)for(var s=0;s<t.shares.length;s++){var o=t.shares[s];if(o.questionId==i&&o.studentId==t.picture.studentId)return}singer.confirm("请确认您分享的是本题的正确答案",function(){$.post("marking/add-share",{batch:t.data.batch,paper_id:t.data.paperId,group_id:t.data.deyiGroupId,question_id:i,student_id:t.picture.studentId,student_name:t.picture.studentName},function(e){e.status?(t.shares.push({id:e.data,questionId:i,studentId:t.picture.studentId}),a.removeClass("qa-share").addClass("qa-share-active").html('<i class="fa fa-star"></i><span>已晒</span>'),singer.msg("分享成功")):singer.msg(e.message)})})}),t.dw.box.delegate(".q-area","mouseover",function(){$(this).addClass("q-area-active")}),t.dw.box.delegate(".q-area","mouseout",function(){$(this).removeClass("q-area-active")}),t.mk.initMix&&singer.isFunction(t.mk.initMix)&&t.mk.initMix.call(this)},exceptionFunc:function(){var e=$(this),a=$(".ms-submits li").eq(t.picture.index-1);if(0==e.data("type")){var i=-1,s=$('<div class="exception-box">');s.append('<div class="excp-item" data-type="4"><i class="fa fa-circle-o"></i> 试卷重叠、题目内容被遮盖</div>'),s.append('<div class="excp-item" data-type="2"><i class="fa fa-circle-o"></i> 试卷严重偏移/倾斜</div>'),s.append('<div class="excp-item" data-type="1"><i class="fa fa-circle-o"></i> 图片不是对应题目</div>'),s.append('<div class="excp-item" data-type="3"><i class="fa fa-circle-o"></i> AB卷混乱</div>'),s.append('<div class="excp-item" data-type="0"><i class="fa fa-circle-o"></i> 其他</div>');var o=$('<div class="excp-other hide">'),d=$('<input type="text" maxlength="50" />');o.html(d),s.append(o),s.find(".excp-item").bind("click",function(){var t=$(this);s.find("i").removeClass("fa-dot-circle-o"),t.find("i").addClass("fa-dot-circle-o"),i=parseInt(t.data("type")),0==i?(o.removeClass("hide"),d.focus()):o.addClass("hide")}),d.focus(function(){t.data.editScore=!0}).blur(function(){t.data.editScore=!1}),singer.dialog({title:"请选择异常类型",content:s,backdropOpacity:.7,okValue:"确定",cancelValue:"取消",ok:function(){if(0>i)return singer.msg("请选择异常类型"),!1;for(var s=[],o=0;o<t.questions.length;o++)s.push(t.questions[o].sort);var n="学生"+t.picture.index+" 题号："+s.join("、");if(t.data.isAb&&(n=(1==t.data.sectionType?"[A卷] ":"[B卷] ")+n),0==i){var r=d.val();r&&r.length&&(n+=" ["+r+"]")}$.post("/marking/add-exception",{id:t.picture.jointPictureId,desc:n,type:i},function(t){if(!t.status)return void singer.msg(t.message);e.data("type",1).html("取消异常申报");var i=a.find("i");i&&i.length?i.attr("class","fa fa-exclamation i-declare"):a.append('<i class="fa fa-exclamation i-declare"></i>')})},cancel:function(){}}).showModal()}else $.post("/marking/cancel-exception",{id:t.picture.jointPictureId},function(i){if(!i.status)return void singer.msg(i.message);e.data("type",0).html("异常申报");var s=a.find("i");t.data.isBag||t.picture.isMarking?s.remove():s.attr("class","i-undo")})},changePicture:function(e){if(t.data.stopping)return!1;if(!t.pictures||!t.pictures.length)return!1;if(t.data.lock)return t.data.stopping=!0,singer.msg("老师别急，正在努力加载中...",1e3,function(){t.data.stopping=!1}),!1;t.data.lock=!0;var a=parseInt($(".em-schedule-currect").text()||"1")+e,i=t.pictures&&t.pictures.length?t.pictures.length:0;1>a&&(a=1),a>i&&(a=i);var s=i>=a?t.pictures[a-1].pictureId:"";i>=a&&t.mk.studentActive(a),t.mt.submit(s)},setBox:function(e,a){switch(t.dw.box.data("v",0),e){case 0:return void t.dw.box.data("t",e).attr("class","cur-0");case 1:return void t.dw.box.data("t",e).attr("class","cur-1");case 2:return void t.dw.box.data("t",e).attr("class","cur-2");case"clear":return void t.dw.box.data("t",e).attr("class","cur-clear");case 3:case 4:return void t.dw.box.data("t",e).data("v",a).attr("class","cur-remark");case 5:switch(t.dw.box.data("t",e).data("v",a),a){case"smile.png":return void t.dw.box.attr("class","cur-bw-smile");case"cry.png":return void t.dw.box.attr("class","cur-bw-cry");case"praise.png":return void t.dw.box.attr("class","cur-bw-praise");case"doubt.png":return void t.dw.box.attr("class","cur-bw-doubt");case"line.png":return void t.dw.box.attr("class","cur-bw-line");case"wavy.png":return void t.dw.box.attr("class","cur-bw-wavy");case"oval.png":return void t.dw.box.attr("class","cur-bw-oval")}return}},studentActive:function(t){var e=$(".ms-submits li"),a=e.length;t-=1,0>t&&(t=0),a>t&&(e.removeClass("active"),e.eq(t).addClass("active"))},zoom:function(){var e=1010;if(t.dw.isZoom){if(t.dw.winW=$(window).width(),t.dw.winW<1316)return singer.msg("您的网页可操作区域过低，不能放大。<br/>请检查浏览器是否未开起全屏功能。"),void(t.dw.isZoom=!1);e=1166}var a=Math.ceil((t.dw.winW-e)/2)-8;t.dw.x=a+175,$(".m-header").attr("style","width:"+e+"px;left:"+a+"px;"),$(".m-goal").attr("style","top:"+t.dw.y+"px;left:"+a+"px;"),$(".m-body").attr("style","margin-left:"+t.dw.x+"px;width:"+(e-230)+"px;"),$("#markingImage").attr("style","width:"+(e-230)+"px;height:auto;"),$(".m-tools").attr("style","top:"+t.dw.y+"px;left:"+(a+(e-45))+"px;"),$(".mg-scroll").attr("style","max-height:"+(t.dw.winH-t.dw.y-50)+"px;"),$(".m-change-left").attr("style","top:"+(t.dw.winH/2-32)+"px;left: "+(a-75)+"px;"),$(".m-change-right").attr("style","top:"+(t.dw.winH/2-32)+"px;left: "+(a+e+10)+"px;");var i=$(".mosaic"),s=$(".tool-zoom");t.dw.isZoom?(i.addClass("mosaic-lg"),s.addClass("tool-zoom-small")):(i.removeClass("mosaic-lg"),s.removeClass("tool-zoom-small")),t.dw.ref()},scrollToActive:function(t,e){if(t&&t.length&&($(".mg-list .mg-item").removeClass("mg-active"),$(".num-"+t).addClass("mg-active"),(2&e)>0&&$(".mg-scroll").mCustomScrollbar("scrollTo",".num-"+t),(4&e)>0)){var a=$(".qno-"+t);if(!a)return;var i=a.offset().left,s=a.offset().top-65;window.scrollTo(i,s)}}},mt:{initDialog:0,loadData:function(){var e=$('<div class="m-init-box f-tac">');e.append('<div><i class="fa fa-spin fa-spinner fa-4x"></i></div>'),e.append('<div class="m-init-message">正在准备阅卷数据，请稍候...</div>'),t.mt.initDialog=singer.dialog({content:e}),t.mt.initDialog.showModal(),$.post("/marking/load",{batch:t.data.batch,type:t.data.sectionType},function(e){e.status?t.mt.bindData(e.data):($(".dy-container").css("padding","0"),$(".m-message").text(e.message).removeClass("hide"),t.mt.initDialog.close().remove(),t.mt.initDialog=0)})},bindData:function(e){t.data.batch=e.batch,t.data.paperId=e.paperId,t.paperTitle=e.paperTitle,t.data.isAb=e.isAb,t.data.allObjective=e.allObjective||!1,t.data.sectionType=e.sectionType,t.data.isBag=e.isBag||!1,t.data.bagId=e.bagId||"",t.data.questionGroupId=e.questionGroupId||"",t.data.deyiGroupId=e.deyiGroupId,t.data.deyiGroupName=e.deyiGroupName||"",t.data.unMarkingCount=e.unMarkingCount||0,singer.config("paperId",e.paperId),t.areas=singer.json(e.areas)||[],t.shares=e.shares||[],t.questions=e.questions||[],t.pictures=e.pictures||[],e.region&&e.region.length&&(t.region=singer.json(e.region));var a={paperTitle:e.paperTitle,pictures:t.pictures,unSubmits:e.unSubmits||[],unMarkingCount:e.unMarkingCount,isAb:e.isAb||!1,markingStatus:e.markingStatus,sectionType:e.sectionType},i=template("m-header-box",a);$(".m-header-box").html(i).removeClass("hide"),$(".m-header").attr("style","left:"+(Math.ceil((t.dw.winW-1010)/2)-8)+"px;");var s=template("question-template",{questions:t.questions});$(".mg-list").html(s);for(var o=$("#mkBox"),d=0;d<t.areas.length;d++){var n=t.areas[d],r=n.x-t.region.x,c=n.y-t.region.y,l=$("<div class='q-area qno-"+n.index+"' style='position: absolute;width:"+n.width+"px;height:"+n.height+"px;left: "+r+"px;top: "+c+"px;'>");l.data("x",r).data("y",c).data("t",n.t).data("w",n.width).data("h",n.height).data("id",n.id).data("sort",n.index),l.append('<div class="qa-sort">'+n.index+"</div>"),l.append('<div class="qa-share"><i class="fa fa-star"></i><span class="qa-share-text">晒答案</span></div>'),o.append(l)}t.mt.bindDataMix&&singer.isFunction(t.mt.bindDataMix)&&t.mt.bindDataMix.call(this);var u="";t.pictures&&t.pictures.length&&(u=e.lastPicture,t.mk.studentActive(t.pictures.length)),$(".m-body").removeClass("hide"),0!=t.mt.initDialog&&(t.mt.initDialog.close().remove(),t.mt.initDialog=0),u?t.mt.loadPicture(u):($("#mkBox").replaceWith('<div class="dy-nothing" style="height: 320px;line-height: 320px"><i class="iconfont dy-icon-emoji01"></i>暂时还没有提交的答卷</div>'),$(".m-change,.btn-mk-save").remove()),t.qt.init(),t.mk.init()},loadPicture:function(e){if(!(t.data.allObjective||t.questions&&t.questions.length))return $(".m-body").addClass("hide"),$(".em-schedule-currect").text("0"),$(".dy-container").css("padding","0"),$(".m-message").text("没有批阅任务").removeClass("hide"),$(".j-autoHeight").attr("style","height:"+$(window).height()+"px;"),void(t.data.lock=!1);if(e&&e.length){var a="";if(t.picture&&(a=t.picture.pictureId),!t.data.isRefresh&&e==a)return 1==t.picture.index&&singer.msg("已批阅到第一份试卷啦~"),t.picture.index==t.pictures.length&&singer.msg("没有待批阅的试卷啦~"),void(t.data.lock=!1)}else singer.msg("参数错误，请刷新重试"),t.data.lock=!1;t.data.isRefresh=!1,$.post("/marking/picture",{picture_id:e,type:t.data.sectionType},function(a){t.mt.jsonPicture(a,e)}),t.data.loaded||(t.data.loaded=!0)},jsonPicture:function(e,a){if(!e.status||!e.data){if(!t.pictures||!t.pictures.length)return $(".m-body").addClass("hide"),$(".dy-container").css("padding","0"),$(".m-message").text("没有待批阅的答卷").removeClass("hide"),void $(".j-autoHeight").attr("style","height:"+$(window).height()+"px;");var i=e.message||"答卷加载失败";return void singer.msg(i)}e.data.pictureUrl&&e.data.pictureUrl.length||singer.msg("由于网络原因加载失败，请重新加载！"),t.picture=e.data,t.mt.bindPicture()},bindPicture:function(){for(var e=0;e<t.pictures.length;e++)if(t.pictures[e].pictureId==t.picture.pictureId){var a=t.pictures[e];t.picture.index=e+1,t.picture.studentId=a.studentId,t.picture.studentName=a.studentName;break}if($("#markingImage").unbind("load.marking").bind("load.marking",function(){t.data.lock=!1}).attr("src",t.picture.pictureUrl),t.picture.details&&t.picture.details.length){var i=$(".mg-list .mg-item");for(e=0;e<t.picture.details.length;e++){var s=t.picture.details[e];i.each(function(t,e){$(e).data("id")==s.questionId&&$(e).find(".gi-input").data("score",s.score).val(s.score)})}}$(".em-schedule-currect").html(t.picture.index),$(".em-schedule-readed").text(t.pictures.length),$(".em-schedule-surplus").data("count",t.picture.unMarkingCount).text(t.picture.unMarkingCount),$(".m-goal .mg-item input").eq(0).focus(),$(".stu-name").html(t.picture.studentName),$(".stu-score").html(t.picture.totalScore),$(".ms-submits li").removeClass("active").each(function(e,a){var i=$(a);i.data("id")==t.picture.pictureId&&i.addClass("active")}),t.shares&&t.shares.length&&($(".qa-share-active").removeClass("qa-share-active").addClass("qa-share").find("span").html("晒答案"),$(".q-area").each(function(e,a){for(var i=$(a),s=i.data("id"),o=0;o<t.shares.length;o++){var d=t.shares[o];if(d.questionId==s&&d.studentId==t.picture.studentId){i.find(".qa-share").removeClass("qa-share").addClass("qa-share-active").find("span").html("已晒");break}}})),t.dw.init()},submit:function(e,a){if(t.qt.semiBox.hide(),0!=t.data.operation||t.details&&t.details.length){t.data.lock=!0;var i=[],s=[];if(t.dw.n_icons&&t.dw.n_icons.length&&((4&t.data.operation)>0||(2&t.data.operation)>0)){for(var o=0;o<t.dw.n_icons.length;o++){var d={x:t.dw.n_icons[o].x+t.region.x,y:t.dw.n_icons[o].y+t.region.y,t:t.dw.n_icons[o].t,w:t.dw.n_icons[o].w};0==t.dw.n_icons[o].t||1==t.dw.n_icons[o].t||2==t.dw.n_icons[o].t?(d.id=t.dw.n_icons[o].id,i.push(d)):s.push(d)}0==(2&t.data.operation)&&(i=[]),0==(4&t.data.operation)&&(s=[])}$.post("/marking/submit",{pictureId:t.picture.pictureId,operation:t.data.operation,paperType:t.data.sectionType,icons:singer.json(i).replace(/\'/gi,'"'),marks:singer.json(s).replace(/\'/gi,'"'),removeIcons:singer.json(t.dw.r_icons).replace(/\'/gi,'"'),detailData:singer.json(t.details).replace(/\'/gi,'"')},function(i){if(i.status){if(t.details=[],t.data.operation=0,t.dw.n_icons=[],t.dw.r_icons=[],t.data.isRefresh=!0,$('.ms-submits li[data-id="'+t.picture.pictureId+'"]').find("i").remove(),a&&singer.isFunction(a))return void a.call(this);t.mt.loadPicture(e)}else t.data.lock=!1,singer.msg(i.message)})}else{if(a&&singer.isFunction(a))return void a.call(this);t.mt.loadPicture(e)}}}})}(marking),$(function(t){var e=marking;e.dw.winW=t(window).width(),e.dw.winH=t(window).height(),e.dw.winW<1220&&(e.dw.winW=1220),t(".remarks").find(".title").bind("click",function(){switch(t(".remarks").find(".title").removeClass("active"),t(".remarks").find(".content").addClass("hide"),t(this).addClass("active"),t(this).data("t")){case 3:t(".remarks").find(".c-text").removeClass("hide");break;case 5:t(".remarks").find(".c-brow").removeClass("hide");break;default:t(".remarks").find(".c-custom").removeClass("hide")}}),t(".custom-history").find(".edit").bind("click",function(){t(".custom-history").addClass("hide"),t(".custom-edit").removeClass("hide"),t(".txt-custom").focus()}),t(document).bind("mouseup",function(e){var a=t(".m-goal");a.is(e.target)||0!==a.has(e.target).length||t(".mg-score-box").data("id","").hide();var i=t(".m-header");i.is(e.target)||0!==i.has(e.target).length||t(".m-students").data("open",0).hide();var s=t(".m-tools");s.is(e.target)||0!==s.has(e.target).length||(t(".remarks").data("open",0).hide(),t(".m-setting").data("open",0).hide())}),t(".mg-scroll").mCustomScrollbar({axis:"y",theme:"minimal-dark"})});