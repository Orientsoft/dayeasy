var logger=singer.getLogger("addCtrl"),createCtrl=["$scope",function(e){e.submiting=!1,e.step=1,e.years=[],e.currentType={name:"",img:""},e.group={type:-1,name:"",summary:"",stage:1,agencyId:"",agencyName:"",grade:0,channelId:-1,postAuth:0,joinAuth:0,subjectId:-1,isManager:!1},e.subjects=[{id:-1,name:"选择科目"}];var t=singer.uri().return_url;e.group.isManager=t&&t.indexOf("/user/group")>0,e.group.isManager&&$.get("/group/subjects",{},function(t){t.status&&(singer.each(t.data,function(t){e.subjects.push(t)}),e.$digest())});var r=function(t){var r=(new Date).getFullYear();e.years=[];for(var n=0;t>n;n++)e.years.push(r-n);e.group.grade=r.toString()},n=function(){if($(".dy-btn-info").blur(),e.submiting)return!1;var r=e.group;if(e.needName){if(!r.userName)return singer.alert("请输入真实姓名！"),!1;if(!/^[\u4e00-\u9fa5]{2,5}$/.test(r.userName))return singer.alert("真实姓名需要输入2-5个汉字！"),!1}if(0==r.type||1==r.type){if(!r.agencyId||32!=r.agencyId.length)return singer.alert("请选择学校！"),!1}else if(2==r.type&&r.channelId<=0)return singer.alert("请选择频道！"),!1;return!r.name||r.name.length>20?(singer.alert("圈子名字不能为空，且长度不能超过20个字！"),!1):e.group.isManager&&1==e.group.type&&e.group.subjectId<=0?(singer.alert("请选择同事圈科目"),!1):(e.submiting=!0,void $.post("/group/create",e.group,function(r){r.status?(t||(t="/group/success/"+r.data.id),location.href=t):(singer.alert(r.message),e.submiting=!1,e.$digest())}))};e.stageChange=function(){var t=1==e.group.stage?6:3;r(t)},e.setStep=function(t,a,g){if(3==e.step||e.step==t||t>1&&e.group.type<0&&0>a)return!1;if(3==t)return n(),!1;if(e.step=t,2==t&&a>=0){var s=$(g);s.is("li")||(s=s.parents("li")),e.currentType={name:s.find("h3").html(),img:s.find("img").attr("src")},e.group.type=a,e.needName=1==$("#needName").val(),2==e.group.type?singer.later(function(){singer.tags({canEdit:!0,max:3,change:function(t){e.group.tags=singer.json(t).replace(/'/gi,'"'),e.$digest()}})},100):r(6)}};var a,g={};e.agencySelector=function(){a||(a=singer.dialog({title:"选择学校",content:'<div class="dy-loading" style="margin-bottom: 30px;width: 320px"><i></i></div>',quickClose:!1,cancel:function(){return this.close(),!1},cancelDisplay:!1})),a.showModal(),g.hasOwnProperty(e.group.stage)?a.content(g[e.group.stage]):$.get("/group/agency-selector",{stage:e.group.stage,code:5101,agencyId:e.group.agencyId,keyword:""},function(t){a.content(t),g[e.group.stage]=t})},$(document).delegate(".school-name li","click.selector",function(){var t=$(this);return t.addClass("z-sel").siblings().removeClass("z-sel"),e.group.agencyId=t.data("aid"),e.group.agencyName=t.html(),e.$digest(),a.close(),!1}),$.get("/group/current-agency",{},function(t){t.status&&(e.group.stage=t.data.stage,e.group.agencyId=t.data.id,e.group.agencyName=t.data.name,e.$digest())})}];