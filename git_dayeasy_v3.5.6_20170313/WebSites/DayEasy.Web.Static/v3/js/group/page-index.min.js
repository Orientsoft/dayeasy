!function(t,e){var a,n,i,s,o,d,r,l,c,p,u,g,m=!1,h={},f=5,v=0,b=15,y=t(".dynamic-list"),k=t(".topic-list"),w={0:{css:"color-bg-green",type:"作业"},1:{css:"color-bg-green",type:"作业"},2:{css:"color-bg-orange",type:"通知"},3:{css:"color-bg-grassgreen",type:"辅导"},4:{css:"color-bg-yellow",type:"表扬"},5:{css:"color-bg-orange",type:"协同阅卷"},6:{css:"color-bg-orange",type:"成绩通知"}},x=1;e.getLogger("group-index");n=function(){return m?!1:(m=!0,void t.post("/message/dynamics",{groupId:p,page:v||0,size:b||15},function(a){if(y.find(".dy-loading").remove(),a.status){var n=a.data.newsDetails,i=a.data.users,o=a.data.userRole;for(var d in i)i.hasOwnProperty(d)&&(h[d]=i[d]);if(n&&n.length){var r,l;for(l=0;l<n.length;l++){var c=n[l];2!=c.dynamicType||c.title||(c.title="重要通知"),c.sender=h[c.userId];var p=w[c.dynamicType];c.typeCss=p.css,c.type=p.type,c.groupType=u,c.batch?2===o?c.link=e.sites.apps+"/work/pub-paper/"+c.batch:4===o&&c.userId===g.id&&(c.link=e.format(e.sites.apps+"/work/teacher/statistics-question?batch={0}&paper_id={1}",c.batch,c.paperId)):c.paperId?c.link=e.sites.apps+"/paper/detail/"+c.paperId:c.examId&&(2===o?c.link=e.sites.apps+"/ea/summary/"+c.examId:4===o&&(c.link=e.sites.apps+"/ea/charts/"+c.examId)),r=t(template("dynamic-item",c)),r.data("goods",c.goods||[]),r.data("title",c.title),r.data("id",c.id),y.append(r),s(r)}}(0==n.length||n.length<b)&&(v>0&&y.append('<div class="dy-ended">没有更多的动态</div>'),t(window).unbind("scroll.dynamic"))}(!a.status||0==v&&!a.data.newsDetails.length)&&(y.append('<div class="dy-nothing">暂时没有相关动态</div>'),t(window).unbind("scroll.dynamic")),m=!1}))},i=function(){return m?!1:(m=!0,void t.get("/topic/search",{groupId:p,isPick:2==x,page:v||0,size:b||15},function(a){if(k.find(".dy-loading").remove(),a.status){if(a.data&&a.data.length)for(var n=0;n<a.data.length;n++){var i=a.data[n];i.summary=e.stripTags(i.content).substr(0,200),i.userPhoto=e.makeThumb(i.userPhoto,35,35),i.time=i.addedAt.substr(0,10);var s=t(template("topic-temp",a.data[n]));k.append(s)}a.data.length<b&&t(window).unbind("scroll.dynamic"),singer.loadFormula()}(!a.status||0==v&&0==a.count)&&k.append('<div class="dy-nothing">暂时没有相关帖子</div>'),m=!1}))},s=function(t,a){var n=t.data("goods");if(a&&(e.inArray(g.id,n)?n.splice(n.indexOf(g.id),1):n.push(g.id),t.data("goods",n)),!n||!n.length)return t.find(".d-like-list").html(""),!1;for(var i=[],s=n.length-1;s>=0;s--){var o=n[s]+"";if(i.push(h[o].name),i.length>=f)break}i="<span>"+i.join("、")+"</span>",n.length>f&&(i+=e.format("等{0}人",n.length)),i+="觉得很赞",t.find(".d-like-list").html('<i class="iconfont dy-icon-zan"></i>'+i)},o=function(){var a=t(".btn-notice");a.blur().attr("disabled","disabled").addClass("disabled");e.dialog({title:"发通知",content:t(".pop-notice").html(),ok:function(){for(var n=t(this.node),i=e.trim(n.find("textarea").val()),s=n.find('input[name="options"]:checked'),o=[],d=0;d<s.length;d++)o.push(s.eq(d).val());return!i||i.length>140?(e.msg("请输入通知内容！"),!1):(t.post("/message/send_notice",{groupId:p,message:i,classes:o.join(",")},function(t){t.status?e.alert("发布成功！",function(){location.reload(!0)}):(e.alert(t.message),a.removeAttr("disabled").removeClass("disabled"))}),!1)},okValue:"发　布",onclose:function(){a.removeAttr("disabled").removeClass("disabled")},onshow:function(){var e=t(this.node),a=e.find("textarea");a.focus()},width:400}).showModal()},d=function(a){var n=t(a),i=n.data("id"),s=n.data("name");return e.confirm(e.format("确认移除圈成员【{0}】?",s),function(){t.post("/group/delete",{groupId:p,userId:i},function(t){t.status?e.alert("移除成功！",function(){n.remove()}):e.alert(t.message)})}),!1},r=function(a,n){var i,s="";i=function(){t.post("/group/verify",{id:a,pass:n,message:s},function(t){t.status?e.msg("操作成功！",2e3,function(){location.reload(!0)}):e.alert(t.message)})},n?i():e.dialog({title:"拒绝申请",content:'<div><textarea placeholder="输入附加信息" name="" class="wf100 mb20 mt10" cols="30" rows="5" maxlength="100"></textarea><p class="dy-result" style="width: 320px;display:block;text-align: right">你还可以输入<em>100</em>个字</p></div>',ok:function(){var a=t(this.node).find("textarea");return!a.val()||a.val().length<1?(e.msg("请输入附加信息！"),!1):(s=a.val(),void i())},okValue:"确认拒绝"}).showModal()},l=function(a){return a?void t.ajax({url:e.sites.apps+"/paper/publishPaper",type:"Post",data:{paperId:a,groupId:p},xhrFields:{withCredentials:!0},success:function(t){e.dialog({title:"转推到我的圈子",content:t}).showModal()}}):!1},c=function(){var a,n;a=function(a){var i=a.val(),s=a.next();return i&&11==i.length?void t.post("/marking/publish-joint",{groupId:p,paperNo:i},function(t){return t.status?(n.close().remove(),void e.confirm("发布成功,是否现在分配题目？",function(){location.href="/marking/allot/"+t.message},function(){location.reload(!0)})):(a.focus(),s.html(t.message),!1)}):(a.focus(),s.html("请输入11位试卷编号！"),!1)},n=e.dialog({title:"发起协同阅卷",content:'<input type="text" id="paperNo" placeholder="试卷编号" style="width:300px;"/><p id="errorMsg" class="text-danger mt10"></p>',okValue:"发布",ok:function(){var e=t(this.node).find("#paperNo");return a(e),!1},cancelValue:"取消",cancel:function(){},width:300}),n.showModal()},a=function(){p=t(".home-circles").data("gid");var e=t(".mian-conter");u=e.data("type"),g={id:e.data("user-id"),name:e.data("user-name")},h[g.id]=g,y.length&&n(),k.length&&i()}(),t(document).ready(function(){var e=t(".ove-y");e.length&&e.mCustomScrollbar({axis:"y",theme:"dark-3"})}).delegate(".btn-notice","click",function(){o()}).delegate(".d-like","click",function(){var e=t(this),a=e.parents(".box-list").data("id");return a?void t.post("/message/support",{id:a},function(t){t.status&&(e.toggleClass("z-crt").html('<i class="iconfont dy-icon-zan"></i>'+t.data),s(e.parents(".box-list"),!0))}):!1}).delegate(".d-comment","click",function(){var a=t(this),n=a.parents(".box-list"),i=n.data("id"),s=n.data("title");e.updateComment=function(t){var n=~~a.html().replace(/<[^>]*>/gi,"");t=e.isNumber(t)?t:1,n+=t,a.html('<i class="iconfont dy-icon-messageline"></i>'+n)},t.get("/message/comment-list",{sourceId:i},function(t){e.dialog({title:s+" - 评论",content:t}).showModal()})}).delegate(".b-repub","click",function(){var e=t(this).data("pid");return l(e),!1}),t(".posa-box button").bind("click",function(){var e=t(this),a=e.parents("li").data("id"),n=e.data("pass");return r(a,n),!1}),t(".bm-delete").bind("click",function(e){e.stopPropagation();var a=t(this).parents("li");return d(a),!1});var I=t(".d-share-wrap");t(".dt-share").click(function(){return I.toggleClass("hide"),!1}),I.find(".dy-icon-close").click(function(){I.addClass("hide")}),t(".dg-nav-list h2").bind("click",function(){var e=t(this),a=e.data("state");return e.hasClass("active")?!1:(e.addClass("active").siblings().removeClass("active"),v=0,x=a,k.empty().append('<div class="dy-loading"><i></i></div>'),void i())}),t("#btn-joinMark").bind("click",function(){return c(),!1}),t(window).bind("scroll.dynamic",function(e){if(m)return!1;var a=t(this).height(),s=t(document).height(),o=t(this).scrollTop(),d=s-a-o;return 160>d&&(v++,y.length&&(y.append('<div class="dy-loading"><i></i></div>'),n()),k.length&&(k.append('<div class="dy-loading"><i></i></div>'),i())),!1}),template.helper("jointHelper",function(t){if(!t||5!=t.dynamicType)return"";switch(t.jointStatus){case 0:var a=t.addedBy==g.id;return t.distributed?t.hasMission||a?e.format('<a class="dy-btn dy-btn-info" target="_blank" href="/marking/mission_v2/{0}">批阅</a>',t.jointBatch):"":a?e.format('<a class="dy-btn dy-btn-info" href="/marking/allot/{0}" target="_blank">分配任务</a>',t.jointBatch):e.format('<a class="dy-btn dy-btn-default disabled">{0}</a>',"等待分配");case 2:var n=e.format(e.sites.apps+"/work/teacher/statistics-score-joint?joint_batch={0}&paper_id={1}",t.jointBatch,t.paperId);return e.format('<a class="dy-btn dy-btn-success" target="_blank" href="{0}">查看统计</a>',n)}return""}),template.config("escape",!1)}(jQuery,SINGER);