!function($,S){var logger=S.getLogger("group-setting"),update,transfer,updateLogo,updateGroup,dissolution,deleteMember,groupId,isManager,quit,$circles;$circles=$(".home-circles"),groupId=$circles.data("gid"),isManager="True"==$circles.data("manager"),update=function(t){var a=$(t),e=a.parents("li").data("param");if("owner"===e)return transfer(t),!1;var n=a.siblings("input,textarea"),i=n.val(),o=a.parent(),r=$(".mian-cont li p");o.hasClass("z-sel")?updateGroup(getUpdateData(t),function(){n.attr({disabled:"disabled",readonly:"readonly"}),o.removeClass("z-sel"),"name"===e&&$(".top-title .dg-name strong").html(i)}):(o.addClass("z-sel"),r.not(o).removeClass("z-sel"),n.removeAttr("disabled").removeAttr("readonly").focus())};var getUpdateData=function(t){var a=$(t),e=a.parents("li").data("param"),n=a.siblings("input,textarea"),i=n.val(),o=groupId;if(i=S.trim(i||""),"name"===e&&(!i||i.length>20))return S.msg("圈名称不能为空且不能超过20个字符！"),!1;if("summary"===e&&(!i||i.length>140))return S.msg("圈简介不能为空且不能超过140个字符！"),!1;var r={id:o};return r[e]=i,r};updateGroup=function(t,a){return t&&t.id&&isManager?void $.post("/group/update",t,function(t){t.status?(S.msg("修改成功！"),a&&S.isFunction(a)&&a.call()):S.msg(t.message)}):!1},transfer=function(t){return $(t).data("show")?!1:void $.post("/group/teachers",{id:groupId},function(a){if(a.status&&a.data&&a.data.length){for(var e=a.data,n='<div class="pop-members"><div class="pop-cont"><ul>{0}</ul></div></div>',i=[],o=0;o<e.length;o++){var r=e[o];i.push(S.format('<li data-uid="{0}" title="{2}"><img width="30" height="30" src="{1}" alt="" /><strong>{2}</strong><p>{3}</p><i class="iconfont dy-icon-gou"></i></li>',r.id,S.makeThumb(r.avatar,30,30),r.name,r.subjectName||""))}S.dialog({title:"转让圈主",content:S.format(n,i.join("")),cancelValue:"取消",okValue:"确认转让",ok:function(){var t=$(this.node),a=t.find("li.active");if(0==a.length)return S.msg("请选择要转让给的教师！"),!1;var e=a.find("strong").html();return S.confirm(S.format("确认将圈主转让给[{0}]吗？",e),function(){var t=a.data("uid");$.post("/group/transfer",{groupId:groupId,userId:t},function(t){t.status?S.alert("转让成功！",function(){location.reload(!0)}):S.alert(t.message)})}),!1},cancel:function(){this.close().remove()},onshow:function(){var t=$(this.node);t.find("li").bind("click",function(){$(this).toggleClass("active").siblings().removeClass("active")})},onclose:function(){$(t).data("show",!1)}}).showModal(),$(t).data("show",!0)}else S.alert("圈内没有其他用户可以接收转让！")})},dissolution=function(){var t="解散圈子后，所有圈子成员将不能再看到圈子里的内容，确认要解散圈子吗？";S.confirm(t,function(){$.post("/group/dissolution",{id:groupId},function(t){t.status?S.alert("圈子已经成功解散！",function(){location.href="/group"}):S.alert(t.message)})})},deleteMember=function(t){var a=$(t),e=a.data("id"),n=a.data("name");S.confirm(S.format("确认移除圈成员【{0}】?",n),function(){$.post("/group/delete",{groupId:groupId,userId:e},function(t){t.status?S.alert("移除成功！",function(){a.remove()}):S.alert(t.message)})})},updateLogo=function(){$(".webuploader-element-invisible").click()},quit=function(){S.confirm(S.format('退出圈子[{0}]之后，<br/><span class="text-danger">你将不能查看与原圈子相关的动态！</span><br/>是否确认要退出？',$(".dg-name strong").html()),function(){$.post("/group/quit",{id:groupId},function(t){t.status?S.alert("你已成功退出圈子！",function(){location.href=S.sites.main}):S.alert(t.message)})})},S.uploader.on("uploadSuccess",function(t,a){if(a.state){var e=a.urls[0];$("#avatar").val(e),$(".dg-avatar img").attr("src",S.makeThumb(e,150,150)),updateGroup({id:groupId,avatar:a.urls[0]})}S.uploader.reset()}),isManager?($(".mian-cont .iconfont").bind("click",function(){return update(this),!1}),$(".mian-cont input,.mian-cont textarea").bind("blur",function(){var t=$(this),a=t.parents(".form-area");a.hasClass("z-sel")&&(t.attr({disabled:"disabled",readonly:"readonly"}),S.later(function(){a.removeClass("z-sel")},500))}),$(".dg-avatar").bind("click",function(){updateLogo()}),$("#dissolution").bind("click",function(){return dissolution(),!1}),$(".post-auth").bind("change",function(){var t=$(this).val();updateGroup({id:groupId,postAuth:t})}),$(".dg-change-bg").bind("click",function(){$.get("/group/choose-image",{type:2,image:encodeURIComponent($(".top-img img").attr("src"))},function(t){S.dialog({content:t,cancelValue:"取消"}).showModal()})}),$(".b-delete").bind("click",function(){$(this).blur();var t=$(this).parents("tr");return deleteMember(t),!1}),S._mix(S,{setImage:function(t){updateGroup({id:groupId,banner:t},function(){$(".top-img img").attr("src",t)})}})):$("#quitBtn").bind("click",function(){return quit(),!1}),S.tags({canEdit:isManager,max:3,data:eval($(".d-tags").data("list")),change:function(t){updateGroup({id:groupId,tags:S.json(t).replace(/'/gi,'"')})}})}(jQuery,SINGER);