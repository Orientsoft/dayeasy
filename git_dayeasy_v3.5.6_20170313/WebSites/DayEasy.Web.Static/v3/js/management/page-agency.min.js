!function(t,n){var e,a,i,o,r;e=function(e){var i=template("edit-template",e);n.dialog({title:"编辑机构信息",content:i,cancelValue:"取消",okValue:"保存",ok:function(){var i=t(this.node),o=i.find("#name").val(),r=i.find("#summary").val(),c=i.find("#logo").val(),l=~~i.find("#sort").val(),u=i.find('button[data-id="ok"]');if(!o)return n.alert("请输入机构名称！"),!1;u.disabled("稍后..");var d={id:e.id};return e.name!=o&&(d.name=o),e.summary!=r&&(d.summary=r),e.logo!=c&&(d.logo=c),e.sort!=l&&(d.sort=l),a(d,function(){u.unDisabled()}),!1}}).showModal()},a=function(e,a){t.post("/agency/edit",e,function(t){return t.status?void n.msg("编辑成功！",2e3,function(){location.reload(!0)}):(n.alert(t.message),a&&a.call(this),!1)})},i=function(){t(".webuploader-element-invisible").click()},r=function(e){if(!e.length)return!1;var a,i;a=function(n){t.get("/system/areas",{code:n||0},function(t){return t&&t.length?void i(t):!1})},i=function(i){var o=t('<select class="form-control area-item">');o.append('<option value="-1">请选择</option>'),n.each(i,function(t){o.append(n.format('<option value="{id}">{name}</option>',t))}),e.append(o),o.bind("change",function(){for(var t=o.val(),n=o.next(),e=0;4>e&&n.length;e++)n.remove(),n=o.next();t>0&&a(t)})},a(0)},t(".b-edit").bind("click",function(){var n=t(this).parents("tr"),a=n.data("agency"),i=n.data("name"),o=n.data("summary"),r=n.data("logo"),c=n.data("sort");return e({id:a,name:i,sort:c,summary:o,logo:r}),!1}),t(".b-certificate").bind("click",function(){var e=t(this).parents("tr"),a=e.data("agency"),i=function(){return t.post("/agency/certificate",{id:a},function(t){return t.status?void n.msg("认证成功！",2e3,function(){location.reload(!0)}):(n.alert(t.message),!1)}),!1};n.confirm("确定认证该机构？",function(){i()})}),t(".btn-add").bind("click",function(){var e=t(this),a=template("addTpl",{});e.blur(),n.dialog({title:"添加机构",width:500,content:a,onshow:function(){o=t(this.node),r(o.find("#areaSelector")),t(".btn-submit").bind("click",function(){var e=t(this),a=o.find("#agencyName"),i=a.val(),r=o.find("#agencyType").val(),c=o.find("#areaSelector > select:last-child").val(),l=o.find("input[name=stage]:checked"),u=[];if(e.blur(),!i)return n.msg("请输入机构名称",2e3,function(){a.focus()}),!1;if(0>r)return n.msg("请选择机构类型"),!1;if("-1"==c)return n.msg("请选择所在区域"),!1;if(0==l.length)return n.msg("请选择机构学段"),!1;l.each(function(t,n){u.push(n.value)}),e.disabled("稍后..");var d={name:i,type:r,code:c,stages:u};t.post("/agency/add",d,function(t){return t.status?(n.alert("添加成功",function(){location.reload(!0)}),!1):(n.alert(t.message),void e.unDisabled())})})}}).showModal()}),t(document).delegate(".b-update-logo","click",function(){i(),o=t(this)}),n.uploader.on("uploadSuccess",function(t,e){if(e.state){var a=e.urls[0];o.prev().val(a),o.attr("src",n.makeThumb(a,50,50))}n.uploader.reset()})}(jQuery,SINGER);