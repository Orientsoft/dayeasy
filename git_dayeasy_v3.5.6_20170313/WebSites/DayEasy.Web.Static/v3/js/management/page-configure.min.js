!function(a,e){var t=[],n={id:"",name:""};a(".b-agency-key").bind("keyup",function(t){var n=a(this).val(),s=a(".dy-agencies");return n&&e.trim(n)?(a.post("/system/agencies",{keyword:encodeURIComponent(n)},function(t){if(s.empty(),t.status){for(var n=0;n<t.data.length;n++){var d=t.data[n],i=a(e.format('<p class="dy-agency-item"><em class="stage{stageCode}">{stage}</em>{name}<small>{area}</small></p>',d));i.data("id",d.id),i.data("name",d.name),s.append(i)}s.removeClass("hide")}else s.addClass("hide")}),!1):(s.empty(),s.addClass("hide"),!1)}),a(".dy-agencies").delegate("p","click",function(){var e=a(this);n.id=e.data("id"),n.name=e.data("name"),a(".b-agency-key").val(n.name),a(".dy-agencies").empty().addClass("hide")}).delegate("p","mouseenter",function(){a(this).addClass("hover")}).delegate("p","mouseleave",function(){a(this).removeClass("hover")});var s,d,i,r,o,p,c;d=function(e){if(s&&s.length||(s=[],a(".b-user-list tr").each(function(e,t){s.push(a(t).data("id"))})),!s.length)return!1;for(var t=0;t<s.length;t++)if(s[t]==e)return!0;return!1},i=function(a){if(s&&s.length)for(var e=0;e<s.length;e++)if(s[e]==a)return void s.splice(e,1)},r=function(a){if(!t.length)return!1;for(var e=0;e<t.length;e++)if(t[e]==a)return!0;return!1},o=function(a){if(t.length)for(var e=0;e<t.length;e++)if(t[e]==a)return void t.splice(e,1)},p=function(a){if(!a)return"-";var e="";return(4&a)>0&&(e+='<span class="mr5">教师</span>'),(128&a)>0&&(e+='<span class="mr5">系统管理员</span>'),e},c=function(){var s=e.trim(a(".b-user-code").val());return s&&5===s.length?r(s)?(e.msg("请勿重复添加"),!1):void a.post("/sys/apps/user",{code:s},function(i){if(i.status){if(a(".b-user-code").val("").focus(),d(i.data.id))return void e.msg("请勿重复添加");var r=i.data.email?i.data.email:i.data.nick,o=a('<tr data-id="'+i.data.id+'" data-code="'+s+'" data-agency="'+n.id+'">');o.append("<td>"+r+"</td>"),o.append("<td>"+i.data.name+"</td>"),o.append("<td>"+p(i.data.role)+"</td>"),o.append("<td>"+(n.name&&n.name.length?n.name:"-")+"</td>");var c=a('<td class="dy-operations">');c.append('<span data-t="push" class="dy-operation dy-success" title="确认添加"><i class="fa fa-check"></i></span>'),c.append("&nbsp;|&nbsp;"),c.append('<span data-t="remove" class="dy-operation dy-danger" title="删除"><i class="fa fa-close"></i></span>'),o.append(c),a(".b-user-list").append(o),t.push(s)}else e.msg(i.message)}):!1},a(".b-user-search").bind("click",c),a(".b-user-code").bind("keyup",function(a){return a.stopPropagation(),13===a.keyCode&&c(),!1}),a(".b-user-list").delegate(".dy-operation","click",function(){var t=a(this),n=t.data("t"),s=t.parents("tr");if("remove"==n)return o(s.data("code")),void s.remove();var d=a(".d-app-configure").data("appid");if("delete"==n){var r=s.data("id");return void e.confirm("确认删除用户的应用？",function(){a.post("/sys/apps/configure-remove",{appId:d,userId:r},function(a){a.status?(i(r),e.msg("取消分配成功",1e3,function(){s.remove()})):e.msg(a.message)})})}"push"==n&&a.post("/sys/apps/configure-submit",{appId:d,userId:s.data("id"),agencyId:s.data("agency")},function(a){a.status?e.msg("已成功添加用户的应用",1e3,function(){t.parents("td").html('<span data-t="delete" class="dy-operation dy-danger"><i class="fa fa-trash"></i> 删除</span>')}):e.msg(a.message)})})}(jQuery,SINGER);