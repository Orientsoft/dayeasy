!function(t,e){var a,n,s,o,d,i,c,r=e.uri(),l=r.stage||0,u=r.subjectId||0,m=t("#stage"),f=t("#subjectId");a=function(a,n){a.status?(c&&c.close().remove(),e.msg(a.message||n,2e3,function(){window.location.reload(!0)})):(e.alert(a.message),t(c.node).find('[data-id="ok"]').removeClass("disabled").removeAttr("disabled").html(function(){return t(this).data("word")||"确认"}))},n=function(n){var s=template("editTemplate",{parent:n}),o=function(e,s){t.post("/sys/kps/add",{parentId:n.id,stage:l,subjectId:u,name:e,sort:s},function(t){a(t,"添加成功！")})};c=e.dialog({title:"添加知识点",content:s,okValue:"添加",ok:function(){var a=t("#textName").val(),n=t("#textSort").val()||0;return""==a||""==e.trim(a)?(e.msg("请输入知识点名称！"),!1):(o(a,n),!1)},cancelValue:"取消",cancel:function(){this.close().remove()}}),c.showModal()},s=function(n){var s=template("editTemplate",n),o=function(e,s){t.post("/sys/kps/edit",{id:n.id,name:e,sort:s},function(t){a(t,"编辑成功！")})};c=e.dialog({title:"编辑知识点",content:s,okValue:"保存",ok:function(){var a=t("#textName").val(),n=t("#textSort").val()||0;return""==a||""==e.trim(a)?(e.msg("请输入知识点名称！"),!1):(o(a,n),!1)},cancelValue:"取消",cancel:function(){this.close().remove()}}),c.showModal()},d=function(n,s){var o="";switch(s){case 4:o="您确定要删除该知识点？";break;case 1:o="您确定要还原该知识点？";break;case-1:o='您确定要彻底删除该知识点吗?(<strong class="text-danger">删除之后不可还原</strong>)'}e.confirm(o,function(){t.post("/sys/kps/update-status",{knowledgeId:n,status:s},function(t){a(t,"更新成功！")})})},i=function(e,a){t.post("/sys/kps/question-count",{code:e},function(t){a&&a.call(this,t)})},o=function(n,s){var o,d,i,r={};o=function(){if(!r||!r.code)return a({status:!1,message:"请选择目标知识点！"}),!1;var o=e.format('确认将【{0}<small class="text-gray ml5">[{1}]</small>】转移到【{2}】？',s,n,r.name);e.confirm(o,function(){t.post("/sys/kps/move",{source:n,target:r.code},function(t){a(t,"转移任务已提交！")})},function(){a({status:!1,message:"已取消"})})},d=function(e,a){t.get("/sys/kps/list",{stage:l,subjectId:u,keyword:e},function(t){t.length&&a&&a.call(this,t)})},i=template("moveTemplate",{name:s,code:n}),c=e.dialog({title:"转移知识点",content:i,okValue:"确认转移",ok:function(){var e=t(this.node).find('[data-id="ok"]');return e.addClass("disabled").attr("disabled","disabled").data("word",e.html()).html("转移中.."),o(),!1},cancelValue:"取消",cancel:function(){this.close().remove()},onshow:function(){t(this.node).find(".d-target").bind("keyup",function(){var a=t(this),s=a.val(),o=t(".d-knowledges");d(s,function(s){o.removeClass("hide").empty();for(var d=0;d<s.length;d++){var i=s[d];0!=i.code.indexOf(n)&&(e.keys(i.path).length>0&&e.each(i.path,function(t){i.name=t+"/"+i.name}),o.append(e.format('<div class="d-knowledge-item" data-code="{code}">{name}<small class="text-gray ml5">[{code}]</small></div>',i)),o.find(".d-knowledge-item").bind("click",function(){var e=t(this);r.code=e.data("code"),r.name=e.html(),o.addClass("hide"),a.val(e.text())}))}})})}}),c.showModal()},m.add(f).change(function(){t("#searchForm").submit()}),t(".b-add").click(function(){var e=t(this).parents("tr"),a=e.data("id"),s=e.data("name");return n({name:s,id:a}),!1}),t("#btn-add").click(function(){if(0>=l||0>=u)return e.msg("请先选择学段和科目！"),!1;var t=m.find(":selected").text(),a=f.find(":selected").text();return n({name:t+" "+a,id:0}),!1}),t(".b-edit").click(function(){var a=t(this).parents("tr"),n=a.data("id"),o=e.stripTags(a.data("name")),d=a.data("sort");return s({id:n,name:o,sort:d}),!1}),t(".b-count").bind("click",function(e){e.stopPropagation();var a=t(this),n=a.parents("tr"),s=n.data("code"),o=(n.data("status"),a.parent());return o.html("..."),i(s,function(t){o.html(t),0==t&&o.parents("tr").find("td:last").append('<a href="#" data-status="-1" class="b-update text-danger ml20">彻底删除</a>'),t>0&&o.append('<a href="#" class="b-move ml20">转移</a>')}),!1}),t(document).delegate(".b-move","click",function(){var e=t(this).parents("tr");return o(e.data("code"),e.data("name")),!1}).delegate(".b-update","click",function(){var e=t(this),a=e.parents("tr").data("id"),n=e.data("status");return d(a,n),!1})}(jQuery,SINGER);