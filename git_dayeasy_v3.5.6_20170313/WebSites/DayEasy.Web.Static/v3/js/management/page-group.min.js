!function(e,t){var a,n,i,r,d,s=e("#searchForm");a=function(){s.submit()},d=function(e,a){var n=[],i='<i class="fa fa-times b-delete" title="删除成员"></i>';return t.each(e,function(e){var r=i;(0>a||e.id==a)&&(r=""),n.push({uid:e.id,code:e.code,avatar:t.makeThumb(e.avatar,30,30),name:e.name?e.name:e.nick?e.nick:"未填写",role:2==e.role?"学生":1==e.role?"家长":e.subjectName,action:r})}),n},r=function(a,n,i,r){return a&&n&&n.length?void e.post("/user/group/add-members",{groupId:a,users:n},function(e){e.status?i&&i.call(this,e.data):(t.alert(e.message),r&&r.call(this))}):!1},i=function(a,n,i){return a&&a.groupId?/^[0-9]{11}$/gi.test(a.paperCode)?!a.userId||a.userId<=0?(t.alert("请选择负责人",function(){i&&i.call(this)}),!1):void e.post("/user/group/publish-joint",a,function(e){e.status?t.alert("发布成功,可到协同列表中查看",function(){n&&n.call(this)}):t.alert(e.message,function(){i&&i.call(this)})}):(t.alert("试卷编号格式不正确,应为11位数字",function(){i&&i.call(this)}),!1):(t.alert("圈子Id不能为空",function(){i&&i.call(this)}),!1)},n=function(a,n,i){e.post("/user/group/delete-member",{groupId:a,userId:n},function(e){e&&e.status?t.msg("移出成功！",2e3,function(){i&&i.call(this)}):t.alert(e.message)})},e("#type,#auth,#ct").bind("change",function(){a()}),e(".b-delete").click(function(){var a=e(this),n=a.data("status"),i=a.parents("tr").data("gid"),r=4==n?"删除":"还原";return t.confirm(t.format("您确定要{0}该圈子?",r),function(){var a=this;e.post("/user/group/delete",{groupId:i},function(e){e.status?(a.close().remove(),t.msg(r+"成功！",2e3,function(){window.location.reload(!0)})):t.alert(e.message)})}),!1}),e(".b-certificate").bind("click",function(){var a=e(this).parents("tr").data("gid");return e.Dayez.confirm("您确定要认证该圈子?",function(){var n=this;e.post("/user/group/certificate",{groupId:a},function(e){e.status?(n.close().remove(),t.msg("认证成功！",2e3,function(){window.location.reload(!0)})):t.alert(e.message)})},function(){}),!1}),e(".d-edit").bind("click",function(){var a,n,i=e(this).parents("tr"),r=i.data("gid");return e.get("/user/group/load",{groupId:r},function(i){if(i.status){var d=i.data;if(0==d.type||1==d.type){var s=["小学","初中","高中"];if(d.stageCn=s[d.stage-1],0==d.type){for(var o=[],l=(new Date).getFullYear(),u=l-6;l>=u;u++)o.push(u);d.years=o}}a=template("editTpl",d),n=t.dialog({title:"编辑圈子信息",width:500,content:a,onshow:function(){var a=e(this.node),n=a.find(".agency-input"),i=a.find(".dy-agency-wrap"),s=a.find(".dy-agencies");n.length&&n.agency({item:i,list:s,add:function(e){i.removeClass("hide"),i.find("#agencyId").val(e.id),i.find(".dy-agency-item").html(t.format('<em class="stage{stageCode}">{stage}</em>{name}<small>{area}</small><i title="删除" class="fa fa-times"></i>',e))}}),a.find(".btn-save").bind("click",function(){var n=e(this),i={id:r,name:a.find("#groupName").val(),summary:a.find("#groupSummary").val()},s=a.find("#agencyId"),o=a.find(".d-grade");return s.length&&(i.agencyId=s.val(),!i.agencyId||32!=i.agencyId.length)?(t.alert("请输入所属机构"),!1):!o.length||(i.gradeYear=~~o.val(),i.gradeYear&&t.inArray(i.gradeYear,d.years))?(console.log(i),n.disabled("稍后.."),void e.post("/user/group/update",i,function(e){return e.status?(t.alert("更新成功",function(){location.reload(!0)}),!1):(t.alert(e.message),void n.unDisabled())})):(t.alert("请选择入学年份"),!1)})}}),n.showModal()}else n.close().remove(),t.alert(i.message)}),!1}),e(".d-members").bind("click",function(){var a,i,s=e(this).parents("tr"),o=s.data("gid"),l=s.find("td:eq(0)").text(),u=s.data("mid");return i=function(a){var n=a.find(".g-keyword").val(),i=a.find(".search-form"),r=i.find(".form-group");return n?(r.html('<div style="padding: 40px 0 25px;"><span class="ui-dialog-loading">Loading..</span></div>'),i.find(".btn-add").disabled(),i.find(".d-total em").html(0),void e.get("/user/group/search-user",{groupId:o,keyword:t.trim(n)},function(e){if(r.empty(),e.status)if(i.removeClass("hide"),e.data&&e.data.length){var t=d(e.data,-1),a=template("usersTpl",t);r.html(a)}else r.html('<div class="dy-nothing">没有找到相关用户</div>');else i.addClass("hide")})):!1},a=t.dialog({width:800,content:'<div style="padding: 40px 0 25px;"><span class="ui-dialog-loading">Loading..</span></div>',padding:0,quickClose:!0,backdropOpacity:.3,onshow:function(){var d=e(this.node);d.delegate(".ui-dialog-close","click",function(){a.close().remove()}).delegate(".b-delete","click",function(){var a=e(this).parents(".user-item"),i=a.attr("title"),r=a.data("uid");t.confirm(t.format("确认要将成员【<b>{0}</b>】移出圈子吗？",i),function(){n(o,r,function(){a.remove();var e=s.find("td:eq(3)");e.html(~~e.html()-1)})})}).delegate(".search-form .user-item","click",function(){var t=e(this),a=e(".search-form"),n=a.find(".btn-add");t.toggleClass("hover");var i=a.find(".user-item.hover").length;i>0?n.unDisabled():n.disabled(),d.find(".d-total em").html(i)}).delegate(".g-keyword","keyup",function(e){13===e.keyCode&&i(d)}).delegate(".btn-search","click",function(){i(d)}).delegate(".search-form .btn-add","click",function(){var a=e(this),n=d.find(".search-form .user-item.hover"),i=[];return n.length?void t.confirm("确认将选中的用户添加到圈子中？",function(){a.disabled("稍后.."),n.each(function(t,a){i.push(e(a).data("uid"))}),r(o,i,function(r){t.msg("添加成功",2e3,function(){var o=d.find(".g-members"),l=o.find(".user-list");l.length||(l=e('<ul class="user-list"></ul>'),o.append(l).find(".dy-nothing").remove()),n.each(function(a,n){var i=e(n);t.inArray(i.data("uid"),r)&&(i.removeClass("hover").append('<i class="fa fa-times b-delete" title="删除成员"></i>'),l.append(i))});var u=s.find("td:eq(3)");u.html(~~u.html()+r.length),d.find(".g-keyword").focus(),a.unDisabled();var c=i.length-r.length;0>=c?(a.disabled(),d.find(".d-total em").html("0")):d.find(".d-total em").html(c)})},function(){a.unDisabled()})}):(t.alert("请选择要添加的用户"),!1)})}}),a.showModal(),e.post("/user/group/members",{groupId:o},function(e){if(!e.status)return!1;var t={members:[],name:l};t.members=d(e.data,u);var n=template("membersTpl",t);a.content(n)}),!1}),e(".d-joint").bind("click",function(){var a,n=e(this).parents("tr"),r=n.data("gid");return a=t.dialog({title:"发起协同",width:600,onshow:function(){var n=e(this.node);n.delegate(".user-item","click",function(){var t=e(this),a=n.find(".btn-publish");t.hasClass("hover")?(t.removeClass("hover"),a.disabled()):(t.addClass("hover").siblings().removeClass("hover"),a.unDisabled())}).delegate(".btn-publish","click",function(){var d=e(this),s=n.find(".d-keyword"),o=n.find(".user-item.hover"),l=t.trim(s.val()||""),u=o.data("uid");d.disabled(),i({groupId:r,paperCode:l,userId:u},function(){a.close().remove()},function(){d.unDisabled()})})}}),a.showModal(),e.post("/user/group/members",{groupId:r},function(e){if(!e.status||!e.data||!e.data.length)return a.close().remove(),t.alert("同事圈还没有任何成员，不能发起协同"),!1;var n=d(e.data,-1),i=template("jointTpl",n);a.content(i)}),!1}),e("#keyword").agency({add:a,remove:a})}(jQuery,SINGER);