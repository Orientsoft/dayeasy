var indexConfig=function(e,t){var a={data:{},seed:1e3,maxSectionLen:6,maxTabLen:4,sources:[],sourceLen:4,getSeed:function(e){return e=e||"S",e+ ++a.seed},init:function(){e.post("/operate/index-config/data",{},function(t){if(a.data=t.data,a.data.carousels=a.data.carousels||[],a.data.fixeds=a.data.fixeds||[],a.data.sections=a.data.sections||[],e(".ic-carousel").find(".num").text(a.data.carousels.length),e(".ic-fixed").find(".num").text(a.data.fixeds.length),a.data.sections&&a.data.sections.length){for(var s=0;s<a.data.sections.length;s++){var i=a.data.sections[s];i.id=a.getSeed();var n=i.id+"T";if(i.tabs&&i.tabs.length){i.tabs[0].active=1;for(var o=0;o<i.tabs.length;o++)i.tabs[o].id=a.getSeed(n)}}var r=template("ic-section",{sections:a.data.sections});e(".ic-sections").append(r)}})},pushSection:function(s){var i=a.data.sections&&a.data.sections.length?a.data.sections.length:0;if(i>=a.maxSectionLen)return void t.msg("最多添加"+a.maxSectionLen+"个版块");i+1>=a.maxSectionLen&&s.parent().hide();var n=e(".ic-sections"),o=a.getSeed(),r=a.getSeed(o+"T"),c={id:o,sources:[],tabs:[{id:r,active:1,sources:[],adverts:[],groups:[]}]};a.data.sections.push(c);var d={sections:[]};d.sections.push(c),n.append(template("ic-section",d))},removeSection:function(e){for(var t=e.parents(".is-item"),s=t.data("id"),i=0;i<a.data.sections.length;i++)if(a.data.sections[i].id==s){a.data.sections.splice(i,1);break}t.parent().siblings("div").show(),t.remove()},pushTab:function(e){for(var s=e.parent().siblings(".is-tabs"),i=e.parents(".is-item").data("id"),n=0,o=0;o<a.data.sections.length;o++)if(a.data.sections[o].id==i){n=a.data.sections[o];break}if(!n)return void t.msg("没有查询到当前Tab，请刷新重试");var r=n.tabs&&n.tabs.length?n.tabs.length:0;if(r>=a.maxTabLen)return void t.msg("最多添加"+a.maxTabLen+"个Tab");r+1>=a.maxTabLen&&e.parent().hide();var c=a.getSeed(i+"T"),d={id:c,active:0,sources:[],adverts:[],groups:[]};n.tabs.push(d);var u={tabs:[]};u.tabs.push(d),s.append(template("ic-tab",u))},removeTab:function(e){for(var t=e.parents(".is-item"),s=e.parents(".is-tab"),i=t.data("id"),n=s.data("id"),o=0;o<a.data.sections.length;o++)if(a.data.sections[o].id==i){for(var r=a.data.sections[o],c=0;c<r.tabs.length;c++)if(r.tabs[c].id==n){r.tabs.splice(c,1);break}break}var d=s.parent();d.siblings("div").show(),s.remove();var u=d.find(".is-tab");u&&u.length&&d.eq(0).addClass("ist-active").find(".is-content-box").removeClass("hide")},checkGroup:function(s){for(var i=s.parents(".is-item"),n=s.parents(".is-tab"),o=n.find(".is-name").text(),r=i.data("id"),c=n.data("id"),d=0,u=0;u<a.data.sections.length;u++)if(a.data.sections[u].id==r){for(var f=a.data.sections[u],l=0;l<f.tabs.length;l++)if(f.tabs[l].id==c){d=f.tabs[l];break}break}if(!d)return void t.msg("没有查询到当前Tab，请刷新重试");var p={groups:[]};for(u=0;u<d.groups.length;u++){var g=d.groups[u];0==g.type&&p.groups.push(g.id)}var v=template("ic-group",p);t.dialog({title:"添加圈子至"+o,content:v,okValue:"确定",cancelValue:"取消",ok:function(){d.groups=[],e(".ic-group").find("input[name='txtGroup']").each(function(t,a){var s=e(a).val();s&&s.length&&d.groups.push({type:0,id:s})}),n.find(".group-num").text(d.groups.length)},cancel:function(){}}).showModal()},checkAdver:function(s){var i,n,o,r=s.parent().data("type"),c=[],d=0,u=0,f=0;if("section"==r&&(n=s.parents(".is-item"),d=a.getItemById(a.data.sections,n.data("id")),!d))return void t.msg("没有查询到当前版块，请刷新重试");if("tab"==r||"tabAdvert"==r||"tabGroup"==r){if(n=s.parents(".is-item"),d=a.getItemById(a.data.sections,n.data("id")),!d)return void t.msg("没有查询到当前版块，请刷新重试");if(o=s.parents(".is-tab"),u=a.getItemById(d.tabs,o.data("id")),!u)return void t.msg("没有查询到当前Tab，请刷新重试")}switch(r){case"carousel":c=a.data.carousels,a.sourceLen=8,i=e(".carousel-num");break;case"fixed":c=a.data.fixeds,a.sourceLen=4,i=e(".fixed-num");break;case"section":c=d.sources,a.sourceLen=1,i=n.find(".section-num");break;case"tab":c=u.sources,a.sourceLen=1,i=o.find(".tab-num");break;case"tabAdvert":c=u.adverts,a.sourceLen=4,i=o.find(".advert-num");break;case"tabGroup":c=u.groups,a.sourceLen=4,i=o.find(".group-num")}if(a.sources=[],c&&c.length)for(f=0;f<c.length;f++)"tabGroup"!=r&&a.sources.push({id:c[f],name:""}),"tabGroup"==r&&1==c[f].type&&a.sources.push({id:c[f].id,name:""});e.get("/operate/advert?partial=1",{},function(e){t.dialog({title:"选择图文广告",content:e,okValue:"确定",cancelValue:"取消",ok:function(){if(c.splice(0,c.length),a.sources&&a.sources.length)for(f=0;f<a.sources.length;f++)"tabGroup"==r?c.push({id:a.sources[f].id,type:1}):c.push(a.sources[f].id);i.text(c.length),"section"==r&&(d.title=a.sources[0].name,n.find(".section-name").text(a.sources[0].name)),"tab"==r&&(u.title=a.sources[0].name,o.find(".tab-name").text(a.sources[0].name))},cancel:function(){},width:800,height:410}).showModal()})},getItemById:function(e,t){if(!e||!e.length||!t)return 0;for(var a=0;a<e.length;a++)if(t==e[a].id)return e[a]},save:function(){return!a.data.carousels||!a.data.carousels.length||a.data.carousels.length>8?void t.msg("轮播广告需要1-8条图文数据"):a.data.fixeds&&4==a.data.fixeds.length?void e.post("/operate/index-config/save",{data:t.json(a.data)},function(e){return e.status?void t.msg("保存成功"):void t.alert(e.message)}):void t.msg("固定广告需要4条图文数据")}};return a}(jQuery,SINGER);!function(e,t,a){a.init(),e(".ic-section-box").delegate(".ic-push","click",function(){var t=e(this),s=t.data("type");switch(s){case"section":a.pushSection(t);break;case"tab":a.pushTab(t)}}).delegate(".ic-remove","click",function(){var s=e(this),i=s.parent().data("type");t.confirm("确认移除？",function(){switch(i){case"section":a.removeSection(s);break;case"tab":a.removeTab(s)}})}).delegate(".is-name","click",function(){var t=e(this),a=t.parent(),s=t.parents(".is-tabs");s.find(".is-tab").removeClass("ist-active"),s.find(".is-content-box").addClass("hide"),a.addClass("ist-active"),a.find(".is-content-box").removeClass("hide")}),e(".ic-box").delegate(".ic-check","click",function(){var t=e(this);return t.data("group")?void a.checkGroup(t):void a.checkAdver(t)}),e("#btnSave").bind("click",function(){a.save()})}(jQuery,SINGER,indexConfig);