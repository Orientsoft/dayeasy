!function(e,t){var n,a,i,d,s="__dayeasy_joints",l="__dayeasy_subjects",c=function(){e("#searchForm").submit()},o=t.json(t.cookie.get(s))||[],r=t.json(t.cookie.get(l))||[],f=e("#createBtn");t.getLogger("exam-create");if(o.length>0){for(n=0;n<o.length;n++){var u=e('tr[data-joint="'+o[n]+'"');u.length>0&&u.addClass("selected").find('input[name="ckbJoint"]').attr("checked","checked")}e(".dy-actions em").html(o.length),o.length>1&&f.removeClass("disabled").removeAttr("disabled")}a=function(){o=[],r=[],t.cookie.set(s,t.json(o)),t.cookie.set(l,t.json(r)),f.addClass("disabled").attr("disabled","disabled"),e(".dy-actions em").html(o.length),e(".dy-table-wrap tr").removeClass("selected").find('input[name="ckbJoint"]').removeAttr("checked")},e("#keyword").agency({init:function(e){i=e},add:c,remove:function(){a(),c()}}),e(".dy-table-wrap tr").bind("click",function(a){var i,d,c=e(this),u=c.find(".d-subject");if(i=!c.hasClass("selected"))for(n=0;n<r.length;n++)if(r[n].id==u.data("sid"))return t.msg("已选择相同科目的协同！"),!1;if(c.toggleClass("selected"),d=c.data("joint"),c.find('input[name="ckbJoint"]').get(0).checked=i,i)o.push(d),r.push({id:u.data("sid"),name:u.data("sname")}),r.sort(function(e,t){return e.id>t.id?1:-1});else{for(n=0;n<o.length;n++)if(o[n]===d){o.splice(n,1);break}for(n=0;n<r.length;n++)r[n].id==u.data("sid")&&r.splice(n,1)}t.cookie.set(s,t.json(o)),t.cookie.set(l,t.json(r)),e(".dy-actions em").html(o.length),o.length<2?f.addClass("disabled").attr("disabled","disabled"):f.removeClass("disabled").removeAttr("disabled")}),e(".b-clear").bind("click",function(){a(),e(this).blur()}),d=function(n,i){e.post("/exam/create",n,function(e){e.status?t.alert("创建考试成功！",function(){a(),location.href="/exam"}):t.alert(e.message,function(){i&&i.call(this)})})},f.bind("click",function(){if(f.hasClass("disabled"))return!1;if(o.length<2)return t.alert("请选择至少两次协同阅卷！"),!1;if(!i||!i.id)return t.alert("请选择机构！"),!1;var a="";for(n=0;n<r.length;n++)a+=r[n].name+"、";a=a.substring(0,a.length-1);var s=template("createTpl",{subjectStr:a}),l=t.dialog({title:"创建大型考试",width:600,content:s,onshow:function(){var n=e(this.node),s=n.find(".d-name"),l=n.find(".btn-create"),c=n.find("input[name=examinationType]"),r=function(){var e=s.val(),t=c.filter(":checked").val();e&&e.length>=5&&"undefined"!=typeof t?l.unDisabled():l.disabled()};s.bind("change",function(){r()}),c.bind("click",function(){r()}),l.bind("click",function(){if(l.hasClass("disabled"))return!1;var e=s.val(),n=c.filter(":checked").val(),r={name:e,agencyId:i.id,agencyName:i.name,stage:i.stageCode,subjects:a,jointBatches:t.json(o),type:n};l.disabled("稍后.."),d(r,function(){l.unDisabled()})})}});l.showModal()})}(jQuery,SINGER);