!function(t,e){function i(t,e){this.$ele=t,this.init(),this.areas=e.initAreas,this.options=e,this.status=r.CREATE,this.dragging=!1,this.resizeDirection=null,this.dragAreaOffset={},this.draw()}t.extend({inArea:function(t,e){var i,r,s,a,n,o;r=function(t){return{x0:t.x,x1:t.x+t.width,y0:t.y,y1:t.y+t.height}},s=r(t);for(var h=0;h<e.length;h++)if(i=e[h],a=r(i),n=Math.min(s.x1,a.x1)-Math.max(s.x0,a.x0),o=Math.min(s.y1,a.y1)-Math.max(s.y0,a.y0),n>0&&o>0)return!0;return!1}});var r={CREATE:"create",MOVE:"move",RESIZE:"resize",NEAR:"near"},s={NE:{name:"NE",x:1,y:-1,cursor:"nesw-resize"},NW:{name:"NW",x:-1,y:-1,cursor:"nwse-resize"},SE:{name:"SE",x:1,y:1,cursor:"nwse-resize"},SW:{name:"SW",x:-1,y:1,cursor:"nesw-resize"}},a={CLICK:"click",DOUBLE_CLICK:"doubleClick"};i.prototype.get=function(){return this.areas},i.prototype.add=function(t){t&&(this.areas=this.areas.concat(t)),this.draw()},i.prototype.clear=function(){this.areas=[],this.draw()},i.prototype.set=function(e){this.options=t.extend({},this.options,e)},i.prototype.bindChangeEvent=function(t){this.$canvas.on("areasChange",t[0])},i.prototype.init=function(){var e=t("<canvas/>");e.attr("width",this.$ele.width()).attr("height",this.$ele.height()).offset(this.$ele.position()).css({position:"absolute",zIndex:200}).appendTo(this.$ele.parent()),this.$canvas=e,this.g2d=e[0].getContext("2d");var i=this,r={};e.mousemove(function(t){var e=c(t),r=u(t);i.dragging?i.onDragging(e,r):i.onMouseMoving(e,r)}).mousedown(function(t){r={x:c(t),y:u(t)},i.onDragStart(c(t),u(t))}).mouseup(function(t){c(t)==r.x&&u(t)==r.y&&i.onClick(c(t),u(t)),i.onDragStop()}).dblclick(function(t){i.onDoubleClick(c(t),u(t))})},i.prototype.onDragStart=function(t,e){if(this.options.drag)switch(this.dragging=!0,this.status){case r.RESIZE:!this.currentArea||o(this.currentArea,this.resizeDirection);break;case r.MOVE:this.dragAreaOffset={x:this.currentArea.x-t,y:this.currentArea.y-e};break;case r.CREATE:if(!this.options.create)return;var i={x:t,y:e,width:0,height:0};this.areas.push(i),this.currentArea=i,this.status=r.RESIZE}},i.prototype.onDragStop=function(){if(this.options.drag)switch(this.dragging=!1,this.status){case r.RESIZE:this.currentArea!=e&&(0==this.currentArea.width&&0==this.currentArea.height?(this.deleteArea(this.currentArea),this.currentArea=e,this.status=r.CREATE):(o(this.currentArea,s.SE),this.triggerChange()));break;case r.MOVE:this.triggerChange()}},i.prototype.onMouseMoving=function(t,i){var a=this.getArea(t,i,this.options.padding),o=this.$canvas;if(a!=e){this.currentArea=a;var c=!1,u=null,g=n(a);for(var l in g)if(h({x:t,y:i},g[l],this.options.padding)){c=!0,u=s[l];break}c?(o.css({cursor:u.cursor}),this.status=r.RESIZE,this.resizeDirection=u):this.getArea(t,i,-this.options.padding)!=e?(o.css({cursor:"move"}),this.status=r.MOVE):(o.css({cursor:"auto"}),this.status=r.NEAR)}else this.currentArea=e,o.css({cursor:"auto"}),this.status=r.CREATE;this.draw()},i.prototype.onDragging=function(t,e){if(this.options.drag){var i=this.currentArea;switch(this.status){case r.RESIZE:i.width=t-i.x,i.height=e-i.y;break;case r.MOVE:i.x=t+this.dragAreaOffset.x,i.y=e+this.dragAreaOffset.y;break;case r.CREATE:}this.draw()}},i.prototype.onDoubleClick=function(t,i){var r=this.getArea(t,i,this.options.padding);r!=e&&this.options.deleteMethod==a.DOUBLE_CLICK&&(this.deleteArea(r),this.draw())},i.prototype.onClick=function(t,i){var r=this.getArea(t,i,this.options.padding);r!=e&&this.options.deleteMethod==a.CLICK&&(this.deleteArea(r),this.draw())},i.prototype.draw=function(){var t,i,r=this.g2d;r.clearRect(0,0,this.$canvas[0].width,this.$canvas[0].height),r.strokeStyle=this.options.area.strokeStyle,r.lineWidth=this.options.area.lineWidth;for(i in this.areas){if(t=this.areas[i],t.num){this.g2d.fillStyle=this.options.point.fillStyle;var s=Math.max(7.5*t.num.length,13)+12;this.g2d.fillRect(t.x,t.y,s,25),this.g2d.fillStyle="#FFFFFF",this.g2d.font="normal 14px arial",this.g2d.fillText(t.num,t.x+6,t.y+19)}this.g2d.strokeRect(t.x,t.y,t.width,t.height)}if(t=this.currentArea,r.fillStyle=this.options.point.fillStyle,t!=e){var a=n(t);for(i in a){var o=a[i],h=this.options.point.size,c=this.options.point.type;switch(r.beginPath(),c){case"rect":var u=o.x-h,g=o.y-h,l=2*h,d=2*h,f=0;r.moveTo(u+f,g),r.arcTo(u+l,g,u+l,g+d,f),r.arcTo(u+l,g+d,u,g+d,f),r.arcTo(u,g+d,u,g,f),r.arcTo(u,g,u+l,g,f);break;default:r.arc(o.x,o.y,this.options.point.size,0,2*Math.PI,!0)}r.closePath(),r.fill()}}},i.prototype.deleteArea=function(t){var i=this.areas,s=i.indexOf(t);s>=0&&(i.splice(i.indexOf(t),1),this.currentArea=e,this.triggerChange(),this.status=r.CREATE)},i.prototype.getArea=function(t,i,r){r=r===e?0:r;for(var s in this.areas){var a=this.areas[s],n=Math.abs,o=a.x,h=a.x+a.width,c=a.y,u=a.y+a.height;if(r>=0&&n(o-t)+n(h-t)-n(a.width)<=2*r&&n(c-i)+n(u-i)-n(a.height)<=2*r)return a;if(0>r&&n(o-t)+n(h-t)-n(a.width)==0&&n(c-i)+n(u-i)-n(a.height)==0&&n(n(o-t)-n(h-t))<=n(a.width)+2*r&&n(n(c-i)-n(u-i))<=n(a.height)+2*r)return a}return e},i.prototype.triggerChange=function(){this.$canvas.trigger("areasChange",{areas:this.areas})};var n=function(t){var e={};for(var i in s)e[i]={x:t.x+t.width*(s[i].x+1)/2,y:t.y+t.height*(s[i].y+1)/2};return e},o=function(t,i){if(t!=e&&i!=e){var r=t.x,s=t.x+t.width,a=t.y,n=t.y+t.height,o=Math.abs(t.width),h=Math.abs(t.height),c={1:Math.min,"-1":Math.max};t.x=c[i.x](r,s),t.y=c[i.y](a,n),t.width=i.x*o,t.height=i.y*h}},h=function(t,e,i){return Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)<=Math.pow(i,2)},c=function(t){return t.offsetX?t.offsetX:t.originalEvent.layerX},u=function(t){return t.offsetY?t.offsetY:t.originalEvent.layerY};t.fn.areaSelect=function(r){var s,a={initAreas:[],deleteMethod:"click",padding:3,area:{strokeStyle:"red",lineWidth:2},point:{size:3,fillStyle:"black",type:"circle"},create:!0,canRepeat:!0,drag:!0};if(s=this.data("AreaSelect"),s!=e||r!==e&&!t.isPlainObject(r))if(s===e)console.error("pls invoke areaSelect() on this element first!");else{if(s[r]!=e)return s[r](Array.prototype.slice.call(arguments,1));console.error("no function "+r)}else{var n=t.extend({},a,r);s=new i(this,n),this.data("AreaSelect",s)}}}(jQuery);