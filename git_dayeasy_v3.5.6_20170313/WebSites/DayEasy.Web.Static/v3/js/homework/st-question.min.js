var SQ=function(){var t={def:DEYI.sites["static"]+"/image/default/user_s50x50.jpg",students:[],details:[],errors:[],data:0,student:function(a){if(t.students.length)for(var s=0;s<t.students.length;s++)if(t.students[s].id==a)return t.students[s];return 0}};return t}();template.helper("bindStudent",function(t,a){for(var s="",e=SQ.data.is_push,i=0;i<SQ.students.length;i++){var n=SQ.students[i];if(n.id==t){var r=n.avatar&&n.avatar.length?n.avatar:SQ.def,d=e?' style="cursor:default;" ':' onclick="location2Detail(this);" ';s='<li  class="pointer" data-studentid="'+n.id+'"'+d+'><img src="'+r+'" alt="" width="32" height="32" /><span>'+n.name+"</span></li>";break}}return s});var location2Detail=function(t){SQ.data.is_push||singer.open("/work/marking-detail?batch="+$("#txtBatch").val()+"&paperId="+$("#txtPaperId").val()+"&studentId="+$(t).data("studentid"))};$(function(t){var a=t("#txtBatch").val(),s=t("#txtPaperId").val(),e=t("#txtGroupId").val();if(a&&a.length&&s&&s.length&&e&&e.length){singer.loadFormula(),t.post("class-students",{group_id:e},function(s){if(s.status){if(!s.data||!s.data.length)return void(SQ.students=-1);SQ.students=s.data,t.get("/work/error-count",{batch:a},function(t){t.status&&t.data&&(SQ.errors=t.data,d())})}else singer.msg("加载圈内学生资料失败，请刷新重试")}),t.post("statistics-question-reasons",{batch:a},function(a){a&&a.length&&t(".reason-count").each(function(s,e){if(a.length)for(var i=t(e).parents(".q-item").data("id"),n=0;n<a.length;n++)if(i==a[n].key){t(e).text(a[n].value);break}})}),t("#divSections").delegate(".dy-btn-default","click",function(){var e=t(this);if(e.blur(),-1==SQ.students)return e.removeClass("dy-btn-info"),void singer.msg("学生资料加载失败，请刷新重试");if(!SQ.students||!SQ.students.length)return e.removeClass("dy-btn-info"),void singer.msg("正在加载学生资料，请稍后");var r=e.parents(".q-item"),d=r.find(".questions-bottom-cont"),l=r.data("id"),o="1"==r.data("objective"),u=o&&"1"==r.data("hassmall");if("1"!=e.data("loadHtml")){e.data("loadHtml",1);var c=[];SQ.errors&&SQ.errors.length&&SQ.errors.hasOwnProperty(l),c=SQ.errors[l],d.html(template("s-error-details",{is_push:SQ.data.is_push,is_objective:o,error_students:c}))}if("1"==e.data("isshow"))e.data("isshow",0).removeClass("dy-btn-info"),u?(r.find(".small-sort-list").stop().slideUp(),d.stop().slideUp()):d.stop().slideUp();else{if(e.data("isshow",1).addClass("dy-btn-info"),u){var p=r.find(".small-sort-list");if(p.stop().slideDown(),d.stop().slideDown(),"1"!=p.data("loadFirst")){var h=p.find(".small-sort").eq(0);i(h),p.data("loadFirst",1)}return}if(d.stop().slideDown(),o){for(var f=0;f<SQ.details.length;f++){var v=SQ.details[f];if(v.qid==l&&""==v.sid)return}t.post("statistics-question-detail",{batch:a,paper_id:s,question_id:l,small_question_id:""},function(t){t.status?(SQ.details.push({qid:l,sid:"",data:0}),n(t.data,r)):singer.msg(t.message)})}}}).delegate(".small-sort","click",function(){i(t(this))}).delegate(".link-variable","click",function(){var a=t(this).parents(".q-item").data("id");return singer.open("/variant?paper_id="+s+"&question_id="+a+"&app=work"),!1}).delegate(".link-detail","click",function(){var e=t(this).parents(".q-item").data("id");return singer.open("detail/"+a+"/"+s+"/"+e),!1});var i=function(e){if(!e.hasClass("active")){e.siblings(".small-sort").removeClass("active"),e.addClass("active");for(var i=e.parents(".q-item"),r=i.data("id"),d=e.data("id"),l=0,o=0;o<SQ.details.length;o++){var u=SQ.details[o];u.qid==r&&u.sid==d&&(l=u.data)}return 0!=l?void n(l,i):void t.post("statistics-question-detail",{batch:a,paper_id:s,question_id:r,small_question_id:d},function(t){t.status?(SQ.details.push({qid:r,sid:d,data:t.data}),n(t.data,i)):singer.msg(t.message)})}},n=function(t,a){t&&(a.find(".f-tal").text("答案："+t.system_answer),t.answers&&t.answers.length&&(t.answers[0].sliced=!0,t.answers[0].selected=!0,a.find(".statistics-lca").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,plotShadow:!1,width:200,height:200},title:null,tooltip:{pointFormat:"{series.name}: <b>{point.y}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!1},showInLegend:!1,events:{click:function(t){r(t.point.students,a,t.point.name)}}}},series:[{type:"pie",name:"选项统计",data:t.answers}]}),r(t.answers[0].students,a,t.answers[0].name)))},r=function(a,s,e){var i=s.find(".list-nonumber");i.html("");var n="<em>{0}</em>的同学";"未答"!=e&&(n="选"+n),t(".list-statistics-title").html(singer.format(n,e));for(var r=SQ.data.is_push?' style="cursor:default;" ':' onclick="location2Detail(this);" ',d=0;d<a.length;d++){var l=SQ.student(a[d]);if(l){var o=l.avatar&&l.avatar.length?l.avatar:SQ.def,u='<li  class="pointer" data-studentid="'+l.id+'"'+r+'><img src="'+o+'" alt="" width="32" height="32" /><span>'+l.name+"</span></li>";i.append(u)}}},d=function(){t(".error-count").each(function(a,s){for(var e in SQ.errors)if(SQ.errors.hasOwnProperty(e)){var i=t(s).parents(".q-item").data("id");e==i&&t(s).text(SQ.errors[e].length||0)}})}}});