!function(t,e){var a=!1,n=[],s=t("#txtBatch").val(),i=t("#boxAvgLoading"),r=t("#boxAvgData"),d=function(){var e=t("#txtJointBatch").val(),a=t("#txtPaperId").val();e&&e.length?t.post("statistics-avges-joint",{joint_batch:e,paper_id:a},function(t){return t.status?(n=t.data,void o(0)):void i.html('<div class="dy-nothing">'+t.message+"</div>")}):t.post("statistics-avges",{batch:s,paper_id:a},function(t){return t.status?(n=t.data,void o(0)):void i.html('<div class="dy-nothing">'+t.message+"</div>")})},o=function(a){if(n&&n.length||(i.html('<div class="dy-nothing">没有没有相关数据！</div>').show(),r.hide()),1!=t("#txtIsAb").val()&&(a=0),!n||!n.length)return!1;var s=t(".avg-wrap"),d={segments:[],groups:[],counts:[],isUnion:!1},o=(0==a?n[0].score_groupes:n[0].ab_score_groupes[a-1]).concat(),c=[];e.each(o.sort(function(){return 1}),function(t){d.segments.push(t.score_info)}),0==a&&d.segments.push("最低分","最高分","平均分"),e.each(n,function(t){d.groups.push({name:t.group_name,agency:t.agency_name}),e.inArray(t.agency_id,c)||c.push(t.agency_id);var n={},s=0==a?t.score_groupes:t.ab_score_groupes[a-1];e.each(s,function(t){n[t.score_info]=t.count}),0==a&&(n["最低分"]=t.min,n["最高分"]=t.max,n["平均分"]=t.avg),d.counts.push(n)}),d.isUnion=c.length>1,console.log(d);var l=template("segmentTpl",d);s.html(l),i.hide(),r.show(),t(".ove-x").mCustomScrollbar("update")};t("#aLoadAvge").bind("click",function(){a||(a=!0,d())}),t("#ddlShares").bind("change",function(){var a=t(this).val();t.post("statistics-share",{batch:s,group_id:a},function(t){return t.status?void e.msg("设置成功",1e3,function(){d()}):void singer.msg(t.message)})}),t("#ddlChangeTab").bind("change",function(){o(parseInt(t(this).val()))}),t("#ddlGroups").bind("change",function(){window.location.href="?joint_batch="+t("#txtJointBatch").val()+"&paper_id="+t("#txtPaperId").val()+"&group_id="+t(this).val()});var c=[],l=function(t){return t&&t.length&&/^[0-9]{0,3}\.??[0-9]{1,2}$/.test(t)?parseFloat(parseFloat(t).toFixed(2)):0};t(".txt-edit-score").bind("change",function(){var e=t(this),a=e.val(),n=/^[0-9]{0,3}\.??[0-9]{1,2}$/;if(!n.test(a)){var s=e.data("def");return void(n.test(s)?e.val(parseFloat(s||"0")):e.val(s))}var i=e.parents("tr").data("uid")||"",r=e.data("type"),d=0,o=v(i);if(a=l(a),1==t("#txtIsAb").val()){var c=e.parents("tr"),f=0;"a"==r?(d=l(t("#txtScoreA").val()),a>d&&(a=d,e.val(a)),o.sectionAScore=a,f=l(c.find(".txt-edit-score").eq(1).val())):(d=l(t("#txtScoreB").val()),a>d&&(a=d,e.val(a)),o.sectionBScore=a,f=l(c.find(".txt-edit-score").eq(0).val())),c.find(".td-total-score").text(a+f)}else d=l(t("#txtScoreT").val()),a>d&&(a=d,e.val(a)),o.totalScore=a});var v=function(e){for(var a=0;a<c.length;a++)if(c[a].studentId==e)return c[a];var n={};return t("#tabScore").find("tr").each(function(a,s){if(t(s).data("uid")==e){var i=t(s).data("id"),r=t(s).find(".txt-edit-score");if(1==t("#txtIsAb").val()){var d=l(r.eq(0).val()),o=l(r.eq(1).val());n={id:i,studentId:e,sectionAScore:d,sectionBScore:o}}else n={id:i,studentId:e,totalScore:l(r.eq(0).val())};c.push(n)}}),n},f=function(e){e?(t(".slide-table").addClass("current"),t(".txt-edit-score").removeAttr("disabled")):(t(".slide-table").removeClass("current"),t(".txt-edit-score").attr("disabled","disabled"))};t(".ck-edit").bind("click",function(){c=[],t(".txt-edit-score").each(function(){t(this).data("def",t(this).val())}),f(!0)}),t(".ck-cancel").bind("click",function(){t(".txt-edit-score").each(function(){var e=t(this);if(e.val(e.data("def")),1==t("#txtIsAb").val()){var a=e.parents("tr").find(".td-total-score");a.text(a.data("def")||"")}}),f(!1)}),t(".txt-edit-score").bind("focus",function(){var e=t(this);"-"==e.val()&&e.val("0"),t(this).addClass("focus")}).bind("blur",function(){t(this).removeClass("focus")}),t(".ck-complete").bind("click",function(){var a=t(this);a.attr("disabled","disabled"),c.length?t.post("statistics-edit-socre",{batch:s,paper_id:t("#txtPaperId").val(),data:singer.json(c)},function(t){return a.removeAttr("disabled"),t.status?void e.msg("操作成功",1e3,function(){window.location.reload(!0)}):void singer.msg(t.message)}):f(!1)}),t(".cbx-stu-info").removeAttr("checked"),t("#btnPraise").attr("disabled","disabled"),t("#btnSendScore").attr("disabled","disabled");var h=[];t(".cbx-stu-info").bind("change",function(){var e=t(this).data("id"),a=this.checked;if("0"==e)h=[],t(".cbx-stu-info").not(t(this)).each(function(e,n){n.checked=a,a&&h.push({id:t(n).data("id"),name:t(n).data("name")})}),a?t(".i-stu-info").addClass("dy-icon-checkboxhv"):t(".i-stu-info").removeClass("dy-icon-checkboxhv");else{if(a)h.push({id:e,name:t(this).data("name")});else for(var n=0;n<h.length;n++)if(h[n].id==e){h.splice(n,1);break}h.length<t(".cbx-stu-info").length-1?(t("#cbxAllPower").get(0).checked=!1,t("#iAllPower").removeClass("dy-icon-checkboxhv")):(t("#cbxAllPower").get(0).checked=!0,t("#iAllPower").addClass("dy-icon-checkboxhv"))}h.length>0?(t("#btnPraise").removeAttr("disabled"),t("#btnSendScore").removeAttr("disabled")):(t("#btnPraise").attr("disabled","disabled"),t("#btnSendScore").attr("disabled","disabled")),t(".selected-number").text(h.length)}),t("#btnPraise").bind("click",function(){if(!h.length)return void singer.msg("请勾选需要表扬的同学");var a="《"+t("#txtPaperTitle").val()+"》以下同学这次考试表现得不错，特别表扬！",n="";h.length>0&&(n+=h[0].name),h.length>1&&(n+="、"+h[1].name),h.length>2&&(n+="、"+h[2].name),h.length>3&&(n+="...... 等 "+h.length+"人");var i=t("<div>");i.append('<textarea style="width:450px;" id="txtPraisesValue" rows="4" maxlength="140">'+a+"</textarea>"),i.append('<div style="margin-bottom:8px;">'+n+"</div>"),e.dialog({title:"表扬",content:i,fixed:!0,backdropOpacity:.7,okValue:"确定",cancelValue:"取消",ok:function(){var e=t("#txtPraisesValue").val();if(!e||!e.length)return void singer.msg("说点鼓励话语吧~~");for(var a="",n=0;n<h.length;n++)0!=n&&(a+="、"),a+=h[n].name;e+="<br/>"+a,t.post("statistics-praise",{batch:s,message:t("<div/>").text(e).html()},function(t){singer.msg(t.status?"已发送表扬":t.message)})},cancel:function(){}}).showModal()}),t("#btnSendScore").bind("click",function(){if(!h.length)return void singer.msg("请勾选需要发送成绩通知短信的同学");for(var e=[],a=0;a<h.length;a++)e.push(h[a].id);singer.confirm("确认为已选中的学生及家长发送短信成绩通知？",function(){t.post("statistics-sendsms",{batch:s,paper_id:t("#txtPaperId").val(),student_ids:singer.json(e)},function(t){return t.status?void singer.msg("已发送通知短信",1e3,function(){window.location.reload()}):void singer.msg(t.message)})})}),t(".stats-list .dy-table tr").find("th:not(:first)").addClass("f-tac").end().find("td:not(:first)").addClass("f-tac");var u={widgets:["zebra","columns"],headers:{}};"1"==t("#txtIsAb").val()?u.headers={0:{sorter:!1},2:{sorter:!1},4:{sorter:!1},5:{sorter:!1},6:{sorter:!1},7:{sorter:!1}}:u.headers={0:{sorter:!1},2:{sorter:!1},4:{sorter:!1},5:{sorter:!1}};var b=t("#tabScore"),g=b.find("th");b.tablesorter(u);var p=function(t){if(t)return void b.addClass("tb-ten-none");var e="ascending"!=g.eq(3).attr("aria-sort");e?b.removeClass("tb-ten-none"):b.addClass("tb-ten-none")};g.eq(1).bind("click.tbt",function(){p(1)}),g.eq(3).bind("click.tbt",function(){p(0)}),t(".dy-table-body").bind("scroll",function(e){var a=t(this),n=a.scrollLeft(),s=a.siblings(".dy-table-head").find("table");s.css({"margin-left":-n}),a.find(".dy-table-left").css({left:n})});var m,x,y,w;x=t("#detailScores"),y=t(".q-scores"),m=function(){return y.data("loaded")?!1:(y.data("loaded",!0),void t.get("/work/teacher/question-scores",{batch:s},function(t){return t.status&&t.data?(w(t.data),y.find(".dy-loading").remove(),void y.find(".dy-table-wrap").removeClass("hide")):!1}))},w=function(a){var n,s,i,r=y.find(".dy-table-caption"),d=y.find(".dy-table-head .dy-table"),o=y.find(".dy-table-left .dy-table"),c=y.find(".dy-table-body > .dy-table"),l=a.questionTypes,v=a.questionSorts,f=Object.getOwnPropertyNames(l).length>1,h=Object.getOwnPropertyNames(v).length;for(s in l)if(l.hasOwnProperty(s)){n='<div class="caption-section">',n+=(f?1==s?"A卷":"B卷":"")+"题目：(";var u=l[s];for(var b in u)u.hasOwnProperty(b)&&(n+=e.format("<span>{0}：{1}</span>",u[b],b));n+=")</div>",r.append(n)}d.css({width:120+70*h}),c.css({width:70*h});var g=d.find("colgroup"),p=c.find("colgroup");for(i=0;h>i;i++)g.append('<col style="width:70px"/>'),p.append('<col style="width:70px"/>');var m=d.find("thead tr");for(s in v)v.hasOwnProperty(s)&&m.append("<th>"+v[s]+"</th>");var x=o.find("tbody"),w=c.find("tbody");for(i=0;i<a.students.length;i++){var k=a.students[i];x.append("<tr><td>"+k.name+"</td></tr>");var S=t("<tr>");for(s in v)if(v.hasOwnProperty(s)){var A="-";k.scores.hasOwnProperty(s)&&(A=k.scores[s]),S.append("<td>"+A+"</td>")}w.append(S)}},x.bind("click",function(){m()}),t(".dy-table-body").bind("scroll",function(e){var a=t(this),n=a.scrollLeft(),s=a.siblings(".dy-table-head").find("table");s.css({"margin-left":-n}),a.find(".dy-table-left").css({left:n})}),t(".dy-tab-nav li").bind("click",function(){var e=t(this);e.addClass("z-crt").siblings("li").removeClass("z-crt")})}(jQuery,SINGER);