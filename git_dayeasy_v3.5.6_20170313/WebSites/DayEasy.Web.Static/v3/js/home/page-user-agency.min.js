!function(i,n){for(var t,e,a,s,d,l=["小学","初中","高中"],c=i(".my-history-pop"),r=(new Date).getFullYear(),o=[],f=0;50>f;f++)o.push(r-f);e=function(t,e){return t?void i.ajax({type:"GET",data:{keyword:t},url:n.sites.main+"/agency-search",dataType:"jsonp",success:function(i){e&&e.call(this,i)}}):!1},d=function(t,e){i.post("/user/add-relation",t,function(t){return t.status?void n.msg("添加成功~!",2e3,function(){c.html('<div class="dy-loading"><i></i></div>'),i.get("/user/history",{},function(i){c.replaceWith(i)}),n.loadAgency&&n.loadAgency.call(this)}):(t.message&&n.alert(t.message),e&&e.call(this),!1)})},a=function(t,e){n.confirm("确认删除该历程？",function(){i.post("/user/remove-relation",{id:t},function(a){return a.status?(n.msg("删除成功！",2e3,function(){e&&e.call(this),i('.process-row[data-aid="'+t+'"]').remove(),n.loadAgency&&n.loadAgency.call(this)}),!0):void(a.message&&n.alert(a.message))})})},s=function(t,e){return t&&t.id?void i.post("/user/update-relation",t,function(i){return i&&i.status?(n.msg("更新成功！"),n.loadAgency&&n.loadAgency.call(this),void(e&&e.call(this,!0))):(i.message&&n.msg(i.message),e&&e.call(this,!1),!1)}):(n.msg("学校关系无效！"),e&&e.call(this),!1)},t=function(){c.find(".b-edit,.add-school,.btn-cancel").bind("click",function(){var n=i(this).parents(".con-list"),t=n.find(".time-class"),e=n.find(".edit-box");e.add(t).toggleClass("hide")}),c.find(".d-time").monthPicker({years:o,topOffset:20}),c.find(".b-delete").bind("click",function(){var n=i(this),t=n.parents(".con-list").data("aid");a(t,function(){n.parents(".con-list").remove()})}),c.find(".btn-submit").bind("click",function(){var t,e,a=i(this),d=a.parents(".con-list"),l=d.data("aid");return l?(t=d.find(".t-start").val(),e=d.find(".t-end").val(),a.disableField("稍候.."),void s({id:l,start:t,end:e},function(i){if(a.undisableFieldset(),i){var s=d.find(".time-class"),l=d.find(".edit-box");t=t.replace("-","."),e=e?e.replace("-","."):"至今",s.html(n.format("<span>{0}</span> - <span>{1}</span>",t,e)),s.add(l).toggleClass("hide")}})):!1}),u.find("input").bind("keypress",function(i){if(13==i.keyCode){var n=u.find("input").val();e(n,function(i){h(i)})}}),u.find("button").bind("click",function(){var i=u.find("input").val();e(i,function(i){h(i)})})};var u=c.find(".input-part"),g=u.parents(".edit-box"),h=function(t){if(!t||!t.length)return n.msg("没有查询到相关机构"),!1;var e=u.next();e.empty(),n.each(t,function(i){i.stageCn=l[i.stage-1],e.append(n.format('<li title="{name}" data-aid="{id}"><span class="stage-{stage}">{stageCn}</span><span class="name">{name}</span></li>',i))}),u.next().removeClass("hide").slideDown(),e.off("click","li").on("click","li",function(){var n=i(this),t=n.data("aid");e.addClass("hide"),e.parent().addClass("hide"),g.find(".agency").html(n.html()).data("aid",t).attr("title",n.attr("title")),g.find(".selected-wrap,.edit-date").removeClass("hide"),g.find(".btn-submit").undisableFieldset()}),g.find(".agency-wrap .dy-icon-index-edit").unbind("click").bind("click",function(){e.parent().removeClass("hide"),g.find(".selected-wrap,.edit-date").addClass("hide")}),g.find(".agency-status input").unbind("change").bind("change",function(){var i=g.find(".edit-date"),n=this.checked;i.find(".current").toggleClass("hide",!n),i.find(".history").toggleClass("hide",n)}),g.find(".btn-submit").unbind("click").bind("click",function(){var t,e,a=i(this),s=g.find(".agency").data("aid"),l=g.find(".agency-status input").get(0).checked;if(!s||g.find(".selected-wrap").hasClass("hide"))return n.msg("请选择学校~!"),!1;if(l){if(t=g.find(".current .t-start").val(),!t)return n.msg("请输入起始时间！"),!1}else{var c=g.find(".history");if(t=c.find(".t-start").val(),e=c.find(".t-end").val(),!t||!e)return n.msg("请输入起始时间和截至时间！"),!1}a.disableField("稍候..");var r={agencyId:s,status:l?0:1,start:t,end:e};d(r,function(){a.undisableFieldset()})})};t()}(jQuery,SINGER);