!function(e,t,a){var n,s,i,c,o,m;c=t.getLogger("dy-comment");var l='<li><img width="40" height="40" src="{0}" alt="" /><div class="box"><div class="box-lg-12 mb10 name-color">{1}<span class="comment-time">{2}</span></div><div class="box-lg-12 mb15 comment-message">{3}</div><div class="box-lg-12 d-comment-actions"><span class="b-comment-delete" title="删除" data-cid="{4}"><i class="iconfont dy-icon-delete"></i>删除</span><span class="b-comment-to" data-text="回复 {1}："><i class="iconfont dy-icon-edit2"></i> 回复</span></div></div></li>',d='<li class="d-comment-item"><img height="40" width="40" src="{0}" alt="" /><div class="box f-parents"><div class="box-lg-12 mb10 name-color">{1}<span class="comment-time">{2}</span><div class="d-comment-floor">{5}</div></div><div class="box-lg-12 mb15 comment-message">{3}</div><div class="box-lg-12 d-comment-actions"><span class="b-comment-delete" title="删除" data-cid="{4}"><i class="iconfont dy-icon-delete"></i>删除</span><span class="b-comment-to" data-text="回复 {1}："><i class="iconfont dy-icon-edit2"></i> 回复</span></div></div><div class="comment-children"><div class="comment-input f-cb hide"><img width="40" height="40" src="{0}" alt="" /><textarea placeholder="我有话要说" name="" class="textarea mb5" cols="30" rows="2" maxlength="140"></textarea><input data-comment-id="{4}" class="dy-btn dy-btn-info f-fr b-comment" type="button" value="回复" /></div><div class="comment-text"><ul class="comment-list"></ul></div></li>';m=['<span class="d-floor-first">沙发</span>','<span class="d-floor-second">板凳</span>','<span class="d-floor-third">地板</span>','<span class="d-floor-four">地下室</span>'],n=function(a,n,s,i){e.post("/message/comment",{sourceId:a,message:n,parentId:s},function(e){e.status?(i&&t.isFunction(i)&&i.call(this,e.data),o(1)):e.message&&e.message.length?t.alert(e.message,function(){i&&t.isFunction(i)&&i.call(this)}):i&&t.isFunction(i)&&i.call(this)})},s=function(a,n){var s;if(n){s=t.format(l,t.makeThumb(a.avatar,40,40),a.name,a.time,a.message,a.id);var i,c;i=e(n).parents(".comment-children"),c=i.find(".comment-list"),c&&0!=c.length||(c=e('<ul class="comment-list"></ul>'),i.find(".comment-text").append(c)),c.append(s)}else{var o;o=a.floor>m.length?a.floor+" 楼":m[a.floor-1],s=t.format(d,t.makeThumb(a.avatar,40,40),a.name,a.time,a.message,a.id,o),e(".ul-list-one").append(s)}},i=function(a){var n=a.data("cid"),s=a.parents(".comment-bxo").data("source-id");return n?void e.post("/message/delete-comment",{id:n,sourceId:s},function(e){e.status?t.alert("删除成功！",function(){a.parents(".box").parent().remove(),t.isFunction(t.updateComment)&&t.updateComment(0-e.data),o(0-e.data)}):t.alert(e.message)}):!1},o=function(t){var a=e(".d-comment-all small");if(0==a.length){var n=e('<div class="d-comment-all">全部回复<small>(0)</small></div>');e(".d-comment-box").prepend(n),a=n.find("small")}t=~~a.html().replace(/[^\d]/g,"")+t,a.html("("+t+")")};var r=function(e,t){var a=e.val().length,n=e.get(0);if(n.setSelectionRange)n.setSelectionRange(t,t);else{var s=n.createTextRange();s.moveStart("character",-a),s.moveEnd("character",-a),s.moveStart("character",t),s.moveEnd("character",0),s.select()}};e(document).delegate(".b-comment","click",function(){var i=e(this),c=i.parents(".comment-input").find("textarea"),o=i.parents(".comment-bxo").data("source-id"),m=t.trim(c.val()),l=i.data("comment-id");return m&&m.length?(i.attr("disabled","disabled"),void n(o,m,l,function(n){if(n){c.val("").keyup(),l&&i.parents(".comment-input").addClass("hide");var o=e(".comment-bxo");n.avatar=o.data("avatar"),n.name=o.data("name"),s(n,l?i:a),t.isFunction(t.updateComment)&&t.updateComment(),t.msg("评论成功~！")}i.removeAttr("disabled")})):(t.alert("请输入评论内容"),!1)}).delegate(".comment-input textarea","keydown",function(t){t.ctrlKey&&13==t.keyCode&&e(this).parents(".comment-input").find(".b-comment").click()}).delegate(".b-comment-to","click",function(){var t=e(this).parents(".d-comment-item").find(".comment-input");if(t.hasClass("hide")){t.removeClass("hide");var a=t.find("textarea");a.val(e(this).data("text")),a.focus(),r(a,a.val().length)}else t.addClass("hide")}).delegate(".b-comment-delete","click",function(){var a=e(this);t.confirm("确认要删除该回复？",function(){i(a)})})}(jQuery,SINGER);