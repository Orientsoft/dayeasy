!function(e,t){e.fn.extend({fileSelector:function(i){i=e.extend({},{accept:"image/*",start:void 0,finished:void 0},i||{});var n=e(t.format('<input type="file" id="importFile" accept="{0}" />',i.accept||"image/*"));n.css("display","none"),e("body").append(n),e(this).bind("click",function(){n.click()}),n.bind("change",function(e){var t,n=e.target.files;if(n&&n.length>0){t=n[0];try{i.start&&i.start.call(this);var c=new FileReader;c.onload=function(e){var n=e.target.result;i.finished&&i.finished.call(this,t.name,n)},c.readAsDataURL(t)}catch(a){}}})}});var i,n,c=[],a=e(".d-list"),o=function(i,a,o){console.log(n);var l=t.array.find(c,function(e){return e.id==i}),s=function(){var i=[];t.each(e.extend(!0,{},n),function(n,c){var a={grade:c,classList:[],checked:!0};t.each(n,function(t){!l.classList||e.inArray(t.id,l.classList)>=0?t.checked=!0:a.checked=!1,a.classList.push(t)});var o=a.classList.length%5;if(o>0)for(var s=0;5-o>s;s++)a.classList.push({id:-1,name:""});i.push(a)});var c=template("classRangeTpl",i),s=dialog({title:a+" - 选课范围",content:c,quickClose:!0,fixed:!0,backdropOpacity:.3,okValue:"确认",cancelValue:"取消",ok:function(){var i=e(this.node),n=i.find("dd.check-item"),c=i.find("dd.active");return 0==c.length?(t.msg("请至少选择一个班级！"),!1):void(n.length!=c.length?(l.classList=[],c.each(function(t,i){l.classList.push(e(i).data("cid"))}),o&&o.call(this,!1)):(delete l.classList,o&&o.call(this,!0)))},cancel:function(){},onshow:function(){var t=e(this.node);t.find(".group-checkbox input").bind("click",function(t){t.stopPropagation();var i=e(this),n=i.is(":checked"),c=i.parents("dl"),a=c.find("dd.check-item");i.siblings("i").toggleClass("dy-icon-checkboxhv",n),a.toggleClass("active",n)}),t.find("dd.check-item").bind("click",function(t){t.stopPropagation();var i,n,c=e(this);return c.hasClass("disabled")?!1:(c.toggleClass("active"),i=c.parents("dl"),n=i.find(".group-checkbox"),void(i.find("dd.check-item").length==i.find("dd.active").length?(n.find("i").addClass("dy-icon-checkboxhv"),n.find("input")[0].checked=!0):(n.find("i").removeClass("dy-icon-checkboxhv"),n.find("input")[0].checked=!1)))})}});s.showModal()};n?s():e.get("/elective/classList",{},function(e){n=e,s()})};e(".d-import").fileSelector({accept:".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel",start:function(){i=t.dialog({content:"正在上传..."}),i.showModal()},finished:function(t,n){e.post("/elective/import",{name:t,fileData:n},function(t){c=t;var n=template("courseListTpl",t);a.html(n);var o=e(".d-import-wrap");o.length&&(e(".d-course-list").removeClass("hide").slideDown("fast"),o.remove()),e(window).bind("beforeunload.elective",function(){return"离开当前页面，数据将不会被保存，是否继续？"}),i.close().remove()})}}),a.on("click",".btn-class-range",function(){var t=e(this),i=t.parents("tr"),n=i.data("cid"),c=i.find("td:eq(0)").html();return o(n,c,function(e){t.html(e?"全部班级":"部分班级"),t.toggleClass("text-danger",!e)}),!1}),a.on("click",".btn-delete",function(){var i=e(this).parents("tr"),n=i.data("cid");t.confirm("确认要删除该课程？",function(){i.remove(),t.msg("删除成功"),c=t.array.filter(c,function(e){return e.id!=n}),e(".total-num").html(c.length)})}),e(".btn-cancel").bind("click",function(){e(window).unbind("beforeunload.elective"),location.href="/elective"}),e(".btn-submit").bind("click",function(){return!c||0>=c?(t.alert("请选导入课程！"),!1):void t.dialog({title:"创建选课",content:'<div class="elective-title"><div class="form-label">为本次选课任务取个名字</div><input type="text" class="form-control" placeholder="请输入选课标题" /></div>',okValue:"确认",cancelValue:"取消",ok:function(){var i=e(this.node),n=i.find(".elective-title input").val();if(!n)return t.msg("请输入选课标题"),!1;var a={title:n,courses:c};return e.post("/elective/create",{data:encodeURIComponent(t.json(a))},function(i){return i&&i.status?(t.msg("创建成功！",2e3,function(){e(window).unbind("beforeunload.elective"),location.href="/elective"}),!1):void t.alert(i.message)}),!1},cancel:function(){}}).showModal()})}(jQuery,SINGER);