!function(e,a){var t={config:{comprtype:!0,icons:["dy-icon-chinese","dy-icon-math","dy-icon-english","dy-icon-physics","dy-icon-chemistry","dy-icon-politics","dy-icon-history","dy-icon-geography","dy-icon-biology","dy-icon-computer","dy-icon-sports"],keyParams:{keyType:1,keyScore:75,scoreA:60,unScoreA:60},keyParamsOperation:null,layerParams:{layerA:10,layerB:30,layerC:30,layerD:20,layerE:10},subjectParams:{subjectId:"",keyType:1,keyScore:75,scoreA:60,unScoreA:60}},data:{subjects:[],ranks:{},main2averageScore:[],classKeys:{},ClassLayers:{}},ui:{subjects:null},event:{init:null,pageLoad:null,resultRanking:null,classKeys:null,classLayers:null,subjectData:null,scoreRate:null}},s=a.examApi,n={body:e("body"),$main:e(".html-main"),$side:e(".html-side")};a._mix(a,{NoName:function(a,t){var s=e(window).width(),n=e(window).height(),r=e(window).scrollTop(),i=e(window).scrollLeft(),l=a.outerWidth(!0),o=a.outerHeight(!0),c=s/2-l/2+i,d=n/2-o/2+r,u='<div class="mask"></div>',m=e(document).width(),v=e(document).height();return a.show().animate({left:c+"px",top:d+"px"},0),e("body").append(u),e(".mask").width(m).height(v),a.find(".h2-title strong").text(t),e(window).resize(function(){a.is(":visible")&&(s=e(window).width(),n=e(window).height(),c=s/2-l/2+i,d=n/2-o/2+r,a.animate({left:c+"px",top:d+"px"},0))}),e(window).scroll(function(){a.is(":visible")&&(r=e(window).scrollTop(),i=e(window).scrollLeft(),c=s/2-l/2+i,d=n/2-o/2+r,a.animate({left:c+"px",top:d+"px"},500).dequeue())}),e("body").on("click",".mask,.close",function(t){t.preventDefault(),a.hide(),e(".mask").remove()}),!1},keynumber:function(a,t){n.body.on("keyup",a,function(a){a.preventDefault(),t.attr("disabled",!1);var s=e(this).val();e(this).val(s.replace(/\D|^0/g,""))})},layerRanks:function(){for(var e=[],t=1,s=0;s<arguments.length;s++){var n=arguments[s];n>0?(e.push(a.format("{0}-{1}名",t,t+n-1)),t+=n):e.push("-")}return e},careClass:function(){if(""==arguments.length)return!1;var e=arguments[0],a=arguments[1],t=arguments[2],s=[];e.sort(function(e,a){return e.value-a.value});for(var n=0;n<e.length;n++)e[n].value<a&&s.push(e[n].name);return s.splice(t),s},resultRankingUi:function(e,a){for(var t=new Array,s=0;s<e.ranks.students.length;s++)for(var n=e.ranks.students[s],r=n.name,i=n.scoreDetails,l=0;l<e.subjects.length;l++){var o=e.subjects[l].id,c=e.subjects[l].subject;t.push({name:r,subject:c,volumeA:i[o].scoreA,volumeB:i[o].scoreB,total:i[o].score,ranking:i[o].rank})}var d=function(e,a){for(var t=[],s=0;s<Math.ceil(e.length/a);s++){var n=s*a,r=n+a;t.push(e.slice(n,r))}return t},u=d(t,e.subjects.length),m=u[a];return m},highcharts:function(a,t){var s=t-a;e("#container").highcharts({chart:{plotBackgroundColor:null,plotBorderWidth:null,backgroundColor:"transparent",plotShadow:!1},title:null,tooltip:{pointFormat:"<b>{point.y}</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",borderColor:"transparent",colors:["#3bafda","#72cff2"],dataLabels:{enabled:!1}}},series:[{type:"pie",name:"",data:[["参考人数",a],["缺考人数",s]]}]})}}),t.event.resultRanking=function(){var r,i=t.data,l=i.ranks.students,o=t.data.subjectId,c=[],d=0;if(e(".html-title-name").html(a.format('<span title="{0}">{0}</span>',i.ranks.name)),o){var u=l.concat().sort(function(e,a){var t=e.scoreDetails[o].rank,s=a.scoreDetails[o].rank;return t=0>t?999:t,s=0>s?999:s,t>s?1:-1}),m=s.subject(o);i={students:u,subjectId:o,isAb:2==t.data.paperType,isZhe:4==m.id||5==m.id}}r=template("menu-main-1",i),n.$main.html(r);var v=e(".dy-table-body"),h=v.find("tr:eq(1)").width()+1,f=v.find("tr").length;f>8&&v.siblings(".dy-table-head").addClass("crt").css("width",h),v.on("scroll",function(a){a.preventDefault();var t=e(this),s=t.scrollLeft(),n=t.siblings(".dy-table-head").find("table");n.css({"margin-left":-s})}),e(".js-students-pop").each(function(t){var s=e(this),n=e.trim(s.text());s.click(function(){var s=a.resultRankingUi(i,t),r=template("SubjectsAllTemp",s);e("#SubjectsAll").html(r),a.NoName(e(".pop-result-ranking"),n)})});for(var g=0;g<l.length;g++){var y=l[g],p=y.className;if(t.data.subjectId){var b=y.scoreDetails[t.data.subjectId];b.score>=0&&d++}else y.score>=0&&d++;c.indexOf(p)<0&&c.push(p)}var C=function(e){var a=/([0-9]+)班/gi.exec(e);return a?~~a[1]:99};c.sort(function(e,a){return C(e)>C(a)?1:-1}),r=template("side-1",{classList:c,scoreCount:d,count:l.length}),n.$side.html(r),a.highcharts(d,l.length)},t.event.subjectData=function(){var r=template("menu-main-2",{subjectId:t.data.subjectId,isAb:2==t.data.paperType});n.$main.html(r);var i=function(e,s,r,i){for(var l=[],o=[],c=a.careClass(r,i,3),d=0;d<e.length-1;d++)l.push(e[d][s]),e[d].keyScaleDiff<0&&o.push(e[d][s]);t.data.main2averageScore=l;var u=Math.max.apply(null,l),m=Math.min.apply(null,l),v={title0:"班平最高最低相差",Differ:(u-m).toFixed(2),title1:"需要关注的班级：",list:c},h=template("side-2",v);n.$side.html(h)},l=function(n,r){for(var l=["averageScore","averageScoreA","averageScoreB"],o=l[r],c=[],d=0;d<n.length-1;d++)c.push({name:n[d].className,value:n[d][o]});var u=n[n.length-1][o],m=0;if(t.data.subjectId){var v=s.subject(t.data.subjectId);switch(r){case 0:m=v.score;break;case 1:m=v.scoreA;break;case 2:m=v.scoreB}}else a.each(t.data.subjects,function(e){m+=e.score});e(".container02").empty().chart({type:"score",data:c,showAverage:!0,max:m,direct:"v",average:u,width:956,height:300,xTitle:"班级",yTitle:"分数",xFormat:function(e){return a.formatClassName(e.name)}}),i(n,o,c,u)};if(t.data.subjectId){var o=t.config.subjectParams;o.subjectId=t.data.subjectId,s.getSubjectData(o,function(a){var s=t.data.classKeys=a;l(s,0),n.body.off("click",".tab-average-menu2 li").on("click",".tab-average-menu2 li",function(a){a.preventDefault();var t=e(this);return t.hasClass("on")?!1:(t.addClass("on").siblings().removeClass("on"),void l(s,e(this).index()))})})}else{var o=t.config.keyParams;s.getClassKeys(o,function(e){var a=t.data.classKeys=e;l(a,0)})}},t.event.classKeys=function(){var r=t.config.keyParams;console.log(r);var i=template("menu-main-3",r);n.$main.html(i);var l=function(r){var i=[];for(i[i.length]in r);var l=function(t,s){for(var n=[],r=0;r<t.length-1;r++)n.push({name:t[r].className,value:(100*t[r][s]).toFixed(2)});var i=(100*t[t.length-1][s]).toFixed(2);e(".container03").empty().chart({type:"percent",data:n,showAverage:!0,max:100,direct:"v",average:i,width:956,height:300,xTitle:"班级",yTitle:"百分比",xFormat:function(e){return a.formatClassName(e.name)}}),o(t,n,i)},o=function(e,t,s){var r=a.careClass(t,s,3),i={title:"需要关注的班级：",list:r},l=template("side-3",i);n.$side.html(l)};if(t.data.subjectId){var c=t.config.subjectParams;c.subjectId=t.data.subjectId,opts=e.extend(c,r||{}),n.body.off("click",".tab-average-menu3 li"),s.getSubjectData(opts,function(a){var s=t.data.classKeys=a,r=["keyScale","aScale","unaScale"];l(s,r[0]),n.body.on("click",".tab-average-menu3 li",function(a){a.preventDefault();var t=e(this);return t.hasClass("on")?!1:(t.addClass("on").siblings().removeClass("on"),void l(s,r[e(this).index()]))})})}else s.getClassKeys(r,function(a){var s=t.data.classKeys=a,r=["keyScale","aScale","unaScale"];n.body.off("click",".tab-average-menu3 li"),l(s,r[0]),n.body.on("click",".tab-average-menu3 li",function(a){a.preventDefault();var t=e(this);return t.hasClass("on")?!1:(t.addClass("on").siblings().removeClass("on"),void l(s,r[t.index()]))})})};l(r),e("#classkey-select").change(function(){var a=e(this);e("#KeyCalculation").attr("disabled",!1),1==a.val()&&a.parents("dd").addClass("on"),0==a.val()&&a.parents("dd").removeClass("on")}),e("#KeyCalculation").click(function(){e(this).attr("disabled",!0);var s=t.config.keyParamsOperation={keyType:parseInt(e("#classkey-select").val()),keyScore:parseInt(e("#FractionAll").val()),scoreA:parseInt(e("#FractionA").val()),unScoreA:parseInt(e("#FractionAb").val())},n=t.config.keyParams=e.extend({},t.config.keyParams,s);return 1==n.keyType&&n.keyScore>100?(a.alert("重点比例不能超过100%！"),!1):(l(n),void e(".tab-average-menu3 li:first").addClass("on").siblings().removeClass("on"))}),a.keynumber("input[name='keynumber']",e("#KeyCalculation"))},t.event.classLayers=function(){var r=t.config.layerParams,i=template("menu-main-4",r);n.$main.html(i);var l=function(r){var i=a.keys(r);s.getClassLayers(r,function(s){t.data.classLayers=s;var r,l=0;a.each(s,function(e){e.classId&&a.each(i,function(a){e[a]>l&&(l=e[a])})}),l=e.nearMax(l),r=function(e){var t=[];return a.each(s,function(a){a.classId&&t.push({name:a.className,value:a[e]})}),t};var o=function(t){var s=r(t);e(".container04").empty().chart({type:"score",data:s,showAverage:!1,max:l,direct:"v",width:956,height:300,xTitle:"班级",yTitle:"人数",xFormat:function(e){return a.formatClassName(e.name)}})};o(i[0]),n.body.off("click",".tab-average-menu4 li").on("click",".tab-average-menu4 li",function(a){a.preventDefault();var t=e(this);return t.hasClass("on")?!1:(t.addClass("on").siblings().removeClass("on"),void o(i[t.index()]))});var c=s[s.length-1],d=template("side-4",c);n.$side.html(d);for(var u=a.layerRanks(c.layerA,c.layerB,c.layerC,c.layerD,c.layerE),m=e(".arrangement-menu .dd-people"),v=0;v<m.length;v++)m.eq(v).find("em").html(u[v])})};l(r),n.body.on("click","#LayersCalculation",function(a){a.preventDefault();var s=t.config.layerParams=e.extend({},r,{layerA:parseInt(e("#LayersA").val()),layerB:parseInt(e("#LayersB").val()),layerC:parseInt(e("#LayersC").val()),layerD:parseInt(e("#LayersD").val()),layerE:parseInt(e("#LayersE").val())});l(s),e(".tab-average-menu4 li:first").addClass("on").siblings().removeClass("on")}),a.keynumber("input[name='keyNumberLayers']",e("#LayersCalculation"))},t.event.segment=function(){t.config.subjectParams.subjectId=t.data.subjectId,s.getSubjectData(t.config.subjectParams,function(e){var r,i={segments:[],classList:[]},l={};a.each(e,function(e){var t,s,n={name:e.className,counts:{}},r=0;return e.classId&&(l[e.classId]=e.averageScore),e.segment?(s=a.keys(e.segment).length,a.each(e.segment,function(l,o){s>6&&r>=.4*s&&(t||(t=~~/-([0-9]+)$/gi.exec(o)[1]+1),o=t+"以下"),e.classId||a.inArray(o,i.segments)||i.segments.push(o),n.counts.hasOwnProperty(o)||(n.counts[o]=0),n.counts[o]+=l,r++}),void i.classList.push(n)):void i.classList.push(n)}),r=template("menu-main-5",i),n.$main.html(r);var o=s.classDiffDegree(t.data.subjectId,l,5);r=template("side-5",o),n.$side.html(r)})},t.event.scoreRate=function(t){if(!t||!a.isString(t)||32!=t.length)return!1;var s,n,r;r=function(t){var s,r=[],i=t.data("qid"),l=t.data("rate");t.addClass("on").siblings().removeClass("on"),n.classScoreRates.hasOwnProperty(i)&&(s=n.classScoreRates[i]);for(var o in n.classList)n.classList.hasOwnProperty(o)&&r.push({name:n.classList[o],value:s?s[o]||0:0});e(".score-rate").empty().chart({type:"percent",data:r,average:l,max:100,showAverage:!0,width:956,height:300,yTitle:"得分率",xTitle:"班级",xFormat:function(e){return a.formatClassName(e.name)}})},s=function(){var a=e(".html-main"),t={sorts:[]};for(var s in n.questionSorts)if(n.questionSorts.hasOwnProperty(s)){var i=n.scoreRates[s];t.sorts.push({id:s,sort:n.questionSorts[s],rate:i})}var l=template("scoreRateTemp",t);a.html(l);var o=a.find("li");r(o.eq(0)),a.find("li").bind("click",function(){var a=e(this);return a.hasClass("on")?!1:void r(a)})},examApi.getScoreRates(t,function(e){n=e,s()})},t.event.init=function(){a.pageLoading(),s.setExamId(e(".dy-main").data("examid"));var n=0,r=function(){n++,n>=2&&t.event.pageLoad()};s.getSubjects(function(e){t.data.subjects=e,r()}),s.getRanks(function(e){t.data.ranks=e,r()})}(),t.event.pageLoad=function(){var s=template("SubjectList",t.data.subjects);e(".html-subject").html(s),t.data.subjects.length<=4&&e(".html-subject").css("margin-top","22px"),t.event.resultRanking(),a.pageLoaded()},n.body.on("change","#ChoiceClass",function(){var t=e("#ChoiceShow"),s=e("#ChoiceClass"),n=e("#totalNumber"),r=".choice-contents",i="on",l="on-tr",o=s.find("option:selected").text(),c=s.val();0==c?t.removeClass(i):t.addClass(i),t.find(r).removeClass(l).end().find(".class-name").each(function(){o==e(this).text()&&e(this).parents(r).addClass(l)});var d=e(".dy-table-body"),u=e(".dy-table-head"),m=d.find(".on-tr").length,v=d.find("tr:eq(1)").width()+1;t.hasClass("on")&&(v=d.find("tr.on-tr:eq(1)").width()+1),u.addClass("on").removeClass("crt"),d.find(".choice-contents:eq(0)").hasClass("on-tr")&&u.removeClass("on"),0==c&&(m=d.find(".choice-contents").length,u.removeClass("on")),u[0].style="",m>8&&d.siblings(".dy-table-head").addClass("crt").css("width",v);var h=t.find(".on-tr").length,f=t.find(".choice-contents").length,g=t.find(".on-tr").find(".miss-exam").length,y=t.find(".choice-contents").find(".miss-exam").length,p=f-y,b=f,C=h-g,k=h;return 0==c?(n.find("b").html(p),n.find("em").html(b),a.highcharts(p,b),!1):(n.find("b").html(C),n.find("em").html(k),void a.highcharts(C,k))}).on("click mouseover mouseout",".js-nav-main li",function(s){function r(e){return e.removeClass("hide").siblings().removeClass("currentstyle").addClass("hide"),e.siblings()}var i=e(this),l=s.type,o=i.parents(".nav-main"),c=~~i.index()+1,d=e(".menu-main-"+c),u=e(".side-"+c);if("click"==l){var m=i.data("subject")||"";if(m==t.data.subjectId&&i.hasClass("current"))return!1;switch(i.data("subject",t.data.subjectId),n.$main.html('<div class="dy-loading"><i></i></div>'),c){case 1:t.event.resultRanking();break;case 2:t.event.subjectData();break;case 3:t.event.classKeys();break;case 4:t.event.classLayers();break;case 5:t.event.segment();break;case 6:a.scoreRate(t.data.subjectId)}i.addClass("current on").siblings().removeClass("current on"),r(d).removeClass("current on"),r(u)}"mouseover"==l&&i.addClass("on").siblings().removeClass("on"),"mouseout"==l&&(i.removeClass("on"),o.find(".current").addClass("on"))}).on("click",".js-add",function(a){a.preventDefault(),t.data.subjectId="",t.data.paperType=1,e(this).addClass("on"),e(".js-subject li").removeClass("on"),e("#menu-nav-1").trigger("click"),e("#menu-nav-4").removeClass("hide"),e("#menu-nav-5 ,#menu-nav-6").addClass("hide")}).on("click",".js-subject li",function(a){a.preventDefault();var s=e(this);if(e(".js-add").removeClass("on"),s.addClass("on").siblings().removeClass("on"),e("#menu-nav-4").addClass("hide"),e("#menu-nav-5 ,#menu-nav-6").removeClass("hide"),t.data.subjectName=jQuery.trim(s.find("a").text()),t.data.subjectId=s.data("subjectid"),t.data.paperType=s.data("type"),t.data.subjectId){for(var n=e(".js-nav-main").find("li"),r=0;r<n.length;r++)if(e(n[r]).hasClass("on")){var i=r+1;console.log(i),e("#menu-nav-1").trigger("click")}}else e("#menu-nav-1").trigger("click")}),e("#excel-export").click(function(){var a=t.data.subjectId,n=t.config.keyParams,r=t.config.layerParams,i=t.config.subjectParams,l=t.data.subjectName,o=2;if(!a){var c=e(".js-nav-main li").eq(0).hasClass("on");return o=1,c&&(o=0),s.download({type:o,classKeysParams:n,classLayersParams:r}),!1}i.subjectId=a,s.download({type:o,subjectParams:i,subjectName:l})})}(jQuery,SINGER);