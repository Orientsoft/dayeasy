!function(e,a){var s,t={subjects:"/ea/subjects/{0}",ranks:"/ea/ranks/{0}",classKeys:"/ea/class-analysis-keys",classLayers:"/ea/class-analysis-layers",subjectKeyAndLayer:"/ea/subject-analysis",subjectScoreRate:"/ea/subject-score-rates"},r={subjects:null,ranks:null,score:0,scoreRates:{}},n={setExamId:function(e){s=e},getSubjects:function(n){e.get(a.format(t.subjects,s),{},function(e){r.subjects={};for(var a=0;a<e.length;a++){var s=e[a];r.score+=s.score,r.subjects[s.id]={id:s.subjectId,name:s.subject,paperType:s.paperType,score:s.score,scoreA:s.scoreA,scoreB:s.scoreB,average:s.averageScore,averageA:s.averageScoreA,averageB:s.averageScoreB}}n&&n.call(this,e)})},subject:function(e){return r.subjects?r.subjects[e]:null},getRanks:function(n){if(r.ranks)return n&&n.call(this,r.ranks),!1;var c=a.format(t.ranks,s);e.get(c,{},function(e){return e.status?(r.ranks=e.data,void(n&&n.call(this,e.data))):(a.msg(e.message),!1)})},getClassKeys:function(a,r){a.examId=s,e.get(t.classKeys,a,function(e){r&&r.call(this,e)})},getClassLayers:function(r,n){return r.layerA+r.layerB+r.layerC+r.layerD+r.layerE!=100?(a.msg("各层分配比例之和需为100%"),!1):(r.examId=s,void e.get(t.classLayers,r,function(e){n&&n.call(this,e)}))},getSubjectData:function(a,r){e.get(t.subjectKeyAndLayer,{examId:s,examSubjectId:a.subjectId,keyType:a.keyType,keyScore:a.keyScore,scoreA:a.scoreA,unScoreA:a.unScoreA},function(e){r&&r.call(this,e)})},getScoreRates:function(s,n){return r&&r.scoreRates.hasOwnProperty(s)?(n&&n.call(this,r.scoreRates[s]),!1):void e.get(t.subjectScoreRate,{id:s},function(e){return e.status?(r.scoreRates[s]=e.data,void(n&&n.call(this,e.data))):(a.msg(e.message),!1)})},download:function(t){var n=e("#exportForm");if(n&&n.length)n.empty();else{var c=e("body");n=e('<form method="post" target="_blank" class="hide">'),c.append(n)}var o=r.ranks.name;switch(t.type){case 0:n.attr("action","/ea/ranking-download"),n.append('<input name="examId" value="'+s+'" />');break;case 1:t.classKeysParams.examId=s,t.classLayersParams.examId=s,n.attr("action","/ea/class-analysis-download"),n.append('<input name="keys" value="'+a.json(t.classKeysParams)+'" />'),n.append('<input name="layer" value="'+a.json(t.classLayersParams)+'" />'),n.append('<input name="name" value="'+o+'" />');break;case 2:t.subjectParams.examId=s,t.subjectParams.examSubjectId=t.subjectParams.subjectId,delete t.subjectParams.subjectId,n.attr("action","/ea/subject-analysis-download"),n.append('<input name="keys" value="'+a.json(t.subjectParams)+'" />'),n.append('<input name="name" value="'+o+"-"+t.subjectName+'" />')}n.submit()},classDiffDegree:function(e,s,t){var n=[];if(!r.ranks)return n;var c,o=r.ranks.students,u={};return a.each(o,function(a){var t=a.scoreDetails[e];t.score<0||s.hasOwnProperty(a.classId)&&(c=s[a.classId],u.hasOwnProperty(a.classId)||(u[a.classId]={name:a.className,count:0,degree:0}),u[a.classId].degree+=Math.abs(t.scoreA+t.scoreB-c),u[a.classId].count++)}),a.each(u,function(e){e.degree<=0||n.push({name:e.name,degree:1*(e.degree/e.count).toFixed(2)})}),n=n.sort(function(e,a){return e.degree<a.degree?1:-1}),t&&n.splice(t),n}};a.mix(a,{examApi:n,formatClassName:function(e){var a=/([0-9]+班)/gi.exec(e);return a?a[1]:e},scoreRate:function(s){if(!s||!a.isString(s)||32!=s.length)return!1;var t,r,c,o;c=function(s){var t,n=[],c=s.data("qid"),o=s.data("rate");s.addClass("on").siblings().removeClass("on"),r.classScoreRates.hasOwnProperty(c)&&(t=r.classScoreRates[c]),a.each(r.classList,function(e,a){n.push({name:e,value:t?t[a]||0:0})}),e(".score-rate").empty().chart({type:"percent",data:n,average:o,max:100,showAverage:!0,width:956,height:300,yTitle:"得分率",xTitle:"班级",xFormat:function(e){return a.formatClassName(e.name)}})},t=function(){var s=e(".html-main"),t={sorts:[]};a.each(r.questionSorts,function(e,a){var s=r.scoreRates[a];t.sorts.push({id:a,sort:e,rate:s})});var n=template("scoreRateTemp",t);s.html(n);var u=o(5),i=template("side-6",u);e(".html-side").html(i);var l=s.find("li");c(l.eq(0)),s.find("li").bind("click",function(){var a=e(this);return a.hasClass("on")?!1:void c(a)})},o=function(e){var s=[];return a.each(r.questionSorts,function(e,t){var n=0,c=r.scoreRates[t],o=r.classScoreRates[t];a.each(o,function(e){n+=Math.abs(e-c)}),n>0&&s.push({sort:e,degree:1*n.toFixed(2)})}),0==s.length?s:(s=s.sort(function(e,a){return e.degree<a.degree?1:-1}),s.splice(e),s)},n.getScoreRates(s,function(e){r=e,t()})}})}(jQuery,SINGER);