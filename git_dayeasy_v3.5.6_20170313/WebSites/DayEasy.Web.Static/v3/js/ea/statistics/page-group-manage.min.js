!function(e,t){var a=e(document),s=!0,o={stage:null,stageText:"",learningStage:[6,3,3],dialogGroup:{BatchGroup:null,estaGroupPop:null,estaImportPop:null}};t._mix(t,{textArea:function(e){if(""==e)return!1;e=e.replace(/\s+/g," ").split(" "),t.isArray(e)||t.msg("粘贴格式错误");for(var a=0;a<e.length;a++)(""==e[a]||"undefined"==typeof e[a])&&(e.splice(a,1),a-=1);return e},getStr:function(e,t){var a=e.split(t)[0],s=e.split(t)[1];return[a,s]},inputCheck:function(a,s){t.inputCheck(e(this)[0],20);var o=a.value,n=parseInt(o);/^[.0-9]+$/.test(o)&&n>=1&&s>=n||(a.value=o.substring(0,o.length-1))},checkName:function(e){return/^[\u4e00-\u9fa5]{2,5}$/.test(e)},pageArrRepeat:function(e,a){if(t.isArray(e)||e.length){for(var s=e.sort(),o=[],n=0;n<s.length-1;n++){var c=s[n];c!=s[n+1]||t.inArray(c,o)||o.push(c)}a&&a.call(this,o)}}});var n={GetFullYear:function(a){var s=~~e("#stage").val(),n=["小","初","高"],c=function(e){for(var t=new Date,c=t.getFullYear(),i=[],r=0;e+1>r;)r++,i.push(c--);o.stage=e,o.stageText=n[s-1],a.call(this,i,e)};switch(s){case 1:c(o.learningStage[0]);break;case 2:c(o.learningStage[1]);break;case 3:c(o.learningStage[2]);break;default:t.msg("没有此学段，数据错误")}},subjects:!1,getSubjects:function(t){return n.subjects?void t.call(this,n.subjects):void e.ajax({url:singer.sites.apps+"/ea/LoadSubjects",type:"Post",success:function(e){n.subjects=e,t.call(this,e)}})},hrefGet:singer.sites.apps+"/ea/CreateGroupForManage",agencyUsers:!1,getAgencyUsers:function(t,a,s){var o=e(".dy-list").data("type");e.post(singer.sites.apps+"/ea/LoadUsersByAgencyId",{groupId:s,subjectId:a,groupType:o},function(e){n.agencyUsers=e,t.call(this,e)})}},c=function(){var a={ClassGroups:[],ColleagueGroups:[]},s=e("#groupNum"),n=e("#group-start"),c=parseInt(s.val()),i=n.val(),r=parseInt(e("#GradeYearCreate").val()),l=~~e(".classnum").val();if(c>0)for(var u=0;c>u;u++)a.ClassGroups.push({name:l>1?i+(l+u)+"班":i+(u+1)+"班",GradeYear:r});var p=e(".itme-subjects .item-form").find("input").siblings("span");if(p.each(function(){var t=e(this);t.prev("input").is(":checked")&&a.ColleagueGroups.push({name:t.text(),SubjectId:t.data("subjectid")})}),e.isEmptyObject(a))return t.msg("请创建圈子"),!1;var d=function(){e.ajax({url:"/ea/BatchCreateGroups",type:"POST",dataType:"json",data:a}).done(function(){t.msg("创建成功"),location.reload()})};e.ajax({url:"/ea/LoadRepeatMsg",type:"POST",dataType:"json",data:a}).done(function(e){if(e.status){o.dialogGroup.BatchGroup.close().remove();var a=template("pop-create-confirm",e.data.groupsSuccess);t.dialog({title:"确认提示",content:a,okValue:"跳过重复圈子，继续创建",cancelValue:"取消",ok:function(){d(),this.close().remove()},cancel:function(){this.close().remove()}}).showModal()}else o.dialogGroup.BatchGroup.close().remove(),d()})},i=function(a,s){var o=[],c="",i="";if(e(".item-form .checkbox-group").find("span").each(function(){var a=t.getStr(e(this).text(),"级")[1];o.push(a)}),1==s)for(var r=0;r<o.length;r++)c+="<li>",c+='<label class="checkbox-group group-checkbox">',c+='<input type="checkbox" name="options"><span data-subjectId="">'+a+o[r]+i+"</span>",c+='<i class="iconfont dy-icon-checkbox"></i>',c+="</label>",c+="</li>";if(2==s){o=[],i="组",t.each(n.subjects,function(e,t){o.push({text:e,id:t})});for(var l=0;l<o.length;l++)c+="<li>",c+='<label class="checkbox-group group-checkbox">',c+='<input type="checkbox" name="options"><span data-subjectId="'+o[l].id+'">'+a+o[l].text+i+"</span>",c+='<i class="iconfont dy-icon-checkbox"></i>',c+="</label>",c+="</li>"}e(".item-form").html(c),e(".checkall").prop("cheched",!1);var u=e(".itme-subjects .group-checkbox").find(".dy-icon-checkbox");u.removeClass("dy-icon-checkboxhv")},r=function(s,n){var c='<form name="form" id="form-file"  method="post"><div class="wrap-file f-cb"><input type="file" name="fileExcel" accept="application/vnd.ms-excel"  class="input-file" style="display:none"><div class="box-file"><div class="input-file-text f-toe" title="请上传office2003格式的excel文件">请上传office2003格式的excel文件</div><span class="uploadBtn dy-btn dy-btn-info">Excel上传</span></div></div></form>';a.off(".inputFile").on("click.inputFile",".uploadBtn",function(){e(".input-file").click()}).on("change.inputFile",".input-file",function(){var t=e(this).val();e(".input-file-text").text(t).attr("title",t)}),e(".excel-in").on("click",function(){o.dialogGroup.estaImportPop.close(),t.dialog({title:"Excel学生名单导入",content:c,okValue:"确定",ok:function(){var a=this,o=e(".input-file").val();return e("#form-file").ajaxSubmit({type:"post",url:"/ea/ExcelBatchImportStudents",data:{groupId:s,role:2},beforeSubmit:function(){if(""==o)return t.msg("未选择Excel文件"),!1;var e=/^.*\.(?:xls|xlsx)$/i;return e.test(o)?void 0:(t.msg("文件格式必须是:xls"),!1)},success:function(e){a.close().remove(),n(e)}}),!1},cancelValue:"取消",cancel:function(){o.dialogGroup.estaImportPop.showModal(),this.close().remove()}}).showModal()})};a.on("click",".btn-esta-group",function(){n.getSubjects(function(a){n.GetFullYear(function(s){var c=template("esta-group-pop",{GetFullYear:s,subjects:a});o.dialogGroup.estaGroupPop=t.dialog({fixed:!0,title:"创建圈子",content:c,okValue:"确认创建",cancelValue:"取消",ok:function(){var a=this,s={name:"",type:0};if(s.type=e("input[name='typeGroup']:checked").val(),s.name=e("#GroupName").val(),""==s.name)return t.msg("请输入圈子名称"),!1;switch(s.type){case"0":s.gradeYear=e("#GradeYear").val();break;case"1":s.subjectId=e("#SubjectId").val()}return e.post(n.hrefGet,s,function(e){e.status?(t.msg("创建成功",2e3,function(){location.reload(!0)}),a.close().remove()):t.msg(e.message)}),!1},cancel:function(){this.close().remove()}}).showModal()})})}).on("click","#batch-esta-group",function(e){e.preventDefault(),n.GetFullYear(function(e,a){var s={GetFullYear:e,classNameInit:{BeginTime:e[0]+a},stageText:o.stageText,SubjectId:n.subjects},i=template("pop-batch-create",s);o.dialogGroup.estaGroupPop.close().remove(),o.dialogGroup.BatchGroup=t.dialog({title:"批量创建圈子",content:i,okValue:"确认创建",ok:function(){return c(),!1},cancelValue:"取消",displayCancel:!1,cancel:function(){this.close().remove()}}).showModal()})}).on("click",".grou-personnel",function(a){a.preventDefault();var s=e(this).attr("groupid"),c=e(this).data("subid"),i=function(a){var n="",c={agencyUsers:a},i=template("batch-group-wrap-pop",c);!function(a){var c=function(e){if(e.status){var a="",s=e.data.repeatCount,o=e.data.repeatUsers,n=e.data.messageCount;if(0==s&&null==o)a+=t.format('<div class="esta-group-success-pop"><div class="esta-group-success "><p class="mb10"><span class="font-color">{0}</span>位新同学已导入成功！</p><p>学生可使用得一号登录，默认密码为“<span class="font-color">123456</span>”</p> </div></div>',n);else if(a+='<div class="pop-create-repeat">',a+='<p class="mb10"><span class="font-color">'+n+"</span>位新同学已导入成功！</p>",a+='<p class="mb20">学生可使用得一号登录，默认密码为“<span class="font-color">123456</span>”</p>',0!=s){a+='<div class="mb10">有'+s+"位同学已在该班级圈中，不能重复导入：</div>",a+='<ul class="ul-list-name">';for(var c=0;c<o.length;c++)a+="<li>"+o[c]+"</li>";a+="</ul>",a+="</div>"}t.alert(a,function(){location.reload()})}else t.msg(e.message)};o.dialogGroup.estaImportPop=t.dialog({title:n,content:i,okValue:"确定",ok:function(){var a,n,i;switch(n=function(){var a={groupId:s,users:t.textArea(e(".text-area").val()),role:2};if(!a.users.length)return t.msg("你还没有添加学生"),!1;for(var n=[],i=0;i<a.users.length;i++)t.checkName(a.users[i])||n.push(a.users[i]);if(n.length)return t.msg("姓名错误:"+n.splice(",")),!1;var r=function(){e.post(singer.sites.apps+"/ea/BatchImportStudents",{data:a},function(e){o.dialogGroup.estaImportPop.close().remove(),c(e)})};t.pageArrRepeat(a.users,function(e){return e&&e.length?(t.msg("姓名输入重复："+e),!1):void r()})},i=function(){var a={ids:[],groupId:s},n=[],c="/ea/ColleagueBatchTeacher";if(e(".table-teacher").find("input[type=checkbox]:checked").each(function(){var t=e(this).parents("td"),s=t.siblings(".value-name"),o=s.data("teacherid"),c=t.siblings(".subject-name").text(),i=s.text();a.ids.push(o),n.push({subject:c,name:i})}),0==e(".dy-list").data("type")){for(var i=n.sort(function(e,t){return e.subject>t.subject?-1:1}),r=[],l=[],u=0;u<i.length-1;u++)i[u].subject==i[u+1].subject&&(t.inArray(u,l)||(r.push(i[u]),l.push(u)),r.push(i[u+1]),l.push(u+1));if(r.length){var p="";p+='<div class="pop-create-repeat">',p+='<p class="mb10"><span class="font-color"></span>导入失败！</p>',p+='<div class="mb10">一个班一个学科只能有一位任课老师以下为重复导入老师。</div>',p+=' <table class="dy-table">',p+="<tbody>";for(var u=0;u<r.length;u++)p+="<tr><td>"+r[u].name+"</td><td>"+r[u].subject+"</td></tr>";return p+="</tbody>",p+="</table>",p+="</div>",o.dialogGroup.estaImportPop.close(),t.alert(p,function(){o.dialogGroup.estaImportPop.showModal()}),!1}c="/ea/BatchTeachers"}e.post(singer.sites.apps+c,a,function(e){if(o.dialogGroup.estaImportPop.close().remove(),e.status){var a=t.format('<div class="esta-group-success-pop"><div class="esta-group-success "><p class="mb10"><span class="font-color">{0}</span>位老师已导入成功！</p></div></div>',e.data.messageCount);t.alert(a,function(){location.reload()})}else t.msg(e.message)})},a=e(".tab-nav-item").find("li.on").data("role")){case 1:n();break;case 2:i()}return!1},cancelValue:"取消",cancel:function(){this.close().remove()}}).showModal(),a&&a.call(this,s,c)}(r)};return n.getAgencyUsers(i,c,s),!1}).on({keyup:function(){var a=t.textArea(e(".text-area").val()).length;e(".js-text-personnel").text(a)}},"#nameText"),e(".tab-nav-manage").on("click",".j-li-tab",function(t){t.stopPropagation(),e(this).addClass("on").siblings().removeClass("on")}),a.on("click",".tab-nav-item li",function(t){t.preventDefault();var a=e(this),s=a.index();a.addClass("on").siblings().removeClass("on"),a.parents(".batch-group-pop").find(".tab-con-item .con-item").css("display","none").eq(s).css("display","block")}).on("click",".esta-group .list-item .checkbox-group",function(){var t=e(this);e(".d-toggle").find(".d-toggle-box").css("display","none").eq(t.index()).css("display","block")}).on({keyup:function(){t.inputCheck(e(this)[0],20);var a=e(this),s=e(".amend-on"),o=e("#group-begin"),n=e.trim(a.val()),c=~~e(".classnum").val();o.data("classNumber",n),e.isNumeric(n)&&""!==n?(s.removeClass("hide"),1==n?s.addClass("on"):s.removeClass("on"),o.val(~~n+c-1+"班")):s.addClass("hide")}},"#groupNum").on("keyup","#group-start",function(){i(e("#group-start").val(),2)}).on("change","#GradeYearCreate",function(){var a=e(this),s=t.getStr(a.val(),"级")[0],n=parseInt(s)+o.stage;e("#group-start").val(o.stageText+n+"级"),e("#group-begin").val(e("#groupNum").val()+"班"),i(o.stageText+n+"级",2)}).on("keyup",".classnum",function(a){a.preventDefault();var s=e(this),o=e("#group-begin");t.inputCheck(s[0],50),""!==s.val()&&o.val(~~s.val()+~~o.data("classNumber")-1+"班")}).on("click",".checkall",function(){var t,a=e(".itme-subjects .group-checkbox").find(".dy-icon-checkbox");t=function(t){e(".itme-subjects").find("input[name='options']").each(function(){e(this).prop("checked",t)})},s?(t(!0),a.addClass("dy-icon-checkboxhv"),s=!1):(t(!1),a.removeClass("dy-icon-checkboxhv"),s=!0)}).on({click:function(a){a.preventDefault();var s=e("#search-member-con"),o=s.find("tbody"),n=o.find("tr"),c=e(".teacher-list"),i=e("#search-member").val(),r=c.find(".dy-nothing");if(n.find(".dy-icon-checkbox").removeClass("dy-icon-checkboxhv"),e(".table-teacher :checkbox").attr("checked",!1),e(".teacher-selected").text(0),r.remove(),"快速搜索"==i)return s.find("tbody").find("tr").removeClass("hide"),!1;if(n.each(function(t,a){var s=e(a),o=s.find("td.value-name").html();s.toggleClass("hide",o.indexOf(i)<0)}),o.find("tr:visible").length>0)r.remove();else{n.addClass("hide");var l=t.showNothing({word:"没有此老师"});c.append(l)}}},"#search-member-btn").on("click",".teacher-list input[type=checkbox]",function(){var t=e(".teacher-list").find("tr").find("input[type=checkbox]:checked").length;e(".teacher-selected").text(t)}),e(".j-auth").bind("click",function(){var a=e(this),s=a.data("status"),o=a.parents("tr").data("gid");a.disableField("稍后");var n=s?'确认要<b class="text-primary" style="font-weight: 600;">认证</b>该圈子?':'确定要<b class="text-danger" style="font-weight: 600;">拒绝</b>认证该圈子?';t.confirm(n,function(){e.ajax({url:"/ea/auth-group",type:"post",data:{Id:o,isAuth:s},success:function(e){e.status?t.msg(s?"认证成功":"已拒绝",2e3,function(){window.location.reload(!0)}):(t.alert(e.message),a.undisableFieldset())}})},function(){a.undisableFieldset()})}),e(".js-first-last").each(function(){var t=e(this).children();t.first().addClass("first-item"),t.last().addClass("last-item")}),e(".y-teacher-list").mCustomScrollbar({axis:"y",theme:"dark-thin",autoExpandScrollbar:!0,advanced:{autoExpandHorizontalScroll:!0}}),e(".item-form").mCustomScrollbar({axis:"y",theme:"dark-thin",autoExpandScrollbar:!0,advanced:{autoExpandHorizontalScroll:!0}})}(jQuery,SINGER);