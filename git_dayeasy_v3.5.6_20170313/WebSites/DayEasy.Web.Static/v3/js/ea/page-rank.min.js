!function(t,e){var a,n,r,s,l,d,i,o,c=t(".dy-table-body tr"),h=e.getLogger("exam-rank"),u=0,y=!1,f=!1,p=t(".dy-ea-ranks"),v=p.data("eid"),m=p.data("name"),g="",S={examId:v,keyType:0,keyScore:80,scoreA:60,unScoreA:40},b={examId:v,layerA:10,layerB:30,layerC:30,layerD:20,layerE:10},k={examId:v,examSubjectId:"",keyType:0,keyScore:80,scoreA:60,unScoreA:40},C=function(t){var e=function(t){return(100*t).toFixed(2)+"%"};return t.averageRatio=t.averageRatio.toFixed(5),t.averageRatioDiff=t.averageRatioDiff.toFixed(5),t.keyScale=e(t.keyScale),t.keyScaleDiff=e(t.keyScaleDiff),t.aScale=e(t.aScale),t.aScaleDiff=e(t.aScaleDiff),t.unaScale=e(t.unaScale),t.unaScaleDiff=e(t.unaScaleDiff),t},F=function(){for(var t=[],a=1,n=0;n<arguments.length;n++){var r=arguments[n];r>0?(t.push(e.format("{0}-{1}名",a,a+r-1)),a+=r):t.push("-")}return t};s=function(){var e=".dy-table-body tr";n&&-1!=n&&(e+='[data-class="'+n+'"]'),r&&(e+="[data-student*="+r+"]"),a=t(e),a.show(),c.not(a).hide(),t(".dy-table-foot strong").html(a.length)},l=function(a){var n=t("#classKeys"),r=n.find("select"),s=n.find("input:eq(0)"),l=n.find("input:eq(1)"),d=n.find("input:eq(2)");return S.keyType=parseInt(r.val()),S.keyScore=parseFloat(s.val()),S.scoreA=parseFloat(l.val()),S.unScoreA=parseFloat(d.val()),!e.isNumber(S.keyScore)||S.keyScore<=0||!e.isNumber(S.scoreA)||!e.isNumber(S.unScoreA)?(e.alert("参数异常，请重新输入！"),h.info(S),a&&e.isFunction(a)&&a.call(this),!1):1==S.keyType&&S.keyScore>100?(e.alert("重点比例不能超过100%！"),a&&e.isFunction(a)&&a.call(this),!1):void t.get("/ea/class-analysis-keys",S,function(n){var r=t("#classKeysBody"),s=t("#classKeysFoot"),l="<tr><td>{className}</td><td>{teacher}</td><td>{totalCount}</td><td>{studentCount}</td><td>{averageScore}</td><td>{averageScoreDiff}</td><td>{averageRatio}</td><td>{averageRatioDiff}</td><td>{keyCount}</td><td>{keyScale}</td><td>{keyScaleDiff}</td><td>{aCount}</td><td>{aScale}</td><td>{aScaleDiff}</td><td>{unaCount}</td><td>{unaScale}</td><td>{unaScaleDiff}</td></tr>",d='<tr class="th-center"><th>{className}</th><th></th><th>{totalCount}</th><th>{studentCount}</th><th>{averageScore}</th><th></th><th></th><th></th><th>{keyCount}</th><th>{keyScale}</th><th></th><th>{aCount}</th><th>{aScale}</th><th></th><th>{unaCount}</th><th>{unaScale}</th><th></th></tr>';r.empty(),s.empty();for(var i=0;i<n.length;i++){var o=C(n[i]);i==n.length-1?s.append(e.format(d,o)):r.append(e.format(l,o))}a&&e.isFunction(a)&&a.call(this,n)})},d=function(a){var n=t("#classLayers"),r=n.find("input:eq(0)"),s=n.find("input:eq(1)"),l=n.find("input:eq(2)"),d=n.find("input:eq(3)"),i=n.find("input:eq(4)");return b.layerA=parseFloat(r.val()),b.layerB=parseFloat(s.val()),b.layerC=parseFloat(l.val()),b.layerD=parseFloat(d.val()),b.layerE=parseFloat(i.val()),e.isNumber(b.layerA)&&e.isNumber(b.layerB)&&e.isNumber(b.layerC)&&e.isNumber(b.layerD)&&e.isNumber(b.layerE)?b.layerA+b.layerB+b.layerC+b.layerD+b.layerE!=100?(e.alert("各分层的总和必须为100%，请重新输入！"),a&&e.isFunction(a)&&a.call(this),!1):void t.get("/ea/class-analysis-layers",b,function(n){var r=t("#classLayersBody"),s=t("#classLayersFoot"),l=t(".dy-table-head em"),d="<tr><td>{className}</td><td>{teacher}</td><td>{totalCount}</td><td>{studentCount}</td><td>{layerA}</td><td>{layerB}</td><td>{layerC}</td><td>{layerD}</td><td>{layerE}</td></tr>",i='<tr class="th-center"><th>{className}</th><th></th><th>{totalCount}</th><th>{studentCount}</th><th>{layerA}</th><th>{layerB}</th><th>{layerC}</th><th>{layerD}</th><th>{layerE}</th></tr>';r.empty(),s.empty();for(var o=0;o<n.length;o++){var c=n[o];if(o==n.length-1){s.append(e.format(i,c));for(var h=F(c.layerA,c.layerB,c.layerC,c.layerD,c.layerE),u=0;u<l.length;u++)l.eq(u).html(h[u])}else r.append(e.format(d,n[o]))}a&&e.isFunction(a)&&a.call(this,n)}):(e.alert("参数异常，请重新输入！"),h.info(b),a&&e.isFunction(a)&&a.call(this),!1)},i=function(a){var n=t("#subjectKeys"),r=n.find("select:eq(0)"),s=n.find("select:eq(1)"),l=n.find("input:eq(0)"),d=n.find("input:eq(1)"),i=n.find("input:eq(2)");return k.examSubjectId=r.val(),g=r.find("option:selected").text(),k.keyType=parseInt(s.val()),k.keyScore=parseFloat(l.val()),k.scoreA=parseFloat(d.val()),k.unScoreA=parseFloat(i.val()),!e.isNumber(k.keyScore)||k.keyScore<=0||!e.isNumber(k.scoreA)||!e.isNumber(k.unScoreA)?(e.alert("参数异常，请重新输入！"),h.info(k),a&&e.isFunction(a)&&a.call(this),!1):1==k.keyType&&k.keyScore>100?(e.alert("重点比例不能超过100%！"),a&&e.isFunction(a)&&a.call(this),!1):void t.get("/ea/subject-analysis",k,function(n){var r,s=t("#subjectKeysBody"),l=t("#subjectKeysFoot"),d="<tr><td>{className}</td><td>{teacher}</td><td>{totalCount}</td><td>{studentCount}</td><td>{averageScore}</td><td>{averageScoreDiff}</td><td>{averageRatio}</td><td>{averageRatioDiff}</td><td>{averageScoreA}</td><td>{averageScoreB}</td><td>{keyCount}</td><td>{keyScale}</td><td>{keyScaleDiff}</td><td>{aCount}</td><td>{aScale}</td><td>{aScaleDiff}</td><td>{unaCount}</td><td>{unaScale}</td><td>{unaScaleDiff}</td></tr>",i='<tr class="th-center"><th>{className}</th><th></th><th>{totalCount}</th><th>{studentCount}</th><th>{averageScore}</th><th></th><th></th><th></th><th>{averageScoreA}</th><th>{averageScoreB}</th><th>{keyCount}</th><th>{keyScale}</th><th></th><th>{aCount}</th><th>{aScale}</th><th></th><th>{unaCount}</th><th>{unaScale}</th><th></th></tr>';s.empty(),l.empty();for(var c=0;c<n.length;c++){var h=C(n[c]);c==n.length-1?l.append(e.format(i,h)):s.append(e.format(d,h)),!r&&h.segmentA&&(r=!0)}o(n),t("#segmentSections").toggleClass("hide",!r),r&&t("#segmentSections").val(0),a&&e.isFunction(a)&&a.call(this,n)})},o=function(a,n){var r,s,l,d=t("#subjectSegmentsBody"),i=t("#subjectSegmentsFoot"),o=t("#segmentsHeader"),c=0;if(a?d.data("segments",a):a=d.data("segments"),d.empty(),i.empty(),o.find(".dy-segment-th").remove(),t(".dy-segments colgroup .dy-segment-col").remove(),!a||!a.length)return!1;var h,u=a[a.length-1],y="segment";if(n)switch(n){case 1:y="segmentA";break;case 2:y="segmentB"}if(h=u[y],!h)return!1;var f=e.format('<tr class="th-center"><th>{className}</th><th></th><th>{totalCount}</th><th>{studentCount}</th>',u);for(r in h)h.hasOwnProperty(r)&&(c++,f+="<th>"+h[r]+"</th>",o.find("tr").append('<th class="dy-segment-th">'+r+"</th>"));for(t(".dy-segments table").css({width:Math.max(1136,396+70*c)}),s=0;c>s;s++)t(".dy-segments colgroup").append('<col class="dy-segment-col" style="width:70px" />');for(f+="</tr>",i.append(f),s=0;s<a.length-1;s++){var p=a[s];h=p[y];var v=e.format("<tr><td>{className}</td><td>{teacher}</td><td>{totalCount}</td><td>{studentCount}</td>",p);if(h)for(r in h)h.hasOwnProperty(r)&&(v+="<td>"+h[r]+"</td>");else for(l=0;c>l;l++)v+="<td>0</td>";v+="</tr>",d.append(v)}},t(".dy-table-body").bind("scroll",function(e){var a=t(this),n=a.scrollLeft(),r=a.siblings(".dy-table-head").find("table");r.css({"margin-left":-n}),console.log(n)}),t(".b-class-list").bind("change",function(){n=t(this).val(),s()}),t(".btn-search i").bind("click",function(){var e=t(this).siblings("input");r=singer.trim(e.val()),s()}),t(".btn-search input").bind("keyup",function(e){13==e.keyCode&&(r=singer.trim(t(this).val()),s())}),t(".dy-ranks-nav a").bind("click",function(){var e=t(this).parents("li"),a=t(".dy-ranks-nav li");if(e.hasClass("active"))return!1;u=a.index(e),1!=u||y?2!=u||f||(f=!0,i()):(y=!0,l(function(){d()})),a.removeClass("active"),e.addClass("active");var n=t(".dy-ranks-panel"),r=n.eq(u);return n.addClass("hide"),r.removeClass("hide"),!1}),t("#classKeys").on("click",".dy-btn",function(){var e=t(this);e.disableField("计算中.."),l(function(){e.undisableFieldset()})}),t("#classLayers").on("click",".dy-btn",function(){var e=t(this);e.disableField("计算中.."),d(function(){e.undisableFieldset()})}),t("#subjectKeys").on("click",".dy-btn",function(){var e=t(this);e.disableField("计算中.."),i(function(){e.undisableFieldset()})}),t(".dy-key-type").bind("change",function(){var e=t(this);e.next().toggleClass("add-right",1==e.val())}),t("#segmentSections").bind("change",function(){var e=t(this).val();o(void 0,~~e)}),t(".b-export").bind("click",function(){var a=t("#exportForm");if(a&&a.length)a.empty();else{var n=t("body");a=t('<form method="post" target="_blank" class="hide">'),n.append(a)}switch(u){case 0:a.attr("action","/ea/ranking-download"),a.append('<input name="examId" value="'+v+'" />');break;case 1:a.attr("action","/ea/class-analysis-download"),a.append('<input name="keys" value="'+e.json(S)+'" />'),a.append('<input name="layer" value="'+e.json(b)+'" />'),a.append('<input name="name" value="'+m+'" />');break;case 2:a.attr("action","/ea/subject-analysis-download"),a.append('<input name="keys" value="'+e.json(k)+'" />'),a.append('<input name="name" value="'+m+"-"+g+'" />')}a.submit()})}(jQuery,SINGER);