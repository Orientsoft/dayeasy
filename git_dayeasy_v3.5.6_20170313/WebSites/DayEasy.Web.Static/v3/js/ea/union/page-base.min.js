!function(e,s){var a,t,r,n="/ea/union-data",c={},o=0,i={},u=(s.getLogger("union-charts"),function(e){return Math.round(100*e)/100}),l=function(e){if(e.scoreA<0&&e.scoreB<0)return-1;var s=0;return e.scoreA>0&&(s+=e.scoreA),e.scoreB>0&&(s+=e.scoreB),s};r=function(){s.each(t.subjects,function(e){o+=e.score});var e={};s.each(t.students,function(a){var r={id:a.id,name:a.name,className:a.className,rank:a.rank,score:a.totalScore,subjects:a.subjects};if(t.exams.hasOwnProperty(a.examId)){var n=t.exams[a.examId];r.agencyId=n.agencyId,r.agency=n.agencyName,n.hasOwnProperty("scores")||(n.scores=[]),n.scores.push({score:r.score,subjects:r.subjects})}s.each(r.subjects,function(s,r){e.hasOwnProperty(r)||(e[r]=[]);var n=t.subjects[r];s.name=n.subject,s.isAb=n.isAb,e[r].push({id:a.id,score:s.score})}),i[a.id]=r}),s.each(e,function(e,a){e=e.sort(function(e,s){return e.score>s.score?-1:1});var t=0,r=0,n=0;s.each(e,function(e){var s=i[e.id].subjects[a];return e.score<0?void(s.rank=-1):(n++,(0==r||e.score<r)&&(t=n,r=e.score),void(s.rank=t))})})},c.init=function(c,o){return t?void(o&&o.call(this)):void e.get(n,{unionBatch:c},function(e){return e.status?(a=c,t=e.data,r(),void(o&&o.call(this))):(s.alert(e.message,function(){location.href="/ea/exam"}),!1)})},c.ranks=function(){var e={count:0,subjects:[],students:[]};return e.count=t.studentCount,s.each(t.subjects,function(s){e.subjects.push({id:s.id,name:s.subject})}),s.each(i,function(s){e.students.push(s)}),e},c.studentScores=function(e){var s={name:"",subjects:{}};if(!i.hasOwnProperty(e))return s;var a=i[e];return s={name:a.name,subjects:a.subjects}},c.averageCompare=function(e){var a={isAb:!1,averages:{average:0,max:o,list:[]}};if(e){var r=t.subjects[e];a.isAb=r.isAb,a.averages.max=r.score,a.isAb?(a.averageA={average:0,max:r.scoreA,list:[]},a.averageB={average:0,max:r.scoreB,list:[]}):(a.highest={average:0,max:r.score,list:[]},a.lowest={average:0,max:r.score,list:[]})}else a.highest={average:0,max:o,list:[]},a.lowest={average:0,max:o,list:[]};var n=0,c=0,i=0,h=0,v=0,m=0;return s.each(t.exams,function(t){var r=0,o=0,f=0,d=0,g=0,b=0,p=0,y=0;s.each(t.scores,function(s){var t=s;if(e&&(t=s.subjects[e]),!(t.score<0)){var n=e>0?l(t):t.score;a.isAb?(r+=n,o++,t.scoreA>=0&&(f+=t.scoreA,d++),t.scoreB>=0&&(g+=t.scoreB,b++)):(r+=n,o++,n>p&&(p=n),n>0&&(0==y||y>n)&&(y=n))}}),n+=r,c+=o,i+=f,h+=d,v+=g,m+=b,a.averages.list.push({name:t.agencyName,value:u(r/o)}),a.isAb?(a.averageA.list.push({name:t.agencyName,value:u(f/d)}),a.averageB.list.push({name:t.agencyName,value:u(g/b)})):(a.highest.list.push({name:t.agencyName,value:p}),a.lowest.list.push({name:t.agencyName,value:y}))}),a.averages.average=u(n/c),a.isAb&&(a.averageA.average=u(i/h),a.averageB.average=u(v/m)),a},c.focusRateAnalysis=function(e,a){var r=function(){if(e){var s=t.subjects[e];a.keyScore=.75*s.score,a.scoreA=a.unScoreA=60}else a.keyScore=.75*o,a.scoreA=a.unScoreA=60};a&&a.keyScore||r();var n={focusRate:{average:0,list:[]},qualifiedRate:{average:0,list:[]},failureRate:{average:0,list:[]}},c=0,i=0,h=0,v=0;return s.each(t.exams,function(t){var r=0,o=0,m=0,f=0;s.each(t.scores,function(t){var n=0,c=0;if(e){var i=t.subjects[e];n=l(i),c=i.scoreA}else{if(!t.scoreA){var u=0,h=0;s.each(t.subjects,function(e){e.scoreA<0||(u+=e.scoreA,h++)}),t.scoreA=u/h}n=t.score,c=t.scoreA}0>n||(r++,n>=a.keyScore&&o++,c>=a.scoreA&&m++,c<a.unScoreA&&f++)}),n.focusRate.list.push({name:t.agencyName,value:u(100*o/r)}),n.qualifiedRate.list.push({name:t.agencyName,value:u(100*m/r)}),n.failureRate.list.push({name:t.agencyName,value:u(100*f/r)}),c+=r,i+=o,h+=m,v+=f}),n.focusRate.average=u(100*i/c),n.qualifiedRate.average=u(100*h/c),n.failureRate.average=u(100*v/c),n},c.segmentDist=function(e){var a={segments:[],agencyList:[]};if(!e||!t.subjects.hasOwnProperty(e))return a;var r=t.subjects[e],n=r.score,c=[];n%10!=0&&(a.segments.push(s.format("{0}-{1}",n,n-n%10)),c.push({max:n,min:n-n%10}),n-=n%10);var o;for(o=n;o>.6*n;o-=10)a.segments.push(s.format("{0}-{1}",o,o-10)),c.push({max:o,min:o-10});return a.segments.push(o+"以下"),c.push({max:o,min:0}),s.each(t.exams,function(t){var r={name:t.agencyName,counts:{}};s.each(a.segments,function(e){r.counts[e]=0}),s.each(t.scores,function(t){if(t.subjects.hasOwnProperty(e)){var n=t.subjects[e];s.each(a.segments,function(e,s){var a=c[s],t=l(n);t<=a.max&&t>a.min&&r.counts[e]++})}}),a.agencyList.push(r)}),a},c.download=function(){var s=e("#exportForm");if(s&&s.length)s.empty();else{var t=e("body");s=e('<form method="post" target="_blank" class="hide">'),t.append(s)}s.attr("action","/ea/union-download"),s.append('<input name="unionBatch" value="'+a+'" />'),s.submit()},c.subjectRanks=function(e){var a={isZhe:-1,isAb:!0,students:[]};if(!t.subjects.hasOwnProperty(e))return a;var r=t.subjects[e];return a.isAb=r.isAb,s.each(i,function(s){var t={name:s.name,className:s.className,agency:s.agency};if(s.subjects.hasOwnProperty(e)){var r=s.subjects[e];t.score=r.score,t.scoreA=r.scoreA,t.scoreB=r.scoreB,t.rank=r.rank,-1==a.isZhe&&(a.isZhe=t.score<l(t))}else t.score=-1,t.scoreA=-1,t.scoreB=-1,t.rank=-1;a.students.push(t)}),a.students=a.students.sort(function(e,s){return e.score>s.score?-1:1}),a},s.mix(s,{chartApi:c}),e.fn.extend({tableScroll:function(){var s=e(this),a=s.find(".dy-table-body"),t=a.siblings(".dy-table-head"),r=t.width(),n=a.find("tr:eq(1)").width()+1,c=a.find("tr").length;c>8&&r>=n&&a.siblings(".dy-table-head").addClass("crt").css("width",n),n>r&&a.bind("scroll",function(s){s.preventDefault();var a=e(this),t=a.scrollLeft(),r=a.siblings(".dy-table-head");return 0===r.length?!1:void r.find("table").css({"margin-left":-t})})},popWindow:function(s){var a=e(this),t=e(document),r=e(window),n=e("body"),c=r.width(),o=r.height(),i=r.scrollTop(),u=r.scrollLeft(),l=a.outerWidth(!0),h=a.outerHeight(!0),v=c/2-l/2+u,m=o/2-h/2+i,f='<div class="mask"></div>',d=t.width(),g=t.height();return a.show().animate({left:v+"px",top:m+"px"},0),n.append(f),e(".mask").width(d).height(g),a.find(".h2-title strong").text(s),r.resize(function(){a.is(":visible")&&(c=e(window).width(),o=e(window).height(),v=c/2-l/2+u,m=o/2-h/2+i,a.animate({left:v+"px",top:m+"px"},0))}),r.scroll(function(){a.is(":visible")&&(i=e(window).scrollTop(),u=e(window).scrollLeft(),v=c/2-l/2+u,m=o/2-h/2+i,a.animate({left:v+"px",top:m+"px"},500).dequeue())}),n.on("click",".mask,.close",function(s){s.preventDefault(),a.hide(),e(".mask").remove()}),!1}})}(jQuery,SINGER);